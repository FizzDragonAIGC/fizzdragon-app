<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FizzDragon AIGCÁï™ÂäáÁ≥ªÁµ±</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            /* FizzDragon ÂÆòÁΩëÈÖçËâ≤ */
            --bg: #14141a;
            --surface: #1a1a22;
            --surface2: #22222c;
            --border: #2d2d3a;
            --text: #f0f0f5;
            --text2: #8a8a9a;
            --accent: #E31B23;      /* FizzDragon LogoÁ∫¢ */
            --accent2: #E31B23;     /* ‰øùÊåÅ‰∏ÄËá¥ */
            --accent-gradient: linear-gradient(135deg, #E31B23, #C41920);
            --user-bg: #1c1c24;
            --ai-bg: transparent;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }
        
        /* Â∑¶‰æßËæπÊ†è - KimiÈ£éÊ†º */
        .sidebar {
            width: 280px;
            height: 100vh;
            background: #0a0a0f;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }
        
        .sidebar.hidden {
            transform: translateX(-100%);
            position: absolute;
        }
        
        .sidebar-header {
            padding: 20px 16px;
            border-bottom: 1px solid var(--border);
            background: #000;
        }
        
        .sidebar-logo {
            width: 100%;
            max-width: 200px;
            height: auto;
            margin-bottom: 8px;
            display: block;
        }
        
        .sidebar-tagline {
            font-size: 11px;
            color: var(--text2);
            letter-spacing: 2px;
            margin-bottom: 12px;
            text-transform: uppercase;
        }
        
        /* Ê®°ÂºèÂàáÊç¢Tabs - ÂûÇÁõ¥‰∏§Ë°å */
        .mode-tabs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .mode-tab {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 16px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text2);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 48px;
        }
        
        .mode-tab:hover {
            background: rgba(255,255,255,0.06);
            color: var(--text);
        }
        
        .mode-tab.active {
            background: rgba(227, 27, 35, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .mode-tab .tab-icon {
            font-size: 18px;
        }
        
        .mode-tab .tab-text {
            font-size: 14px;
            font-weight: 500;
        }
        
        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: rgba(232, 48, 48, 0.1);
            border: none;
            border-radius: 8px;
            color: #E31B23;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .new-chat-btn .btn-icon {
            font-size: 14px;
        }
        
        .new-chat-btn:hover {
            background: rgba(232, 48, 48, 0.2);
            color: #E31B23;
        }
        
        .sidebar-section {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .sidebar-section-title {
            font-size: 11px;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 8px 12px;
        }
        
        .project-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .project-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .project-item:hover {
            background: var(--surface);
        }
        
        .project-item.active {
            background: var(--surface2);
        }
        
        .project-item .icon {
            font-size: 16px;
        }
        
        .project-item .info {
            flex: 1;
            min-width: 0;
        }
        
        .project-item .title {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .project-item .meta {
            font-size: 11px;
            color: var(--text2);
        }
        
        .project-item .action-btn {
            opacity: 0;
            padding: 4px 8px;
            background: rgba(227, 27, 35, 0.2);
            border: none;
            border-radius: 4px;
            color: #E31B23;
            cursor: pointer;
            font-size: 12px;
            transition: opacity 0.2s;
            margin-left: 4px;
        }
        
        .project-item:hover .action-btn {
            opacity: 1;
        }
        
        .project-item .action-btn:hover {
            background: rgba(227, 27, 35, 0.4);
        }
        
        .project-item .actions {
            display: flex;
            gap: 2px;
        }
        
        .project-item[draggable="true"] {
            cursor: grab;
        }
        
        .project-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .project-item.drag-over {
            border-top: 2px solid var(--accent);
        }
        
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
        }
        
        .beta-badge {
            text-align: center;
            padding: 10px;
            background: rgba(227, 27, 35, 0.1);
            border-radius: 8px;
            color: #E31B23;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* ‰∏ªÂÜÖÂÆπÂå∫ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        /* ‰∏âÊ†èÂ∏ÉÂ±ÄÂÆπÂô® */
        .content-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        /* Âè≥‰æßËµÑ‰∫ßÈù¢Êùø - Êõ¥ÂÆΩ */
        .assets-panel {
            width: 520px;
            background: #0a0a0f;
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .assets-panel-header {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            background: #000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .assets-panel-header h3 {
            font-size: 13px;
            color: var(--accent);
            margin: 0;
            white-space: nowrap;
        }
        
        .assets-header-actions {
            display: flex;
            gap: 6px;
        }
        
        .assets-action-btn {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #999;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .assets-action-btn:hover {
            background: #252525;
            color: #fff;
            border-color: #444;
        }
        
        .assets-action-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .assets-action-btn.primary:hover {
            background: #C41920;
            transform: scale(1.02);
        }
        
        .assets-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        /* Âπ∂ÊéíÂ∏ÉÂ±Ä */
        .asset-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .asset-section {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface2) 100%);
            border-radius: 10px;
            border: 1px solid var(--border);
            min-width: 0;
            transition: all 0.2s;
        }
        
        .asset-section:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(227, 27, 35, 0.1);
        }
        
        .asset-section.full-width {
            flex: none;
            width: 100%;
        }
        
        .asset-section-title {
            font-size: 12px;
            color: var(--accent);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }
        
        .asset-section-content {
            font-size: 12px;
            color: var(--text);
            line-height: 1.6;
        }
        
        .asset-item {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .asset-item b {
            color: var(--text2);
            font-weight: 500;
        }
        
        .asset-item:last-child {
            border-bottom: none;
        }
        
        .asset-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 4px;
        }
        
        .asset-status.done { background: rgba(56, 161, 105, 0.2); color: #38a169; }
        .asset-status.pending { background: rgba(214, 158, 46, 0.2); color: #d69e2e; }
        
        /* ÁîªÂ∏ÉÂºèËµÑ‰∫ßÊµÅ */
        .canvas-flow {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .canvas-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text2);
        }
        
        .canvas-empty .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        .canvas-empty .empty-text {
            font-size: 13px;
            line-height: 1.6;
        }
        
        /* ËµÑ‰∫ßÂå∫ÂùóÔºà‰∏§Â§ßÂàÜÁªÑÔºâ*/
        .assets-section {
            margin-bottom: 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .assets-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(227,27,35,0.15) 0%, rgba(227,27,35,0.05) 100%);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            color: var(--accent);
        }
        .assets-section-header:hover {
            background: linear-gradient(135deg, rgba(227,27,35,0.2) 0%, rgba(227,27,35,0.1) 100%);
        }
        .assets-section-stats {
            font-size: 10px;
            color: var(--text2);
            font-weight: 400;
            margin-left: auto;
            margin-right: 8px;
        }
        .assets-section-body {
            padding: 8px;
        }
        
        /* ËµÑ‰∫ßÂç°Áâá */
        .canvas-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .canvas-card-header {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            background: var(--surface2);
            border-bottom: 1px solid var(--border);
            gap: 8px;
        }
        
        .canvas-card-num {
            background: var(--accent);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }
        
        .canvas-card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            flex: 1;
        }
        
        .canvas-card-status {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(56, 161, 105, 0.2);
            color: #38a169;
        }
        
        .canvas-card-body {
            padding: 12px 14px;
            font-size: 12px;
            color: var(--text2);
            line-height: 1.5;
        }
        
        .canvas-card-row {
            display: flex;
            margin: 4px 0;
        }
        
        .canvas-card-label {
            color: var(--text2);
            min-width: 60px;
        }
        
        .canvas-card-value {
            color: var(--text);
            flex: 1;
        }
        
        /* ËßíËâ≤ËµÑ‰∫ßÈ°π */
        .character-asset-item {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }
        .character-asset-item:last-child { border-bottom: none; }
        .character-asset-item:hover { background: rgba(227,27,35,0.05); }
        .character-asset-header {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }
        .character-asset-name { color: var(--text); }
        .character-asset-role { color: var(--text2); font-size: 11px; }
        .character-asset-toggle { margin-left: auto; color: var(--text2); font-size: 10px; transition: transform 0.2s; }
        .character-asset-detail {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border);
        }
        .char-section { margin-bottom: 8px; }
        .char-section:last-child { margin-bottom: 0; }
        .char-section-title {
            font-size: 10px;
            color: var(--accent);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .char-section-content {
            font-size: 11px;
            color: var(--text);
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .char-prompt {
            background: #1a1a1a;
            padding: 6px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 10px;
            user-select: all;
        }
        .copy-btn {
            background: #333;
            border: none;
            color: #aaa;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            cursor: pointer;
            margin-left: auto;
        }
        .copy-btn:hover { background: var(--accent); color: white; }
        
        /* Á´†ËäÇÁõíÂ≠ê */
        .chapter-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .chapter-box-header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: var(--surface2);
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            font-weight: 600;
        }
        
        .chapter-box-content {
            display: flex;
        }
        
        .chapter-box-left {
            flex: 1;
            padding: 10px 12px;
            border-right: 1px solid var(--border);
            font-size: 11px;
        }
        
        .chapter-box-right {
            flex: 1;
            padding: 10px 12px;
            font-size: 11px;
        }
        
        .chapter-box-label {
            font-size: 10px;
            color: var(--text2);
            margin-bottom: 4px;
        }
        
        .chapter-box-footer {
            display: flex;
            justify-content: flex-end;
            padding: 8px 12px;
            border-top: 1px solid var(--border);
            background: var(--surface2);
        }
        
        .chapter-box-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .chapter-box-btn:hover {
            background: #C41920;
        }
        
        /* Á´†ËäÇÂÜÖÂÆπÂ±ïÂºÄÈù¢Êùø */
        .chapter-content-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #0d0d0d;
        }
        
        .chapter-content-panel.expanded {
            max-height: 400px;
        }
        
        .chapter-content-scroll {
            max-height: 350px;
            overflow-y: auto;
            padding: 12px;
            font-size: 12px;
            line-height: 1.6;
            color: #ccc;
            white-space: pre-wrap;
        }
        
        .chapter-content-scroll::-webkit-scrollbar {
            width: 4px;
        }
        
        .chapter-content-scroll::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 2px;
        }
        
        .chapter-content-edit {
            width: 100%;
            min-height: 200px;
            max-height: 350px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #ccc;
            padding: 10px;
            font-size: 12px;
            line-height: 1.6;
            resize: vertical;
            border-radius: 4px;
        }
        
        .chapter-tab-btn {
            background: transparent;
            border: none;
            color: var(--text2);
            padding: 6px 10px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .chapter-tab-btn:hover {
            background: #252525;
            color: #fff;
        }
        
        .chapter-tab-btn.active {
            background: var(--accent);
            color: white;
        }
        
        /* ÊâãÊú∫Á´ØÈöêËóèÂè≥‰æßÈù¢Êùø */
        @media (max-width: 1024px) {
            .assets-panel {
                display: none;
            }
        }
        
        @media (max-width: 1200px) {
            .assets-panel {
                width: 350px;
            }
        }
        
        .menu-toggle {
            background: var(--surface);
            border: none;
            border-radius: 8px;
            color: var(--text);
            font-size: 22px;
            cursor: pointer;
            padding: 8px 12px;
            display: none;
            transition: background 0.2s;
        }
        .menu-toggle:hover, .menu-toggle:active {
            background: var(--surface2);
        }
        
        .header-title {
            font-size: 14px;
            color: var(--text2);
        }
        
        /* 768px Â™í‰ΩìÊü•ËØ¢ÁßªËá≥Â∫ïÈÉ®Áªü‰∏ÄÁÆ°ÁêÜ */
        
        /* È°∂ÈÉ®Ê†è - FizzDragonÈ£éÊ†º */
        .header {
            padding: 16px 24px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .header img {
            height: 24px;
            filter: brightness(1.1);
        }
        
        .logo {
            font-size: 14px;
            font-weight: 500;
            color: var(--text2);
            letter-spacing: 0.5px;
        }
        
        .status {
            margin-left: auto;
            font-size: 12px;
            color: var(--text2);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }
        
        .status-dot.offline { background: #ef4444; }
        .status-dot.loading { background: #E31B23; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        
        /* ËØ≠Ë®ÄÈÄâÊã©Âô® */
        .lang-select {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 12px;
        }
        
        .lang-select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 0 10px;
            color: #888;
            font-size: 12px;
        }
        
        .user-menu button:hover {
            color: #E31B23 !important;
        }
        
        /* ËÅäÂ§©Âå∫Âüü */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* ÊªöÂä®Êù°Ê†∑Âºè - Ê∑±ÈªëÁÅ∞Ëâ≤ */
        .chat-container::-webkit-scrollbar {
            width: 5px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #0d0d0d;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #2a2a2a;
            border-radius: 3px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #3a3a3a;
        }
        
        /* ÂÖ®Â±ÄÊªöÂä®Êù°Ê†∑Âºè */
        *::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        *::-webkit-scrollbar-track {
            background: #0d0d0d;
        }
        *::-webkit-scrollbar-thumb {
            background: #2a2a2a;
            border-radius: 3px;
        }
        *::-webkit-scrollbar-thumb:hover {
            background: #3a3a3a;
        }
        
        .message {
            max-width: 95%;
            padding: 8px 12px;
            line-height: 1.5;
            font-size: 14px;
            border-radius: 10px;
            margin-bottom: 6px;
        }
        
        /* ÂåÖÂê´ÂèØÁºñËæëÊ°ÜÁöÑÊ∂àÊÅØÂÖ®ÂÆΩ */
        .message:has(.editable-result) {
            max-width: 95%;
            width: 95%;
        }
        
        .message.user {
            background: rgba(227, 27, 35, 0.15);
            border: 1px solid rgba(227, 27, 35, 0.3);
            margin-left: auto;  /* Èù†Âè≥ */
            border-radius: 10px 10px 4px 10px;
        }
        
        .message.ai {
            background: var(--surface);
            border: 1px solid var(--border);
            margin-right: auto;  /* Èù†Â∑¶ */
            border-radius: 10px 10px 10px 4px;
        }
        
        .message .role {
            font-size: 11px;
            color: var(--text2);
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .message.user .role { color: var(--accent); }
        .message.ai .role { color: #888; }
        
        /* ÂèØÁºñËæëÁ°ÆËÆ§Ê°Ü - Â§ßÂûãÁºñËæëÂå∫ */
        .editable-result {
            background: #0d0d0d;
            border: 2px solid #E31B23;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            width: 100%;
            max-width: 100%;
            box-shadow: 0 4px 20px rgba(227, 27, 35, 0.15);
        }
        
        .editable-result .result-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid #333;
        }
        
        .editable-result .result-number {
            background: var(--accent);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .editable-result .result-title {
            font-size: 14px;
            font-weight: 600;
            color: #e0e0e0;
        }
        
        .editable-result .result-tag {
            background: rgba(227, 27, 35, 0.2);
            color: var(--accent);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: auto;
        }
        
        .editable-result textarea {
            width: 100%;
            min-height: 200px;
            max-height: 70vh;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 6px;
            color: #e0e0e0;
            padding: 12px 15px;
            font-size: 13px;
            line-height: 1.7;
            resize: vertical;
            font-family: inherit;
            white-space: pre-wrap;
            overflow-y: auto;
        }
        
        .editable-result textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(227, 27, 35, 0.2);
        }
        
        .editable-result .actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            justify-content: flex-end;
        }
        
        .editable-result .btn-confirm {
            background: var(--accent);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .editable-result .btn-confirm:hover {
            background: #C41920;
        }
        
        .editable-result .btn-regenerate {
            background: #2a2a2a;
            color: #999;
            border: 1px solid #404040;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        
        .editable-result .btn-regenerate:hover {
            background: #333;
            border-color: #555;
            color: #ccc;
        }
        
        /* ÂàÜÈïúÈÄâÊã©Âô® */
        .storyboard-selector {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
        }
        
        .selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        
        .selector-header .total-info {
            font-size: 11px;
            color: #888;
        }
        
        .selector-actions-top {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .selector-actions-top button {
            background: #252525;
            border: 1px solid #404040;
            color: #999;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .selector-actions-top button:hover {
            background: #333;
            color: #fff;
        }
        
        .selector-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
        }
        
        .storyboard-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .storyboard-checkbox:hover {
            background: #252525;
        }
        
        .storyboard-checkbox input {
            accent-color: var(--accent);
        }
        
        .checkbox-label {
            flex: 1;
            font-size: 13px;
            color: #ccc;
        }
        
        .checkbox-label .shot-count {
            float: right;
            font-size: 11px;
            color: #666;
        }
        
        .selector-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .selector-actions .btn-cancel {
            background: #252525;
            border: 1px solid #404040;
            color: #999;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .selector-actions .btn-confirm {
            background: var(--accent);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        /* ÁªìÊûúÂç°Áâá - Á¥ßÂáëÂ§ßÁ∫≤Ê†∑Âºè (ÊöóËâ≤‰∏ªÈ¢ò) */
        .result-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 6px 0;
        }
        
        .result-card .card-row {
            display: flex;
            margin: 4px 0;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .result-card .card-label {
            color: #777;
            min-width: 60px;
            flex-shrink: 0;
        }
        
        .result-card .card-value {
            color: #e0e0e0;
            flex: 1;
        }
        
        .message .content { white-space: pre-wrap; }
        
        .message .content h3 {
            font-size: 14px;
            margin: 12px 0 8px;
            color: var(--accent);
        }
        
        .message .content ul {
            margin-left: 20px;
            margin-top: 8px;
        }
        
        .message .content li { margin: 4px 0; }
        
        /* Âø´Êç∑ÂõûÂ§ç - FizzDragonÈ£éÊ†º */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 16px;
            max-width: 100%;
        }
        
        .quick-reply {
            padding: 10px 18px;
            background: rgba(232, 48, 48, 0.08);
            border: none;
            border-radius: 20px;
            color: #E31B23;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 100%;
            word-break: break-word;
        }
        
        .quick-reply:hover, .quick-reply:active {
            background: rgba(232, 48, 48, 0.2);
            color: #E31B23;
        }
        
        .quick-reply:active {
            transform: scale(0.97);
        }
        
        /* ÁßªÂä®Á´ØÂø´Êç∑ÂõûÂ§ç - ÂÖ®ÂÆΩÂûÇÁõ¥ÊéíÂàó */
        @media (max-width: 600px) {
            .message {
                max-width: 100% !important;
                overflow: hidden;
            }
            .message .content {
                overflow: hidden;
                word-wrap: break-word;
            }
            .quick-replies {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px;
                width: 100%;
            }
            .quick-reply {
                width: 100% !important;
                max-width: 100% !important;
                text-align: center;
                padding: 14px 16px;
                font-size: 14px;
                box-sizing: border-box;
            }
        }
        
        /* ËæìÂÖ•Âå∫Âüü */
        .input-area {
            padding: 16px 20px;
            background: var(--bg);
            border-top: none;
        }
        
        .input-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        #userInput {
            width: 100%;
            padding: 14px 16px;
            padding-right: 100px;
            background: #1a1a1a;
            border: none;
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            resize: none;
            min-height: 48px;
            max-height: 150px;
            font-family: inherit;
        }
        
        #userInput:focus {
            outline: none;
            box-shadow: 0 0 0 1px #E31B23;
        }
        
        .input-actions {
            position: absolute;
            right: 8px;
            bottom: 8px;
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 10px 18px;
            font-size: 16px;
        }
        
        .btn-primary:hover { 
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-upload {
            background: #252525;
            color: var(--text2);
            border: 1px solid #333;
            padding: 10px 14px;
            font-size: 16px;
            border-radius: 8px;
        }
        
        .btn-upload:hover { 
            color: var(--accent); 
            border-color: var(--accent);
            background: #1a1a1a;
        }
        
        #fileInput { display: none; }
        
        /* ÊâìÂ≠óÂä®Áîª */
        .typing {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }
        
        .typing span {
            width: 6px;
            height: 6px;
            background: #E31B23;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
        
        /* ËøõÂ∫¶Âç°Áâá */
        .progress-card {
            background: transparent;
            border: none;
            border-left: 2px solid #E31B23;
            border-radius: 0;
            padding: 8px 12px;
            margin-top: 8px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            color: #E31B23;
        }
        
        .progress-bar {
            height: 3px;
            background: #2d2d3a;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #E31B23;
            transition: width 0.3s;
        }
        
        /* ÁªìÊûúÂç°Áâá */
        .result-card {
            background: transparent;
            border: none;
            border-left: 2px solid #333;
            border-radius: 0;
            overflow: hidden;
            margin-top: 12px;
            padding-left: 16px;
        }
        
        .result-header {
            padding: 8px 0;
            background: transparent;
            border-bottom: none;
            font-size: 13px;
            font-weight: 600;
            color: var(--text2);
        }
        
        .result-content {
            padding: 8px 0;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Áî®Êà∑Âä©ÊâãÊµÆÂä®ÊåâÈíÆ */
        .fizzdragon-fab {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(227, 27, 35, 0.4);
            transition: all 0.2s;
            z-index: 1000;
        }
        
        .fizzdragon-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(227, 27, 35, 0.5);
        }
        
        .help-fab {
            position: fixed;
            bottom: 30px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #E31B23, #B51820);
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(232, 48, 48, 0.4);
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .help-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(232, 48, 48, 0.6);
        }
        
        .help-fab:active {
            transform: scale(0.95);
        }
        
        .help-fab.loading {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ==================== ÁßªÂä®Á´ØÈÄÇÈÖçÔºàApple HIGÊ†áÂáÜÔºâ==================== */
        
        /* Â∫ïÈÉ®ÂØºËà™Ê†è - ÈªòËÆ§ÈöêËóè */
        .bottom-toolbar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #0a0a0f;
            border-top: 1px solid var(--border);
            padding: 6px 4px;
            padding-bottom: calc(6px + env(safe-area-inset-bottom, 0px));
            z-index: 100;
            justify-content: space-around;
            align-items: center;
        }
        
        .toolbar-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            min-width: 64px;
            min-height: 48px;
            padding: 6px 8px;
            background: transparent;
            border: none;
            color: var(--text2);
            font-size: 11px;
            cursor: pointer;
            border-radius: 8px;
        }
        
        .toolbar-btn:active {
            background: rgba(227, 27, 35, 0.2);
        }
        
        .toolbar-btn.active {
            color: var(--accent);
        }
        
        .toolbar-btn .icon {
            font-size: 24px;
            line-height: 1;
        }

        /* ===== ÊâãÊú∫Á´ØÈÄÇÈÖç (<=768px) ===== */
        @media (max-width: 768px) {
            /* ÈöêËóèÊ°åÈù¢Á´ØÂÖÉÁ¥† */
            .fizzdragon-fab,
            .help-fab,
            .menu-toggle.mobile-assets-btn,
            .status,
            .lang-select {
                display: none !important;
            }
            
            /* ÊòæÁ§∫Â∫ïÈÉ®ÂØºËà™ */
            .bottom-toolbar {
                display: flex;
            }
            
            /* üîß ‰øÆÂ§çÊªöÂä®ÈóÆÈ¢ò - ÁÆÄÂçïÁ≤óÊö¥ÊñπÊ°à */
            html, body {
                height: 100%;
                overflow: hidden;
                position: fixed;
                width: 100%;
            }
            .main-content {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                display: flex;
                flex-direction: column;
            }
            .content-wrapper {
                flex: 1;
                position: relative;
                overflow: hidden;
            }
            .chat-area {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                display: flex;
                flex-direction: column;
            }
            .chat-container {
                flex: 1;
                overflow-y: scroll !important;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
                padding: 12px;
                padding-bottom: 160px;
            }
            
            /* Â§¥ÈÉ® - 44pxÊúÄÂ∞èËß¶Êéß */
            .header {
                padding: 8px 12px;
                min-height: 50px;
                flex-shrink: 0;
            }
            .header-title {
                font-size: 16px;
                text-align: center;
                flex: 1;
            }
            .menu-toggle {
                display: flex !important;
                min-width: 44px;
                min-height: 44px;
                font-size: 20px;
                align-items: center;
                justify-content: center;
            }
            
            /* Â∑¶‰æßËæπÊ†è */
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 300px;
                max-width: 85vw;
                z-index: 1001;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .sidebar.show {
                transform: translateX(0);
            }
            
            /* ‰æßËæπÊ†èÂÜÖÊåâÈíÆ - 44pxÊúÄÂ∞è */
            .new-chat-btn {
                min-height: 48px;
                font-size: 15px;
            }
            .mode-tab {
                min-height: 44px;
                padding: 10px;
            }
            .project-item {
                min-height: 48px;
                padding: 12px;
            }
            
            /* Âè≥‰æßËµÑ‰∫ßÈù¢Êùø */
            .assets-panel {
                position: fixed !important;
                right: 0;
                top: 0;
                bottom: 0;
                width: 320px !important;
                max-width: 90vw !important;
                z-index: 1001;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                display: flex !important;
            }
            .assets-panel.show {
                transform: translateX(0);
            }
            
            /* ËµÑ‰∫ßÈù¢ÊùøÂÜÖÊåâÈíÆ */
            .assets-action-btn {
                min-height: 44px;
                padding: 12px;
                font-size: 13px;
            }
            
            /* ÈÅÆÁΩ©Â±Ç */
            .sidebar-overlay,
            .assets-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s;
            }
            .sidebar-overlay.show,
            .assets-overlay.show {
                opacity: 1;
                visibility: visible;
            }
            
            /* ËÅäÂ§©Âå∫Âüü */
            .chat-container {
                padding: 12px;
                padding-bottom: 140px;
            }
            
            /* Ê∂àÊÅØÊ∞îÊ≥° */
            .message {
                max-width: 90%;
                padding: 14px;
                border-radius: 16px;
                font-size: 15px;
                line-height: 1.6;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            .message.ai {
                background: var(--surface);
                border: 1px solid var(--border);
                margin-right: auto;
            }
            .message.user {
                background: rgba(227, 27, 35, 0.15);
                border: 1px solid rgba(227, 27, 35, 0.3);
                margin-left: auto;
                margin-right: 0;
                max-width: 80%;
            }
            
            /* Âø´Êç∑ÂõûÂ§ç - 44pxÊúÄÂ∞èËß¶Êéß */
            .quick-replies {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-top: 14px;
            }
            .quick-reply {
                width: 100%;
                min-height: 48px;
                padding: 14px 18px;
                text-align: center;
                border-radius: 24px;
                font-size: 15px;
                background: var(--surface);
                border: 1px solid var(--border);
                color: var(--text);
            }
            .quick-reply:active {
                background: rgba(227, 27, 35, 0.15);
                border-color: var(--accent);
                color: var(--accent);
            }
            
            /* ËæìÂÖ•Âå∫Âüü */
            .input-area {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 60px;
                padding: 8px 12px;
                padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
                background: var(--bg);
                border-top: 1px solid var(--border);
                z-index: 150;  /* üîß ÊèêÈ´òz-indexÁ°Æ‰øùÊåâÈíÆÂèØÁÇπÂáª */
            }
            
            .input-wrapper {
                position: relative;
            }
            
            #userInput {
                width: 100%;
                min-height: 44px;
                padding: 12px 90px 12px 16px;
                border-radius: 22px;
                font-size: 16px;
                background: var(--surface);
                border: 1px solid var(--border);
            }
            
            .input-actions {
                position: absolute;
                right: 6px;
                top: 50%;
                transform: translateY(-50%);
                display: flex;
                gap: 6px;
                z-index: 100;  /* üîß Á°Æ‰øùÊåâÈíÆÂú®ÊúÄ‰∏äÂ±Ç */
            }
            
            /* ËæìÂÖ•ÊåâÈíÆ - 44pxËß¶Êéß */
            .btn-upload,
            .btn-primary {
                min-width: 44px;  /* üîß Â¢ûÂä†Âà∞Apple HIGÊ†áÂáÜ44px */
                min-height: 44px;
                padding: 0;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                position: relative;
                z-index: 101;  /* üîß Á°Æ‰øùÊåâÈíÆÂèØÁÇπÂáª */
            }
        }
        
        /* ===== Â∞èÂ±èÊâãÊú∫ (<=375px) ===== */
        @media (max-width: 375px) {
            .sidebar {
                width: 100vw;
                max-width: none;
            }
            .header-title {
                font-size: 14px;
            }
            /* Â∫ïÈÉ®ÂØºËà™Âè™ÊòæÁ§∫ÂõæÊ†á */
            .toolbar-btn span:not(.icon) {
                display: none;
            }
            .toolbar-btn {
                min-width: 50px;
            }
        }
        
        /* ===== ‰∏≠Á≠âÊâãÊú∫ (376-428px) ===== */
        @media (min-width: 376px) and (max-width: 428px) {
            .header-title {
                font-size: 15px;
            }
        }
        
        /* iOSÂÆâÂÖ®Âå∫ÂüüÔºàÂàòÊµ∑Â±èÔºâ */
        @supports (padding: env(safe-area-inset-bottom)) {
            .bottom-toolbar {
                padding-bottom: calc(6px + env(safe-area-inset-bottom));
                height: calc(60px + env(safe-area-inset-bottom));
            }
            @media (max-width: 768px) {
                .input-area {
                    bottom: calc(60px + env(safe-area-inset-bottom));
                }
                .chat-container {
                    padding-bottom: calc(140px + env(safe-area-inset-bottom));
                }
            }
        }
        
        /* ÊµÅÂºèËæìÂá∫ÂÆûÊó∂È¢ÑËßà */
        .stream-preview {
            background: rgba(227, 27, 35, 0.1) !important;
            border-left: 3px solid var(--accent);
        }
        .stream-content {
            font-size: 12px;
            line-height: 1.6;
            color: #bbb;
            max-height: 300px;
            overflow-y: auto;
        }
        .typing-cursor {
            animation: blink 0.8s infinite;
            color: var(--accent);
            font-weight: bold;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- ‰æßËæπÊ†èÈÅÆÁΩ©ÔºàÊâãÊú∫Á´ØÁÇπÂáªÂÖ≥Èó≠Ôºâ -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    
    <!-- ËµÑ‰∫ßÈù¢ÊùøÈÅÆÁΩ©ÔºàÊâãÊú∫Á´ØÁÇπÂáªÂÖ≥Èó≠Ôºâ -->
    <div class="assets-overlay" id="assetsOverlay" onclick="toggleAssetsPanel()"></div>
    
    <!-- Â∑¶‰æßËæπÊ†è -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="logo.jpg" alt="FizzDragon" class="sidebar-logo">
            <div class="sidebar-tagline" id="sidebarTagline">ÂâµÈÄ†Â•ΩÊïÖ‰∫ã</div>
            
            <!-- Ê®°ÂºèTabs -->
            <div class="mode-tabs">
                <button class="mode-tab active" data-mode="drama" onclick="switchAppMode('drama')">
                    <span class="tab-icon">üé¨</span>
                    <span class="tab-text">AIÂΩ±Ë¶ñÈ†ÖÁõÆ</span>
                </button>
                <button class="mode-tab" data-mode="ad" onclick="switchAppMode('ad')">
                    <span class="tab-icon">üì∫</span>
                    <span class="tab-text">AIÂª£ÂëäÂàÜÈè°</span>
                </button>
            </div>
            
            <button class="new-chat-btn" id="newProjectBtn" onclick="startNewProject()">
                <span class="btn-icon">‚ú®</span> <span id="newBtnText">Êñ∞Âª∫ÂΩ±Ë¶ñÈ†ÖÁõÆ</span>
            </button>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-section-title" id="projectListTitle">ÊàëÁöÑÂΩ±Ë¶ñÈ†ÖÁõÆ</div>
            <div class="project-list" id="projectList">
                <!-- È°πÁõÆÂàóË°®Âä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
        
        <div class="sidebar-footer">
            <div class="beta-badge">‚ú® ËÆìÊØèÂÄã‰∫∫ÈÉΩËÉΩÂâµ‰ΩúÂΩ±Ë¶ñ</div>
        </div>
    </div>
    
    <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
    <div class="main-content">
        <div class="header">
            <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
            <div class="header-title" id="headerTitle">FizzDragon AIGCÁï™ÂäáÁ≥ªÁµ±</div>
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">ÈÄ£Êé•‰∏≠...</span>
            </div>
            <select class="lang-select" id="langSelect" onchange="changeLanguage(this.value)">
                <option value="en">English</option>
                <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
                <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
            </select>
            <div class="user-menu" id="userMenu">
                <span id="currentUsername">üë§</span>
                <button onclick="handleLogout()" title="ÁôªÂá∫" style="background:none;border:none;color:#888;cursor:pointer;padding:5px;">üö™</button>
            </div>
            <button class="menu-toggle mobile-assets-btn" onclick="toggleAssetsPanel()" style="margin-left:auto;">üì¶ <span class="mobile-only">Ë≥áÁî¢</span></button>
        </div>
        
        <div class="content-wrapper">
            <!-- ‰∏≠Èó¥ÂØπËØùÂå∫ -->
            <div class="chat-area">
                <div class="chat-container" id="chatContainer">
                    <!-- Ê∂àÊÅØ‰ºöÂä®ÊÄÅÊ∑ªÂä†Âà∞ËøôÈáå -->
                </div>
            
                <div class="input-area">
            <div class="input-row">
                <div class="input-wrapper">
                    <textarea id="userInput" placeholder="Ëº∏ÂÖ•Ê∂àÊÅØ..." rows="1"></textarea>
                    <div class="input-actions">
                        <input type="file" id="fileInput" accept=".txt,.docx,.pdf">
                        <button class="btn btn-upload" onclick="document.getElementById('fileInput').click()">üìÑ</button>
                        <button class="btn btn-primary" id="sendBtn" onclick="sendMessage()">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KimiÈ£éÊ†ºÂ∫ïÈÉ®Â∑•ÂÖ∑Ê†è (‰ªÖÁßªÂä®Á´ØÊòæÁ§∫) -->
        <div class="bottom-toolbar" id="bottomToolbar">
            <button class="toolbar-btn" onclick="toggleSidebar()" id="toolbarProjects">
                <span class="icon">üìÅ</span>
                <span>È†ÖÁõÆ</span>
            </button>
            <button class="toolbar-btn" onclick="document.getElementById('fileInput').click()">
                <span class="icon">üìÑ</span>
                <span>Â∞éÂÖ•</span>
            </button>
            <button class="toolbar-btn active" onclick="startNewProject()">
                <span class="icon">‚ú®</span>
                <span>Êñ∞Âª∫</span>
            </button>
            <button class="toolbar-btn" onclick="toggleAssetsPanel()">
                <span class="icon">üì¶</span>
                <span>Ë≥áÁî¢</span>
            </button>
            <button class="toolbar-btn" onclick="showMobileExportMenu()">
                <span class="icon">üì§</span>
                <span>Â∞éÂá∫</span>
            </button>
        </div>
            </div><!-- ÂÖ≥Èó≠ chat-area -->
            
            <!-- Âè≥‰æßÈ°πÁõÆËµÑ‰∫ßÈù¢Êùø -->
            <div class="assets-panel" id="assetsPanel">
                <div class="assets-panel-header">
                    <h3>üì¶ È†ÖÁõÆË≥áÁî¢</h3>
                    <div class="assets-header-actions">
                        <button class="assets-action-btn" onclick="exportStoryboards()" title="Â∞éÂá∫ÂàÜÈè°Ë°®Excel">üìä Â∞éÂá∫Excel</button>
                        <button class="assets-action-btn primary" onclick="importToFizzDragon()" title="Â∞éÂÖ•FizzStudioË£Ω‰Ωú">üöÄ Â∞éÂÖ•FizzStudio</button>
                    </div>
                </div>
                <div class="assets-panel-content" id="assetsPanelContent">
                    <!-- ÁîªÂ∏ÉÂºèÂä®ÊÄÅÂÜÖÂÆπ -->
                    <div class="canvas-flow" id="canvasFlow">
                        <div class="canvas-empty">
                            <div class="empty-icon">üì¶</div>
                            <div class="empty-text" data-i18n-title="emptyAssetsTitle" data-i18n-desc="emptyAssetsDesc">Â∞éÂÖ•Â∞èË™™Âæå<br>Ë≥áÁî¢ÊúÉÂú®ÈÄôË£°Â±ïÁ§∫</div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- ÂÖ≥Èó≠ content-wrapper -->
    </div><!-- ÂÖ≥Èó≠ main-content -->

    <!-- FizzDragonÂØºÂÖ•ÊµÆÂä®ÊåâÈíÆ -->
    <button class="fizzdragon-fab" onclick="importToFizzDragon()" title="Â∞éÂÖ• FizzDragon">
        üöÄ
    </button>

    <!-- Áî®Êà∑Âä©ÊâãÊµÆÂä®ÊåâÈíÆ -->
    <button class="help-fab" onclick="callHelpAgent()" title="ÈÅáÂà∞ÂïèÈ°åÔºüÈªûÊàëÊ±ÇÂä©">
        üÜò
    </button>

    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    
    <script>
// ==================== ÈÖçÁΩÆ ====================
// ÂêéÁ´ØAPIÂú∞ÂùÄ - ‰ºòÂÖà‰ΩøÁî®ÈößÈÅìÔºàGitHub PagesÈúÄË¶ÅHTTPSÔºâ
const TUNNEL_URL = 'https://fizzdragon-backend.onrender.com';
const API_ENDPOINTS = [
    '/api',  // ÂêåÊ∫êÈÉ®ÁΩ≤
    TUNNEL_URL + '/api',  // CloudflareÈößÈÅì
    'http://localhost:3001/api'  // Êú¨Âú∞ÂºÄÂèë
];
// Ëá™Âä®ÈÄâÊã©ÔºöÂ¶ÇÊûúÊòØGitHub PagesÔºå‰ΩøÁî®ÈößÈÅìÔºõÂê¶ÂàôÁî®Áõ∏ÂØπË∑ØÂæÑ
let API_BASE = window.location.hostname.includes('github.io') ? TUNNEL_URL + '/api' : '/api';

// ==================== Agent‰∫∫Ê†ºÁ≥ªÁªü ====================
const AGENT_PERSONAS = {
    concept: {
        name: 'Ê¶ÇÂøµÂàÜÊûêÂ∏´',
        avatar: 'ü¶â',  // Áå´Â§¥Èπ∞ - Êô∫ÊÖß
        personality: 'ÊÑõÊÄùËÄÉÁöÑËÄÅË≤ìÈ†≠È∑π',
        phrases: {
            start: 'ÂóöÔΩûËÆìÊàë‰ªîÁ¥∞ËÆÄËÆÄÈÄôÂÄãÊïÖ‰∫ã...',
            working: '„ÄåÊ≠£Âú®ÊâìÈñãÊïÖ‰∫ãÂàÜÊûêÂºïÊìéÔºåÊèêÂèñÊ†∏ÂøÉË°ùÁ™Å...„Äç',
            step1: '„ÄåÊàëÊ≠£Âú®Ë™øÁî®„ÄäÊïÖ‰∫ã„ÄãÊñπÊ≥ïË´ñÔºåÂàÜÊûêÈ°ûÂûãËàáÂü∫Ë™ø...„Äç',
            step2: '„ÄåËÆìÊàëÁúãÁúãÈÄôÊïÖ‰∫ãÁöÑÈùàÈ≠ÇÊòØ‰ªÄÈ∫º...„Äç',
            analyzing: '„ÄåÈÄôÂÄãÊïÖ‰∫ãÁöÑÊ∑±Â±§‰∏ªÈ°åÊòØ...„Äç',
            done: 'ÂóöÂóöÔºÅÊàëÁúãÈÄè‰∫ÜÈÄôÂÄãÊïÖ‰∫ãÁöÑÊú¨Ë≥™ÔºÅ'
        }
    },
    character: {
        name: 'ËßíËâ≤Ë®≠Ë®àÂ∏´',
        avatar: 'üê±',  // Áå´Âí™ - ÊïèÈîêËßÇÂØü
        personality: 'ÂñÑËß£‰∫∫ÂøÉÁöÑË≤ìÂí™',
        phrases: {
            start: 'ÂñµÔΩûËÆìÊàë‰æÜË™çË≠òÊØè‰∏ÄÂÄãËßíËâ≤...',
            working: '„ÄåÊ≠£Âú®Ë™øÁî®‰∫∫Áâ©ÂøÉÁêÜÂàÜÊûêÊ®°ÁµÑ...„Äç',
            step1: '„ÄåÊàëÊ≠£Âú®ËÆÄÂèñËßíËâ≤ÁöÑËÉåÊôØÊïÖ‰∫ã...„Äç',
            step2: '„ÄåÂàÜÊûê‰∫∫Áâ©ÁöÑÊ¨≤ÊúõËàáÊÅêÊáº...„Äç',
            step3: '„ÄåË®≠Ë®àËßíËâ≤ÁöÑË¶ñË¶∫ÂΩ¢Ë±°...„Äç',
            analyzing: '„ÄåÈÄôÂÄãËßíËâ≤ÁöÑÂÖßÂøÉ‰∏ñÁïåÂæàË±êÂØåÂë¢...„Äç',
            done: 'ÂñµÔºÅÊØèÂÄãËßíËâ≤ÈÉΩÊ¥ªËµ∑‰æÜ‰∫ÜÔºÅ'
        }
    },
    narrative: {
        name: 'Á´†ÁØÄË¶èÂäÉÂ∏´',
        avatar: 'ü¶ä',  // ÁãêÁã∏ - ËÅ™Êòé
        personality: 'ËÅ∞ÊòéÁöÑÂ∞èÁãêÁã∏',
        phrases: {
            start: 'ÂòøÂòøÔΩûËÆìÊàë‰æÜÂÆâÊéíÊïÖ‰∫ãÁØÄÂ•è...',
            working: '„ÄåÊ≠£Âú®Ë™øÁî®‰∏âÂπïÂäáÁµêÊßãÊ®°Âûã...„Äç',
            step1: '„ÄåÊàëÊ≠£Âú®ÂàÜÊûêÊïÖ‰∫ãÁöÑËµ∑ÊâøËΩâÂêà...„Äç',
            step2: '„ÄåË®àÁÆóÊØèÈõÜÁöÑÊÉÖÊÑüÁØÄÊãç...„Äç',
            step3: '„ÄåË®≠Ë®àÊá∏ÂøµÈâ§Â≠êÔºåËÆìËßÄÁúæÊ¨≤ÁΩ∑‰∏çËÉΩ...„Äç',
            analyzing: '„ÄåÈÄôË£°ÊáâË©≤ÊîæÂÄãËΩâÊäòÈªû...„Äç',
            done: 'ÊêûÂÆöÔºÅÊïÖ‰∫ãÁµêÊßãÂÆåÁæéÔºÅ'
        }
    },
    production_design: {
        name: 'ÊúçÂåñÈÅìË®≠Ë®àÂ∏´',
        avatar: 'üê∞',  // ÂÖîÂ≠ê - ÁªÜËá¥
        personality: 'Á¥∞ÂøÉÁöÑÂ∞èÂÖîÂ≠ê',
        phrases: {
            start: 'ËÆìÊàë‰æÜË®≠Ë®àÊØèÂÄãÁ¥∞ÁØÄÔΩû',
            working: '„ÄåÊ≠£Âú®Ë™øÁî®ÊôÇ‰ª£ËÉåÊôØË≥áÊñôÂ∫´...„Äç',
            step1: '„ÄåÁ†îÁ©∂ÈÄôÂÄãÊôÇ‰ª£ÁöÑÊúçË£ùÈ¢®Ê†º...„Äç',
            step2: '„ÄåÁÇ∫ÊØèÂÄãËßíËâ≤Ë®≠Ë®àÂ∞àÂ±¨ÈÄ†Âûã...„Äç',
            step3: '„ÄåË¶èÂäÉÂ†¥ÊôØÁöÑË¶ñË¶∫Ê∞õÂúç...„Äç',
            analyzing: '„ÄåÈÄô‰ª∂Ë°£ÊúçË¶ÅÊèõÂÄãÈ°èËâ≤ÊâçÂ∞çÂë≥...„Äç',
            done: 'ÂÆåÊàêÔºÅÊØèÂÄãÁ¥∞ÁØÄÈÉΩÁ∂ìÈÅéÁ≤æÂøÉË®≠Ë®àÔºÅ'
        }
    },
    screenwriter: {
        name: 'Á∑®Âäá',
        avatar: 'üêª',  // ÁÜä - Ê≤âÁ®≥
        personality: 'Á©©ÈáçÁöÑÂ§ßÊ£ïÁÜä',
        phrases: {
            start: 'ËÆìÊàë‰æÜÂØ´ÈÄôÂÄãÊïÖ‰∫ã...',
            working: '„ÄåÊ≠£Âú®Ë™øÁî®ÂäáÊú¨ÂØ´‰ΩúÊäÄÂ∑ßÂ∫´...„Äç',
            step1: '„ÄåÂõûÈ°ßÂâçÈù¢ÁöÑÂäáÊÉÖ‰∏ä‰∏ãÊñá...„Äç',
            step2: '„ÄåÊßãÂª∫ÈÄô‰∏ÄÈõÜÁöÑÂ†¥ÊôØÁµêÊßã...„Äç',
            step3: '„ÄåÊí∞ÂØ´Â∞çÁôΩÂíåÂãï‰ΩúÊèèËø∞...„Äç',
            analyzing: '„ÄåÈÄôÂè•Âè∞Ë©ûË¶ÅÂÜçÊâìÁ£®‰∏Ä‰∏ã...„Äç',
            done: 'ÂØ´ÂÆå‰∫ÜÔºÅÈÄôÈõÜÂæàÁ≤æÂΩ©ÔºÅ'
        }
    },
    storyboard: {
        name: 'ÂàÜÈè°Â∞éÊºî',
        avatar: 'üêï',  // ÈáëÊØõÁãó - ÁÉ≠ÊÉÖ
        personality: 'ÁÜ±ÊÉÖÁöÑÈáëÊØõÂ∞éÊºî',
        phrases: {
            start: 'Ê±™ÔºÅËÆìÊàë‰æÜÊääÂäáÊú¨ËÆäÊàêÁï´Èù¢ÔºÅ',
            working: '„ÄåÊ≠£Âú®ÊâìÈñã storyboard_complete skill...„Äç',
            step1: '„ÄåË™øÁî®Â†¥ÊôØÂàÜÊûêÂºïÊìéÔºåË≠òÂà•ËΩâÂ†¥Èªû...„Äç',
            step2: '„ÄåÂïüÂãïÊßãÂúñË®≠Ë®àÊ®°ÁµÑÔºåË®àÁÆóÈªÉÈáëÂàÜÂâ≤...„Äç',
            step3: '„ÄåÁîüÊàêÈÅãÈè°ÊñπÊ°àÔºåcrane„ÄÅdolly„ÄÅsteadicam...„Äç',
            step4: '„ÄåËº∏Âá∫ Image_Prompt Âíå Video_Prompt...„Äç',
            analyzing: '„ÄåÈÄôÂÄãÈè°È†≠Áî®‰ΩéËßíÂ∫¶ÊúÉÊõ¥ÊúâÂäõÈáèÊÑüÔºÅ„Äç',
            done: 'Ê±™Ê±™ÔºÅÂàÜÈè°ÂÆåÊàêÔºåÊØèÂÄãÈè°È†≠ÈÉΩÊòØËóùË°ìÂìÅÔºÅ'
        }
    },
    interview: {
        name: 'Ë®™Ë´áÂ∏´',
        avatar: 'ü¶ú',  // Èπ¶Èπâ - ÂñÑ‰∫é‰∫§ÊµÅ
        personality: 'ÊÑõËÅäÂ§©ÁöÑÈ∏öÈµ°',
        phrases: {
            start: 'Âó®ÔºÅËÆìÊàë‰æÜ‰∫ÜËß£‰Ω†ÁöÑÊÉ≥Ê≥ïÔΩû',
            working: '„ÄåÊ≠£Âú®Ë®≠Ë®àÊúÄËÉΩÂïüÁôºÂâµÊÑèÁöÑÂïèÈ°å...„Äç',
            step1: '„ÄåÂàÜÊûê‰Ω†ÁöÑÊïÖ‰∫ãÔºåÊâæÂá∫ÈóúÈçµÂïèÈ°å...„Äç',
            step2: '„ÄåÊ∫ñÂÇôÊ∑±Â∫¶Ë®™Ë´áÈ°åÁõÆ...„Äç',
            analyzing: '„Äå‰Ω†ÁöÑÂõûÁ≠îÁµ¶‰∫ÜÊàëÊñ∞ÈùàÊÑüÔºÅ„Äç',
            done: 'Â§™Ê£í‰∫ÜÔºÅÊàëÂ∑≤Á∂ìÂÆåÂÖ®ÁêÜËß£‰Ω†ÁöÑÂâµ‰ΩúÊÑèÂúñÔºÅ'
        }
    }
};

function getAgentPhrase(agentId, phase = 'working') {
    const persona = AGENT_PERSONAS[agentId];
    if (persona?.phrases?.[phase]) {
        return `${persona.avatar} ${persona.phrases[phase]}`;
    }
    return null;
}

// ==================== Â§öËØ≠Ë®ÄÁ≥ªÁªü ====================
let currentLang = localStorage.getItem('lang') || 'zh-TW';

const i18n = {
    'zh-TW': {
        // Âü∫Á°ÄUI
        title: 'FizzDragon AIGCÁï™ÂäáÁ≥ªÁµ±',
        connecting: 'ÈÄ£Êé•‰∏≠...',
        connected: 'ÂΩ±Ë¶ñÊ®°ÂûãÂ∑≤ÈÄ£Êé•',
        newProject: 'Êñ∞Âª∫ÂΩ±Ë¶ñÈ†ÖÁõÆ',
        myProjects: 'ÊàëÁöÑÂΩ±Ë¶ñÈ†ÖÁõÆ',
        noProjects: 'ÈÇÑÊ≤íÊúâÈ†ÖÁõÆ',
        beta: '‚ú® ËÆìÊØèÂÄã‰∫∫ÈÉΩËÉΩÂâµ‰ΩúÂΩ±Ë¶ñ',
        tagline: 'ÂâµÈÄ†Â•ΩÊïÖ‰∫ã',
        
        // ËµÑ‰∫ßÈù¢Êùø
        projectAssets: 'üì¶ È†ÖÁõÆË≥áÁî¢',
        concept: 'üí° È´òÊ¶ÇÂøµ',
        characters: 'üë§ ËßíËâ≤',
        chapters: 'üìù Á´†ÁØÄ',
        production: 'üëó ÊúçÂåñÈÅì',
        scripts: '‚úçÔ∏è ÂäáÊú¨',
        storyboards: 'üé¨ ÂàÜÈè°CSV',
        exportJson: 'üì• Â∞éÂá∫JSON',
        exportCsv: 'üìä Â∞éÂá∫CSV',
        notGenerated: 'Êú™ÁîüÊàê',
        
        // ËæìÂÖ•ÂíåÊåâÈíÆ
        inputPlaceholder: 'Ëº∏ÂÖ•Ê∂àÊÅØ...',
        importNovel: 'üìÑ Â∞éÂÖ•Â∞èË™™',
        aiWrite: '‚úçÔ∏è AIÂπ´ÊàëÂØ´',
        deepInterview: 'üé§ Ê∑±Â∫¶Ë®™Ë´áÔºàÊõ¥Á≤æÊ∫ñÔºâ',
        directAnalysis: '‚ö° Áõ¥Êé•ÂàÜÊûêÔºàÊõ¥Âø´ÈÄüÔºâ',
        confirm: '‚úÖ Á¢∫Ë™ç‰øùÂ≠ò',
        regenerate: 'üîÑ ÈáçÊñ∞ÁîüÊàê',
        skip: '‚è≠Ô∏è Ë∑≥ÈÅé',
        skipAll: '‚è≠Ô∏è Ë∑≥ÈÅéÊâÄÊúâË®™Ë´á',
        continue: 'ÁπºÁ∫å',
        help: 'Âπ´Âä©',
        
        // Ê¨¢ËøéÊ∂àÊÅØ
        welcome: '‚ú® **Ê≠°Ëøé‰æÜÂà∞ FizzDragon AIGCÁï™ÂäáÁ≥ªÁµ±**',
        welcomeDesc: 'ÊàëÊòØ‰Ω†ÁöÑAIÂâµ‰ΩúÂ§•‰º¥ÔºåËÉΩÂπ´‰Ω†ÊääÂ∞èË™™/ÊïÖ‰∫ãËΩâÂåñÁÇ∫Â∞àÊ•≠ÂàÜÈè°Ë°®„ÄÇ',
        chooseStart: 'Ë´ãÈÅ∏ÊìáÈñãÂßãÊñπÂºèÔºö',
        
        // ÊµÅÁ®ãÊèêÁ§∫
        conceptDone: 'üìñ **È´òÊ¶ÇÂøµÂàÜÊûêÂÆåÊàêÔºÅ**',
        charactersDone: 'üë§ **ËßíËâ≤ÂàÜÊûêÂÆåÊàêÔºÅ**',
        chaptersDone: 'üìù **Á´†ÁØÄË¶èÂäÉÂÆåÊàêÔºÅ**',
        productionDone: 'üëó **ÊúçÂåñÈÅìË®≠Ë®àÂÆåÊàêÔºÅ**',
        scriptDone: '‚úçÔ∏è **ÂäáÊú¨ÂÆåÊàêÔºÅ**',
        storyboardDone: 'üé¨ **ÂàÜÈè°ÂÆåÊàêÔºÅ**',
        
        // Áä∂ÊÄÅ
        analyzing: 'Ê≠£Âú®ÂàÜÊûê...',
        generating: 'Ê≠£Âú®ÁîüÊàê...',
        saving: 'Ê≠£Âú®‰øùÂ≠ò...',
        saved: 'üíæ Â∑≤‰øùÂ≠ò',
        
        // È°πÁõÆ
        episodes: 'ÈõÜ',
        scriptsCount: 'ÂäáÊú¨',
        storyboardsCount: 'ÂàÜÈè°',
        unnamed: 'Êú™ÂëΩÂêç',
        stepNotStarted: 'ÂæÖÈñãÂßã',
        stepConcept: 'Ê¶ÇÂøµ',
        stepCharacter: 'ËßíËâ≤',
        stepChapter: 'Á´†ÁØÄ',
        stepProduction: 'ÊúçÂåñÈÅì',
        stepScript: 'ÂäáÊú¨',
        stepStoryboard: 'ÂàÜÈè°',
        rename: 'ÈáçÂëΩÂêç',
        delete: 'Âà™Èô§',
        
        // ÈîôËØØ
        errorRetry: 'ÈáçË©¶',
        errorSkip: 'Ë∑≥ÈÅé',
        noContent: 'ÈÇÑÊ≤íÊúâÂ∞éÂÖ•Â∞èË™™ÂÖßÂÆπ',
        
        // ÂØºÂá∫
        exportToFizzDragon: 'üöÄ Â∞éÂÖ• FizzDragon',
        emptyAssetsTitle: 'Â∞éÂÖ•Â∞èË™™Âæå',
        emptyAssetsDesc: 'Ë≥áÁî¢ÊúÉÂú®ÈÄôË£°Â±ïÁ§∫',
        // Âàõ‰ΩúÊ®°Âºè
        writeMode: '‚úçÔ∏è **Ââµ‰ΩúÊ®°Âºè**',
        writeModeDesc: 'ËÆìÊàëÂÄë‰∏ÄËµ∑Ââµ‰Ωú‰Ω†ÁöÑÊïÖ‰∫ãÔºÅ',
        writeModePrompt: `È¶ñÂÖàÔºåÁ∞°ÂñÆÊèèËø∞‰Ω†ÁöÑ**ÊïÖ‰∫ãÈùàÊÑü**Ôºö
- ÂèØ‰ª•ÊòØ‰∏ÄÂè•Ë©±Ê¶ÇÂøµ
- ÂèØ‰ª•ÊòØ‰∏ÄÂÄãÂ†¥ÊôØ
- ÂèØ‰ª•ÊòØ‰∏ÄÂÄãËßíËâ≤

ÊØîÂ¶ÇÔºö„Äå‰∏ÄÂÄãÈ¶ôÊ∏ØÁ¥ÖVanÂè∏Ê©üÔºåÂáåÊô®ËºâÂÆ¢ÊôÇÈÅáÂà∞Â•áÊÄ™ÁöÑ‰πòÂÆ¢„Äç`,
        randomGenerate: 'üé≤ Âπ´ÊàëÈö®Ê©üÁîüÊàê',
        seeExamples: 'üìö ÁúãÁØÑ‰æã',
        storyExamples: 'üìö **ÊïÖ‰∫ãÁØÑ‰æã**',
        supernatural: 'ÈùàÁï∞È°û üîÆ',
        romance: 'ÊÑõÊÉÖÈ°û üíï',
        mystery: 'Êá∏ÁñëÈ°û üîç',
        fantasy: 'Â•áÂπªÈ°û ‚ú®',
        supernaturalEx: '„ÄåÊ∑±Â§úÈ£üÂ†ÇÁöÑËÄÅÈóÜ‰∏ÉÂèîÔºåÂ∞àÈñÄÊãõÂæÖÈÇ£‰∫õ...Â∑≤Á∂ì‰∏çÂú®‰∫∫‰∏ñÁöÑÂÆ¢‰∫∫„Äç',
        romanceEx: '„ÄåÂ•πÊØèÂ§©Êê≠Âêå‰∏ÄÁè≠Ê∏ØÈêµÔºåÊöóÊàÄËªäÂªÇË£°ÁúãÊõ∏ÁöÑÁî∑ÁîüÔºåÁõ¥Âà∞Êúâ‰∏ÄÂ§©ÁôºÁèæ‰ªñÁúãÁöÑÊòØÂ•πÂØ´ÁöÑÂ∞èË™™„Äç',
        mysteryEx: '„ÄåÂª∫ÁØâÂ∏´ÁôºÁèæËá™Â∑±Ë®≠Ë®àÁöÑÂ§ßÊ®ìË£°ÔºåÊúâ‰∏ÄÂ±§‰∏çÂ≠òÂú®ÊñºÂúñÁ¥ô‰∏äÁöÑÊ®ìÂ±§„Äç',
        fantasyEx: '„ÄåÈ¶ôÊ∏ØÊúÄÂæå‰∏ÄÂÄãÈ¢®Ê∞¥Â∏´ÁöÑÂ≠´Â•≥ÔºåÊÑèÂ§ñÁπºÊâø‰∫ÜËÉΩÁúãË¶ãÂüéÂ∏ÇÈæçËÑàÁöÑËÉΩÂäõ„Äç',
        pickOrInput: 'ÈÅ∏‰∏ÄÂÄãÈñãÂßãÔºåÊàñËº∏ÂÖ•‰Ω†Ëá™Â∑±ÁöÑÊÉ≥Ê≥ïÔºö',
        randomIdea: 'üé≤ **Èö®Ê©üÈùàÊÑü**',
        likeThis: 'üëç Â∞±ÈÄôÂÄãÔºÅ',
        tryAnother: 'üé≤ Êèõ‰∏ÄÂÄã',
        editIt: '‚úèÔ∏è Êàë‰æÜÊîπ'
    },
    'zh-CN': {
        title: 'FizzDragon AIGCÁï™ÂâßÁ≥ªÁªü',
        connecting: 'ËøûÊé•‰∏≠...',
        connected: 'ÂΩ±ËßÜÊ®°ÂûãÂ∑≤ËøûÊé•',
        newProject: '+ Êñ∞Âª∫È°πÁõÆ',
        myProjects: 'ÊàëÁöÑÈ°πÁõÆ',
        noProjects: 'ËøòÊ≤°ÊúâÈ°πÁõÆ',
        beta: '‚ú® ËÆ©ÊØè‰∏™‰∫∫ÈÉΩËÉΩÂàõ‰ΩúÂΩ±ËßÜ',
        projectAssets: 'üì¶ È°πÁõÆËµÑ‰∫ß',
        concept: 'üí° È´òÊ¶ÇÂøµ',
        characters: 'üë§ ËßíËâ≤',
        chapters: 'üìù Á´†ËäÇ',
        production: 'üëó ÊúçÂåñÈÅì',
        scripts: '‚úçÔ∏è ÂâßÊú¨',
        storyboards: 'üé¨ ÂàÜÈïúCSV',
        exportJson: 'üì• ÂØºÂá∫JSON',
        exportCsv: 'üìä ÂØºÂá∫CSV',
        notGenerated: 'Êú™ÁîüÊàê',
        inputPlaceholder: 'ËæìÂÖ•Ê∂àÊÅØ...',
        importNovel: 'üìÑ ÂØºÂÖ•Â∞èËØ¥',
        aiWrite: '‚úçÔ∏è AIÂ∏ÆÊàëÂÜô',
        deepInterview: 'üé§ Ê∑±Â∫¶ËÆøË∞àÔºàÊõ¥Á≤æÂáÜÔºâ',
        directAnalysis: '‚ö° Áõ¥Êé•ÂàÜÊûêÔºàÊõ¥Âø´ÈÄüÔºâ',
        confirm: '‚úÖ Á°ÆËÆ§‰øùÂ≠ò',
        regenerate: 'üîÑ ÈáçÊñ∞ÁîüÊàê',
        skip: '‚è≠Ô∏è Ë∑≥Ëøá',
        skipAll: '‚è≠Ô∏è Ë∑≥ËøáÊâÄÊúâËÆøË∞à',
        continue: 'ÁªßÁª≠',
        help: 'Â∏ÆÂä©',
        welcome: '‚ú® **Ê¨¢ËøéÊù•Âà∞ FizzDragon AIGCÁï™ÂâßÁ≥ªÁªü**',
        welcomeDesc: 'ÊàëÊòØ‰Ω†ÁöÑAIÂàõ‰Ωú‰ºô‰º¥ÔºåËÉΩÂ∏Æ‰Ω†ÊääÂ∞èËØ¥/ÊïÖ‰∫ãËΩ¨Âåñ‰∏∫‰∏ì‰∏öÂàÜÈïúË°®„ÄÇ',
        chooseStart: 'ËØ∑ÈÄâÊã©ÂºÄÂßãÊñπÂºèÔºö',
        conceptDone: 'üìñ **È´òÊ¶ÇÂøµÂàÜÊûêÂÆåÊàêÔºÅ**',
        charactersDone: 'üë§ **ËßíËâ≤ÂàÜÊûêÂÆåÊàêÔºÅ**',
        chaptersDone: 'üìù **Á´†ËäÇËßÑÂàíÂÆåÊàêÔºÅ**',
        productionDone: 'üëó **ÊúçÂåñÈÅìËÆæËÆ°ÂÆåÊàêÔºÅ**',
        scriptDone: '‚úçÔ∏è **ÂâßÊú¨ÂÆåÊàêÔºÅ**',
        storyboardDone: 'üé¨ **ÂàÜÈïúÂÆåÊàêÔºÅ**',
        analyzing: 'Ê≠£Âú®ÂàÜÊûê...',
        generating: 'Ê≠£Âú®ÁîüÊàê...',
        saving: 'Ê≠£Âú®‰øùÂ≠ò...',
        saved: 'üíæ Â∑≤‰øùÂ≠ò',
        episodes: 'ÈõÜ',
        scriptsCount: 'ÂâßÊú¨',
        storyboardsCount: 'ÂàÜÈïú',
        unnamed: 'Êú™ÂëΩÂêç',
        stepNotStarted: 'ÂæÖÂºÄÂßã',
        stepConcept: 'Ê¶ÇÂøµ',
        stepCharacter: 'ËßíËâ≤',
        stepChapter: 'Á´†ËäÇ',
        stepProduction: 'ÊúçÂåñÈÅì',
        stepScript: 'ÂâßÊú¨',
        stepStoryboard: 'ÂàÜÈïú',
        rename: 'ÈáçÂëΩÂêç',
        delete: 'Âà†Èô§',
        errorRetry: 'ÈáçËØï',
        errorSkip: 'Ë∑≥Ëøá',
        noContent: 'ËøòÊ≤°ÊúâÂØºÂÖ•Â∞èËØ¥ÂÜÖÂÆπ',
        exportToFizzDragon: 'üöÄ ÂØºÂÖ• FizzDragon',
        emptyAssetsTitle: 'ÂØºÂÖ•Â∞èËØ¥Âêé',
        emptyAssetsDesc: 'ËµÑ‰∫ß‰ºöÂú®ËøôÈáåÂ±ïÁ§∫',
        // Âàõ‰ΩúÊ®°Âºè
        writeMode: '‚úçÔ∏è **Âàõ‰ΩúÊ®°Âºè**',
        writeModeDesc: 'ËÆ©Êàë‰ª¨‰∏ÄËµ∑Âàõ‰Ωú‰Ω†ÁöÑÊïÖ‰∫ãÔºÅ',
        writeModePrompt: `È¶ñÂÖàÔºåÁÆÄÂçïÊèèËø∞‰Ω†ÁöÑ**ÊïÖ‰∫ãÁÅµÊÑü**Ôºö
- ÂèØ‰ª•ÊòØ‰∏ÄÂè•ËØùÊ¶ÇÂøµ
- ÂèØ‰ª•ÊòØ‰∏Ä‰∏™Âú∫ÊôØ
- ÂèØ‰ª•ÊòØ‰∏Ä‰∏™ËßíËâ≤

ÊØîÂ¶ÇÔºö„Äå‰∏Ä‰∏™È¶ôÊ∏ØÁ∫¢VanÂè∏Êú∫ÔºåÂáåÊô®ËΩΩÂÆ¢Êó∂ÈÅáÂà∞Â•áÊÄ™ÁöÑ‰πòÂÆ¢„Äç`,
        randomGenerate: 'üé≤ Â∏ÆÊàëÈöèÊú∫ÁîüÊàê',
        seeExamples: 'üìö ÁúãËåÉ‰æã',
        storyExamples: 'üìö **ÊïÖ‰∫ãËåÉ‰æã**',
        supernatural: 'ÁÅµÂºÇÁ±ª üîÆ',
        romance: 'Áà±ÊÉÖÁ±ª üíï',
        mystery: 'ÊÇ¨ÁñëÁ±ª üîç',
        fantasy: 'Â•áÂπªÁ±ª ‚ú®',
        supernaturalEx: '„ÄåÊ∑±Â§úÈ£üÂ†ÇÁöÑËÄÅÊùø‰∏ÉÂèîÔºå‰∏ìÈó®ÊãõÂæÖÈÇ£‰∫õ...Â∑≤Áªè‰∏çÂú®‰∫∫‰∏ñÁöÑÂÆ¢‰∫∫„Äç',
        romanceEx: '„ÄåÂ•πÊØèÂ§©Êê≠Âêå‰∏ÄÁè≠Ê∏ØÈìÅÔºåÊöóÊÅãËΩ¶Âé¢ÈáåÁúã‰π¶ÁöÑÁî∑ÁîüÔºåÁõ¥Âà∞Êúâ‰∏ÄÂ§©ÂèëÁé∞‰ªñÁúãÁöÑÊòØÂ•πÂÜôÁöÑÂ∞èËØ¥„Äç',
        mysteryEx: '„ÄåÂª∫Á≠ëÂ∏àÂèëÁé∞Ëá™Â∑±ËÆæËÆ°ÁöÑÂ§ßÊ•ºÈáåÔºåÊúâ‰∏ÄÂ±Ç‰∏çÂ≠òÂú®‰∫éÂõæÁ∫∏‰∏äÁöÑÊ•ºÂ±Ç„Äç',
        fantasyEx: '„ÄåÈ¶ôÊ∏ØÊúÄÂêé‰∏Ä‰∏™È£éÊ∞¥Â∏àÁöÑÂ≠ôÂ•≥ÔºåÊÑèÂ§ñÁªßÊâø‰∫ÜËÉΩÁúãËßÅÂüéÂ∏ÇÈæôËÑâÁöÑËÉΩÂäõ„Äç',
        pickOrInput: 'ÈÄâ‰∏Ä‰∏™ÂºÄÂßãÔºåÊàñËæìÂÖ•‰Ω†Ëá™Â∑±ÁöÑÊÉ≥Ê≥ïÔºö',
        randomIdea: 'üé≤ **ÈöèÊú∫ÁÅµÊÑü**',
        likeThis: 'üëç Â∞±Ëøô‰∏™ÔºÅ',
        tryAnother: 'üé≤ Êç¢‰∏Ä‰∏™',
        editIt: '‚úèÔ∏è ÊàëÊù•Êîπ'
    },
    'en': {
        title: 'FizzDragon AIGC Drama Studio',
        connecting: 'Connecting...',
        connected: 'AI Model Connected',
        newProject: 'New Project',
        myProjects: 'My Projects',
        noProjects: 'No projects yet',
        beta: '‚ú® Empowering Everyone to Create',
        tagline: 'Create Good Stories',
        projectAssets: 'üì¶ Project Assets',
        concept: 'üí° Concept',
        characters: 'üë§ Characters',
        chapters: 'üìù Chapters',
        production: 'üëó Production Design',
        scripts: '‚úçÔ∏è Scripts',
        storyboards: 'üé¨ Storyboard CSV',
        exportJson: 'üì• Export JSON',
        exportCsv: 'üìä Export CSV',
        notGenerated: 'Not generated',
        inputPlaceholder: 'Type a message...',
        importNovel: 'üìÑ Import Novel',
        aiWrite: '‚úçÔ∏è AI Write for Me',
        deepInterview: 'üé§ Deep Interview (More Precise)',
        directAnalysis: '‚ö° Direct Analysis (Faster)',
        confirm: '‚úÖ Confirm',
        regenerate: 'üîÑ Regenerate',
        skip: '‚è≠Ô∏è Skip',
        skipAll: '‚è≠Ô∏è Skip All Questions',
        continue: 'Continue',
        help: 'Help',
        welcome: '‚ú® **Welcome to FizzDragon AIGC Drama Studio**',
        welcomeDesc: "I'm your AI creative partner, helping you transform novels/stories into professional storyboards.",
        chooseStart: 'Choose how to start:',
        conceptDone: 'üìñ **Concept Analysis Complete!**',
        charactersDone: 'üë§ **Character Analysis Complete!**',
        chaptersDone: 'üìù **Chapter Planning Complete!**',
        productionDone: 'üëó **Production Design Complete!**',
        scriptDone: '‚úçÔ∏è **Script Complete!**',
        storyboardDone: 'üé¨ **Storyboard Complete!**',
        analyzing: 'Analyzing...',
        generating: 'Generating...',
        saving: 'Saving...',
        saved: 'üíæ Saved',
        episodes: 'episodes',
        scriptsCount: 'scripts',
        storyboardsCount: 'storyboards',
        unnamed: 'Untitled',
        stepNotStarted: 'Not Started',
        stepConcept: 'Concept',
        stepCharacter: 'Character',
        stepChapter: 'Chapter',
        stepProduction: 'Production',
        stepScript: 'Script',
        stepStoryboard: 'Storyboard',
        rename: 'Rename',
        delete: 'Delete',
        errorRetry: 'Retry',
        errorSkip: 'Skip',
        noContent: 'No novel content imported yet',
        exportToFizzDragon: 'üöÄ Import to FizzDragon',
        emptyAssetsTitle: 'Import a novel',
        emptyAssetsDesc: 'Assets will be displayed here',
        // Âàõ‰ΩúÊ®°Âºè
        writeMode: '‚úçÔ∏è **Creative Mode**',
        writeModeDesc: "Let's create your story together!",
        writeModePrompt: `First, describe your **story idea**:
- A one-line concept
- A scene
- A character

For example: "A Hong Kong minibus driver picks up strange passengers at midnight"`,
        randomGenerate: 'üé≤ Random Generate',
        seeExamples: 'üìö See Examples',
        storyExamples: 'üìö **Story Examples**',
        supernatural: 'Supernatural üîÆ',
        romance: 'Romance üíï',
        mystery: 'Mystery üîç',
        fantasy: 'Fantasy ‚ú®',
        supernaturalEx: '"Uncle Seven runs a late-night diner that serves customers who are... no longer alive"',
        romanceEx: '"She takes the same MTR train every day, secretly admiring the guy reading a book, until she discovers he\'s reading her novel"',
        mysteryEx: '"An architect discovers a floor in his building that doesn\'t exist in the blueprints"',
        fantasyEx: '"The granddaughter of Hong Kong\'s last feng shui master inherits the ability to see the city\'s dragon veins"',
        pickOrInput: 'Pick one to start, or type your own idea:',
        randomIdea: 'üé≤ **Random Idea**',
        likeThis: 'üëç Use this!',
        tryAnother: 'üé≤ Try another',
        editIt: '‚úèÔ∏è Let me edit'
    }
};

function t(key) {
    return i18n[currentLang]?.[key] || i18n['zh-TW'][key] || key;
}

function changeLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('lang', lang);
    applyLanguage();
}

function applyLanguage() {
    // Êõ¥Êñ∞ÈùôÊÄÅUIÂÖÉÁ¥†
    document.getElementById('headerTitle').textContent = t('title');
    document.getElementById('statusText').textContent = t('connected');
    document.getElementById('userInput').placeholder = t('inputPlaceholder');
    
    // Êõ¥Êñ∞‰æßËæπÊ†èÔºàÂè™Êõ¥Êñ∞ÊñáÂ≠óÈÉ®ÂàÜÔºå‰øùÁïôÂõæÊ†áÔºâ
    const newBtnText = document.getElementById('newBtnText');
    if (newBtnText) newBtnText.textContent = t('newProject');
    
    const projectListTitle = document.getElementById('projectListTitle');
    if (projectListTitle) projectListTitle.textContent = t('myProjects');
    
    const sidebarTagline = document.getElementById('sidebarTagline');
    if (sidebarTagline) sidebarTagline.textContent = t('tagline') || 'ÂâµÈÄ†Â•ΩÊïÖ‰∫ã';
    
    const betaBadge = document.querySelector('.beta-badge');
    if (betaBadge) betaBadge.textContent = t('beta');
    
    // Êõ¥Êñ∞ËµÑ‰∫ßÈù¢ÊùøÊ†áÈ¢òÔºàÈ°∫Â∫èÔºöÈ´òÊ¶ÇÂøµ|Á´†ËäÇ, ËßíËâ≤|ÊúçÂåñÈÅì, ÂâßÊú¨|ÂàÜÈïúÔºâ
    const assetsTitles = document.querySelectorAll('.asset-section-title');
    const titleKeys = ['concept', 'chapters', 'characters', 'production', 'scripts', 'storyboards'];
    assetsTitles.forEach((el, i) => {
        if (titleKeys[i]) el.textContent = t(titleKeys[i]);
    });
    
    // Êõ¥Êñ∞ËµÑ‰∫ßÈù¢ÊùøÊ†áÈ¢ò
    const assetsPanelHeader = document.querySelector('.assets-panel-header h3');
    if (assetsPanelHeader) assetsPanelHeader.textContent = t('projectAssets');
    
    // Êõ¥Êñ∞ÂØºÂá∫ÊåâÈíÆ
    const exportBtns = document.querySelectorAll('.asset-row .new-chat-btn');
    if (exportBtns[0]) exportBtns[0].textContent = t('exportJson');
    if (exportBtns[1]) exportBtns[1].textContent = t('exportCsv');
    
    // Êõ¥Êñ∞Êú™ÁîüÊàêÊñáÊú¨
    document.querySelectorAll('.asset-section-content').forEach(el => {
        if (el.textContent.trim() === 'Êú™ÁîüÊàê' || el.textContent.trim() === 'Not generated' || el.textContent.trim() === 'Êú™ÁîüÊàê') {
            el.textContent = t('notGenerated');
        }
    });
    
    // Êõ¥Êñ∞Á©∫ËµÑ‰∫ßÊèêÁ§∫
    const emptyText = document.querySelector('.empty-text');
    if (emptyText) {
        emptyText.innerHTML = `${t('emptyAssetsTitle')}<br>${t('emptyAssetsDesc')}`;
    }
    
    // Êõ¥Êñ∞ËØ≠Ë®ÄÈÄâÊã©Âô®
    document.getElementById('langSelect').value = currentLang;
    
    // ËØ≠Ë®ÄÂàáÊç¢Êó∂Âà∑Êñ∞Ê¨¢ËøéÊ∂àÊÅØÔºà‰ªÖÂú®ÊâãÂä®ÂàáÊç¢ËØ≠Ë®ÄÊó∂Ôºâ
    // ÂàùÂßãÂä†ËΩΩÁî± init() Â§ÑÁêÜÔºå‰∏çÂú®ËøôÈáåË∞ÉÁî®
}

// Â§öËØ≠Ë®ÄÊ¨¢ËøéÊ∂àÊÅØ
function showWelcome() {
    const projects = getProjects();
    const projectCount = Object.keys(projects).length;
    
    const welcomeTexts = {
        'en': `‚ú® **Welcome to FizzDragon AIGC Drama Studio**

We've studied **hundreds of master works**, including:
‚Ä¢ Robert McKee "Story" - Value Transformation Theory
‚Ä¢ Joseph Campbell "The Hero with a Thousand Faces"
‚Ä¢ Blake Snyder "Save the Cat" - 15 Beat Sheet
‚Ä¢ Christopher Vogler "The Writer's Journey"
‚Ä¢ Syd Field "Screenplay" - Three-Act Structure
‚Ä¢ Steven D. Katz "Shot by Shot" - Storyboarding

**Empowering every creator to work with the masters.**

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Choose how to start:
${projectCount > 0 ? `üìÇ You have **${projectCount}** saved project(s)\n` : ''}`,
        'zh-CN': `‚ú® **Ê¨¢ËøéÊù•Âà∞ FizzDragon AIGCÁï™ÂâßÁ≥ªÁªü**

Êàë‰ª¨Â≠¶‰π†‰∫Ü**‰∏äÁôæÊú¨Â§ßÂ∏àËëó‰Ωú**ÔºåÂåÖÊã¨Ôºö
‚Ä¢ Robert McKee„ÄäÊïÖ‰∫ã„Äã- ‰ª∑ÂÄºËΩ¨Êç¢ÁêÜËÆ∫
‚Ä¢ Joseph Campbell„ÄäÂçÉÈù¢Ëã±ÈõÑ„Äã- Ëã±ÈõÑÊóÖÁ®ãÂéüÂûã
‚Ä¢ Blake Snyder„ÄäSave the Cat„Äã- 15ËäÇÊãçË°®
‚Ä¢ Christopher Vogler„Ää‰ΩúÂÆ∂‰πãË∑Ø„Äã- 12Èò∂ÊÆµÁªìÊûÑ
‚Ä¢ Syd Field„ÄäScreenplay„Äã- ‰∏âÂπïÂâßÂú£Áªè
‚Ä¢ Steven D. Katz„ÄäShot by Shot„Äã- ÂàÜÈïúÂØºÊºîÂ≠¶

**ËÆ©ÊØè‰∏Ä‰∏™Âàõ‰ΩúËÄÖÊúâÊú∫‰ºöÂíåÁúüÊ≠£ÁöÑÂ§ßÂ∏àÂÖ±ÂêåÂàõ‰Ωú„ÄÇ**

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ÈÄâÊã©ÂºÄÂßãÊñπÂºèÔºö
${projectCount > 0 ? `üìÇ ‰Ω†Êúâ **${projectCount}** ‰∏™Â∑≤‰øùÂ≠òÁöÑÈ°πÁõÆ\n` : ''}`,
        'zh-TW': `‚ú® **Ê≠°Ëøé‰æÜÂà∞ FizzDragon AIGCÁï™ÂäáÁ≥ªÁµ±**

ÊàëÂÄëÂ≠∏Áøí‰∫Ü**‰∏äÁôæÊú¨Â§ßÂ∏´Ëëó‰Ωú**ÔºåÂåÖÊã¨Ôºö
‚Ä¢ Robert McKee„ÄäÊïÖ‰∫ã„Äã- ÂÉπÂÄºËΩâÊèõÁêÜË´ñ
‚Ä¢ Joseph Campbell„ÄäÂçÉÈù¢Ëã±ÈõÑ„Äã- Ëã±ÈõÑÊóÖÁ®ãÂéüÂûã
‚Ä¢ Blake Snyder„ÄäSave the Cat„Äã- 15ÁØÄÊãçË°®
‚Ä¢ Christopher Vogler„Ää‰ΩúÂÆ∂‰πãË∑Ø„Äã- 12ÈöéÊÆµÁµêÊßã
‚Ä¢ Syd Field„ÄäScreenplay„Äã- ‰∏âÂπïÂäáËÅñÁ∂ì
‚Ä¢ Steven D. Katz„ÄäShot by Shot„Äã- ÂàÜÈè°Â∞éÊºîÂ≠∏

**ËÆìÊØè‰∏ÄÂÄãÂâµ‰ΩúËÄÖÊúâÊ©üÊúÉÂíåÁúüÊ≠£ÁöÑÂ§ßÂ∏´ÂÖ±ÂêåÂâµ‰Ωú„ÄÇ**

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ÈÅ∏ÊìáÈñãÂßãÊñπÂºèÔºö
${projectCount > 0 ? `üìÇ ‰Ω†Êúâ **${projectCount}** ÂÄãÂ∑≤‰øùÂ≠òÁöÑÈ†ÖÁõÆ\n` : ''}`
    };
    
    addAIMessage(welcomeTexts[currentLang] || welcomeTexts['zh-TW'], [
        { text: t('importNovel'), action: () => document.getElementById('fileInput').click() },
        { text: t('aiWrite'), action: () => startWriteMode() }
    ]);
}

// È°µÈù¢Âä†ËΩΩÊó∂Â∫îÁî®ËØ≠Ë®Ä
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('langSelect').value = currentLang;
    applyLanguage();
});

// ==================== Áä∂ÊÄÅ ====================
// ==================== È°πÁõÆËµÑ‰∫ßÁªìÊûÑ ====================
const state = {
    novel: null,
    novelTitle: '',
    mode: null,  // 'import' | 'write'
    step: 0,     // 0=Á≠âÂæÖ, 1=È´òÊ¶ÇÂøµ, 2=ËßíËâ≤, 3=Á´†ËäÇËßÑÂàí, 4=ÊúçÂåñÈÅì, 5=ÂâßÊú¨, 6=ÂàÜÈïú
    
    // È°πÁõÆËµÑ‰∫ß (Project Assets)
    assets: {
        // 1. È´òÊ¶ÇÂøµ
        concept: null,           // {genre, theme, tone, logline, episodeSummaries[]}
        
        // 2. ËßíËâ≤
        characters: [],          // [{name, role, bio, appearance, prompt}]
        
        // 3. Á´†ËäÇËßÑÂàí
        chapters: [],            // [{number, title, duration, summary}]
        
        // 4. ÊúçÂåñÈÅì (Production Design)
        costumes: [],            // [{character, scene, outfit, props, prompt}]
        sets: [],                // [{name, description, prompt}]
        props: [],               // [{name, description, prompt}]
        
        // 5. ÂâßÊú¨ (ÂàÜÁ´†Â≠òÂÇ®)
        scripts: {},             // {1: "Á¨¨1Á´†ÂâßÊú¨", 2: "Á¨¨2Á´†ÂâßÊú¨", ...}
        
        // 6. ÂàÜÈïú (ÂàÜÁ´†Â≠òÂÇ®)
        storyboards: {}          // {1: [{shot_id, scene, lighting, camera, acting, action, image_prompt, video_prompt}], ...}
    },
    
    // Âà∂‰ΩúËÆæÁΩÆ
    production: {
        episodes: 10,
        durationMin: 3,
        shotsPerMin: 15,
        totalShots: 450
    },
    
    // ËÆøË∞àÁä∂ÊÄÅ
    interview: {},
    interviewQuestions: [],
    currentQuestion: 0,
    
    // ÂΩìÂâçÁºñËæë
    currentChapter: 0            // ÂΩìÂâçÊ≠£Âú®ÂÜô/ÁîüÊàêÁöÑÁ´†ËäÇ
};

// ÂÜô‰ΩúÁä∂ÊÄÅ
const writeState = {
    idea: null,
    interview: {},
    outline: null,
    chapters: [],
    currentChapter: 0,
    currentQuestion: null,  // null=Êú™ÂºÄÂßã, -1=Á≠âÂæÖËæìÂÖ•ÊïÖ‰∫ãÁÅµÊÑü, 0+=ËÆøË∞àÈóÆÈ¢òÁºñÂè∑
    storyboard: null
};

// ==================== Â∫îÁî®Ê®°Âºè ====================
let appMode = 'drama';  // 'drama' | 'ad'

// ÂπøÂëäÂàÜÈïúÁä∂ÊÄÅ
const adState = {
    step: 0,           // 0=Á≠âÂæÖ, 1=‰ø°ÊÅØÊî∂ÈõÜ, 2=Á≠ñÁï•ÂàÜÊûê, 3=ÂàÜÈïúËÆæËÆ°, 4=ÊâßË°åÁîüÊàê, 5=‰øÆÊîπÂØºÂá∫
    productImage: null,       // Base64 Êàñ URL
    actorImages: [],          // ÊºîÂëòÂõæÁâá
    requirement: '',          // ‰∏ÄÂè•ËØùÈúÄÊ±Ç
    duration: 30,             // 15/30/60Áßí
    style: '',                // È£éÊ†º
    
    // È°πÁõÆËµÑ‰∫ß
    assets: {
        userProfile: null,    // Áî®Êà∑ÁîªÂÉèJSON
        creativeBrief: null,  // ÂàõÊÑèÁÆÄÊä•
        storyboard: [],       // ÂàÜÈïúËÑöÊú¨ [{shot_id, scene_type, angle, camera_move, description, product_show, actor, props, color_lighting, copy, duration}]
        previews: [],         // È¢ÑËßàÂõæ
        video: null           // È¢ÑËßàËßÜÈ¢ë
    }
};

// ÂπøÂëäAgent‰∫∫Ê†º
const AD_AGENT_PERSONAS = {
    ad_director: {
        name: 'Âª£ÂëäÂ∞éÊºî',
        avatar: 'üé¨',
        personality: 'Á∂ìÈ©óË±êÂØåÁöÑÂâµÊÑèÁ∏ΩÁõ£',
        phrases: {
            start: 'Âó®ÔºÅÊàëÊòØ‰Ω†ÁöÑÂª£ÂëäÂ∞éÊºîÔºåËÆìÊàëÂÄë‰æÜÊâìÈÄ†‰∏ÄÊîØÁ≤æÂΩ©ÁöÑÂª£ÂëäÔºÅ',
            working: '„ÄåÊ≠£Âú®ÂàÜÊûê‰Ω†ÁöÑÈúÄÊ±Ç...„Äç',
            step1: '„ÄåÊî∂ÈõÜÁî¢ÂìÅÂíåÂèóÁúæ‰ø°ÊÅØ...„Äç',
            done: 'Â§™Ê£í‰∫ÜÔºÅÊàëÂ∑≤Á∂ìÂÆåÂÖ®ÁêÜËß£‰Ω†ÁöÑÈúÄÊ±ÇÔºÅ'
        }
    },
    ad_strategy: {
        name: 'Á≠ñÁï•Â∏´',
        avatar: 'üß†',
        personality: 'Ê¥ûÂØü‰∫∫ÂøÉÁöÑÁ≠ñÁï•Â∞àÂÆ∂',
        phrases: {
            start: 'ËÆìÊàë‰æÜÂàÜÊûêÊúÄ‰Ω≥ÂâµÊÑèÊñπÂêë...',
            working: '„ÄåÊ≠£Âú®Ë™øÁî®„ÄäÂÆö‰Ωç„ÄãÂíå„ÄäÊ∂àË≤ªËÄÖË°åÁÇ∫Â≠∏„Äã...„Äç',
            step1: '„ÄåÊèêÁÖâÁî¢ÂìÅÊ†∏ÂøÉË≥£Èªû...„Äç',
            step2: '„ÄåÊßãÂª∫ÁõÆÊ®ôÂèóÁúæÁï´ÂÉè...„Äç',
            step3: '„ÄåÁ¢∫ÂÆöÊÉÖÁ∑íÈóúÈçµË©ûÂíåÊïò‰∫ãÊñπÂêë...„Äç',
            done: 'Á≠ñÁï•ÂàÜÊûêÂÆåÊàêÔºÅÂâµÊÑèÊñπÂêëÂ∑≤Á¢∫ÂÆöÔºÅ'
        }
    },
    ad_visual: {
        name: 'Ë¶ñË¶∫Â∞éÊºî',
        avatar: 'üëÅÔ∏è',
        personality: 'Ë¶ñË¶∫ËóùË°ìÂÆ∂',
        phrases: {
            start: 'ËÆìÊàë‰æÜË®≠Ë®àÊØèÂÄãÈè°È†≠ÁöÑÁï´Èù¢...',
            working: '„ÄåÊ≠£Âú®Ë™øÁî®„ÄäAIGCÂãïÁï´ÂàÜÈè°Ë®≠Ë®à„Äã...„Äç',
            step1: '„ÄåÊãÜËß£Èè°È†≠Êï∏ÈáèÂíåÈ°ûÂûã...„Äç',
            step2: '„ÄåË®≠Ë®àÊôØÂà•„ÄÅËßíÂ∫¶„ÄÅÈÅãÈè°...„Äç',
            step3: '„ÄåË£úÂÖÖÁï´Èù¢ÊèèËø∞ÂíåÂÖâÂΩ±...„Äç',
            done: 'Ë¶ñË¶∫ÂàÜÈè°Ë®≠Ë®àÂÆåÊàêÔºÅ'
        }
    },
    ad_copywriter: {
        name: 'ÊñáÊ°àÂ∏´',
        avatar: '‚úçÔ∏è',
        personality: 'Â¶ôÁ≠ÜÁîüËä±ÁöÑÊñáÊ°àÂ§ßÂ∏´',
        phrases: {
            start: 'ËÆìÊàë‰æÜÁÇ∫ÊØèÂÄãÈè°È†≠ÈÖç‰∏äÊñáÊ°à...',
            working: '„ÄåÊ≠£Âú®Ë™øÁî®„ÄäÊñáÊ°àË®ìÁ∑¥ÊâãÂÜä„Äã...„Äç',
            step1: '„ÄåË®≠Ë®à‰∏ªSlogan...„Äç',
            step2: '„ÄåÁÇ∫ÊØèÂÄãÈè°È†≠ÈÖçÊñáÊ°à...„Äç',
            done: 'ÊñáÊ°àÂâµ‰ΩúÂÆåÊàêÔºÅ'
        }
    }
};

// ==================== Ê†áÈ¢òÊèêÂèñÔºàBug #5 fixÔºâ====================
function extractTitleFromText(text) {
    if (!text || typeof text !== 'string') return null;
    
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    const firstLines = lines.slice(0, 10); // Ê£ÄÊü•Ââç10Ë°å
    
    // 1. Êü•Êâæ„ÄäÊ†áÈ¢ò„ÄãÊ†ºÂºè
    for (const line of firstLines) {
        const match = line.match(/„Ää(.+?)„Äã/);
        if (match && match[1].length <= 30) {
            console.log('üìö ÊèêÂèñÊ†áÈ¢òÔºà‰π¶ÂêçÂè∑Ôºâ:', match[1]);
            return match[1];
        }
    }
    
    // 2. Êü•Êâæ"Ê†áÈ¢òÔºö"Êàñ"Title:"Ê†ºÂºè
    for (const line of firstLines) {
        const match = line.match(/(?:Ê†áÈ¢ò|È°åÁõÆ|Title|‰π¶Âêç|ÁâáÂêç)[Ôºö:]\s*(.+)/i);
        if (match && match[1].length <= 30) {
            console.log('üìö ÊèêÂèñÊ†áÈ¢òÔºàÂâçÁºÄÔºâ:', match[1]);
            return match[1].trim();
        }
    }
    
    // 3. Á¨¨‰∏Ä‰∏™ÈùûÁ©∫Ë°åÂ¶ÇÊûúÊòØÁü≠ÊñáÊú¨ÔºàÂèØËÉΩÊòØÊ†áÈ¢òÔºâ
    if (firstLines[0] && firstLines[0].length <= 30 && !firstLines[0].includes('„ÄÇ')) {
        // Ê£ÄÊü•Á¨¨‰∫åË°åÊòØ‰∏çÊòØ‰ΩúËÄÖÂêç
        const secondLine = firstLines[1] || '';
        if (secondLine.match(/‰ΩúËÄÖ|Ëëó|ÁºñÂâß|ÂØºÊºî|Author/i) || secondLine.length < firstLines[0].length) {
            console.log('üìö ÊèêÂèñÊ†áÈ¢òÔºàÈ¶ñË°åÔºâ:', firstLines[0]);
            return firstLines[0];
        }
    }
    
    console.log('üìö Êú™ËÉΩÊèêÂèñÊ†áÈ¢òÔºå‰ΩøÁî®Êñá‰ª∂Âêç');
    return null;
}

// ==================== ÂâßÊú¨Ê∏ÖÁêÜÔºàÂéªÈô§MarkdownÊ†áËÆ∞Ôºâ====================
function cleanScriptMarkdown(text) {
    if (!text || typeof text !== 'string') return text;
    
    return text
        // ÂéªÈô§Á≤ó‰ΩìÊ†áËÆ∞ **ÊñáÂ≠ó**
        .replace(/\*\*([^*]+)\*\*/g, '$1')
        // ÂéªÈô§Êñú‰ΩìÊ†áËÆ∞ *ÊñáÂ≠ó* Êàñ _ÊñáÂ≠ó_
        .replace(/\*([^*]+)\*/g, '$1')
        .replace(/_([^_]+)_/g, '$1')
        // ÂéªÈô§Ë°åÂÜÖ‰ª£Á†Å `ÊñáÂ≠ó`
        .replace(/`([^`]+)`/g, '$1')
        // ÂéªÈô§Ê†áÈ¢òÊ†áËÆ∞ # ## ###
        .replace(/^#{1,3}\s+/gm, '')
        // Ê∏ÖÁêÜÂ§ö‰ΩôÁ©∫Ë°å
        .replace(/\n{3,}/g, '\n\n')
        .trim();
}

// ==================== JSONËß£ÊûêÔºàÂ∏¶Ëá™Âä®‰øÆÂ§çÔºâ====================
function safeJSONParse(text, context = 'unknown') {
    // Â¶ÇÊûúÂ∑≤ÁªèÊòØÂØπË±°ÔºåÁõ¥Êé•ËøîÂõû
    if (typeof text === 'object' && text !== null) {
        console.log(`safeJSONParse [${context}]: Â∑≤ÁªèÊòØÂØπË±°ÔºåÁõ¥Êé•ËøîÂõû`);
        return text;
    }
    
    if (!text || typeof text !== 'string') {
        console.warn(`safeJSONParse [${context}]: Á©∫ËæìÂÖ•ÊàñÈùûÂ≠óÁ¨¶‰∏≤`, typeof text);
        return {};
    }
    
    // Ê∏ÖÁêÜÂ∏∏ËßÅÈóÆÈ¢ò
    let cleaned = text
        .replace(/```json\n?/g, '')
        .replace(/```\n?/g, '')
        .trim();
    
    // Â∞ùËØïÁõ¥Êé•Ëß£Êûê
    try {
        return JSON.parse(cleaned);
    } catch (e) {
        console.warn(`safeJSONParse [${context}]: È¶ñÊ¨°Ëß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØï‰øÆÂ§ç...`);
    }
    
    // ‰øÆÂ§ç1: ÊèêÂèñJSONÂØπË±°/Êï∞ÁªÑ
    const jsonMatch = cleaned.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
    if (jsonMatch) {
        try {
            return JSON.parse(jsonMatch[1]);
        } catch (e) {}
    }
    
    // ‰øÆÂ§ç2: ÁßªÈô§Â∞æÈÉ®ÈÄóÂè∑
    try {
        const noTrailing = cleaned.replace(/,(\s*[\}\]])/g, '$1');
        return JSON.parse(noTrailing);
    } catch (e) {}
    
    // ‰øÆÂ§ç3: ‰øÆÂ§çÂçïÂºïÂè∑
    try {
        const doubleQuotes = cleaned.replace(/'/g, '"');
        return JSON.parse(doubleQuotes);
    } catch (e) {}
    
    console.error(`safeJSONParse [${context}]: ÊâÄÊúâ‰øÆÂ§çÂ∞ùËØïÂ§±Ë¥•`);
    return {};
}

// ==================== ÊµÅÁ®ãÂÆö‰πâ ====================
const STEPS = [
    { id: 0, name: 'Â∞éÂÖ•Â∞èË™™', agent: null },
    { id: 1, name: 'Ê¶ÇÂøµÊèêÂèñ', agent: 'concept' },
    { id: 2, name: 'ÂâµÊÑèË®™Ë´á', agent: 'interview' },
    { id: 3, name: 'Á´†ÁØÄË¶èÂäÉ', agent: 'narrative' },
    { id: 4, name: 'ËßíËâ≤Ë®≠Ë®à', agent: 'character' },
    { id: 5, name: 'ÂàÜÈè°ÁîüÊàê', agent: 'storyboard' }
];

// ==================== ÂÜÖÊµãÊ®°ÂºèÔºàÊó†ÁßØÂàÜÁ≥ªÁªüÔºâ====================
const MEMBERSHIP = {
    free: { name: 'ÂÖßÊ∏¨Áâà', maxProjects: 999, icon: 'üéâ' }
};

let currentUser = {
    id: localStorage.getItem('user_id') || 'guest_' + Date.now(),
    plan: 'free'
};

function initUser() {
    localStorage.setItem('user_id', currentUser.id);
}

function updateUserUI() {
    // ÂÜÖÊµãÁâà‰∏çÈúÄË¶ÅÊõ¥Êñ∞UI
}

// ==================== ‰æßËæπÊ†è ====================
let currentProjectId = null;

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    sidebar.classList.toggle('show');
    overlay.classList.toggle('show');
}

function toggleAssetsPanel() {
    const panel = document.getElementById('assetsPanel');
    const overlay = document.getElementById('assetsOverlay');
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
        // ÁßªÂä®Á´ØÔºöÊªëÂá∫ÊïàÊûú
        panel.classList.toggle('show');
        overlay.classList.toggle('show');
    } else {
        // Ê°åÈù¢Á´ØÔºöÊòæÁ§∫/ÈöêËóè
        if (panel.style.display === 'none') {
            panel.style.display = 'flex';
        } else {
            panel.style.display = 'none';
        }
    }
}

// Êõ¥Êñ∞Âè≥‰æßËµÑ‰∫ßÈù¢Êùø
function updateAssetsPanel() {
    const a = state.assets || {};
    const p = state.production || {};
    
    // üîß Ë∞ÉËØïÔºöÊâìÂç∞ÂΩìÂâçËµÑ‰∫ßÁä∂ÊÄÅ
    console.log('üì¶ updateAssetsPanel - ÂΩìÂâçËµÑ‰∫ß:', {
        concept: !!a.concept,
        characters: a.characters?.length || 0,
        chapters: a.chapters?.length || 0,
        costumes: a.costumes?.length || 0,
        scripts: Object.keys(a.scripts || {}).length,
        storyboards: Object.keys(a.storyboards || {}).length
    });
    const container = document.getElementById('canvasFlow');
    
    // Ê£ÄÊü•ÊòØÂê¶Êúâ‰ªª‰ΩïÂÜÖÂÆπ
    const hasContent = a.concept || a.characters?.length > 0 || a.chapters?.length > 0 || a.costumes?.length > 0 || a.sets?.length > 0;
    
    if (!hasContent) {
        container.innerHTML = `
            <div class="canvas-empty">
                <div class="empty-icon">üì¶</div>
                <div class="empty-text">${t('emptyAssetsTitle')}<br>${t('emptyAssetsDesc')}</div>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    // ==================== Âå∫Âùó1ÔºöÂü∫Á°ÄËÆæÂÆö ====================
    const hasBaseSettings = a.concept || a.characters?.length > 0 || a.costumes?.length > 0 || a.sets?.length > 0;
    if (hasBaseSettings) {
        html += `<div class="assets-section">
            <div class="assets-section-header" onclick="toggleSection('baseSettings')">
                <span>üìã Âü∫Á§éË®≠ÂÆö</span>
                <span id="baseSettingsToggle">‚ñº</span>
            </div>
            <div class="assets-section-body" id="baseSettingsBody">`;
        
        // 01 È´òÊ¶ÇÂøµ
        if (a.concept) {
            const c = a.concept;
            html += `
                <div class="canvas-card">
                    <div class="canvas-card-header">
                        <span class="canvas-card-num">01</span>
                        <span class="canvas-card-title">üí° È´òÊ¶ÇÂøµ</span>
                        <span class="canvas-card-status">‚úì</span>
                    </div>
                    <div class="canvas-card-body">
                        <div class="canvas-card-row"><span class="canvas-card-label">È°ûÂûã</span><span class="canvas-card-value">${c.genre || '-'}</span></div>
                        <div class="canvas-card-row"><span class="canvas-card-label">‰∏ªÈ°å</span><span class="canvas-card-value">${c.theme || '-'}</span></div>
                        <div class="canvas-card-row"><span class="canvas-card-label">Âü∫Ë™ø</span><span class="canvas-card-value">${c.tone || '-'}</span></div>
                        ${c.logline ? `<div style="margin-top:6px;font-size:10px;color:var(--text2);line-height:1.4;">"${c.logline.substring(0, 80)}..."</div>` : ''}
                    </div>
                </div>
            `;
        }
        
        // 02 ‰∫∫Áâ©Â∞è‰º†
        if (a.characters?.length > 0) {
            const withPrompt = a.characters.filter(c => c.prompt).length;
            html += `
                <div class="canvas-card">
                    <div class="canvas-card-header">
                        <span class="canvas-card-num">02</span>
                        <span class="canvas-card-title">üë§ ‰∫∫Áâ©Â∞èÂÇ≥ (${a.characters.length})</span>
                        <span class="canvas-card-status">${withPrompt} Prompt</span>
                    </div>
                    <div class="canvas-card-body" style="padding:0;">
                        ${a.characters.map((c, i) => `
                            <div class="character-asset-item" onclick="toggleCharacterDetail(${i})">
                                <div class="character-asset-header">
                                    <span class="character-asset-name">‚Ä¢ <b>${c.name}</b></span>
                                    <span class="character-asset-role">(${c.role || 'ËßíËâ≤'})</span>
                                    <span class="character-asset-toggle" id="charToggle${i}">‚ñº</span>
                                </div>
                                <div class="character-asset-detail" id="charDetail${i}" style="display:none;">
                                    ${c.bio ? `<div class="char-section"><div class="char-section-title">üìñ Â∞èÂÇ≥</div><div class="char-section-content">${c.bio}</div></div>` : ''}
                                    ${c.appearance ? `<div class="char-section"><div class="char-section-title">üë§ Â§ñË≤å</div><div class="char-section-content">${c.appearance}</div></div>` : ''}
                                    ${c.prompt ? `<div class="char-section"><div class="char-section-title">üé® Prompt <button class="copy-btn" onclick="event.stopPropagation();copyCharPrompt(${i})">üìã</button></div><div class="char-section-content char-prompt" id="charPrompt${i}">${c.prompt}</div></div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // 03 ÊúçÂåñÈÅì
        if (a.costumes?.length > 0 || a.sets?.length > 0 || a.props?.length > 0) {
            const costumeCount = a.costumes?.length || 0;
            const setCount = a.sets?.length || 0;
            html += `
                <div class="canvas-card">
                    <div class="canvas-card-header" onclick="toggleProductionDetail()" style="cursor:pointer;">
                        <span class="canvas-card-num">03</span>
                        <span class="canvas-card-title">üëó ÊúçÂåñÈÅì</span>
                        <span class="canvas-card-status">${costumeCount}Êúç ${setCount}ÊôØ</span>
                    </div>
                    <div class="canvas-card-body" id="productionDetail" style="display:none;padding:0;">
                        ${costumeCount > 0 ? `
                            <div style="padding:6px 10px;border-bottom:1px solid var(--border);">
                                ${a.costumes.slice(0, 3).map(c => `
                                    <div style="font-size:10px;margin:3px 0;"><b>${c.character || 'ËßíËâ≤'}</b>: ${c.outfit || '-'}</div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${setCount > 0 ? `
                            <div style="padding:6px 10px;">
                                ${a.sets.slice(0, 3).map(s => `
                                    <div style="font-size:10px;margin:3px 0;"><b>${s.name || 'Â†¥ÊôØ'}</b>: ${s.atmosphere || '-'}</div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        html += `</div></div>`; // ÂÖ≥Èó≠ baseSettings
    }
    
    // ==================== Âå∫Âùó2ÔºöÂÜÖÂÆπÁîü‰∫ß ====================
    const hasProduction = a.chapters?.length > 0;
    if (hasProduction) {
        const scriptCount = Object.keys(a.scripts || {}).length;
        const sbCount = Object.keys(a.storyboards || {}).length;
        const totalShots = Object.values(a.storyboards || {}).reduce((sum, arr) => sum + (arr?.length || 0), 0);
        
        html += `<div class="assets-section">
            <div class="assets-section-header" onclick="toggleSection('production')">
                <span>üìù ÂÖßÂÆπÁîüÁî¢</span>
                <span class="assets-section-stats">${a.chapters.length}Á´† | ${scriptCount}ÂäáÊú¨ | ${totalShots}Èè°</span>
                <span id="productionToggle2">‚ñº</span>
            </div>
            <div class="assets-section-body" id="productionBody">`;
        
        // Á´†ËäÇÂàóË°®ÔºàÂåÖÂê´ÂâßÊú¨ÂíåÂàÜÈïúÔºâ
        html += getChaptersHtml(a);
        
        html += `</div></div>`; // ÂÖ≥Èó≠ production
    }
    
    container.innerHTML = html;
}

// ÂàáÊç¢Âå∫ÂùóÂ±ïÂºÄ/Êî∂Ëµ∑
function toggleSection(sectionId) {
    const body = document.getElementById(sectionId + 'Body');
    const toggle = document.getElementById(sectionId + 'Toggle') || document.getElementById(sectionId + 'Toggle2');
    if (body && toggle) {
        const isHidden = body.style.display === 'none';
        body.style.display = isHidden ? 'block' : 'none';
        toggle.textContent = isHidden ? '‚ñ≤' : '‚ñº';
    }
}

// 03 Á´†ËäÇÁõíÂ≠êÂàóË°® - ÂçïÁã¨ÂáΩÊï∞ÔºàÂèØÂ±ïÂºÄÊü•Áúã/ÁºñËæëÂÜÖÂÆπÔºâ
function getChaptersHtml(a) {
    if (!a.chapters?.length) return '';
    
    // ËÆ°ÁÆóËµ∑ÊâøËΩ¨ÂêàÂàÜÂ∏É
    const total = a.chapters.length;
    const phaseRanges = {
        Ëµ∑: Math.ceil(total * 0.25),
        Êâø: Math.ceil(total * 0.5),
        ËΩ¨: Math.ceil(total * 0.75)
    };
    
    let html = `<div style="font-size:11px;color:var(--text2);padding:8px 0 4px;">üìù Á´†ÁØÄÂäáÊú¨ & ÂàÜÈè°ÔºàÈªûÊìäÊü•ÁúãÂÖßÂÆπÔºâ</div>`;
    
    a.chapters.forEach((ch, i) => {
        const num = i + 1;
        const hasScript = a.scripts?.[num];
        const hasStoryboard = a.storyboards?.[num];
        const shotCount = a.storyboards?.[num]?.length || 0;
        const scriptPreview = hasScript ? a.scripts[num].substring(0, 100) + '...' : '';
        
        // Ëé∑ÂèñphaseÊ†áÁ≠æ
        let phase = ch.phase || '';
        if (!phase) {
            if (num <= phaseRanges.Ëµ∑) phase = 'Ëµ∑';
            else if (num <= phaseRanges.Êâø) phase = 'Êâø';
            else if (num <= phaseRanges.ËΩ¨) phase = 'ËΩ¨';
            else phase = 'Âêà';
        }
        
        const phaseColors = { 'Ëµ∑': '#4CAF50', 'Êâø': '#2196F3', 'ËΩ¨': '#FF9800', 'Âêà': '#E91E63' };
        const phaseColor = phaseColors[phase] || '#888';
        
        // ÊèêÂèñÁ´†ËäÇËØ¶ÁªÜ‰ø°ÊÅØ
        const summary = ch.summary || '';
        const conflict = ch.conflict || '';
        const highlight = ch.highlight || '';
        const hook = ch.hook || '';
        const emotion = ch.emotion || '';
        
        html += `
            <div class="chapter-box" id="chapterBox${num}">
                <div class="chapter-box-header" style="cursor:pointer;" onclick="toggleChapterContent(${num})">
                    <span style="background:${phaseColor};color:white;padding:1px 6px;border-radius:3px;margin-right:6px;font-size:9px;font-weight:600;">„Äê${phase}„Äë</span>
                    <span style="color:var(--accent);margin-right:6px;font-weight:600;">E${String(num).padStart(2,'0')}</span>
                    <span style="flex:1;font-weight:500;">${ch.title || `Á¨¨${num}ÈõÜ`}</span>
                    <span id="chapterToggle${num}" style="font-size:10px;color:#666;">‚ñº</span>
                </div>
                <!-- Á´†ËäÇËØ¶ÊÉÖÔºàÂ§ßÁ∫≤„ÄÅÂÜ≤Á™Å„ÄÅ‰∫ÆÁÇπÔºâ-->
                <div class="chapter-info" style="padding:8px 10px;background:rgba(0,0,0,0.2);font-size:10px;line-height:1.6;">
                    ${summary ? `<div style="color:var(--text);margin-bottom:6px;padding:6px 8px;background:rgba(255,255,255,0.05);border-radius:4px;border-left:2px solid var(--accent);">
                        <div style="color:var(--accent);font-weight:600;margin-bottom:3px;">üìñ Êú¨ÈõÜÂ§ßÁ∂±</div>
                        <div style="color:var(--text2);">${summary}</div>
                    </div>` : ''}
                    <div style="display:flex;flex-wrap:wrap;gap:6px;">
                        ${conflict ? `<div style="color:#E31B23;font-weight:500;flex:1;min-width:120px;">‚öîÔ∏è ${conflict}</div>` : ''}
                        ${highlight ? `<div style="color:#FFD700;flex:1;min-width:120px;">üåü ${highlight}</div>` : ''}
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;">
                        ${hook ? `<div style="color:#9C27B0;flex:1;min-width:120px;">üé£ ${hook}</div>` : ''}
                        ${emotion ? `<div style="color:#03A9F4;flex:1;min-width:120px;">üí´ ${emotion}</div>` : ''}
                    </div>
                    ${ch.scenes ? `<div style="color:var(--text2);margin-top:4px;">üé¨ Â†¥ÊôØ: ${ch.scenes}</div>` : ''}
                </div>
                <div class="chapter-box-content">
                    <div class="chapter-box-left" style="cursor:pointer;" onclick="showChapterScript(${num})">
                        <div class="chapter-box-label">‚úçÔ∏è ÂäáÊú¨</div>
                        ${hasScript 
                            ? `<span style="color:#38a169;">‚úÖ ÈªûÊìäÊü•Áúã</span>` 
                            : `<span style="color:var(--text2);">‚è≥ ÂæÖÁîüÊàê</span>`}
                    </div>
                    <div class="chapter-box-right" style="cursor:pointer;" onclick="showChapterStoryboard(${num})">
                        <div class="chapter-box-label">üé¨ ÂàÜÈè°</div>
                        ${hasStoryboard 
                            ? `<span style="color:#38a169;">‚úÖ ${shotCount}Èè° ÈªûÊìäÊü•Áúã</span>` 
                            : `<span style="color:var(--text2);">‚è≥ ÂæÖÁîüÊàê</span>`}
                    </div>
                </div>
                <!-- Â±ïÂºÄÁöÑÂÜÖÂÆπÈù¢Êùø -->
                <div class="chapter-content-panel" id="chapterPanel${num}">
                    <div class="chapter-content-scroll" id="chapterContent${num}">
                        ${hasScript ? scriptPreview : 'Â∞öÊú™ÁîüÊàêÂäáÊú¨'}
                    </div>
                </div>
            </div>
        `;
    });
    return html;
}

// ÂàáÊç¢ËßíËâ≤ËØ¶ÊÉÖÂ±ïÂºÄ/Êî∂Ëµ∑
function toggleCharacterDetail(index) {
    const detail = document.getElementById(`charDetail${index}`);
    const toggle = document.getElementById(`charToggle${index}`);
    if (detail.style.display === 'none') {
        detail.style.display = 'block';
        toggle.textContent = '‚ñ≤';
        toggle.style.transform = 'rotate(180deg)';
    } else {
        detail.style.display = 'none';
        toggle.textContent = '‚ñº';
        toggle.style.transform = 'rotate(0deg)';
    }
}

// Â§çÂà∂ËßíËâ≤Prompt
function copyCharPrompt(index) {
    const chars = state.assets?.characters || [];
    const char = chars[index];
    if (char?.prompt) {
        navigator.clipboard.writeText(char.prompt).then(() => {
            // ÊòæÁ§∫Â§çÂà∂ÊàêÂäüÊèêÁ§∫
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Â∑≤Ë§áË£Ω';
            btn.style.background = '#4CAF50';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 1500);
        });
    }
}

// ÂàáÊç¢ÊúçÂåñÈÅìËØ¶ÊÉÖÂ±ïÂºÄ/Êî∂Ëµ∑
function toggleProductionDetail() {
    const detail = document.getElementById('productionDetail');
    const toggle = document.getElementById('productionToggle');
    if (detail.style.display === 'none') {
        detail.style.display = 'block';
        toggle.textContent = '‚ñ≤';
    } else {
        detail.style.display = 'none';
        toggle.textContent = '‚ñº';
    }
}

// ÈÄöÁî®Â§çÂà∂ÊñáÊú¨ÂáΩÊï∞
function copyText(text) {
    navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úì';
        btn.style.background = '#4CAF50';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
        }, 1500);
    });
}

// ÂàáÊç¢Á´†ËäÇÂÜÖÂÆπÂ±ïÂºÄ/Êî∂Ëµ∑
function toggleChapterContent(num) {
    const panel = document.getElementById(`chapterPanel${num}`);
    const toggle = document.getElementById(`chapterToggle${num}`);
    if (panel.classList.contains('expanded')) {
        panel.classList.remove('expanded');
        toggle.textContent = '‚ñº';
    } else {
        panel.classList.add('expanded');
        toggle.textContent = '‚ñ≤';
        // Âä†ËΩΩÂÜÖÂÆπ
        showChapterScript(num);
    }
}

// ÊòæÁ§∫ÂâßÊú¨ÂÜÖÂÆπ
function showChapterScript(num) {
    const script = state.assets.scripts?.[num];
    const content = document.getElementById(`chapterContent${num}`);
    const panel = document.getElementById(`chapterPanel${num}`);
    
    if (!script) {
        content.innerHTML = `<div style="color:#888;text-align:center;padding:20px;">
            Â∞öÊú™ÁîüÊàêÂäáÊú¨<br>
            <button onclick="runScriptWriting(${num})" style="margin-top:10px;padding:6px 12px;background:var(--accent);border:none;color:white;border-radius:4px;cursor:pointer;">
                ‚úçÔ∏è ÁîüÊàêÁ¨¨${num}ÈõÜÂäáÊú¨
            </button>
        </div>`;
    } else {
        content.innerHTML = `
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                <span style="color:var(--accent);font-weight:bold;">‚úçÔ∏è Á¨¨${num}ÈõÜÂäáÊú¨</span>
                <button onclick="editChapterScript(${num})" style="padding:2px 8px;background:#333;border:1px solid #444;color:#ccc;border-radius:4px;cursor:pointer;font-size:10px;">‚úèÔ∏è Á∑®ËºØ</button>
            </div>
            <div style="white-space:pre-wrap;">${escapeHtml(script)}</div>
        `;
    }
    
    panel.classList.add('expanded');
    document.getElementById(`chapterToggle${num}`).textContent = '‚ñ≤';
}

// ÊòæÁ§∫ÂàÜÈïúÂÜÖÂÆπ
function showChapterStoryboard(num) {
    const storyboard = state.assets.storyboards?.[num];
    const content = document.getElementById(`chapterContent${num}`);
    const panel = document.getElementById(`chapterPanel${num}`);
    
    if (!storyboard || storyboard.length === 0) {
        content.innerHTML = `<div style="color:#888;text-align:center;padding:20px;">
            Â∞öÊú™ÁîüÊàêÂàÜÈè°<br>
            <button onclick="runStoryboardGeneration(${num})" style="margin-top:10px;padding:6px 12px;background:var(--accent);border:none;color:white;border-radius:4px;cursor:pointer;">
                üé¨ ÁîüÊàêÁ¨¨${num}ÈõÜÂàÜÈè°
            </button>
        </div>`;
    } else {
        let shotsHtml = storyboard.slice(0, 20).map((shot, i) => `
            <div style="padding:8px;margin:4px 0;background:#1a1a1a;border-radius:4px;border-left:2px solid var(--accent);">
                <div style="color:var(--accent);font-size:10px;margin-bottom:4px;">Èè°È†≠ ${i+1}</div>
                <div style="font-size:11px;">${shot.scene || shot.description || ''}</div>
                ${shot.image_prompt ? `<div style="font-size:10px;color:#666;margin-top:4px;">üé® ${shot.image_prompt.substring(0, 60)}...</div>` : ''}
            </div>
        `).join('');
        
        if (storyboard.length > 20) {
            shotsHtml += `<div style="text-align:center;color:#666;padding:8px;">...ÈÇÑÊúâ ${storyboard.length - 20} ÂÄãÈè°È†≠</div>`;
        }
        
        content.innerHTML = `
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                <span style="color:var(--accent);font-weight:bold;">üé¨ Á¨¨${num}ÈõÜÂàÜÈè° (${storyboard.length}Èè°)</span>
                <button onclick="exportChapterCSV(${num})" style="padding:2px 8px;background:#333;border:1px solid #444;color:#ccc;border-radius:4px;cursor:pointer;font-size:10px;">üìä Â∞éÂá∫CSV</button>
            </div>
            ${shotsHtml}
        `;
    }
    
    panel.classList.add('expanded');
    document.getElementById(`chapterToggle${num}`).textContent = '‚ñ≤';
}

// ÁºñËæëÂâßÊú¨
function editChapterScript(num) {
    const script = state.assets.scripts?.[num] || '';
    const content = document.getElementById(`chapterContent${num}`);
    
    content.innerHTML = `
        <div style="margin-bottom:8px;">
            <span style="color:var(--accent);font-weight:bold;">‚úèÔ∏è Á∑®ËºØÁ¨¨${num}ÈõÜÂäáÊú¨</span>
        </div>
        <textarea id="editScript${num}" class="chapter-content-edit">${escapeHtml(script)}</textarea>
        <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end;">
            <button onclick="showChapterScript(${num})" style="padding:4px 12px;background:#333;border:1px solid #444;color:#ccc;border-radius:4px;cursor:pointer;">ÂèñÊ∂à</button>
            <button onclick="saveChapterScript(${num})" style="padding:4px 12px;background:var(--accent);border:none;color:white;border-radius:4px;cursor:pointer;">üíæ ‰øùÂ≠ò</button>
        </div>
    `;
}

// ‰øùÂ≠òÂâßÊú¨
function saveChapterScript(num) {
    const textarea = document.getElementById(`editScript${num}`);
    if (textarea) {
        state.assets.scripts[num] = textarea.value;
        saveProject();
        showChapterScript(num);
        addAIMessage(`‚úÖ Á¨¨${num}ÈõÜÂäáÊú¨Â∑≤‰øùÂ≠òÔºÅ`);
    }
}

// ÂØºÂá∫ÂçïÈõÜExcel
function exportChapterCSV(num) {
    const storyboard = state.assets.storyboards?.[num];
    if (!storyboard) return;
    
    const headers = ['Èè°È†≠ID', 'Â†¥ÊôØ', 'ÊôÇÈñì', 'ÂÖâÁ∑ö', 'Ê∞õÂúç', 'ËßíËâ≤', 'Âãï‰Ωú', 'Âè∞Ë©û', 'Ê©ü‰Ωç', 'ÈÅãÈè°', 'ÊôØÂà•', 'Image_Prompt', 'Video_Prompt'];
    
    // Excel XMLÊ†ºÂºè
    let excelContent = `<?xml version="1.0" encoding="UTF-8"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
<Styles>
<Style ss:ID="header"><Font ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#E31B23" ss:Pattern="Solid"/></Style>
<Style ss:ID="cell"><Alignment ss:Vertical="Top" ss:WrapText="1"/></Style>
</Styles>
<Worksheet ss:Name="Á¨¨${num}ÈõÜÂàÜÈè°">
<Table>
<Row>`;
    
    headers.forEach(h => {
        excelContent += `<Cell ss:StyleID="header"><Data ss:Type="String">${h}</Data></Cell>`;
    });
    excelContent += `</Row>`;
    
    storyboard.forEach((shot, i) => {
        excelContent += `<Row>`;
        const values = [
            `E${String(num).padStart(2,'0')}_S${String(i+1).padStart(3,'0')}`,
            shot.scene || '',
            shot.time || '',
            shot.lighting || '',
            shot.mood || '',
            shot.characters || shot.character || '',
            shot.action || '',
            shot.dialogue || '',
            shot.camera_position || '',
            shot.camera_movement || '',
            shot.shot_size || '',
            shot.image_prompt || shot.ai_prompt || '',
            shot.video_prompt || ''
        ];
        values.forEach(v => {
            excelContent += `<Cell ss:StyleID="cell"><Data ss:Type="String">${escapeHtml(String(v))}</Data></Cell>`;
        });
        excelContent += `</Row>`;
    });
    
    excelContent += `</Table></Worksheet></Workbook>`;
    
    const blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `E${String(num).padStart(2,'0')}_ÂàÜÈè°Ë°®.xls`;
    a.click();
    URL.revokeObjectURL(url);
    
    addAIMessage(`üìä Â∑≤Â∞éÂá∫Á¨¨${num}ÈõÜÂàÜÈè°ExcelÔºÅ`);
}

// ÂØºÂá∫ÂçïÈõÜÂà∞FizzDragon
function exportChapterToFizzDragon(chapterNum) {
    const a = state.assets || {};
    const chapter = a.chapters?.[chapterNum - 1];
    const script = a.scripts?.[chapterNum];
    const storyboard = a.storyboards?.[chapterNum];
    
    if (!storyboard) {
        addAIMessage(`‚ö†Ô∏è Á¨¨${chapterNum}ÈõÜÂàÜÈè°Â∞öÊú™ÁîüÊàê`);
        return;
    }
    
    const data = {
        episode: chapterNum,
        title: chapter?.title || `Á¨¨${chapterNum}ÈõÜ`,
        script: script,
        storyboard: storyboard,
        shotCount: storyboard.length
    };
    
    // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
    navigator.clipboard.writeText(JSON.stringify(data, null, 2)).then(() => {
        addAIMessage(`‚úÖ **Á¨¨${chapterNum}ÈõÜÂ∑≤Ë§áË£ΩÔºÅ**

‚Ä¢ ${storyboard.length} ÂÄãÂàÜÈè°
‚Ä¢ ÂåÖÂê´ Image_Prompt + Video_Prompt

ÂâçÂæÄ FizzDragon Âπ≥Âè∞Á≤òË≤ºÂ∞éÂÖ•Âç≥ÂèØ„ÄÇ`, [
            { text: 'üåê ÊâìÈñãFizzDragon', action: () => window.open('https://fizzdragon.com', '_blank') }
        ]);
    }).catch(() => {
        // Â¶ÇÊûúÂâ™Ë¥¥ÊùøÂ§±Ë¥•Ôºå‰∏ãËΩΩÊñá‰ª∂
        downloadFile(`E${String(chapterNum).padStart(2,'0')}_storyboard.json`, JSON.stringify(data, null, 2), 'application/json');
        addAIMessage(`üì• Â∑≤‰∏ãËºâÁ¨¨${chapterNum}ÈõÜÂàÜÈè°Êñá‰ª∂`);
    });
}

// KimiÈ£éÊ†ºÂ∫ïÈÉ®Â∑•ÂÖ∑Ê†èÂàáÊç¢
function switchMode(mode) {
    // Êõ¥Êñ∞Â∑•ÂÖ∑Ê†èÊåâÈíÆÁä∂ÊÄÅ
    document.querySelectorAll('.toolbar-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById('toolbar' + mode.charAt(0).toUpperCase() + mode.slice(1));
    if (activeBtn) activeBtn.classList.add('active');
    
    // Ê†πÊçÆÊ®°ÂºèÊâßË°åÂä®‰Ωú
    switch(mode) {
        case 'story':
            // ÊïÖ‰∫ãÂàÜÊûêÊ®°Âºè - ÊòæÁ§∫Âø´Êç∑ÈÄâÈ°π
            addAIMessage('üìñ ÊïÖ‰∫ãÊ®°ÂºèÂ∑≤ÊøÄÊ¥ª„ÄÇÊÇ®ÂèØ‰ª•Ôºö\n‚Ä¢ Â∞éÂÖ•Â∞èË™™ÊñáÊú¨ÈÄ≤Ë°åÂàÜÊûê\n‚Ä¢ ‰ΩøÁî®AIÁîüÊàêÊïÖ‰∫ãÊ¶ÇÂøµ\n‚Ä¢ ÂâµÂª∫ËßíËâ≤Âíå‰∏ñÁïåËßÄ', [
                { text: 'üìÑ Â∞éÂÖ•Â∞èË™™', action: () => document.getElementById('fileInput').click() },
                { text: '‚ú® AIÁîüÊàêÊïÖ‰∫ã', action: () => startNewProject() }
            ]);
            break;
        case 'write':
            // ÂÜô‰ΩúÊ®°Âºè
            if (typeof switchToWriteMode === 'function') {
                switchToWriteMode();
            } else {
                addAIMessage('‚úçÔ∏è ÂØ´‰ΩúÊ®°ÂºèÂ∑≤ÊøÄÊ¥ª„ÄÇÈñãÂßãÂâµ‰ΩúÊÇ®ÁöÑÊïÖ‰∫ãÔºÅ');
            }
            break;
        case 'storyboard':
            // ÂàÜÈïúÊ®°Âºè
            addAIMessage('üé¨ ÂàÜÈè°Ê®°ÂºèÂ∑≤ÊøÄÊ¥ª„ÄÇÂ∞áÊÇ®ÁöÑÊïÖ‰∫ãËΩâÂåñÁÇ∫ÂèØË¶ñÂåñÂàÜÈè°„ÄÇ');
            break;
        case 'export':
            // ÂØºÂá∫Ê®°Âºè
            addAIMessage('üì§ Â∞éÂá∫ÈÅ∏È†ÖÔºö', [
                { text: 'üìã JSONÊ†ºÂºè', action: () => exportProject('json') },
                { text: 'üìä ExcelÂàÜÈè°Ë°®', action: () => exportProject('excel') },
                { text: 'üé® PromptÂåÖ', action: () => exportProject('prompts') }
            ]);
            break;
    }
}

function renderProjectList() {
    // ‰ΩøÁî®Ê®°ÂºèËøáÊª§ÁöÑÊ∏≤Êüì
    renderProjectListByMode();
}

function openProject(projectId) {
    currentProjectId = projectId;
    renderProjectList();
    loadProject(projectId);
    
    // Êõ¥Êñ∞Ê†áÈ¢ò
    const projects = getProjects();
    const p = projects[projectId];
    if (p) {
        document.getElementById('headerTitle').textContent = p.name || 'FizzDragon AIGCÁï™ÂäáÁ≥ªÁµ±';
    }
    
    // Êõ¥Êñ∞Âè≥‰æßËµÑ‰∫ßÈù¢Êùø
    updateAssetsPanel();
    
    // ÁßªÂä®Á´ØÂÖ≥Èó≠‰æßËæπÊ†è
    if (window.innerWidth <= 768) {
        toggleSidebar();
    }
}

function startNewProject() {
    console.log('üÜï startNewProject called, appMode:', appMode);
    
    // Ê∏ÖÁ©∫ÂΩìÂâçÁä∂ÊÄÅ
    currentProjectId = null;
    state.novel = null;
    state.novelTitle = '';
    state.step = 0;
    state.mode = null;
    writeState.idea = null;
    writeState.outline = null;
    writeState.chapters = [];
    writeState.currentQuestion = null;
    
    // üîß Ê∏ÖÁ©∫È°πÁõÆËµÑ‰∫ßÔºàËøôÊòØÊºèÊéâÁöÑÔºÅÔºâ
    state.assets = {
        concept: null,
        characters: [],
        chapters: [],
        costumes: null,
        scripts: {},
        storyboards: {}
    };
    state.production = {
        episodes: 10,
        durationMin: 3,
        shotsPerMin: 10
    };
    
    // Ê∏ÖÁ©∫ÂπøÂëäÁä∂ÊÄÅ
    adState.step = 0;
    adState.productImage = null;
    adState.actorImages = [];
    adState.requirement = '';
    adState.duration = 30;
    adState.style = '';
    adState.assets = { userProfile: null, creativeBrief: null, storyboard: [], previews: [], video: null };
    
    // Ê∏ÖÁ©∫ËÅäÂ§©
    document.getElementById('chatContainer').innerHTML = '';
    document.getElementById('headerTitle').textContent = appMode === 'ad' ? 'FizzDragon AIÂª£ÂëäÂàÜÈè°' : 'FizzDragon AIGCÁï™ÂäáÁ≥ªÁµ±';
    
    // Ê†πÊçÆÊ®°ÂºèÊòæÁ§∫Ê¨¢Ëøé
    if (appMode === 'ad') {
        showAdWelcome();
    } else {
        showStartOptions();
    }
    renderProjectList();
    
    // üîß Êõ¥Êñ∞Âè≥‰æßËµÑ‰∫ßÈù¢ÊùøÔºàÊ∏ÖÁ©∫ÊòæÁ§∫Ôºâ
    updateAssetsPanel();
    
    // ÁßªÂä®Á´ØÂÖ≥Èó≠‰æßËæπÊ†è
    if (window.innerWidth <= 768) {
        toggleSidebar();
    }
}

// ==================== Â∫îÁî®Ê®°ÂºèÂàáÊç¢ ====================
function switchAppMode(mode) {
    appMode = mode;
    console.log('üîÄ ÂàáÊç¢Ê®°Âºè:', mode);
    
    // Êõ¥Êñ∞TabÊ†∑Âºè
    document.querySelectorAll('.mode-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.mode === mode);
    });
    
    // Êõ¥Êñ∞Êñ∞Âª∫ÊåâÈíÆÊñáÂ≠óÂíåÊ†áÈ¢ò
    const newBtnText = document.getElementById('newBtnText');
    const projectListTitle = document.getElementById('projectListTitle');
    const headerTitle = document.getElementById('headerTitle');
    
    if (mode === 'ad') {
        newBtnText.textContent = 'Êñ∞Âª∫Âª£ÂëäÈ†ÖÁõÆ';
        projectListTitle.textContent = 'ÊàëÁöÑÂª£ÂëäÈ†ÖÁõÆ';
        headerTitle.textContent = 'FizzDragon AIÂª£ÂëäÂàÜÈè°';
    } else {
        newBtnText.textContent = 'Êñ∞Âª∫ÂΩ±Ë¶ñÈ†ÖÁõÆ';
        projectListTitle.textContent = 'ÊàëÁöÑÂΩ±Ë¶ñÈ†ÖÁõÆ';
        headerTitle.textContent = 'FizzDragon AIGCÁï™ÂäáÁ≥ªÁµ±';
    }
    
    // ËøáÊª§È°πÁõÆÂàóË°®
    renderProjectListByMode();
    
    // Â¶ÇÊûúÊ≤°ÊúâËøõË°å‰∏≠ÁöÑÈ°πÁõÆÔºåÊòæÁ§∫ÂØπÂ∫îÊ¨¢ËøéÈ°µ
    if (!currentProjectId) {
        document.getElementById('chatContainer').innerHTML = '';
        if (mode === 'ad') {
            showAdWelcome();
        } else {
            showStartOptions();
        }
    }
}

function renderProjectListByMode() {
    const projects = getProjects();
    const list = Object.values(projects)
        .filter(p => {
            // ÂπøÂëäÊ®°ÂºèÔºöÂè™ÊòæÁ§∫type='ad'ÁöÑÈ°πÁõÆ
            // ÂΩ±ËßÜÊ®°ÂºèÔºöÊòæÁ§∫type‰∏çÊòØ'ad'ÁöÑÈ°πÁõÆÔºàÂåÖÊã¨Ê≤°ÊúâtypeÂ≠óÊÆµÁöÑÊóßÈ°πÁõÆÔºâ
            if (appMode === 'ad') {
                return p.type === 'ad';
            } else {
                return !p.type || p.type !== 'ad';  // ÂåÖÂê´undefined/null/Èùûad
            }
        })
        .sort((a, b) => {
            if (a.order !== undefined && b.order !== undefined) {
                return a.order - b.order;
            }
            return new Date(b.timestamp) - new Date(a.timestamp);
        });
    const container = document.getElementById('projectList');
    
    if (list.length === 0) {
        container.innerHTML = `<div style="padding:12px;color:var(--text2);font-size:12px;">${t('noProjects')}</div>`;
        return;
    }
    
    const stepNameKeys = ['stepNotStarted', 'stepConcept', 'stepCharacter', 'stepChapter', 'stepProduction', 'stepScript', 'stepStoryboard'];
    
    container.innerHTML = list.map((p) => {
        const isActive = p.id === currentProjectId;
        const assets = p.assets || {};
        const chapterCount = assets.chapters?.length || p.chapters?.length || 0;
        const scriptCount = Object.keys(assets.scripts || {}).length;
        const sbCount = Object.keys(assets.storyboards || {}).length || p.adAssets?.storyboard?.length || 0;
        const stepName = stepNameKeys[p.step] ? t(stepNameKeys[p.step]) : '';
        const icon = p.type === 'ad' ? 'üì∫' : (p.stage === 'write' ? '‚úçÔ∏è' : 'üìÑ');
        
        const displayName = p.name || t('unnamed');
        const safeName = displayName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return `
            <div class="project-item ${isActive ? 'active' : ''}" 
                 draggable="true"
                 data-project-id="${p.id}"
                 onclick="openProject('${p.id}')"
                 ondragstart="handleDragStart(event, '${p.id}')"
                 ondragend="handleDragEnd(event)"
                 ondragover="handleDragOver(event)"
                 ondragleave="handleDragLeave(event)"
                 ondrop="handleDrop(event, '${p.id}')">
                <div class="icon">${icon}</div>
                <div class="info">
                    <div class="title">${displayName}</div>
                    <div class="meta">${p.type === 'ad' ? `${p.duration || 30}Áßí ¬∑ ${sbCount}Èè°È†≠` : `${chapterCount} ${t('episodes')} ¬∑ ${scriptCount} ${t('scriptsCount')} ¬∑ ${sbCount} ${t('storyboardsCount')}`} ${stepName ? '¬∑ '+stepName : ''}</div>
                </div>
                <div class="actions">
                    <button class="action-btn" onclick="event.stopPropagation(); renameProject('${p.id}', '${safeName}')" title="${t('rename')}">‚úèÔ∏è</button>
                    <button class="action-btn" onclick="event.stopPropagation(); confirmDeleteProject('${p.id}', '${safeName}')" title="${t('delete')}">‚úï</button>
                </div>
            </div>
        `;
    }).join('');
}

// ==================== AIÂπøÂëäÂàÜÈïúÁ≥ªÁªü ====================
function showAdWelcome() {
    const welcomeTexts = {
        'en': `üì∫ **Welcome to FizzDragon AI Ad Storyboard**

We've studied **advertising master works**, including:
‚Ä¢ David Ogilvy "Oerta" - Advertising Principles
‚Ä¢ Luke Sullivan "Hey Whipple, Squeeze This" - Creative Ads
‚Ä¢ "AIGC Animation Storyboard Design" - AI Visual Language
‚Ä¢ "Hand-on AI Movie Making" - Practical Techniques

**Create professional ad storyboards with AI.**

Just provide: Product Image + One-line Requirement + Duration

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
What would you like to create?`,
        'zh-CN': `üì∫ **Ê¨¢ËøéÊù•Âà∞ FizzDragon AIÂπøÂëäÂàÜÈïú**

Êàë‰ª¨Â≠¶‰π†‰∫Ü**ÂπøÂëäÂ§ßÂ∏àËëó‰Ωú**ÔºåÂåÖÊã¨Ôºö
‚Ä¢ David Ogilvy„Ää‰∏Ä‰∏™ÂπøÂëä‰∫∫ÁöÑËá™ÁôΩ„Äã
‚Ä¢ Luke Sullivan„ÄäÂòøÔºåÊÉ†ÊôÆÂ∞îÔºåÊçèÁ¥ßÂÆÉ„Äã
‚Ä¢ „ÄäAIGCÂä®ÁîªÂàÜÈïúËÆæËÆ°„Äã- AIËßÜËßâËØ≠Ë®Ä
‚Ä¢ „ÄäÊâãÊääÊâãÊïô‰Ω†ÂÅöAIÂ§ßÁâá„Äã- ÂÆûÊàòÊäÄÂ∑ß
‚Ä¢ „ÄäÂÆö‰Ωç„Äã„ÄäÊ∂àË¥πËÄÖË°å‰∏∫Â≠¶„Äã- Á≠ñÁï•Âü∫Á°Ä

**ËÆ©AIÂ∏Æ‰Ω†ÁîüÊàê‰∏ì‰∏öÂπøÂëäÂàÜÈïú„ÄÇ**

Âè™ÈúÄÊèê‰æõÔºö‰∫ßÂìÅÂõæ + ‰∏ÄÂè•ËØùÈúÄÊ±Ç + Êó∂Èïø

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ÂºÄÂßãÂàõ‰Ωú‰Ω†ÁöÑÂπøÂëäÂêßÔºÅ`,
        'zh-TW': `üì∫ **Ê≠°Ëøé‰æÜÂà∞ FizzDragon AIÂª£ÂëäÂàÜÈè°**

ÊàëÂÄëÂ≠∏Áøí‰∫Ü**Âª£ÂëäÂ§ßÂ∏´Ëëó‰Ωú**ÔºåÂåÖÊã¨Ôºö
‚Ä¢ David Ogilvy„Ää‰∏ÄÂÄãÂª£Âëä‰∫∫ÁöÑËá™ÁôΩ„Äã
‚Ä¢ Luke Sullivan„ÄäÂòøÔºåÊÉ†ÊôÆÁàæÔºåÊçèÁ∑äÂÆÉ„Äã
‚Ä¢ „ÄäAIGCÂãïÁï´ÂàÜÈè°Ë®≠Ë®à„Äã- AIË¶ñË¶∫Ë™ûË®Ä
‚Ä¢ „ÄäÊâãÊääÊâãÊïô‰Ω†ÂÅöAIÂ§ßÁâá„Äã- ÂØ¶Êà∞ÊäÄÂ∑ß
‚Ä¢ „ÄäÂÆö‰Ωç„Äã„ÄäÊ∂àË≤ªËÄÖË°åÁÇ∫Â≠∏„Äã- Á≠ñÁï•Âü∫Á§é

**ËÆìAIÂπ´‰Ω†ÁîüÊàêÂ∞àÊ•≠Âª£ÂëäÂàÜÈè°„ÄÇ**

Âè™ÈúÄÊèê‰æõÔºöÁî¢ÂìÅÂúñ + ‰∏ÄÂè•Ë©±ÈúÄÊ±Ç + ÊôÇÈï∑

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ÈñãÂßãÂâµ‰Ωú‰Ω†ÁöÑÂª£ÂëäÂêßÔºÅ`
    };
    
    addAIMessage(welcomeTexts[currentLang] || welcomeTexts['zh-TW'], [
        { text: 'üöÄ ÈñãÂßãÂâµ‰ΩúÂª£Âëä', action: () => startAdCreation() },
        { text: 'üìö Êü•ÁúãÊ°à‰æã', action: () => showAdExamples() }
    ]);
}

function showAdExamples() {
    addAIMessage(`üìö **Âª£ÂëäÊ°à‰æãÂèÉËÄÉ**

**‚òï ÂíñÂï°Âª£Âëä (15Áßí)**
Áî¢ÂìÅÔºöÁ≤æÂìÅÂíñÂï°Ë±Ü
ÈúÄÊ±ÇÔºöÂ±ïÁèæÊ∏ÖÊô®ÈÜíËÖ¶ÁöÑÂÑÄÂºèÊÑü
È¢®Ê†ºÔºöÊ∫´ÊöñÊ≤ªÊÑà
‚Üí 6ÂÄãÈè°È†≠ÔºöÊô®ÂÖâ‚ÜíÂíñÂï°Ë±ÜÁâπÂØ´‚ÜíÊ≤ñÊ≥°‚ÜíÈ¶ôÊ∞£‚ÜíÂìÅÂöê‚ÜíLogo

**üíÑ ÁæéÂ¶ùÂª£Âëä (30Áßí)**
Áî¢ÂìÅÔºöÂè£Á¥Ö
ÈúÄÊ±ÇÔºöËÅ∑Â†¥Â•≥ÊÄßÁöÑËá™‰ø°ËõªËÆä
È¢®Ê†ºÔºöÈÉΩÂ∏ÇÊôÇÂ∞ö
‚Üí 10ÂÄãÈè°È†≠ÔºöËæ¶ÂÖ¨ÂÆ§‚ÜíÂåñÂ¶ù‚ÜíËµ∞Ë∑Ø‚ÜíÊúÉË≠∞‚ÜíÂæÆÁ¨ë‚ÜíÁâπÂØ´

**üöó Ê±ΩËªäÂª£Âëä (60Áßí)**
Áî¢ÂìÅÔºöÈõªÂãïSUV
ÈúÄÊ±ÇÔºöÈÄ±Êú´ÂÆ∂Â∫≠Âá∫ÈÅäÁöÑÂø´Ê®ÇÊôÇÂÖâ
È¢®Ê†ºÔºöÊ∫´È¶®Ëá™ÁÑ∂
‚Üí 18ÂÄãÈè°È†≠ÔºöÂá∫Áôº‚ÜíÂÖ¨Ë∑Ø‚ÜíÈ¢®ÊôØ‚ÜíÊäµÈÅî‚ÜíÁé©ËÄç‚ÜíÂõûÁ®ã

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ÊÉ≥Ââµ‰ΩúÂì™Á®ÆÈ¢®Ê†ºÔºü`, [
        { text: '‚òï È°û‰ººÂíñÂï°Âª£Âëä', action: () => { adState.style = 'Ê∫´ÊöñÊ≤ªÊÑà'; startAdCreation(); } },
        { text: 'üíÑ È°û‰ººÁæéÂ¶ùÂª£Âëä', action: () => { adState.style = 'ÈÉΩÂ∏ÇÊôÇÂ∞ö'; startAdCreation(); } },
        { text: 'üöó È°û‰ººÊ±ΩËªäÂª£Âëä', action: () => { adState.style = 'Ê∫´È¶®Ëá™ÁÑ∂'; startAdCreation(); } },
        { text: 'üé® Ëá™ÂÆöÁæ©È¢®Ê†º', action: () => startAdCreation() }
    ]);
}

// Á¨¨1ËΩÆÔºö‰ø°ÊÅØÊî∂ÈõÜ
function startAdCreation() {
    adState.step = 1;
    
    addAIMessage(`üé¨ **Á¨¨1Ê≠•ÔºöÂëäË®¥Êàë‰Ω†ÁöÑÂª£ÂëäÈúÄÊ±Ç**

Ë´ãÊèê‰æõ‰ª•‰∏ã‰ø°ÊÅØÔºö

**1Ô∏è‚É£ Áî¢ÂìÅ/ÂìÅÁâå**ÔºàÂøÖÂ°´Ôºâ
‰∏äÂÇ≥Áî¢ÂìÅÂúñÁâáÔºåÊàñÊèèËø∞‰Ω†ÁöÑÁî¢ÂìÅ

**2Ô∏è‚É£ ‰∏ÄÂè•Ë©±ÈúÄÊ±Ç**ÔºàÂøÖÂ°´Ôºâ
‰æãÂ¶ÇÔºö„ÄåÂíñÂï°Âª£ÂëäÔºåÂ±ïÁèæÊ∏ÖÊô®ÈÜíËÖ¶ÁöÑÂÑÄÂºèÊÑü„Äç

**3Ô∏è‚É£ Âª£ÂëäÊôÇÈï∑**
<div class="ad-duration-select" style="display:flex;gap:8px;margin:12px 0;">
    <button class="duration-btn ${adState.duration === 15 ? 'active' : ''}" onclick="selectAdDuration(15)">
        <div style="font-size:20px;margin-bottom:4px;">‚ö°</div>
        <div>15Áßí</div>
        <div style="font-size:10px;color:var(--text2);">6ÂÄãÈè°È†≠</div>
    </button>
    <button class="duration-btn ${adState.duration === 30 ? 'active' : ''}" onclick="selectAdDuration(30)">
        <div style="font-size:20px;margin-bottom:4px;">üì±</div>
        <div>30Áßí</div>
        <div style="font-size:10px;color:var(--text2);">8-10Èè°È†≠</div>
    </button>
    <button class="duration-btn ${adState.duration === 60 ? 'active' : ''}" onclick="selectAdDuration(60)">
        <div style="font-size:20px;margin-bottom:4px;">üé¨</div>
        <div>60Áßí</div>
        <div style="font-size:10px;color:var(--text2);">12-18Èè°È†≠</div>
    </button>
</div>

<style>
.duration-btn {
    flex:1; padding:12px; background:var(--surface); border:1px solid var(--border); border-radius:8px;
    color:var(--text); cursor:pointer; text-align:center; transition:all 0.2s;
}
.duration-btn:hover { border-color:var(--accent); }
.duration-btn.active { background:rgba(227,27,35,0.15); border-color:var(--accent); color:var(--accent); }
</style>

**4Ô∏è‚É£ ÊºîÂì°ÔºàÂèØÈÅ∏Ôºâ**
‰∏äÂÇ≥ÊºîÂì°ÁÖßÁâáÔºåÊàñËÆìAIË®≠Ë®àËôõÊì¨ËßíËâ≤

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Ë´ãÂú®‰∏ãÊñπËº∏ÂÖ•‰Ω†ÁöÑ**‰∏ÄÂè•Ë©±ÈúÄÊ±Ç**Ôºå‰∏¶‰∏äÂÇ≥Áî¢ÂìÅÂúñÔºö`, [
        { text: 'üì∑ ‰∏äÂÇ≥Áî¢ÂìÅÂúñ', action: () => uploadAdImage('product') },
        { text: 'üë§ ‰∏äÂÇ≥ÊºîÂì°Âúñ', action: () => uploadAdImage('actor') },
        { text: 'ü§ñ AIË®≠Ë®àÊºîÂì°', action: () => designAIActor() }
    ]);
    
    // ËÆæÁΩÆÁ≠âÂæÖÁî®Êà∑ËæìÂÖ•Áä∂ÊÄÅ
    adState.waitingFor = 'requirement';
}

function selectAdDuration(duration) {
    adState.duration = duration;
    // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
    document.querySelectorAll('.duration-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.includes(duration + 'Áßí'));
    });
    
    addUserMessage(`ÈÅ∏ÊìáÂª£ÂëäÊôÇÈï∑Ôºö${duration}Áßí`);
    addAIMessage(`‚úÖ Â∑≤ÈÅ∏Êìá **${duration}Áßí** Âª£Âëä
    
Èè°È†≠Êï∏ÈáèÔºö${duration === 15 ? '6ÂÄã' : duration === 30 ? '8-10ÂÄã' : '12-18ÂÄã'}
Âπ≥ÂùáÊØèÈè°Ôºö${duration === 15 ? '2.5Áßí' : duration === 30 ? '3-3.5Áßí' : '3-5Áßí'}

Ë´ãÁπºÁ∫åËº∏ÂÖ•‰Ω†ÁöÑ‰∏ÄÂè•Ë©±ÈúÄÊ±ÇÔºåÊàñ‰∏äÂÇ≥Áî¢ÂìÅÂúñ„ÄÇ`);
}

function uploadAdImage(type) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // ËØªÂèñÂπ∂ÊòæÁ§∫ÂõæÁâá
        const reader = new FileReader();
        reader.onload = (e) => {
            const base64 = e.target.result;
            
            if (type === 'product') {
                adState.productImage = base64;
                addUserMessage(`üì∑ Â∑≤‰∏äÂÇ≥Áî¢ÂìÅÂúñÔºö${file.name}`);
                addAIMessage(`‚úÖ Áî¢ÂìÅÂúñÂ∑≤Êî∂Âà∞ÔºÅ

<img src="${base64}" style="max-width:200px;border-radius:8px;margin:8px 0;">

ÁèæÂú®Ë´ãÂëäË®¥Êàë‰Ω†ÁöÑ**‰∏ÄÂè•Ë©±ÈúÄÊ±Ç**Ôºå‰æãÂ¶ÇÔºö
„ÄåÂíñÂï°Âª£ÂëäÔºåÂ±ïÁèæÊ∏ÖÊô®ÈÜíËÖ¶ÁöÑÂÑÄÂºèÊÑüÔºåÁõÆÊ®ôÂèóÁúæÊòØÈÉΩÂ∏ÇÁôΩÈ†ò„Äç`);
            } else {
                adState.actorImages.push({ name: file.name, data: base64 });
                addUserMessage(`üë§ Â∑≤‰∏äÂÇ≥ÊºîÂì°ÂúñÔºö${file.name}`);
                addAIMessage(`‚úÖ ÊºîÂì°ÂúñÂ∑≤Êî∂Âà∞ÔºÅÔºàÂÖ± ${adState.actorImages.length} ÂºµÔºâ

<img src="${base64}" style="max-width:150px;border-radius:8px;margin:8px 0;">`, [
                    { text: 'üë§ ÁπºÁ∫å‰∏äÂÇ≥ÊºîÂì°', action: () => uploadAdImage('actor') },
                    { text: '‚úÖ ÊºîÂì°‰∏äÂÇ≥ÂÆåÊàê', action: () => {} }
                ]);
            }
        };
        reader.readAsDataURL(file);
    };
    input.click();
}

function designAIActor() {
    addAIMessage(`ü§ñ **AIÊºîÂì°Ë®≠Ë®à**

Ë´ãÊèèËø∞‰Ω†ÊÉ≥Ë¶ÅÁöÑÊºîÂì°ÂΩ¢Ë±°Ôºö

**Âπ¥ÈΩ°ÁØÑÂúç**: 20-25 / 25-30 / 30-40 / 40+
**ÊÄßÂà•**: Áî∑ / Â•≥ / ‰∏çÈôê
**È¢®Ê†º**: ÈôΩÂÖâÊ¥ªÊΩë / ÈÉΩÂ∏ÇÁ≤æËã± / ÈÑ∞ÂÆ∂Ë¶™Âàá / ÊôÇÂ∞öÊΩÆÊµÅ
**ÁâπÂæµ**: Â¶Ç„ÄåÁü≠È´Æ„ÄÅÊà¥ÁúºÈè°„ÄÅÂæÆÁ¨ë„Äç

‰æãÂ¶ÇÔºö„Äå25-30Ê≠≤ÈÉΩÂ∏ÇÂ•≥ÊÄßÔºåÁü≠È´ÆÔºåËÅ∑Ê•≠Ë£ùÔºåËá™‰ø°ÂæÆÁ¨ë„Äç

Ë´ãÂú®‰∏ãÊñπËº∏ÂÖ•ÊºîÂì°ÊèèËø∞Ôºö`);
    adState.waitingFor = 'actor_design';
}

// Â§ÑÁêÜÂπøÂëäÊ®°Âºè‰∏ãÁöÑÁî®Êà∑ËæìÂÖ•
async function handleAdInput(text) {
    if (adState.waitingFor === 'actor_design') {
        adState.actorImages.push({ name: 'AIË®≠Ë®à', description: text, type: 'ai_generated' });
        addAIMessage(`‚úÖ Â∑≤Ë®òÈåÑAIÊºîÂì°ÊèèËø∞Ôºö

„Äå${text}„Äç

Á®çÂæåÊúÉÊ†πÊìöÊ≠§ÊèèËø∞ÁîüÊàêÊºîÂì°ÂΩ¢Ë±°„ÄÇ`, [
            { text: 'üë§ Ê∑ªÂä†Êõ¥Â§öÊºîÂì°', action: () => designAIActor() },
            { text: '‚úÖ ÊºîÂì°Ë®≠ÂÆöÂÆåÊàê', action: () => checkAdReadyForStrategy() }
        ]);
        adState.waitingFor = 'requirement';
        return;
    }
    
    if (adState.waitingFor === 'requirement' || adState.step === 1) {
        adState.requirement = text;
        addAIMessage(`‚úÖ Êî∂Âà∞‰Ω†ÁöÑÈúÄÊ±ÇÔºö

„Äå${text}„Äç

**Áï∂ÂâçË®≠ÂÆö**Ôºö
- Áî¢ÂìÅÂúñÔºö${adState.productImage ? '‚úÖ Â∑≤‰∏äÂÇ≥' : '‚ùå Êú™‰∏äÂÇ≥'}
- ÊºîÂì°Ôºö${adState.actorImages.length > 0 ? `‚úÖ ${adState.actorImages.length} ÂÄã` : '‚ùå Êú™Ë®≠ÂÆö'}
- ÊôÇÈï∑Ôºö${adState.duration}Áßí
- È¢®Ê†ºÔºö${adState.style || 'ÂæÖAIÊé®Ëñ¶'}`, [
            { text: 'üöÄ ÈñãÂßãÁîüÊàêÂàÜÈè°', action: () => runAdStrategy() },
            { text: 'üì∑ Ë£úÂÖÖÁî¢ÂìÅÂúñ', action: () => uploadAdImage('product') },
            { text: 'üë§ Ë£úÂÖÖÊºîÂì°', action: () => uploadAdImage('actor') }
        ]);
        return;
    }
    
    // ÂÖ∂‰ªñÊÉÖÂÜµÔºöÂèØËÉΩÊòØ‰øÆÊîπÂèçÈ¶à
    if (adState.step === 5) {
        handleAdFeedback(text);
    }
}

function checkAdReadyForStrategy() {
    if (!adState.requirement) {
        addAIMessage(`Ë´ãÂÖàËº∏ÂÖ•‰Ω†ÁöÑ‰∏ÄÂè•Ë©±ÈúÄÊ±ÇÔºÅ`);
        return;
    }
    
    addAIMessage(`‚úÖ ‰ø°ÊÅØÊî∂ÈõÜÂÆåÊàêÔºÅ

**Âª£ÂëäÊ¶ÇË¶Å**Ôºö
- ÈúÄÊ±ÇÔºö${adState.requirement}
- ÊôÇÈï∑Ôºö${adState.duration}Áßí
- Áî¢ÂìÅÂúñÔºö${adState.productImage ? '‚úÖ' : '‚ùå (ÂèØÁ®çÂæåË£úÂÖÖ)'}
- ÊºîÂì°Ôºö${adState.actorImages.length}ÂÄã

Ê∫ñÂÇôÂ•Ω‰∫ÜÂóéÔºü`, [
        { text: 'üöÄ ÈñãÂßãÁîüÊàêÂàÜÈè°', action: () => runAdStrategy() },
        { text: '‚úèÔ∏è ‰øÆÊîπË®≠ÂÆö', action: () => startAdCreation() }
    ]);
}

// Á¨¨2ËΩÆÔºöÁ≠ñÁï•ÂàÜÊûê
async function runAdStrategy() {
    adState.step = 2;
    
    // ÊòæÁ§∫AgentÁä∂ÊÄÅ
    const persona = AD_AGENT_PERSONAS.ad_strategy;
    addAIMessage(`${persona.avatar} **${persona.name}** ${persona.phrases.start}

<div class="agent-progress">
    <div class="step active">1. ÊèêÁÖâÁî¢ÂìÅË≥£Èªû</div>
    <div class="step">2. ÊßãÂª∫ÂèóÁúæÁï´ÂÉè</div>
    <div class="step">3. ÊÉÖÁ∑íÈóúÈçµË©û</div>
    <div class="step">4. Êïò‰∫ãÂª∫Ë≠∞</div>
</div>

<style>
.agent-progress { display:flex; flex-direction:column; gap:6px; margin:12px 0; padding:12px; background:var(--surface); border-radius:8px; }
.agent-progress .step { font-size:12px; color:var(--text2); padding:4px 8px; }
.agent-progress .step.active { color:var(--accent); font-weight:500; }
.agent-progress .step.done { color:#4ade80; }
.agent-progress .step.done::before { content:'‚úì '; }
</style>`);
    
    try {
        // Ë∞ÉÁî®Á≠ñÁï•Agent
        const strategyPrompt = `‰ΩúÁÇ∫Âª£ÂëäÁ≠ñÁï•Â∏´ÔºåÂàÜÊûê‰ª•‰∏ãÂª£ÂëäÈúÄÊ±ÇÔºö

ÈúÄÊ±ÇÔºö${adState.requirement}
ÊôÇÈï∑Ôºö${adState.duration}Áßí
${adState.style ? `ÊúüÊúõÈ¢®Ê†ºÔºö${adState.style}` : ''}
${adState.actorImages.length > 0 ? `ÊºîÂì°Êï∏ÈáèÔºö${adState.actorImages.length}` : ''}

Ë´ãËº∏Âá∫JSONÊ†ºÂºèÁöÑÂâµÊÑèÁ∞°Â†±Ôºö
{
    "product_insight": "Áî¢ÂìÅÊ†∏ÂøÉË≥£ÈªûÔºà3-5ÂÄãÔºâ",
    "target_audience": {
        "age": "Âπ¥ÈΩ°ÁØÑÂúç",
        "gender": "ÊÄßÂà•",
        "lifestyle": "ÁîüÊ¥ªÊñπÂºè",
        "pain_points": ["ÁóõÈªû1", "ÁóõÈªû2"]
    },
    "emotion_keywords": ["ÊÉÖÁ∑í1", "ÊÉÖÁ∑í2", "ÊÉÖÁ∑í3"],
    "narrative_suggestion": "Êïò‰∫ãÊñπÂêëÂª∫Ë≠∞",
    "recommended_style": "Êé®Ëñ¶Ë¶ñË¶∫È¢®Ê†º",
    "main_slogan": "‰∏ªSloganÂª∫Ë≠∞"
}`;
        
        const result = await callAgent('concept', strategyPrompt, {});
        const brief = safeJSONParse(result, 'ad_strategy');
        adState.assets.creativeBrief = brief;
        
        // ÊòæÁ§∫Á≠ñÁï•ÁªìÊûú
        addAIMessage(`${persona.avatar} **Á≠ñÁï•ÂàÜÊûêÂÆåÊàêÔºÅ**

**üì¶ Áî¢ÂìÅË≥£Èªû**
${brief.product_insight || '(ÂàÜÊûê‰∏≠...)'}

**üë• ÁõÆÊ®ôÂèóÁúæ**
${brief.target_audience ? `
- Âπ¥ÈΩ°Ôºö${brief.target_audience.age || '25-35Ê≠≤'}
- ÊÄßÂà•Ôºö${brief.target_audience.gender || '‰∏çÈôê'}
- ÁîüÊ¥ªÊñπÂºèÔºö${brief.target_audience.lifestyle || 'ÈÉΩÂ∏ÇÁôΩÈ†ò'}
- ÁóõÈªûÔºö${(brief.target_audience.pain_points || []).join('„ÄÅ')}
` : '(ÂàÜÊûê‰∏≠...)'}

**üí≠ ÊÉÖÁ∑íÈóúÈçµË©û**
${(brief.emotion_keywords || ['Ê∫´Êöñ', 'Ê≤ªÊÑà', 'ÂÑÄÂºèÊÑü']).join(' ¬∑ ')}

**üìù Êïò‰∫ãÂª∫Ë≠∞**
${brief.narrative_suggestion || '(ÁîüÊàê‰∏≠...)'}

**üé® Êé®Ëñ¶È¢®Ê†º**
${brief.recommended_style || adState.style || 'Ê∫´ÊöñÊ≤ªÊÑà'}

**‚ú® ‰∏ªSlogan**
„Äå${brief.main_slogan || '(ÂæÖÁîüÊàê)'}„Äç

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Á≠ñÁï•ÊñπÂêëÁ¢∫Ë™çÂæåÔºåÂ∞áÈÄ≤ÂÖ•ÂàÜÈè°Ë®≠Ë®àÈöéÊÆµ„ÄÇ`, [
            { text: '‚úÖ Á¢∫Ë™çÔºåÈñãÂßãË®≠Ë®àÂàÜÈè°', action: () => runAdStoryboard() },
            { text: '‚úèÔ∏è Ë™øÊï¥Á≠ñÁï•ÊñπÂêë', action: () => adjustAdStrategy() },
            { text: 'üîÑ ÈáçÊñ∞ÁîüÊàê', action: () => runAdStrategy() }
        ]);
        
    } catch (err) {
        console.error('Á≠ñÁï•ÂàÜÊûêÂ§±Êïó:', err);
        addAIMessage(`‚ùå Á≠ñÁï•ÂàÜÊûêÈÅáÂà∞ÂïèÈ°åÔºåË´ãÈáçË©¶„ÄÇ`, [
            { text: 'üîÑ ÈáçË©¶', action: () => runAdStrategy() }
        ]);
    }
}

function adjustAdStrategy() {
    addAIMessage(`‚úèÔ∏è **Ë™øÊï¥Á≠ñÁï•ÊñπÂêë**

Ë´ãÂëäË®¥Êàë‰Ω†ÊÉ≥‰øÆÊîπ‰ªÄÈ∫ºÔºö
- ÁõÆÊ®ôÂèóÁúæ
- ÊÉÖÁ∑íÂü∫Ë™ø
- Êïò‰∫ãÊñπÂêë
- Slogan

ÊàñÁõ¥Êé•Ëº∏ÂÖ•‰Ω†ÁöÑÊÉ≥Ê≥ïÔºö`);
    adState.waitingFor = 'strategy_adjust';
}

// Á¨¨3ËΩÆÔºöÂàÜÈïúËÆæËÆ°
async function runAdStoryboard() {
    adState.step = 3;
    
    const visualPersona = AD_AGENT_PERSONAS.ad_visual;
    const copyPersona = AD_AGENT_PERSONAS.ad_copywriter;
    
    // ËÆ°ÁÆóÈïúÂ§¥Êï∞
    const shotCount = adState.duration === 15 ? 6 : adState.duration === 30 ? 10 : 15;
    
    addAIMessage(`${visualPersona.avatar} **${visualPersona.name}** + ${copyPersona.avatar} **${copyPersona.name}** ÂçîÂêåÂâµ‰Ωú‰∏≠...

Ê≠£Âú®Ë®≠Ë®à **${shotCount}** ÂÄãÈè°È†≠ÁöÑÂàÜÈè°ËÖ≥Êú¨...

<div class="agent-progress">
    <div class="step active">1. ÊãÜËß£Èè°È†≠ÁµêÊßã</div>
    <div class="step">2. Ë®≠Ë®àÊôØÂà•/ËßíÂ∫¶/ÈÅãÈè°</div>
    <div class="step">3. Êí∞ÂØ´Áï´Èù¢ÊèèËø∞</div>
    <div class="step">4. ÈÖçÁΩÆÊñáÊ°à/ÊóÅÁôΩ</div>
</div>`);
    
    try {
        const brief = adState.assets.creativeBrief || {};
        
        const storyboardPrompt = `‰ΩúÁÇ∫Âª£ÂëäÂàÜÈè°Â∏´ÔºåÁÇ∫‰ª•‰∏ãÂª£ÂëäË®≠Ë®àÂ∞àÊ•≠ÂàÜÈè°Ë°®Ôºö

„ÄêÂª£Âëä‰ø°ÊÅØ„Äë
ÈúÄÊ±ÇÔºö${adState.requirement}
ÊôÇÈï∑Ôºö${adState.duration}Áßí
Èè°È†≠Êï∏Ôºö${shotCount}ÂÄã
È¢®Ê†ºÔºö${brief.recommended_style || adState.style || 'Ê∫´ÊöñÊ≤ªÊÑà'}
SloganÔºö${brief.main_slogan || ''}

„ÄêÂâµÊÑèÁ∞°Â†±„Äë
Ë≥£ÈªûÔºö${brief.product_insight || ''}
ÂèóÁúæÔºö${JSON.stringify(brief.target_audience || {})}
ÊÉÖÁ∑íÔºö${(brief.emotion_keywords || []).join('„ÄÅ')}
Êïò‰∫ãÔºö${brief.narrative_suggestion || ''}

Ë´ãËº∏Âá∫JSONÊï∏ÁµÑÔºåÊØèÂÄãÈè°È†≠ÂåÖÂê´11ÂÄãÂ≠óÊÆµÔºö
[
    {
        "shot_id": "SC-01",
        "scene_type": "ÊôØÂà•ÔºöÁâπÂØ´/ËøëÊôØ/‰∏≠ÊôØ/ÂÖ®ÊôØ/ÈÅ†ÊôØ",
        "angle": "ËßíÂ∫¶ÔºöÂπ≥Ë¶ñ/‰ª∞Ë¶ñ/‰øØË¶ñ/ÊñúËßí",
        "camera_move": "ÈÅãÈè°ÔºöÂõ∫ÂÆö/Êé®/Êãâ/Êêñ/Áßª/Ë∑ü/Âçá/Èôç",
        "description": "Ë©≥Á¥∞Áï´Èù¢ÊèèËø∞Ôºà30-50Â≠óÔºâ",
        "product_show": "Áî¢ÂìÅÂá∫ÁèæÊñπÂºè",
        "actor": "ÊºîÂì°/ËßíËâ≤Âãï‰ΩúË°®ÊÉÖ",
        "props_scene": "ÈÅìÂÖ∑ÂíåÂ†¥ÊôØÂÖÉÁ¥†",
        "color_lighting": "Ëâ≤ÂΩ©ÂíåÂÖâÂΩ±",
        "copy": "ÊñáÊ°à/ÊóÅÁôΩ/Â∞çË©±",
        "duration": 3
    }
]

Âö¥Ê†ºËº∏Âá∫${shotCount}ÂÄãÈè°È†≠ÔºÅ`;

        const result = await callAgent('storyboard', storyboardPrompt, {});
        let storyboard = safeJSONParse(result, 'ad_storyboard');
        
        // Á°Æ‰øùÊòØÊï∞ÁªÑ
        if (!Array.isArray(storyboard)) {
            storyboard = storyboard.shots || storyboard.storyboard || [];
        }
        
        adState.assets.storyboard = storyboard;
        
        // ÊòæÁ§∫ÂàÜÈïúÁªìÊûú
        let storyboardHtml = storyboard.map((shot, i) => `
<div class="ad-shot-card">
    <div class="shot-header">
        <span class="shot-num">${shot.shot_id || `SC-${String(i+1).padStart(2,'0')}`}</span>
        <span class="shot-duration">${shot.duration || 3}Áßí</span>
    </div>
    <div class="shot-body">
        <div class="shot-row"><b>ÊôØÂà•</b> ${shot.scene_type || '-'}</div>
        <div class="shot-row"><b>ËßíÂ∫¶</b> ${shot.angle || '-'}</div>
        <div class="shot-row"><b>ÈÅãÈè°</b> ${shot.camera_move || '-'}</div>
        <div class="shot-row"><b>Áï´Èù¢</b> ${shot.description || '-'}</div>
        <div class="shot-row"><b>Áî¢ÂìÅ</b> ${shot.product_show || '-'}</div>
        <div class="shot-row"><b>ÊºîÂì°</b> ${shot.actor || '-'}</div>
        <div class="shot-row"><b>ÂÖâÂΩ±</b> ${shot.color_lighting || '-'}</div>
        <div class="shot-row"><b>ÊñáÊ°à</b> „Äå${shot.copy || '-'}„Äç</div>
    </div>
</div>
        `).join('');
        
        addAIMessage(`${visualPersona.avatar}${copyPersona.avatar} **ÂàÜÈè°Ë®≠Ë®àÂÆåÊàêÔºÅ**

ÂÖ± **${storyboard.length}** ÂÄãÈè°È†≠ÔºåÁ∏ΩÊôÇÈï∑ **${adState.duration}Áßí**

<style>
.ad-shot-card { background:var(--surface); border:1px solid var(--border); border-radius:8px; margin:8px 0; overflow:hidden; }
.shot-header { display:flex; justify-content:space-between; padding:8px 12px; background:var(--surface2); border-bottom:1px solid var(--border); }
.shot-num { color:var(--accent); font-weight:600; }
.shot-duration { color:var(--text2); font-size:12px; }
.shot-body { padding:10px 12px; font-size:12px; }
.shot-row { margin:4px 0; }
.shot-row b { color:var(--text2); display:inline-block; width:40px; }
</style>

${storyboardHtml}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ÂàÜÈè°Á¢∫Ë™çÂæåÂèØ‰ª•Ôºö
1. ÁîüÊàêÈ†êË¶ΩÂúñ
2. Â∞éÂá∫ÂàÜÈè°Ë°®
3. ÈÄ≤ÂÖ•FizzStudioË£Ω‰Ωú`, [
            { text: 'üñºÔ∏è ÁîüÊàêÈ†êË¶ΩÂúñ', action: () => generateAdPreviews() },
            { text: 'üìä Â∞éÂá∫Excel', action: () => exportAdStoryboard() },
            { text: '‚úèÔ∏è ‰øÆÊîπÊüêÂÄãÈè°È†≠', action: () => editAdShot() },
            { text: 'üöÄ Â∞éÂÖ•FizzStudio', action: () => importAdToFizzStudio() }
        ]);
        
        // ‰øùÂ≠òÈ°πÁõÆ
        saveAdProject();
        
    } catch (err) {
        console.error('ÂàÜÈè°Ë®≠Ë®àÂ§±Êïó:', err);
        addAIMessage(`‚ùå ÂàÜÈè°Ë®≠Ë®àÈÅáÂà∞ÂïèÈ°åÔºåË´ãÈáçË©¶„ÄÇ`, [
            { text: 'üîÑ ÈáçË©¶', action: () => runAdStoryboard() }
        ]);
    }
}

function editAdShot() {
    addAIMessage(`‚úèÔ∏è **‰øÆÊîπÈè°È†≠**

Ë´ãËº∏ÂÖ•Ë¶Å‰øÆÊîπÁöÑÂÖßÂÆπÔºåÊ†ºÂºèÔºö
„ÄåÈè°È†≠XÔºö‰øÆÊîπË¶ÅÊ±Ç„Äç

‰æãÂ¶ÇÔºö
- „ÄåÈè°È†≠3ÔºöÊää‰øØË¶ñÊîπÊàêÂπ≥Ë¶ñ„Äç
- „ÄåÈè°È†≠5ÔºöÊñáÊ°àÊîπÊàê'ÈñãÂïüÁæéÂ•Ω‰∏ÄÂ§©'„Äç
- „ÄåÈè°È†≠2ÔºöÂ¢ûÂä†Áî¢ÂìÅÁâπÂØ´„Äç`);
    adState.waitingFor = 'shot_edit';
}

// Á¨¨4ËΩÆÔºöÁîüÊàêÈ¢ÑËßà
async function generateAdPreviews() {
    adState.step = 4;
    
    addAIMessage(`üñºÔ∏è **ÁîüÊàêÈ†êË¶ΩÂúñ**

Ê≠£Âú®ÁÇ∫ ${adState.assets.storyboard.length} ÂÄãÈè°È†≠ÁîüÊàêÈ†êË¶ΩÂúñ...

‚ö†Ô∏è Ê≠§ÂäüËÉΩÈúÄË¶ÅÈÄ£Êé•ÂúñÂÉèÁîüÊàêAPIÔºàÂ¶ÇDALL-E„ÄÅMidjourney„ÄÅStable DiffusionÔºâ

Áï∂ÂâçÁÇ∫**È†êË¶ΩÊ®°Âºè**ÔºåÂ∞áËº∏Âá∫ÂúñÂÉèÁîüÊàêPrompt‰æõÊÇ®Âú®ÂÖ∂‰ªñÂπ≥Âè∞‰ΩøÁî®„ÄÇ`, [
        { text: 'üìã Ëº∏Âá∫ÊâÄÊúâPrompt', action: () => outputAdPrompts() },
        { text: 'üìä Áõ¥Êé•Â∞éÂá∫ÂàÜÈè°Ë°®', action: () => exportAdStoryboard() }
    ]);
}

function outputAdPrompts() {
    const storyboard = adState.assets.storyboard || [];
    const brief = adState.assets.creativeBrief || {};
    
    let promptsHtml = storyboard.map((shot, i) => {
        // ÊûÑÂª∫ÂõæÂÉèÁîüÊàêPrompt
        const imagePrompt = `${brief.recommended_style || 'cinematic'} advertisement shot, ${shot.scene_type || 'medium shot'}, ${shot.angle || 'eye level'}, ${shot.description || ''}, ${shot.color_lighting || 'soft natural lighting'}, professional commercial photography, 8k, high quality`;
        
        return `
<div class="prompt-card">
    <div class="prompt-header">
        <span>${shot.shot_id || `SC-${i+1}`}</span>
        <button class="copy-btn" onclick="copyText(this, \`${imagePrompt.replace(/`/g, "'")}\`)">üìã Ë§áË£Ω</button>
    </div>
    <div class="prompt-text">${imagePrompt}</div>
</div>
        `;
    }).join('');
    
    addAIMessage(`üìã **ÂúñÂÉèÁîüÊàêPrompts**

‰ª•‰∏ãPromptÂèØÁî®ÊñºMidjourney„ÄÅDALL-E„ÄÅStable DiffusionÁ≠âÂπ≥Âè∞Ôºö

<style>
.prompt-card { background:var(--surface); border:1px solid var(--border); border-radius:8px; margin:8px 0; overflow:hidden; }
.prompt-header { display:flex; justify-content:space-between; align-items:center; padding:8px 12px; background:var(--surface2); }
.prompt-text { padding:10px 12px; font-size:11px; color:var(--text2); line-height:1.5; font-family:monospace; }
.copy-btn { background:transparent; border:1px solid var(--border); color:var(--text2); padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px; }
.copy-btn:hover { border-color:var(--accent); color:var(--accent); }
</style>

${promptsHtml}`, [
        { text: 'üìä Â∞éÂá∫Excel', action: () => exportAdStoryboard() },
        { text: 'üöÄ Â∞éÂÖ•FizzStudio', action: () => importAdToFizzStudio() }
    ]);
}

// Á¨¨5ËΩÆÔºö‰øÆÊîπ‰∏éÂØºÂá∫
function handleAdFeedback(text) {
    // Ëß£ÊûêÁî®Êà∑ÁöÑ‰øÆÊîπËØ∑Ê±Ç
    const shotMatch = text.match(/Èè°È†≠(\d+)/i);
    if (shotMatch) {
        const shotNum = parseInt(shotMatch[1]) - 1;
        if (shotNum >= 0 && shotNum < adState.assets.storyboard.length) {
            addAIMessage(`‚úèÔ∏è Ê≠£Âú®‰øÆÊîπ **Èè°È†≠${shotNum + 1}**...

ÂéüÂÖßÂÆπÔºö
${JSON.stringify(adState.assets.storyboard[shotNum], null, 2)}

Ë´ãÁ®çÂÄôÔºåAIÊ≠£Âú®Ê†πÊìöÊÇ®ÁöÑË¶ÅÊ±Ç‰øÆÊîπ...`);
            
            // TODO: Ë∞ÉÁî®AI‰øÆÊîπÁâπÂÆöÈïúÂ§¥
            return;
        }
    }
    
    addAIMessage(`Ë´ãÊåáÂÆöË¶Å‰øÆÊîπÁöÑÈè°È†≠Á∑®ËôüÔºå‰æãÂ¶ÇÔºö„ÄåÈè°È†≠3ÔºöÊää‰øØË¶ñÊîπÊàêÂπ≥Ë¶ñ„Äç`);
}

// ÂØºÂá∫ÂπøÂëäÂàÜÈïúË°®
function exportAdStoryboard() {
    const storyboard = adState.assets.storyboard || [];
    if (storyboard.length === 0) {
        addAIMessage(`‚ùå ÈÇÑÊ≤íÊúâÂàÜÈè°ÂÖßÂÆπÂèØÂ∞éÂá∫ÔºÅ`);
        return;
    }
    
    // ÊûÑÂª∫CSV
    const headers = ['Èè°Ëôü', 'ÊôØÂà•', 'ËßíÂ∫¶', 'ÈÅãÈè°', 'Áï´Èù¢ÊèèËø∞', 'Áî¢ÂìÅÂá∫Áèæ', 'ÊºîÂì°Âãï‰Ωú', 'ÈÅìÂÖ∑Â†¥ÊôØ', 'Ëâ≤ÂΩ©ÂÖâÂΩ±', 'ÊñáÊ°àÊóÅÁôΩ', 'ÊôÇÈï∑'];
    const rows = storyboard.map(shot => [
        shot.shot_id || '',
        shot.scene_type || '',
        shot.angle || '',
        shot.camera_move || '',
        shot.description || '',
        shot.product_show || '',
        shot.actor || '',
        shot.props_scene || '',
        shot.color_lighting || '',
        shot.copy || '',
        shot.duration || 3
    ]);
    
    const csv = [headers, ...rows].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Âª£ÂëäÂàÜÈè°_${adState.duration}Áßí_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    addAIMessage(`‚úÖ ÂàÜÈè°Ë°®Â∑≤Â∞éÂá∫ÔºÅ

Êñá‰ª∂ÔºöÂª£ÂëäÂàÜÈè°_${adState.duration}Áßí_${new Date().toISOString().slice(0,10)}.csv
Èè°È†≠Êï∏Ôºö${storyboard.length}
ÊôÇÈï∑Ôºö${adState.duration}Áßí`, [
        { text: 'üöÄ Â∞éÂÖ•FizzStudio', action: () => importAdToFizzStudio() },
        { text: 'üÜï ÂâµÂª∫Êñ∞Âª£Âëä', action: () => startNewProject() }
    ]);
}

function importAdToFizzStudio() {
    addAIMessage(`üöÄ **Â∞éÂÖ•FizzStudio**

ÂàÜÈè°Ë°®Â∑≤Ê∫ñÂÇôÂ∞±Á∑íÔºÅ

FizzStudioÂ∞áÂπ´‰Ω†Ôºö
1. üñºÔ∏è Ê†πÊìöÂàÜÈè°ÁîüÊàêAIÂúñÂÉè
2. üé¨ ÁîüÊàêÂãïÊÖãË¶ñÈ†ªÁâáÊÆµ
3. üéµ Ê∑ªÂä†Èü≥Ê®ÇÂíåÈÖçÈü≥
4. ‚úÇÔ∏è Ëá™ÂãïÂâ™ËºØÂêàÊàê

ÈªûÊìä‰∏ãÊñπÊåâÈàïÂâçÂæÄFizzStudioÔºö`, [
        { text: 'üöÄ ÊâìÈñãFizzStudio', action: () => window.open('https://fizzdragon.com/studio', '_blank') },
        { text: 'üì• ÂÖàÂ∞éÂá∫Êú¨Âú∞', action: () => exportAdStoryboard() }
    ]);
}

// ‰øùÂ≠òÂπøÂëäÈ°πÁõÆ
function saveAdProject(name = null, silent = false) {
    const projects = getProjects();
    const projectName = name || `Âª£Âëä_${adState.duration}Áßí_${Date.now()}`;
    const projectId = currentProjectId || 'ad_' + Date.now();
    currentProjectId = projectId;
    
    projects[projectId] = {
        id: projectId,
        name: projectName,
        type: 'ad',  // Ê†áËÆ∞‰∏∫ÂπøÂëäÈ°πÁõÆ
        step: adState.step,
        timestamp: new Date().toISOString(),
        
        // ÂπøÂëäËÆæÂÆö
        duration: adState.duration,
        style: adState.style,
        requirement: adState.requirement,
        productImage: adState.productImage,
        actorImages: adState.actorImages,
        
        // ÂπøÂëäËµÑ‰∫ß
        adAssets: adState.assets
    };
    
    localStorage.setItem(getProjectsKey(), JSON.stringify(projects));
    renderProjectListByMode();
    
    if (!silent) {
        showSaveIndicator();
    }
    
    return projectId;
}

// ==================== ÂàùÂßãÂåñ ====================
// ÁôªÂá∫
function handleLogout() {
    const token = localStorage.getItem('fizzdragon_token');
    if (token) {
        fetch('/api/auth/logout', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        }).catch(() => {});
    }
    localStorage.removeItem('fizzdragon_token');
    localStorage.removeItem('fizzdragon_user');
    // window.location.href = 'login.html'; // ÂÜÖÊµãÊ®°ÂºèÔºöË∑≥ËøáÁôªÂΩï
}

// ÊòæÁ§∫ÂΩìÂâçÁî®Êà∑Âêç
function showCurrentUser() {
    const user = JSON.parse(localStorage.getItem('fizzdragon_user') || 'null');
    if (user && user.username) {
        const el = document.getElementById('currentUsername');
        if (el) el.textContent = `üë§ ${user.username}`;
    }
}

async function init() {
    console.log('üöÄ init() ÂºÄÂßã');
    showCurrentUser();
    
    // ÂàùÂßãÂåñÁî®Êà∑Âíå‰æßËæπÊ†è
    initUser();
    renderProjectList();
    
    // üîß ÂÖàÊòæÁ§∫Ê¨¢ËøéËØ≠Ôºå‰∏çÁ≠âAPIÊ£ÄÊµã
    showStartOptions();
    
    // ÂêéÂè∞Ê£ÄÊµãAPIÔºà‰∏çÈòªÂ°ûÊ¨¢ËøéËØ≠ÊòæÁ§∫Ôºâ
    detectAPI().catch(err => console.warn('APIÊ£ÄÊµãÂ§±Ë¥•:', err));
    
    console.log('üöÄ init() ÂÆåÊàê');
}

function showStartOptions() {
    console.log('üè† showStartOptions called, current state:', { mode: state.mode, step: state.step });
    
    // üîß ‰øÆÂ§çBug: Â¶ÇÊûúÂ∑≤ÁªèÊúâËøõË°å‰∏≠ÁöÑÂ∑•‰ΩúÔºå‰∏çË¶ÅÊòæÁ§∫ÂºÄÂßãÈÄâÈ°π
    if (state.mode && state.step > 0) {
        console.log('‚ö†Ô∏è showStartOptions blocked: workflow already in progress');
        continueImportProject();
        return;
    }
    
    // üîß Ê∏ÖÁ©∫ËÅäÂ§©ÂÆπÂô®ÔºåÁ°Æ‰øùËÉΩÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.innerHTML = '';
    
    // ‰ΩøÁî®Â§öËØ≠Ë®ÄÊ¨¢ËøéÊ∂àÊÅØÔºàÂåÖÂê´ÊåâÈíÆÔºâ
    showWelcome();
}

function showLearningResources() {
    addAIMessage(`üìö **FizzDragon Â≠∏ÁøíË≥áÊ∫êÂ∫´**

**Êïò‰∫ãÁµêÊßãÂ§ßÂ∏´**
‚Ä¢ Robert McKee„ÄäÊïÖ‰∫ã„Äã- ÂÉπÂÄºËΩâÊèõÁêÜË´ñ
‚Ä¢ John Truby„ÄäThe Anatomy of Story„Äã- 22Ê≠•ÁµêÊßã
‚Ä¢ Joseph Campbell„ÄäÂçÉÈù¢Ëã±ÈõÑ„Äã- Ëã±ÈõÑ‰πãÊóÖ
‚Ä¢ Christopher Vogler„Ää‰ΩúÂÆ∂‰πãË∑Ø„Äã- 12ÈöéÊÆµÊóÖÁ®ã
‚Ä¢ Blake Snyder„ÄäSave the Cat„Äã- 15ÁØÄÊãçË°®
‚Ä¢ Syd Field„ÄäScreenplay„Äã- ‰∏âÂπïÂäáÁµêÊßã

**ËßíËâ≤Ë®≠Ë®àÁêÜË´ñ**
‚Ä¢ K.M. Weiland„ÄäCreating Character Arcs„Äã
‚Ä¢ Tom Bancroft„ÄäCreating Characters with Personality„Äã
‚Ä¢ ÂøÉÁêÜÂ≠∏ÂãïÊ©üÁêÜË´ñ - Ê¨≤Êúõ/ÂâµÂÇ∑/ÂºßÁ∑ö

**Ë¶ñË¶∫Êïò‰∫ã**
‚Ä¢ Steven D. Katz„ÄäFilm Directing Shot by Shot„Äã
‚Ä¢ Gustavo Mercado„ÄäThe Filmmaker's Eye„Äã
‚Ä¢ Francis Glebas„ÄäDirecting the Story„Äã

**Â§ßÂ∏´Ë®™Ë´á**
‚Ä¢ Hitchcock/Truffaut ÈõªÂΩ±Ë®™Ë´áÈåÑ
‚Ä¢ Aaron Sorkin MasterClass
‚Ä¢ ÂÆÆÂ¥éÈßøÂâµ‰ΩúÁ≠ÜË®ò

**ÊñáÂåñÈ¢®Ê†º**
‚Ä¢ ‰∏≠ÂúãÈõªÂΩ±ÁæéÂ≠∏ - ÁéãÂÆ∂Ë°õ„ÄÅÊùéÂÆâ„ÄÅ‰æØÂ≠ùË≥¢
‚Ä¢ Êó•Êú¨ÂãïÁï´ - ÂÆÆÂ¥éÈßø„ÄÅÊñ∞Êµ∑Ë™†
‚Ä¢ Â•ΩËêäÂ°¢Á∂ìÂÖ∏ - Spielberg„ÄÅNolan
‚Ä¢ Ê≠êÊ¥≤ËóùË°ìÈõªÂΩ± - Fellini„ÄÅBergman

ÂÖ± **100+** Êú¨Â∞àÊ•≠Êõ∏Á±çËûçÂÖ•Á≥ªÁµ±„ÄÇ`, [
        { text: 'üîô ËøîÂõû', action: () => showStartOptions() }
    ]);
}

function resumeProgress(saved) {
    // ÊÅ¢Â§çÁä∂ÊÄÅ
    writeState.idea = saved.idea;
    writeState.interview = saved.interview;
    writeState.outline = saved.outline;
    writeState.chapters = saved.chapters || [];
    writeState.storyboard = saved.storyboard;
    state.mode = 'write';
    
    const chs = saved.outline?.chapters || [];
    const completed = saved.chapters?.length || 0;
    
    if (completed >= chs.length) {
        addAIMessage(`‚úÖ Â∞èË™™Â∑≤ÂÖ®ÈÉ®ÂÆåÊàêÔºÅ

**„Ää${saved.outline?.title}„Äã** - ${completed} Á´†

Êé•‰∏ã‰æÜÔºö`, [
            { text: 'üé¨ ËΩâÊèõÂàÜÈè°', action: () => convertToStoryboard() },
            { text: 'üì• Â∞éÂá∫Â∞èË™™', action: () => exportNovel() },
            { text: 'üì• Â∞éÂá∫Excel', action: () => exportExcel() }
        ]);
    } else {
        writeState.currentChapter = completed;
        addAIMessage(`‚ñ∂Ô∏è ÁπºÁ∫åÂâµ‰Ωú„Ää${saved.outline?.title}„Äã

**ÈÄ≤Â∫¶**: ${completed}/${chs.length} Á´†
**‰∏ã‰∏ÄÁ´†**: Á¨¨${completed + 1}Á´† ${chs[completed]?.title || ''}`, [
            { text: `üìù ÁπºÁ∫åÂØ´Á¨¨${completed + 1}Á´†`, action: () => writeNextChapter() },
            { text: 'üìñ Êü•ÁúãÂ§ßÁ∂±', action: () => showOutline() },
            { text: 'üì• Â∞éÂá∫Â∑≤ÂÆåÊàê', action: () => exportNovel() }
        ]);
    }
}

function showOutline() {
    const o = writeState.outline;
    const chs = o?.chapters || [];
    
    addAIMessage(`üìù **ÊïÖ‰∫ãÂ§ßÁ∂±**

**„Ää${o?.title || 'Êú™ÂëΩÂêç'}„Äã**
${o?.logline || ''}

---

${chs.map((c, i) => {
    const done = writeState.chapters[i] ? '‚úÖ' : '‚¨ú';
    return `${done} Á¨¨${c.number}Á´† ${c.title}`;
}).join('\n')}`);
}

// ==================== APIÊ£ÄÊµã ====================
async function detectAPI() {
    console.log('üîå detectAPI() ÂºÄÂßãÊ£ÄÊµã...');
    setStatus('loading', 'ÈÄ£Êé•‰∏≠...');
    
    for (const endpoint of API_ENDPOINTS) {
        console.log('üîå Â∞ùËØï:', endpoint);
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            const res = await fetch(`${endpoint}/health`, { 
                signal: controller.signal,
                mode: 'cors'
            });
            clearTimeout(timeoutId);
            
            if (res.ok) {
                const data = await res.json();
                API_BASE = endpoint;
                setStatus('online', `${data.providerName || 'AI'} Â∑≤ÈÄ£Êé•`);
                console.log('‚úÖ APIËøûÊé•ÊàêÂäü:', endpoint, data.provider);
                return;
            }
        } catch (e) {
            console.log('‚ùå APIÂ§±Ë¥•:', endpoint, e.message);
        }
    }
    setStatus('offline', 'ÈÄ£Êé•Â§±Êïó - Ë´ãÂà∑Êñ∞ÈáçË©¶');
    console.log('‚ùå ÊâÄÊúâAPIÁ´ØÁÇπÈÉΩÂ§±Ë¥•');
}

function setStatus(status, text) {
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    dot.className = 'status-dot ' + (status === 'online' ? '' : status === 'loading' ? 'loading' : 'offline');
    txt.textContent = text;
}

// ==================== Ââµ‰ΩúÊ®°Âºè ====================
// ÂÜô‰ΩúËÆøË∞àÈóÆÈ¢ò
const WRITE_QUESTIONS = [
    'ÈÄôÂÄãÊïÖ‰∫ãÊÉ≥ÂÇ≥ÈÅî‰ªÄÈ∫ºÊ†∏ÂøÉ‰∏ªÈ°åÊàñÊÉÖÊÑüÔºü',
    '‰∏ªËßíÊòØ‰ªÄÈ∫ºÊ®£ÁöÑ‰∫∫ÔºüÊúâ‰ªÄÈ∫ºÁâπÈªûÂíåÂº±ÈªûÔºü',
    '‰∏ªËßíÈù¢Ëá®ÁöÑÊúÄÂ§ßÊåëÊà∞ÊàñË°ùÁ™ÅÊòØ‰ªÄÈ∫ºÔºü',
    'ÊïÖ‰∫ãÁôºÁîüÂú®‰ªÄÈ∫ºÊôÇ‰ª£ÂíåÂú∞ÈªûÔºüÊúâ‰ªÄÈ∫ºÁç®ÁâπÊ∞õÂúçÔºü',
    '‰Ω†Â∏åÊúõËßÄÁúæÁúãÂÆåÂæåÊúâ‰ªÄÈ∫ºÊÑüÂèóÔºü',
    'ÊïÖ‰∫ãÂ§ßÊ¶ÇË¶ÅÂ§öÈï∑ÔºüÔºàÁü≠ÁØá10Á´†/‰∏≠ÁØá30Á´†/Èï∑ÁØá50-100Á´†Ôºâ',
    'ÊúâÂèÉËÄÉÁöÑ‰ΩúÂìÅÈ¢®Ê†ºÂóéÔºüÔºàÈõªÂΩ±„ÄÅÂäáÈõÜ„ÄÅÂ∞èË™™Ôºâ',
    'ÊúâÁâπÂà•ÊÉ≥Âä†ÂÖ•ÁöÑÂ†¥ÊôØÊàñÊÉÖÁØÄÂóéÔºü',
    '‰∏ªË¶ÅÈÖçËßíÊúâÂì™‰∫õÔºüÂíå‰∏ªËßíÊòØ‰ªÄÈ∫ºÈóú‰øÇÔºü',
    'ÊïÖ‰∫ãÊúâ‰ªÄÈ∫ºÁç®ÁâπÁöÑ‰∏ñÁïåËßÄË®≠ÂÆöÂóéÔºü'
];

function startWriteMode() {
    // Ê£ÄÊü•ÊòØÂê¶ÊúâËøõË°å‰∏≠ÁöÑÂ∑•‰Ωú
    if (hasActiveWork()) {
        confirmResetAndImport(() => {
            document.getElementById('chatContainer').innerHTML = '';
            doStartWriteMode();
        });
        return;
    }
    doStartWriteMode();
}

function doStartWriteMode() {
    state.mode = 'write';
    writeState.currentQuestion = -1;
    
    addAIMessage(`${t('writeMode')}

${t('writeModeDesc')}

${t('writeModePrompt')}`, [
        { text: t('randomGenerate'), action: () => randomIdea() },
        { text: t('seeExamples'), action: () => showExamples() }
    ]);
}

async function randomIdea() {
    addTypingIndicator();
    
    try {
        const result = await callAgent('concept', 'Ë´ãÈö®Ê©üÁîüÊàê‰∏ÄÂÄãÊúâË∂£ÁöÑÁü≠ÂäáÊïÖ‰∫ãÈùàÊÑüÔºåÈ°ûÂûãÂèØ‰ª•ÊòØÈùàÁï∞„ÄÅÊÑõÊÉÖ„ÄÅÊá∏Áñë„ÄÅÂ•áÂπªÁ≠âÔºåËÉåÊôØË®≠ÂÆöÂú®È¶ôÊ∏Ø„ÄÇËº∏Âá∫JSONÊ†ºÂºèÔºö{genre, setting, premise, hook}');
        removeTypingIndicator();
        
        const idea = safeJSONParse(result.replace(/```json\n?/g, '').replace(/```/g, ''), 'randomIdea');
        writeState.idea = idea;
        
        const genreLabel = currentLang === 'en' ? 'Genre' : 'È°ûÂûã';
        const settingLabel = currentLang === 'en' ? 'Setting' : 'ËÉåÊôØ';
        const storyLabel = currentLang === 'en' ? 'Story' : 'ÊïÖ‰∫ã';
        const hookLabel = currentLang === 'en' ? 'Hook' : '‰∫ÆÈªû';
        const likeItQ = currentLang === 'en' ? 'Like this direction?' : 'ÂñúÊ≠°ÈÄôÂÄãÊñπÂêëÂóéÔºü';
        
        addAIMessage(`${t('randomIdea')}

**${genreLabel}**: ${idea.genre || 'TBD'}
**${settingLabel}**: ${idea.setting || 'TBD'}  
**${storyLabel}**: ${idea.premise || idea.logline || 'TBD'}
**${hookLabel}**: ${idea.hook || 'TBD'}

${likeItQ}`, [
            { text: t('likeThis'), action: () => startWriteInterview() },
            { text: t('tryAnother'), action: () => randomIdea() },
            { text: t('editIt'), action: () => {} }
        ]);
    } catch (err) {
        removeTypingIndicator();
        recordError(err, 'Èö®Ê©üÈùàÊÑü');
        showFriendlyError(err, 'Èö®Ê©üÈùàÊÑü', () => randomIdea());
    }
}

function showExamples() {
    addAIMessage(`${t('storyExamples')}

**${t('supernatural')}**
${t('supernaturalEx')}

**${t('romance')}**
${t('romanceEx')}

**${t('mystery')}**
${t('mysteryEx')}

**${t('fantasy')}**
${t('fantasyEx')}

${t('pickOrInput')}`, [
        { text: 'üîÆ ' + (currentLang === 'en' ? 'Diner' : 'Ê∑±Â§úÈ£üÂ†Ç'), action: () => useExample(t('supernaturalEx').replace(/[„Äå„Äç""]/g, ''), t('supernatural')) },
        { text: 'üíï ' + (currentLang === 'en' ? 'MTR Love' : 'Ê∏ØÈêµÊÑõÊÉÖ'), action: () => useExample(t('romanceEx').replace(/[„Äå„Äç""]/g, ''), t('romance')) },
        { text: 'üîç ' + (currentLang === 'en' ? 'Mystery Floor' : 'Á•ûÁßòÊ®ìÂ±§'), action: () => useExample(t('mysteryEx').replace(/[„Äå„Äç""]/g, ''), t('mystery')) }
    ]);
}

function useExample(premise, genre) {
    addUserMessage(premise);
    writeState.idea = { premise, genre };
    startWriteInterview();
}

// ==================== ÂÜô‰ΩúËÆøË∞à ====================
function startWriteInterview() {
    writeState.currentQuestion = 0;
    writeState.interview = {};
    writeState.skipAll = false;  // üîß ÈáçÁΩÆË∑≥ËøáÊ†áÂøó
    
    addAIMessage(`Â•ΩÁöÑÔºÅÁèæÂú®ËÆìÊàë‰∫ÜËß£Êõ¥Â§öÁ¥∞ÁØÄÔºåÈÄôÊúÉÂπ´Âä©ÊàëÂØ´Âá∫Êõ¥Á¨¶Âêà‰Ω†ÊÉ≥Ê≥ïÁöÑÊïÖ‰∫ã„ÄÇ

üé§ **Ââµ‰ΩúË®™Ë´á** (${WRITE_QUESTIONS.length} ÂÄãÂïèÈ°å)`, [
        { text: '‚è≠Ô∏è Ë∑≥ÈÅéÊâÄÊúâË®™Ë´á', action: () => { 
            writeState.skipAll = true;  // üîß ËÆæÁΩÆË∑≥ËøáÊ†áÂøó
            writeState.currentQuestion = WRITE_QUESTIONS.length; 
            finishWriteInterview(); 
        } }
    ]);
    
    setTimeout(() => askWriteQuestion(), 500);
}

function askWriteQuestion() {
    // üîß Â¶ÇÊûúÂ∑≤Ë∑≥ËøáÊâÄÊúâÊàñÈóÆÈ¢òÂ∑≤ÂÆåÊàêÔºåÁõ¥Êé•ËøîÂõû
    if (writeState.skipAll || writeState.currentQuestion >= WRITE_QUESTIONS.length) {
        finishWriteInterview();
        return;
    }
    
    const q = WRITE_QUESTIONS[writeState.currentQuestion];
    const num = writeState.currentQuestion + 1;
    
    // Á∫ØÂØπËØùÂºèÔºö‰∏çÊòæÁ§∫ÊåâÈíÆ
    addAIMessage(`üé§ **Ââµ‰ΩúË®™Ë´á (${num}/${WRITE_QUESTIONS.length})**

${q}`, [
        { text: '‚è≠Ô∏è Ë∑≥ÈÅéÈÄôÈ°å', action: () => { handleUserInput('Ë∑≥ÈÅé'); } }
    ]);
}

async function finishWriteInterview() {
    // üîß ÂÖàËÆ©Áî®Êà∑ËÆæÁΩÆÂà∂‰ΩúËßÑÊ†º
    showWriteProductionSettings();
}

// üîß Âàõ‰ΩúÊ®°ÂºèÁöÑÂà∂‰ΩúËÆæÁΩÆ
function showWriteProductionSettings() {
    addAIMessage(`‚úÖ Ë®™Ë´áÂÆåÊàêÔºÅ

Âú®ÈñãÂßãÂâµ‰ΩúÂâçÔºåË´ãË®≠ÂÆö‰Ω†ÁöÑ**Áï™ÂäáË¶èÊ†º**Ôºö

üì∫ **ÈõÜÊï∏Ë®≠ÂÆö**
Ë´ãËº∏ÂÖ•ÈõÜÊï∏Ôºà‰æãÂ¶ÇÔºö50Ôºâ`, [
        { text: '10ÈõÜÔºàÁü≠ÁØáÔºâ', action: () => setWriteEpisodes(10) },
        { text: '24ÈõÜÔºàÊ®ôÊ∫ñÁï™Ôºâ', action: () => setWriteEpisodes(24) },
        { text: '50ÈõÜÔºàÈï∑ÁØáÔºâ', action: () => setWriteEpisodes(50) }
    ]);
    
    writeState.productionStep = 0;
}

function setWriteEpisodes(num) {
    state.production.episodes = num;
    addUserMessage(`${num} ÈõÜ`);
    
    addAIMessage(`‚úÖ ${num} ÈõÜ

‚è±Ô∏è **ÊØèÈõÜÊôÇÈï∑**
Ë´ãËº∏ÂÖ•ÊØèÈõÜÊôÇÈï∑ÔºàÂàÜÈêòÔºâ`, [
        { text: '2ÂàÜÈêòÔºàÁü≠Ë¶ñÈ†ªÔºâ', action: () => setWriteDuration(2) },
        { text: '5ÂàÜÈêòÔºàÊ®ôÊ∫ñÁï™Ôºâ', action: () => setWriteDuration(5) },
        { text: '10ÂàÜÈêòÔºàÂäáÊÉÖÁï™Ôºâ', action: () => setWriteDuration(10) }
    ]);
    
    writeState.productionStep = 1;
}

function setWriteDuration(min) {
    state.production.durationMin = min;
    addUserMessage(`${min} ÂàÜÈêò/ÈõÜ`);
    
    addAIMessage(`‚úÖ ${min} ÂàÜÈêò/ÈõÜ

üé¨ **Èè°È†≠ÂØÜÂ∫¶**
ÊØèÂàÜÈêòÂ§öÂ∞ëÂÄãÈè°È†≠Ôºü`, [
        { text: '8ÂÄã/ÂàÜÈêòÔºàÊÖ¢ÁØÄÂ•èÔºâ', action: () => setWriteShots(8) },
        { text: '12ÂÄã/ÂàÜÈêòÔºà‰∏≠Á≠âÔºâ', action: () => setWriteShots(12) },
        { text: '15ÂÄã/ÂàÜÈêòÔºàÂø´ÁØÄÂ•èÔºâ', action: () => setWriteShots(15) }
    ]);
    
    writeState.productionStep = 2;
}

function setWriteShots(shots) {
    state.production.shotsPerMin = shots;
    addUserMessage(`${shots} Èè°È†≠/ÂàÜÈêò`);
    
    const totalMin = state.production.episodes * state.production.durationMin;
    const totalShots = totalMin * state.production.shotsPerMin;
    
    addAIMessage(`üìä **Ë£Ω‰ΩúË¶èÊ†ºÁ¢∫Ë™ç**

‚Ä¢ ÈõÜÊï∏: ${state.production.episodes} ÈõÜ
‚Ä¢ ÊØèÈõÜÊôÇÈï∑: ${state.production.durationMin} ÂàÜÈêò
‚Ä¢ Èè°È†≠ÂØÜÂ∫¶: ${state.production.shotsPerMin} ÂÄã/ÂàÜÈêò
‚Ä¢ **Á∏ΩÊôÇÈï∑**: ${totalMin} ÂàÜÈêò
‚Ä¢ **È†êË®àÂàÜÈè°**: ${totalShots.toLocaleString()} ÂÄã

Á¢∫Ë™çÂæåÈñãÂßãÂâµ‰ΩúÔºÅ`, [
        { text: '‚úÖ Á¢∫Ë™çÔºåÈñãÂßãÂâµ‰Ωú', action: () => startWriteCreation() },
        { text: 'üîÑ ÈáçÊñ∞Ë®≠ÂÆö', action: () => showWriteProductionSettings() }
    ]);
    
    writeState.productionStep = 3;
}

async function startWriteCreation() {
    addAIMessage(`üöÄ **ÈñãÂßãÂâµ‰ΩúÔºÅ**

ÁèæÂú®ÈñãÂßãÂâµ‰ΩúÊµÅÁ®ãÔºö
1Ô∏è‚É£ ÁîüÊàêÈ´òÊ¶ÇÂøµ
2Ô∏è‚É£ Ë®≠Ë®àËßíËâ≤
3Ô∏è‚É£ Ë¶èÂäÉÁ´†ÁØÄÔºà${state.production.episodes}ÈõÜÔºâ
4Ô∏è‚É£ Ë®≠Ë®àÊúçÂåñÈÅì
5Ô∏è‚É£ ÂØ´ÂäáÊú¨

Ê≠£Âú®ÁîüÊàê**È´òÊ¶ÇÂøµ**...`);
    
    // ÂàáÊç¢Âà∞ÂØºÂÖ•Ê®°ÂºèÁöÑËµÑ‰∫ßÊµÅÁ®ã
    state.mode = 'write';
    state.step = 1;
    
    // ÂàõÂª∫È°πÁõÆ
    state.novelTitle = writeState.idea?.premise?.substring(0, 20) || 'Ââµ‰ΩúÈ†ÖÁõÆ';
    currentProjectId = null;
    saveProject(state.novelTitle, true);
    
    // Áî®ËÆøË∞àÂÜÖÂÆπÁîüÊàêÈ´òÊ¶ÇÂøµ
    await generateWriteConcept();
}

// ÂÜô‰ΩúÊ®°Âºè - ÁîüÊàêÈ´òÊ¶ÇÂøµ
async function generateWriteConcept() {
    // üîß ËØ¶ÁªÜÊ≠•È™§ÊòæÁ§∫
    const steps = [
        { text: 'üì° ÈÄ£Êé•Ê¶ÇÂøµÁîüÊàêÂô®...', done: false, current: true },
        { text: 'üìö ËºâÂÖ•narrative_complete Skill...', done: false },
        { text: 'ü§ñ Ë™øÁî®DeepSeekÊ®°Âûã...', done: false },
        { text: 'üìù Ëß£ÊûêJSONÁµêÊûú...', done: false }
    ];
    showAgentStatus('üí° Ê¶ÇÂøµÁîüÊàêÂô®', 'Ê≠£Âú®ÂàùÂßãÂåñ...', 'concept', steps);
    
    try {
        // Ê≠•È™§1ÂÆåÊàê
        steps[0].done = true; steps[0].current = false;
        steps[1].current = true;
        showAgentStatus('üí° Ê¶ÇÂøµÁîüÊàêÂô®', 'ËºâÂÖ•Êïò‰∫ãÁêÜË´ñÁü•Ë≠òÂ∫´...', 'concept', steps);
        
        const prompt = `Ê†πÊìö‰ª•‰∏ãÂâµ‰ΩúÊÑèÂúñÔºåÁîüÊàêÈ´òÊ¶ÇÂøµÂàÜÊûêÔºö

ÊïÖ‰∫ãÈùàÊÑüÔºö${JSON.stringify(writeState.idea)}
Ââµ‰ΩúËÄÖË®™Ë´áÔºö${JSON.stringify(writeState.interview)}

Ë´ãËº∏Âá∫JSONÔºö{genre, theme, tone, logline, hooks[], emotionalJourney}`;
        
        // Ê≠•È™§2ÂÆåÊàê
        steps[1].done = true; steps[1].current = false;
        steps[2].current = true;
        showAgentStatus('üí° Ê¶ÇÂøµÁîüÊàêÂô®', 'DeepSeekÊ≠£Âú®ÂàÜÊûêÊïÖ‰∫ãÁµêÊßã...', 'concept', steps);
        
        const result = await callAgent('concept', prompt);
        
        // Ê≠•È™§3ÂÆåÊàê
        steps[2].done = true; steps[2].current = false;
        steps[3].current = true;
        showAgentStatus('üí° Ê¶ÇÂøµÁîüÊàêÂô®', 'Ëß£ÊûêÈ´òÊ¶ÇÂøµJSON...', 'concept', steps);
        
        const concept = safeJSONParse(result, 'concept');
        
        // ÂÖ®ÈÉ®ÂÆåÊàê
        steps[3].done = true; steps[3].current = false;
        
        state.assets.concept = concept;
        state.novelTitle = concept.title || writeState.idea?.premise?.substring(0, 20) || 'Ââµ‰ΩúÈ†ÖÁõÆ';
        state.step = 1;
        
        removeTypingIndicator();
        hideAgentStatus();
        
        addAIMessage(`üí° **È´òÊ¶ÇÂøµÁîüÊàêÂÆåÊàêÔºÅ**

**È°ûÂûã**: ${concept.genre || '-'}
**‰∏ªÈ°å**: ${concept.theme || '-'}
**Âü∫Ë™ø**: ${concept.tone || '-'}
**Logline**: ${concept.logline || '-'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úÖ Â∑≤Â≠òÂÖ•È†ÖÁõÆË≥áÁî¢

Êé•‰∏ã‰æÜÈÄ≤Ë°å**ËßíËâ≤Ë®≠Ë®à**...`);
        
        saveProject(state.novelTitle, true);
        
        // ËøõÂÖ•ËßíËâ≤ËÆæËÆ°
        setTimeout(() => generateWriteCharacters(), 1000);
        
    } catch (err) {
        removeTypingIndicator();
        hideAgentStatus();
        showFriendlyError(err, 'È´òÊ¶ÇÂøµÁîüÊàê', () => generateWriteConcept());
    }
}

// ÂÜô‰ΩúÊ®°Âºè - ÁîüÊàêËßíËâ≤
async function generateWriteCharacters() {
    state.step = 2;
    
    // üîß ËØ¶ÁªÜÊ≠•È™§ÊòæÁ§∫
    const steps = [
        { text: 'üì° ÈÄ£Êé•ËßíËâ≤Ë®≠Ë®àÂ∏´...', done: false, current: true },
        { text: 'üìö ËºâÂÖ•character_complete Skill...', done: false },
        { text: 'ü§ñ Ë™øÁî®DeepSeekÊ®°Âûã...', done: false },
        { text: 'üìù Ëß£ÊûêËßíËâ≤JSON...', done: false }
    ];
    showAgentStatus('üë§ ËßíËâ≤Ë®≠Ë®àÂ∏´', 'Ê≠£Âú®ÂàùÂßãÂåñ...', 'character', steps);
    
    try {
        steps[0].done = true; steps[0].current = false;
        steps[1].current = true;
        showAgentStatus('üë§ ËßíËâ≤Ë®≠Ë®àÂ∏´', 'ËºâÂÖ•ËßíËâ≤Ë®≠Ë®àÊñπÊ≥ïË´ñ...', 'character', steps);
        
        const prompt = `Ê†πÊìö‰ª•‰∏ãÈ´òÊ¶ÇÂøµÔºåË®≠Ë®à‰∏ªË¶ÅËßíËâ≤Ôºö

È´òÊ¶ÇÂøµÔºö${JSON.stringify(state.assets.concept)}
ÊïÖ‰∫ãÈùàÊÑüÔºö${JSON.stringify(writeState.idea)}
Ââµ‰ΩúËÄÖË®™Ë´áÔºö${JSON.stringify(writeState.interview)}

Ë´ãË®≠Ë®à3-5ÂÄã‰∏ªË¶ÅËßíËâ≤ÔºåËº∏Âá∫JSONÔºö{characters: [{name, role, bio, appearance, prompt}]}`;
        
        steps[1].done = true; steps[1].current = false;
        steps[2].current = true;
        showAgentStatus('üë§ ËßíËâ≤Ë®≠Ë®àÂ∏´', 'DeepSeekÊ≠£Âú®Ë®≠Ë®àËßíËâ≤...', 'character', steps);
        
        const result = await callAgent('character', prompt);
        
        steps[2].done = true; steps[2].current = false;
        steps[3].current = true;
        showAgentStatus('üë§ ËßíËâ≤Ë®≠Ë®àÂ∏´', 'Ëß£ÊûêËßíËâ≤Ë≥áÊñô...', 'character', steps);
        
        const charData = safeJSONParse(result, 'characters');
        steps[3].done = true; steps[3].current = false;
        
        state.assets.characters = charData.characters || [];
        
        removeTypingIndicator();
        hideAgentStatus();
        
        const charList = state.assets.characters.map(c => `‚Ä¢ **${c.name}** (${c.role})`).join('\n');
        
        addAIMessage(`üë§ **ËßíËâ≤Ë®≠Ë®àÂÆåÊàêÔºÅ**

${charList}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úÖ Â∑≤Â≠òÂÖ•È†ÖÁõÆË≥áÁî¢

Êé•‰∏ã‰æÜÈÄ≤Ë°å**Ë£Ω‰ΩúË¶èÊ†ºË®≠ÂÆö**...`);
        
        saveProject(null, true);
        
        // ËøõÂÖ•Âà∂‰ΩúËßÑÊ†ºËÆæÁΩÆÔºàÂíåÂØºÂÖ•Ê®°ÂºèÂÖ±Áî®Ôºâ
        setTimeout(() => runProductionEvaluation(), 1000);
        
    } catch (err) {
        removeTypingIndicator();
        hideAgentStatus();
        showFriendlyError(err, 'ËßíËâ≤Ë®≠Ë®à', () => generateWriteCharacters());
    }
}

// ==================== ÁîüÊàêÂ§ßÁ∫≤ ====================
async function generateOutline() {
    addProgressCard('ÁîüÊàêÊïÖ‰∫ãÂ§ßÁ∂±', 0);
    
    try {
        const context = {
            idea: writeState.idea,
            interview: writeState.interview
        };
        
        const prompt = `Ê†πÊìö‰ª•‰∏ãÂâµ‰ΩúËÄÖË®™Ë´áÔºåÁîüÊàê‰∏ÄÂÄãÂÆåÊï¥ÁöÑÊïÖ‰∫ãÂ§ßÁ∂±„ÄÇ

ÊïÖ‰∫ãÈùàÊÑüÔºö${JSON.stringify(writeState.idea)}
Ââµ‰ΩúËÄÖÂõûÁ≠îÔºö${JSON.stringify(writeState.interview)}

Ë´ãËº∏Âá∫JSONÊ†ºÂºèÔºö
{
  "title": "ÊïÖ‰∫ãÊ®ôÈ°å",
  "logline": "‰∏ÄÂè•Ë©±Ê¶ÇÊã¨",
  "genre": "È°ûÂûã",
  "setting": "ËÉåÊôØË®≠ÂÆö",
  "theme": "Ê†∏ÂøÉ‰∏ªÈ°å",
  "chapters": [
    {"number": 1, "title": "Á´†ÁØÄÊ®ôÈ°å", "summary": "ÂäáÊÉÖÊ¶ÇË¶ÅÔºà50Â≠óÔºâ", "hook": "Á´†ÁØÄ‰∫ÆÈªû"}
  ]
}

Ë¶ÅÊ±ÇÔºö
- Ê†πÊìöÊïÖ‰∫ãË§áÈõúÂ∫¶ÔºåÂèØ‰ª•10-100Á´†
- ÊØèÁ´†ÊúâÊòéÁ¢∫ÁöÑÂäáÊÉÖÊé®ÈÄ≤
- ÊØè5-10Á´†‰∏ÄÂÄãÂ∞èÈ´òÊΩÆ
- ÁµêÂ∞æË¶ÅÊúâÂ§ßÈ´òÊΩÆÂíåÊî∂Â∞æ
- Â¶ÇÊûúÊòØÈï∑ÁØáÔºåÂÖàË¶èÂäÉÂ§ßÁ∂±ÁµêÊßãÔºàÂ∫èÂπï/ÈñãÁ´Ø/ÁôºÂ±ï/È´òÊΩÆ/ÁµêÂ±ÄÔºâ`;
        
        updateProgress(30);
        const result = await callAgent('narrative', prompt, context);
        updateProgress(100);
        
        writeState.outline = safeJSONParse(result.replace(/```json\n?/g, '').replace(/```/g, ''), 'outline');
        
        removeProgressCard();
        
        const o = writeState.outline;
        const chs = o.chapters || [];
        
        addAIMessage(`üìù **ÊïÖ‰∫ãÂ§ßÁ∂±**

**„Ää${o.title || 'Êú™ÂëΩÂêç'}„Äã**
${o.logline || ''}

**È°ûÂûã**: ${o.genre || 'ÂæÖÂÆö'}
**ËÉåÊôØ**: ${o.setting || 'ÂæÖÂÆö'}
**‰∏ªÈ°å**: ${o.theme || 'ÂæÖÂÆö'}

---

**Á´†ÁØÄË¶èÂäÉ** (ÂÖ±${chs.length}Á´†)Ôºö

${chs.slice(0, 5).map(c => `**Á¨¨${c.number}Á´† ${c.title}**\n${c.summary}`).join('\n\n')}
${chs.length > 5 ? `\n\n...ÈÇÑÊúâ ${chs.length - 5} Á´†` : ''}

---

Á¢∫Ë™çÂ§ßÁ∂±ÂæåÔºåÊàëÊúÉ**ÈÄêÁ´†ÂØ´‰Ωú**„ÄÇ`, [
            { text: '‚úÖ ÈñãÂßãÂØ´Á¨¨1Á´†', action: () => startWritingChapters() },
            { text: 'üìù Ë™øÊï¥Â§ßÁ∂±', action: () => showAdjustWarning('outline', 3) },
            { text: 'üíæ ‰øùÂ≠òÂ§ßÁ∂±', action: () => saveProgress('outline') }
        ]);
        
    } catch (err) {
        removeProgressCard();
        recordError(err, 'Â§ßÁ∂±ÁîüÊàê');
        showFriendlyError(err, 'Â§ßÁ∂±ÁîüÊàê', () => generateOutline());
    }
}

// ==================== ÈÄêÁ´†ÂÜô‰Ωú ====================
async function startWritingChapters() {
    writeState.currentChapter = 0;
    writeState.chapters = [];
    await writeNextChapter();
}

async function writeNextChapter() {
    const outline = writeState.outline;
    const chs = outline.chapters || [];
    
    if (writeState.currentChapter >= chs.length) {
        finishWriting();
        return;
    }
    
    const ch = chs[writeState.currentChapter];
    const num = writeState.currentChapter + 1;
    const total = chs.length;
    
    addProgressCard(`ÂØ´‰ΩúÁ¨¨${num}Á´†Ôºö${ch.title}`, 0);
    
    try {
        // ========== Êô∫ËÉΩ‰∏ä‰∏ãÊñáÊûÑÂª∫ ==========
        
        // 1. ÊïÖ‰∫ãÂ§ßÁ∫≤ÔºàÁ≤æÁÆÄÁâàÔºâ
        const outlineContext = `„ÄêÊïÖ‰∫ãÂ§ßÁ∂±„Äë
Ê®ôÈ°åÔºö${outline.title}
È°ûÂûãÔºö${outline.genre || ''}
‰∏ªÈ°åÔºö${outline.theme || ''}
‰∏ÄÂè•Ë©±Ôºö${outline.logline || ''}`;
        
        // 2. ‰∫∫Áâ©Â∞è‰º†ÔºàÂ¶ÇÊûúÊúâÔºâ
        let characterContext = '';
        if (state.characters?.characters) {
            const mainChars = state.characters.characters.slice(0, 3);
            characterContext = `\n„Äê‰∏ªË¶Å‰∫∫Áâ©„Äë\n` + mainChars.map(c => 
                `${c.name}(${c.role || 'ËßíËâ≤'}): ${c.psychology?.want || ''} / ${c.psychology?.wound || ''}`
            ).join('\n');
        }
        
        // 3. ÂâçÊñáÂõûÈ°æÔºàÊúÄËøë2-3Á´†ÁöÑÁªìÂ∞æÔºâ
        let prevContext = '';
        if (writeState.chapters.length > 0) {
            const recentChapters = writeState.chapters.slice(-3);
            prevContext = `\n„ÄêÂâçÊÉÖÂõûÈ°ß„Äë\n` + recentChapters.map(c => {
                const ending = c.content.slice(-800);  // ÂèñÊØèÁ´†ÊúÄÂêé800Â≠ó
                return `Á¨¨${c.number}Á´†„Ää${c.title}„ÄãÁµêÂ∞æÔºö\n${ending}`;
            }).join('\n---\n');
        }
        
        // 4. ÂâçÂêéÁ´†ËäÇÈ¢ÑËßà
        let surroundingContext = '\n„ÄêÁ´†ÁØÄËÑàÁµ°„Äë\n';
        if (num > 1) {
            const prevCh = chs[num - 2];
            surroundingContext += `‰∏ä‰∏ÄÁ´†(${num-1})Ôºö${prevCh.title} - ${prevCh.summary}\n`;
        }
        surroundingContext += `‚ñ∂ Êú¨Á´†(${num})Ôºö${ch.title} - ${ch.summary}\n`;
        if (num < total) {
            const nextCh = chs[num];
            surroundingContext += `‰∏ã‰∏ÄÁ´†(${num+1})Ôºö${nextCh.title} - ${nextCh.summary}\n`;
        }
        surroundingContext += `Á´†ÁØÄ‰∫ÆÈªûÔºö${ch.hook || 'ÁÑ°'}`;
        
        // 5. ÊûÑÂª∫ÂÆåÊï¥prompt
        const prompt = `‰Ω†ÊòØÂ∞àÊ•≠Â∞èË™™‰ΩúÂÆ∂„ÄÇË´ãÊí∞ÂØ´Á¨¨${num}Á´†ÔºàÂÖ±${total}Á´†Ôºâ„ÄÇ

${outlineContext}
${characterContext}
${surroundingContext}
${prevContext ? prevContext.substring(0, 2000) : ''}

„ÄêÂØ´‰ΩúË¶ÅÊ±Ç„Äë
- Â≠óÊï∏Ôºö1500-2500Â≠ó
- ÂåÖÂê´Â†¥ÊôØÊèèÂØ´„ÄÅÂ∞çË©±„ÄÅÂøÉÁêÜÊ¥ªÂãï
- ‰øùÊåÅ‰∫∫Áâ©ÊÄßÊ†º‰∏ÄËá¥
- ÊâøÊé•‰∏äÊñáÔºåÈã™Â¢ä‰∏ãÊñá
- Á´†ÁØÄÁµêÂ∞æÁïôÊá∏ÂøµÊàñÊÉÖÊÑüÈ´òÊΩÆ
- Áõ¥Êé•Ëº∏Âá∫Ê≠£ÊñáÔºå‰∏çË¶ÅÊ®ôÈ°åÂíåËß£Èáã`;

        updateProgress(50);
        const result = await callAgent('screenwriter', prompt);
        updateProgress(100);
        
        // ‰øùÂ≠òÁ´†ËäÇ
        writeState.chapters.push({
            number: num,
            title: ch.title,
            content: result,
            timestamp: new Date().toISOString()
        });
        
        // ========== Ëá™Âä®‰øùÂ≠ò ==========
        autoSaveProject();
        
        removeProgressCard();
        
        const wordsWritten = result.length;
        const totalWords = writeState.chapters.reduce((sum, c) => sum + c.content.length, 0);
        
        addAIMessage(`‚úÖ **Á¨¨${num}Á´†„Ää${ch.title}„Äã** ÂÆåÊàêÔºÅ

${result.substring(0, 400)}...

---
üìä Êú¨Á´† ${wordsWritten} Â≠ó | Á∏ΩË®à ${totalWords.toLocaleString()} Â≠ó
üìà ÈÄ≤Â∫¶ ${num}/${total} Á´† (${Math.round(num/total*100)}%)`, [
            { text: `‚ñ∂Ô∏è ÁπºÁ∫åÁ¨¨${num + 1}Á´†`, action: () => { writeState.currentChapter++; writeNextChapter(); } },
            { text: 'üìñ Èñ±ËÆÄÂÖ®Êñá', action: () => showChapterContent(num) },
            { text: '‚úèÔ∏è ‰øÆÊîπÊú¨Á´†', action: () => editChapter(num) },
            { text: '‚è∏Ô∏è Êö´ÂÅú', action: () => pauseWriting() }
        ]);
        
    } catch (err) {
        removeProgressCard();
        // ‰øùÂ≠òÂ∑≤ÊúâËøõÂ∫¶
        autoSaveProject();
        const info = friendlyError(err, 'Á´†ÁØÄÂØ´‰Ωú');
        addAIMessage(`${info.title} - Á¨¨${num}Á´†

**ÂèØËÉΩÂéüÂõ†**: ${info.reason}

‚úÖ **Â•ΩÊ∂àÊÅØ**: Â∑≤Ëá™Âãï‰øùÂ≠òÂâç${num-1}Á´†ÁöÑÈÄ≤Â∫¶ÔºÅ

**Âª∫Ë≠∞**:
${info.solutions.slice(0, 2).map(s => `‚Ä¢ ${s}`).join('\n')}`, [
            { text: 'üîÑ ÈáçË©¶Êú¨Á´†', action: () => writeNextChapter() },
            { text: 'üìÇ Êü•ÁúãÂ∑≤‰øùÂ≠òÈ†ÖÁõÆ', action: () => showProjectList() }
        ]);
    }
}

// Ëá™Âä®‰øùÂ≠òÔºàÈùôÈªòÔºâ
function autoSaveProject() {
    const projects = getProjects();
    const projectName = writeState.outline?.title || `È†ÖÁõÆ_${Date.now()}`;
    const projectId = projectName.replace(/\s+/g, '_').toLowerCase();
    
    projects[projectId] = {
        id: projectId,
        name: projectName,
        stage: 'write',
        timestamp: new Date().toISOString(),
        idea: writeState.idea,
        interview: writeState.interview,
        outline: writeState.outline,
        chapters: writeState.chapters,
        writeStoryboard: writeState.storyboard,
        novel: state.novel,
        novelTitle: state.novelTitle,
        concept: state.concept,
        characters: state.characters
    };
    
    localStorage.setItem(getProjectsKey(), JSON.stringify(projects));
    console.log(`üíæ Ëá™Âãï‰øùÂ≠ò: ${projectName} (${writeState.chapters.length}Á´†)`);
}

// ÊòæÁ§∫Á´†ËäÇÂÜÖÂÆπ
function showChapterContent(num) {
    const ch = writeState.chapters.find(c => c.number === num);
    if (!ch) return;
    
    addAIMessage(`üìñ **Á¨¨${num}Á´†„Ää${ch.title}„Äã**

${ch.content}

---
Â≠óÊï∏Ôºö${ch.content.length}`, [
        { text: '‚úèÔ∏è ‰øÆÊîπ', action: () => editChapter(num) },
        { text: 'üîô ËøîÂõû', action: () => {} }
    ]);
}

// ÁºñËæëÁ´†ËäÇ
function editChapter(num) {
    const ch = writeState.chapters.find(c => c.number === num);
    if (!ch) return;
    
    addAIMessage(`‚úèÔ∏è **Á∑®ËºØÁ¨¨${num}Á´†**

Ë´ãÁõ¥Êé•Ëº∏ÂÖ•‰øÆÊîπÊÑèË¶ãÊàñÊñ∞ÁöÑÂÖßÂÆπÔºö
- Ëº∏ÂÖ•„ÄåÈáçÂØ´„Äç- ÈáçÊñ∞ÁîüÊàêÊï¥Á´†
- Ëº∏ÂÖ•‰øÆÊîπÊÑèË¶ã - AIÂπ´‰Ω†‰øÆÊîπ
- Áõ¥Êé•Ë≤º‰∏äÊñ∞ÂÖßÂÆπ - ÊõøÊèõÊï¥Á´†`, [
        { text: 'üîÑ ÈáçÂØ´Êï¥Á´†', action: () => rewriteChapter(num) },
        { text: 'üîô ÂèñÊ∂à', action: () => {} }
    ]);
    
    // ËÆæÁΩÆÁºñËæëÁä∂ÊÄÅ
    state.editingChapter = num;
}

async function rewriteChapter(num) {
    // Âà†Èô§ËøôÁ´†ÔºåÈáçÊñ∞ÂÜô
    writeState.chapters = writeState.chapters.filter(c => c.number !== num);
    writeState.currentChapter = num - 1;
    await writeNextChapter();
}

function pauseWriting() {
    saveProgress('chapters');
    addAIMessage(`‚è∏Ô∏è Â∑≤Êö´ÂÅúÂØ´‰Ωú

**ÈÄ≤Â∫¶**: ${writeState.chapters.length}/${writeState.outline?.chapters?.length || 0} Á´†Â∑≤ÂÆåÊàê

Èö®ÊôÇÂèØ‰ª•ÁπºÁ∫åÔºö`, [
        { text: '‚ñ∂Ô∏è ÁπºÁ∫åÂØ´‰Ωú', action: () => { writeState.currentChapter++; writeNextChapter(); } },
        { text: 'üé¨ ÂÖàÁîüÊàêÂàÜÈè°', action: () => convertToStoryboard() },
        { text: 'üì• Â∞éÂá∫Â∑≤ÂÆåÊàêÁ´†ÁØÄ', action: () => exportNovel() }
    ]);
}

function finishWriting() {
    const totalWords = writeState.chapters.reduce((sum, c) => sum + c.content.length, 0);
    
    addAIMessage(`üéâ **Â∞èË™™ÂØ´‰ΩúÂÆåÊàêÔºÅ**

**„Ää${writeState.outline?.title || 'Êú™ÂëΩÂêç'}„Äã**
- ÂÖ± ${writeState.chapters.length} Á´†
- Á¥Ñ ${totalWords.toLocaleString()} Â≠ó

Êé•‰∏ã‰æÜÂèØ‰ª•Ôºö`, [
        { text: 'üé¨ ËΩâÊèõÊàêÂàÜÈè°', action: () => convertToStoryboard() },
        { text: 'üì• Â∞éÂá∫Â∞èË™™', action: () => exportNovel() },
        { text: 'üíæ ‰øùÂ≠òÂÖ®ÈÉ®', action: () => saveProgress('complete') }
    ]);
}

// ==================== ËΩ¨ÂàÜÈïú ====================
async function convertToStoryboard() {
    addProgressCard('ËΩâÊèõÁÇ∫ÂàÜÈè°Ë°®', 0);
    
    try {
        const novelText = writeState.chapters.map(c => `„ÄêÁ¨¨${c.number}Á´† ${c.title}„Äë\n${c.content}`).join('\n\n');
        
        state.novel = novelText;
        state.novelTitle = writeState.outline?.title || 'Êú™ÂëΩÂêç';
        state.concept = writeState.outline;
        
        updateProgress(30);
        
        // ÂÖàÁîüÊàêËßíËâ≤
        const charResult = await callAgent('character', novelText.substring(0, 4000));
        state.characters = safeJSONParse(charResult.replace(/```json\n?/g, '').replace(/```/g, ''), 'characters');
        
        updateProgress(60);
        
        // ÁîüÊàêÂàÜÈïú
        const sbResult = await callAgent('storyboard', novelText.substring(0, 3000), {
            concept: state.concept,
            characters: state.characters
        });
        
        writeState.storyboard = sbResult;
        state.storyboard = sbResult;
        
        updateProgress(100);
        removeProgressCard();
        
        addAIMessage(`üé¨ **ÂàÜÈè°Ë°®ÁîüÊàêÂÆåÊàêÔºÅ**

ËßíËâ≤Ôºö${(state.characters?.characters || []).length} ÂÄã
ÂàÜÈè°ÔºöÂ∑≤ÁîüÊàê

ÂÖ®ÈÉ®Ë≥áÊñôÊ∫ñÂÇôÂ∞±Á∑íÔºÅ`, [
            { text: 'üì• Â∞éÂá∫Excel', action: () => exportExcel() },
            { text: 'üì• Â∞éÂá∫JSON', action: () => exportAll() },
            { text: 'üíæ ‰øùÂ≠òÈ†ÖÁõÆ', action: () => saveProgress('complete') }
        ]);
        
    } catch (err) {
        removeProgressCard();
        recordError(err, 'ÂàÜÈè°ËΩâÊèõ');
        showFriendlyError(err, 'ÂàÜÈè°ËΩâÊèõ', () => convertToStoryboard());
    }
}

// ==================== È°πÁõÆÁÆ°ÁêÜ ====================
// Áî®Êà∑Á∫ßÈ°πÁõÆÈöîÁ¶ª - ÊØè‰∏™Áî®Êà∑ÊúâÁã¨Á´ãÁöÑÈ°πÁõÆÂ≠òÂÇ®
function getProjectsKey() {
    // ‰ΩøÁî®Âõ∫ÂÆökeyÔºåÁ°Æ‰øùÈ°πÁõÆÊåÅ‰πÖÂåñÔºàÂÜÖÊµãÈò∂ÊÆµ‰∏çÂÅöÁî®Êà∑ÈöîÁ¶ªÔºâ
    return 'fizzdragon_projects';
}

function getProjects() {
    try {
        const userKey = getProjectsKey();
        let projects = JSON.parse(localStorage.getItem(userKey) || '{}');
        
        // üîß ËøÅÁßªÊóßÊï∞ÊçÆÔºöÊ£ÄÊü•ÊóßÁöÑÂÖ®Â±ÄkeyÊòØÂê¶ÊúâÊï∞ÊçÆ
        const oldKey = 'fizzdragon_projects';
        const oldData = localStorage.getItem(oldKey);
        if (oldData && Object.keys(projects).length === 0) {
            try {
                const oldProjects = JSON.parse(oldData);
                if (Object.keys(oldProjects).length > 0) {
                    console.log('üì¶ ÂèëÁé∞ÊóßÈ°πÁõÆÊï∞ÊçÆÔºåÊ≠£Âú®ËøÅÁßªÂà∞Áî®Êà∑Á©∫Èó¥...');
                    projects = oldProjects;
                    localStorage.setItem(userKey, JSON.stringify(projects));
                    // ËøÅÁßªÂêéÂà†Èô§ÊóßkeyÔºàÂèØÈÄâÔºå‰øùÁïôÂ§á‰ªΩÔºâ
                    // localStorage.removeItem(oldKey);
                    console.log(`‚úÖ Â∑≤ËøÅÁßª ${Object.keys(projects).length} ‰∏™È°πÁõÆ`);
                }
            } catch (e) {
                console.warn('ËøÅÁßªÊóßÊï∞ÊçÆÂ§±Ë¥•:', e);
            }
        }
        
        return projects;
    } catch {
        return {};
    }
}

function saveProject(name = null, silent = false) {
    const projects = getProjects();
    const projectName = name || state.novelTitle || writeState.outline?.title || `È†ÖÁõÆ_${Date.now()}`;
    
    // ‰ΩøÁî®Áé∞ÊúâÈ°πÁõÆIDÊàñÂàõÂª∫Êñ∞ÁöÑ
    const projectId = currentProjectId || projectName.replace(/\s+/g, '_').toLowerCase() + '_' + Date.now();
    currentProjectId = projectId;
    
    projects[projectId] = {
        id: projectId,
        name: projectName,
        stage: state.mode === 'write' ? 'write' : 'import',
        step: state.step,
        timestamp: new Date().toISOString(),
        
        // È°πÁõÆËµÑ‰∫ßÔºàÊñ∞ÁªìÊûÑÔºâ
        assets: state.assets,
        production: state.production,
        
        // ÂÜô‰ΩúÊ®°ÂºèÊï∞ÊçÆÔºàÂÖºÂÆπÔºâ
        idea: writeState.idea,
        interview: writeState.interview,
        outline: writeState.outline,
        chapters: writeState.chapters,
        writeStoryboard: writeState.storyboard,
        
        // ÂØºÂÖ•Ê®°ÂºèÊï∞ÊçÆÔºàÂÖºÂÆπÔºâ
        novel: state.novel,
        novelTitle: state.novelTitle,
        concept: state.concept || state.assets?.concept,
        importInterview: state.interview,
        characters: state.characters || state.assets?.characters,
        storyboard: state.storyboard
    };
    
    localStorage.setItem(getProjectsKey(), JSON.stringify(projects));
    
    // Êõ¥Êñ∞Â∑¶‰æßËæπÊ†è
    renderProjectList();
    
    // Êõ¥Êñ∞Âè≥‰æßËµÑ‰∫ßÈù¢Êùø
    updateAssetsPanel();
    
    // Êõ¥Êñ∞Ê†áÈ¢ò
    document.getElementById('headerTitle').textContent = projectName;
    
    if (!silent) {
        console.log(`üíæ È†ÖÁõÆÂ∑≤‰øùÂ≠ò: ${projectName}`);
        // ÊòæÁ§∫‰øùÂ≠òÊèêÁ§∫ÔºàÁü≠ÊöÇÔºâ
        showSaveIndicator();
    }
    
    return projectId;
}

// ==================== Ëá™Âä®‰øùÂ≠ò ====================
let autoSaveTimer = null;
let lastSaveState = '';

function startAutoSave() {
    // ÊØè30ÁßíÊ£ÄÊü•Âπ∂Ëá™Âä®‰øùÂ≠ò
    if (autoSaveTimer) clearInterval(autoSaveTimer);
    autoSaveTimer = setInterval(() => {
        if (currentProjectId && state.novel) {
            const currentState = JSON.stringify({
                step: state.step,
                assets: state.assets,
                production: state.production
            });
            
            // Âè™ÊúâÁä∂ÊÄÅÂèòÂåñÊó∂Êâç‰øùÂ≠ò
            if (currentState !== lastSaveState) {
                saveProject(null, true);
                lastSaveState = currentState;
                console.log('üîÑ Ëá™Âãï‰øùÂ≠ò');
            }
        }
    }, 30000);
}

function showSaveIndicator() {
    const indicator = document.createElement('div');
    indicator.style.cssText = 'position:fixed;top:20px;right:20px;background:#1a1a22;border:1px solid #2d2d3a;padding:8px 16px;border-radius:8px;color:#4ade80;font-size:12px;z-index:9999;animation:fadeInOut 2s forwards;';
    indicator.textContent = 'üíæ Â∑≤‰øùÂ≠ò';
    document.body.appendChild(indicator);
    setTimeout(() => indicator.remove(), 2000);
}

// È°µÈù¢Âä†ËΩΩÊó∂ÂêØÂä®Ëá™Âä®‰øùÂ≠ò
document.addEventListener('DOMContentLoaded', startAutoSave);

// È°µÈù¢ÂÖ≥Èó≠Ââç‰øùÂ≠ò
window.addEventListener('beforeunload', () => {
    if (currentProjectId && state.novel) {
        saveProject(null, true);
    }
});

function showProjectList() {
    const projects = getProjects();
    const list = Object.values(projects);
    
    if (list.length === 0) {
        addAIMessage(`üìÇ **È†ÖÁõÆÂàóË°®**

ÈÇÑÊ≤íÊúâ‰øùÂ≠òÁöÑÈ†ÖÁõÆ„ÄÇ

ÈñãÂßãÂâµ‰ΩúÂæåÈªûÊìä„Äåüíæ ‰øùÂ≠ò„ÄçÂç≥ÂèØ‰øùÂ≠òÈ†ÖÁõÆ„ÄÇ`, [
            { text: '‚úçÔ∏è Ââµ‰ΩúÂ∞èË™™', action: () => startWriteMode() },
            { text: 'üìÑ Â∞éÂÖ•Â∞èË™™', action: () => document.getElementById('fileInput').click() }
        ]);
        return;
    }
    
    const projectList = list
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 10)
        .map(p => {
            const date = new Date(p.timestamp).toLocaleDateString();
            const chapters = p.chapters?.length || 0;
            return `**${p.name}** (${date})\n   ${chapters}Á´† | ${p.stage === 'write' ? 'Ââµ‰Ωú' : 'Â∞éÂÖ•'}`;
        })
        .join('\n\n');
    
    addAIMessage(`üìÇ **È†ÖÁõÆÂàóË°®** (${list.length}ÂÄã)

${projectList}

ÈÅ∏ÊìáË¶ÅÊâìÈñãÁöÑÈ†ÖÁõÆÔºö`, list.slice(0, 5).map(p => ({
        text: `üìñ ${p.name}`,
        action: () => loadProject(p.id)
    })).concat([
        { text: 'üÜï Êñ∞Âª∫È†ÖÁõÆ', action: () => showStartOptions() },
        { text: 'üóëÔ∏è ÁÆ°ÁêÜÈ†ÖÁõÆ', action: () => manageProjects() }
    ]));
}

function loadProject(projectId) {
    const projects = getProjects();
    const p = projects[projectId];
    
    if (!p) {
        addAIMessage(`‚ùå È†ÖÁõÆ‰∏çÂ≠òÂú®`);
        return;
    }
    
    // ÊÅ¢Â§çÂÜô‰ΩúÊ®°ÂºèÁä∂ÊÄÅ
    writeState.idea = p.idea;
    writeState.interview = p.interview;
    writeState.outline = p.outline;
    writeState.chapters = p.chapters || [];
    writeState.storyboard = p.writeStoryboard;
    
    // ÊÅ¢Â§çÂØºÂÖ•Ê®°ÂºèÁä∂ÊÄÅ
    state.novel = p.novel;
    state.novelTitle = p.novelTitle || p.name;
    state.concept = p.concept;
    state.interview = p.importInterview;
    state.characters = p.characters;
    state.storyboard = p.storyboard;
    state.mode = p.stage;
    state.step = p.step || 0;
    
    // üîß ÊÅ¢Â§çÈ°πÁõÆËµÑ‰∫ßÔºàÂÖàÊ∏ÖÁ©∫ÂÜçÂä†ËΩΩÔºåÁ°Æ‰øù‰∏çÊ±°ÊüìÔºâ
    state.assets = {
        concept: null,
        characters: [],
        chapters: [],
        costumes: null,
        scripts: {},
        storyboards: {}
    };
    
    if (p.assets) {
        state.assets = p.assets;
    }
    
    // üîß ÊÅ¢Â§çÁîü‰∫ßËßÑÊ†ºÔºàÂÖàÊ∏ÖÁ©∫ÂÜçÂä†ËΩΩÔºâ
    state.production = {
        episodes: 10,
        durationMin: 3,
        shotsPerMin: 10
    };
    
    if (p.production) {
        state.production = p.production;
    }
    
    // ÁªüËÆ°ËµÑ‰∫ß
    const assets = p.assets || {};
    const chapterCount = assets.chapters?.length || 0;
    const charCount = assets.characters?.length || 0;
    const scriptCount = Object.keys(assets.scripts || {}).length;
    const sbCount = Object.keys(assets.storyboards || {}).length;
    const stepNames = ['ÂæÖÈñãÂßã', 'È´òÊ¶ÇÂøµ', 'ËßíËâ≤', 'Á´†ÁØÄ', 'ÊúçÂåñÈÅì', 'ÂäáÊú¨', 'ÂàÜÈè°'];
    
    // üîß Êõ¥Êñ∞Âè≥‰æßËµÑ‰∫ßÈù¢Êùø
    updateAssetsPanel();
    
    // Êõ¥Êñ∞Ê†áÈ¢ò
    document.getElementById('headerTitle').textContent = p.name;
    
    // Êõ¥Êñ∞ÂΩìÂâçÈ°πÁõÆID
    currentProjectId = projectId;
    
    addAIMessage(`üìñ **Â∑≤ËºâÂÖ•È†ÖÁõÆ**

**„Ää${p.name}„Äã**

üì¶ **È†ÖÁõÆË≥áÁî¢**:
‚Ä¢ È´òÊ¶ÇÂøµ: ${assets.concept ? '‚úÖ' : '‚ùå'}
‚Ä¢ ËßíËâ≤: ${charCount} ÂÄã
‚Ä¢ Á´†ÁØÄ: ${chapterCount} ÈõÜ
‚Ä¢ ÂäáÊú¨: ${scriptCount}/${chapterCount} ÈõÜ
‚Ä¢ ÂàÜÈè°: ${sbCount}/${chapterCount} ÈõÜ
‚Ä¢ Áï∂ÂâçÈöéÊÆµ: ${stepNames[p.step] || 'ÂæÖÈñãÂßã'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Ëº∏ÂÖ•„ÄåÁπºÁ∫å„ÄçÁπºÁ∫åÊµÅÁ®ãÔºåÊàñ„ÄåÈ†ÖÁõÆË≥áÁî¢„ÄçÊü•ÁúãË©≥ÊÉÖ`);
}

function continueWriteProject() {
    const chs = writeState.outline?.chapters || [];
    const completed = writeState.chapters?.length || 0;
    const total = chs.length;
    const totalWords = writeState.chapters?.reduce((sum, c) => sum + (c.content?.length || 0), 0) || 0;
    
    // üîß Èò≤Ê≠¢Á©∫È°πÁõÆÊòæÁ§∫"Â∑≤ÂÆåÊàê"
    if (total === 0) {
        addAIMessage(`‚ö†Ô∏è **ÈÇÑÊ≤íÊúâÂÖßÂÆπ**

Ë´ãÂÖàÔºö
1. Â∞éÂÖ•Â∞èË™™ÊñáÊú¨
2. ÊàñÈñãÂßãÊñ∞ÁöÑÂâµ‰Ωú

ÈªûÊìä‰∏ãÊñπÊåâÈàïÈñãÂßãÔºö`, [
            { text: 'üìÑ Â∞éÂÖ•Â∞èË™™', action: () => document.getElementById('novelInput').click() },
            { text: '‚úçÔ∏è Êñ∞Âª∫Ââµ‰Ωú', action: () => startNewProject() }
        ]);
        return;
    }
    
    if (completed >= total && totalWords > 0) {
        addAIMessage(`‚úÖ **Â∞èË™™Â∑≤ÂÆåÊàêÔºÅ**

**„Ää${writeState.outline?.title || 'Êú™ÂëΩÂêç'}„Äã**
- ÂÖ± ${total} Á´†
- Á¥Ñ ${totalWords.toLocaleString()} Â≠ó

ÂèØ‰ª•ËΩâÊèõÂàÜÈè°ÊàñÂ∞éÂá∫Ôºö`, [
            { text: 'üé¨ ËΩâÊèõÂàÜÈè°', action: () => convertToStoryboard() },
            { text: 'üì• Â∞éÂá∫Â∞èË™™', action: () => exportNovel() },
            { text: 'üìä Â∞éÂá∫Excel', action: () => exportExcel() }
        ]);
    } else {
        writeState.currentChapter = completed;
        const nextCh = chs[completed];
        
        addAIMessage(`‚ñ∂Ô∏è **ÁπºÁ∫åÂØ´‰Ωú**

**„Ää${writeState.outline?.title}„Äã**

üìä ÈÄ≤Â∫¶Ôºö${completed}/${total} Á´† (${Math.round(completed/total*100)}%)
üìù Â∑≤ÂØ´Ôºö${totalWords.toLocaleString()} Â≠ó
üìñ ‰∏ã‰∏ÄÁ´†ÔºöÁ¨¨${completed + 1}Á´†„Ää${nextCh?.title || ''}„Äã

ÊàëÊúÉËá™ÂãïÂä†ËºâÔºö
1. ‚úÖ ÊïÖ‰∫ãÂ§ßÁ∂±
2. ‚úÖ ‰∫∫Áâ©Â∞èÂÇ≥
3. ‚úÖ ÂâçÊñáÂõûÈ°ß
4. ‚úÖ Á´†ÁØÄËÑàÁµ°

Ê∫ñÂÇôÂ•ΩÁπºÁ∫å‰∫ÜÂóéÔºü`, [
            { text: `‚ñ∂Ô∏è ÈñãÂßãÂØ´Á¨¨${completed + 1}Á´†`, action: () => writeNextChapter() },
            { text: 'üìñ Êü•ÁúãÂ§ßÁ∂±', action: () => showOutline() },
            { text: 'üìö Êü•ÁúãÂ∑≤ÂØ´Á´†ÁØÄ', action: () => showWrittenChapters() }
        ]);
    }
}

function showWrittenChapters() {
    const chapters = writeState.chapters || [];
    
    if (chapters.length === 0) {
        addAIMessage(`ÈÇÑÊ≤íÊúâÂØ´‰ªª‰ΩïÁ´†ÁØÄ„ÄÇ`);
        return;
    }
    
    const list = chapters.map(c => 
        `**Á¨¨${c.number}Á´†„Ää${c.title}„Äã** (${c.content?.length || 0}Â≠ó)`
    ).join('\n');
    
    addAIMessage(`üìö **Â∑≤ÂÆåÊàêÁ´†ÁØÄ**

${list}

ÈªûÊìäÊü•ÁúãË©≥ÊÉÖÔºö`, chapters.slice(-5).map(c => ({
        text: `üìñ Á¨¨${c.number}Á´†`,
        action: () => showChapterContent(c.number)
    })));
}

function continueImportProject() {
    console.log('continueImportProject:', { step: state.step, novel: !!state.novel, concept: !!state.concept, chapters: !!state.chapters, characters: !!state.characters, storyboard: !!state.storyboard });
    
    // ‰øùÂ≠òÂΩìÂâçËøõÂ∫¶
    saveProject();
    
    // üîß Ê†πÊçÆÂΩìÂâçÁä∂ÊÄÅËá™Âä®ÁªßÁª≠‰∏ã‰∏ÄÊ≠•
    if (state.storyboard && state.storyboard.shots?.length > 0) {
        const shotCount = state.storyboard.shots?.length || 0;
        addAIMessage(`‚úÖ **ÂàÜÈè°Ë°®Â∑≤ÂÆåÊàêÔºÅ** ÂÖ± ${shotCount} ÂÄãÈè°È†≠

ÂèØ‰ª•Â∞éÂá∫ÊàñÈáçÊñ∞ÁîüÊàêÔºö`, [
            { text: 'üì• Â∞éÂá∫Excel', action: () => exportExcel() },
            { text: 'üì• Â∞éÂá∫JSON', action: () => exportAll() },
            { text: 'üîÑ ÈáçÊñ∞ÁîüÊàêÂàÜÈè°', action: () => runStoryboardStep() }
        ]);
    } else if (state.characters?.characters?.length > 0) {
        const charCount = state.characters.characters.length;
        addAIMessage(`üë§ Â∑≤Ë®≠Ë®à ${charCount} ÂÄãËßíËâ≤ÔºåÊ≠£Âú®ÁîüÊàêÂàÜÈè°...`);
        setTimeout(() => runStoryboardStep(), 500);
    } else if (state.chapters?.chapters?.length > 0) {
        const chapterCount = state.chapters.chapters.length;
        addAIMessage(`üìù Â∑≤Ë¶èÂäÉ ${chapterCount} Á´†ÔºåÊ≠£Âú®Ë®≠Ë®àËßíËâ≤...`);
        setTimeout(() => runCharacterStep(), 500);
    } else if (state.concept?.genre || state.concept?.theme) {
        addAIMessage(`üìñ Ê¶ÇÂøµÂàÜÊûêÂÆåÊàêÔºåÊ≠£Âú®Ë¶èÂäÉÁ´†ÁØÄ...`);
        setTimeout(() => runChaptersStep(), 500);
    } else if (state.novel) {
        addAIMessage(`üìÑ Â∞èË™™Â∑≤Â∞éÂÖ•Ôºà${state.novel.length}Â≠óÔºâÔºåÊ≠£Âú®ÂàÜÊûêÊ¶ÇÂøµ...`);
        setTimeout(() => runConceptStep(), 500);
    } else {
        addAIMessage(`üìù Ë´ãÈÅ∏ÊìáÈñãÂßãÊñπÂºèÔºö`, [
            { text: 'üìÑ Â∞éÂÖ•Â∞èË™™Êñá‰ª∂', action: () => document.getElementById('fileInput').click() },
            { text: '‚úçÔ∏è AIÂπ´ÊàëÂØ´Â∞èË™™', action: () => startWriteMode() },
            { text: 'üìù Áõ¥Êé•Ëº∏ÂÖ•ÊïÖ‰∫ã', action: () => addAIMessage('Ë´ãÁõ¥Êé•Ëº∏ÂÖ•ÊàñÁ≤òË≤º‰Ω†ÁöÑÊïÖ‰∫ãÂÖßÂÆπÔºà100Â≠ó‰ª•‰∏äÔºâ') }
        ]);
    }
}

function manageProjects() {
    const projects = getProjects();
    const list = Object.values(projects);
    
    addAIMessage(`üóëÔ∏è **ÁÆ°ÁêÜÈ†ÖÁõÆ**

ÈÅ∏ÊìáË¶ÅÂà™Èô§ÁöÑÈ†ÖÁõÆÔºö`, list.map(p => ({
        text: `‚ùå Âà™Èô§ ${p.name}`,
        action: () => deleteProject(p.id)
    })).concat([
        { text: 'üîô ËøîÂõûÂàóË°®', action: () => showProjectList() }
    ]));
}

function renameProject(projectId, currentName) {
    const newName = prompt('Ëº∏ÂÖ•Êñ∞ÁöÑÈ†ÖÁõÆÂêçÁ®±Ôºö', currentName);
    if (newName && newName.trim() && newName !== currentName) {
        const projects = getProjects();
        if (projects[projectId]) {
            projects[projectId].name = newName.trim();
            localStorage.setItem(getProjectsKey(), JSON.stringify(projects));
            renderProjectList();
            
            // Êõ¥Êñ∞Ê†áÈ¢òÂ¶ÇÊûúÊòØÂΩìÂâçÈ°πÁõÆ
            if (projectId === currentProjectId) {
                document.getElementById('headerTitle').textContent = newName.trim();
                state.title = newName.trim();
            }
        }
    }
}

// ==================== ÊãñÊãΩÊéíÂ∫è ====================
let draggedProjectId = null;

function handleDragStart(e, projectId) {
    draggedProjectId = projectId;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.project-item').forEach(el => el.classList.remove('drag-over'));
    draggedProjectId = null;
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const item = e.target.closest('.project-item');
    if (item && item.dataset.projectId !== draggedProjectId) {
        item.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    const item = e.target.closest('.project-item');
    if (item) item.classList.remove('drag-over');
}

function handleDrop(e, targetProjectId) {
    e.preventDefault();
    const item = e.target.closest('.project-item');
    if (item) item.classList.remove('drag-over');
    
    if (!draggedProjectId || draggedProjectId === targetProjectId) return;
    
    const projects = getProjects();
    const list = Object.values(projects).sort((a, b) => (a.order || 0) - (b.order || 0));
    
    // ÊâæÂà∞ÊãñÊãΩÈ°πÂíåÁõÆÊ†áÈ°πÁöÑÁ¥¢Âºï
    const draggedIdx = list.findIndex(p => p.id === draggedProjectId);
    const targetIdx = list.findIndex(p => p.id === targetProjectId);
    
    if (draggedIdx === -1 || targetIdx === -1) return;
    
    // ÁßªÂä®È°πÁõÆ
    const [dragged] = list.splice(draggedIdx, 1);
    list.splice(targetIdx, 0, dragged);
    
    // Êõ¥Êñ∞order
    list.forEach((p, i) => {
        projects[p.id].order = i;
    });
    
    localStorage.setItem(getProjectsKey(), JSON.stringify(projects));
    renderProjectList();
}

function confirmDeleteProject(projectId, name) {
    if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§È†ÖÁõÆ„Äå${name}„ÄçÂóéÔºü\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÊí§Èä∑ÔºÅ`)) {
        deleteProject(projectId);
    }
}

function deleteProject(projectId) {
    const projects = getProjects();
    const name = projects[projectId]?.name;
    delete projects[projectId];
    localStorage.setItem(getProjectsKey(), JSON.stringify(projects));
    
    // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈ°πÁõÆÔºåÊ∏ÖÁ©∫ÂΩìÂâçÈ°πÁõÆ
    if (projectId === currentProjectId) {
        currentProjectId = null;
        state = { novel: '', title: '', step: 0, assets: {} };
        document.getElementById('headerTitle').textContent = 'FizzDragon AIGCÁï™ÂäáÁ≥ªÁµ±';
    }
    
    renderProjectList();
    addAIMessage(`üóëÔ∏è Â∑≤Âà™Èô§È†ÖÁõÆ„Äå${name}„Äç`);
}

function showExportOptions() {
    addAIMessage(`üì• **Â∞éÂá∫ÈÅ∏È†Ö**`, [
        { text: 'üìÑ Â∞éÂá∫Â∞èË™™ (TXT)', action: () => exportNovel() },
        { text: 'üìä Â∞éÂá∫Excel', action: () => exportExcel() },
        { text: 'üì¶ Â∞éÂá∫ÂÖ®ÈÉ® (JSON)', action: () => exportAll() }
    ]);
}

// ÂÖºÂÆπÊóßÁöÑ‰øùÂ≠òÂáΩÊï∞
function saveProgress(stage) {
    saveProject();
}

function loadProgress() {
    // ÂÖºÂÆπÊóßÁâàÊú¨ÔºöÊ£ÄÊü•Âçï‰∏Ä‰øùÂ≠ò
    const oldSave = localStorage.getItem('ai_drama_write_progress');
    if (oldSave) {
        try {
            const data = JSON.parse(oldSave);
            // ËøÅÁßªÂà∞Êñ∞Á≥ªÁªü
            if (data.outline) {
                const projects = getProjects();
                const id = (data.outline.title || 'migrated').replace(/\s+/g, '_').toLowerCase();
                projects[id] = {
                    id,
                    name: data.outline?.title || 'ÈÅ∑ÁßªÈ†ÖÁõÆ',
                    ...data
                };
                localStorage.setItem(getProjectsKey(), JSON.stringify(projects));
                localStorage.removeItem('ai_drama_write_progress');
                return projects[id];
            }
        } catch {}
    }
    
    // ËøîÂõûÊúÄËøëÁöÑÈ°πÁõÆ
    const projects = getProjects();
    const list = Object.values(projects);
    if (list.length > 0) {
        return list.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
    }
    return null;
}

function exportNovel() {
    // üîß È™åËØÅÊúâÂÜÖÂÆπÊâçËÉΩÂØºÂá∫
    if (!writeState.chapters || writeState.chapters.length === 0) {
        addAIMessage(`‚ö†Ô∏è **Ê≤íÊúâÂÖßÂÆπÂèØÂ∞éÂá∫**

Ë´ãÂÖàÂÆåÊàêÂ∞èË™™ÂØ´‰ΩúÂÜçÂ∞éÂá∫„ÄÇ`);
        return;
    }
    
    const content = writeState.chapters.map(c => 
        `# Á¨¨${c.number}Á´† ${c.title}\n\n${c.content}`
    ).join('\n\n---\n\n');
    
    const blob = new Blob([`# ${writeState.outline?.title || 'Êú™ÂëΩÂêç'}\n\n${content}`], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${writeState.outline?.title || 'Â∞èË™™'}.txt`;
    a.click();
    
    addAIMessage(`üì• Â∑≤Â∞éÂá∫Â∞èË™™Ôºö${writeState.outline?.title || 'Â∞èË™™'}.txt`);
}

function exportExcel() {
    // üîß È™åËØÅÊúâÂÜÖÂÆπÊâçËÉΩÂØºÂá∫
    const hasChapters = writeState.outline?.chapters?.length > 0;
    const hasCharacters = state.characters?.characters?.length > 0;
    
    if (!hasChapters && !hasCharacters) {
        addAIMessage(`‚ö†Ô∏è **Ê≤íÊúâÂÖßÂÆπÂèØÂ∞éÂá∫**

Ë´ãÂÖàÂÆåÊàêÂàÜÊûêÊàñÂØ´‰ΩúÂÜçÂ∞éÂá∫„ÄÇ`);
        return;
    }
    
    // ÂáÜÂ§áÊï∞ÊçÆ
    const rows = [];
    
    // Ê∑ªÂä†Á´†ËäÇ‰ø°ÊÅØ
    rows.push(['Á´†ÁØÄ', 'Ê®ôÈ°å', 'Ê¶ÇË¶Å']);
    (writeState.outline?.chapters || []).forEach(ch => {
        rows.push([`Á¨¨${ch.number}Á´†`, ch.title, ch.summary]);
    });
    
    rows.push([]);
    rows.push(['ËßíËâ≤', 'È°ûÂûã', 'ÊèèËø∞', 'AI Prompt']);
    (state.characters?.characters || []).forEach(c => {
        rows.push([c.name, c.role || '', c.psychology?.want || '', c.ai_prompt || '']);
    });
    
    // ‰ΩøÁî®SheetJSÂØºÂá∫
    if (typeof XLSX !== 'undefined') {
        const ws = XLSX.utils.aoa_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'ÊïÖ‰∫ãË≥áÊñô');
        XLSX.writeFile(wb, `${writeState.outline?.title || 'ÊïÖ‰∫ã'}_ÂàÜÈè°Ë°®.xlsx`);
        addAIMessage(`üì• Â∑≤Â∞éÂá∫ExcelÔºö${writeState.outline?.title || 'ÊïÖ‰∫ã'}_ÂàÜÈè°Ë°®.xlsx`);
    } else {
        // ÈôçÁ∫ß‰∏∫CSV
        const csv = rows.map(r => r.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${writeState.outline?.title || 'ÊïÖ‰∫ã'}_ÂàÜÈè°Ë°®.csv`;
        a.click();
        addAIMessage(`üì• Â∑≤Â∞éÂá∫CSVÔºö${writeState.outline?.title || 'ÊïÖ‰∫ã'}_ÂàÜÈè°Ë°®.csv`);
    }
}

// ==================== Ê∂àÊÅØUI ====================
function addUserMessage(text) {
    const container = document.getElementById('chatContainer');
    const msg = document.createElement('div');
    msg.className = 'message user';
    msg.innerHTML = `<div class="role">‰Ω†</div><div class="content">${escapeHtml(text)}</div>`;
    container.appendChild(msg);
    scrollToBottom();
}

function addAIMessage(text, quickReplies = []) {
    const container = document.getElementById('chatContainer');
    const msg = document.createElement('div');
    msg.className = 'message ai';
    
    let html = `<div class="role">üé¨ AIGCÁï™ÂäáÂä©Êâã</div><div class="content">${formatMessage(text)}</div>`;
    
    if (quickReplies.length > 0) {
        html += '<div class="quick-replies">';
        quickReplies.forEach((r, i) => {
            html += `<button class="quick-reply" onclick="handleQuickReply(${i})">${r.text}</button>`;
        });
        html += '</div>';
        window._quickReplies = quickReplies;
    }
    
    msg.innerHTML = html;
    container.appendChild(msg);
    scrollToBottom();
    return msg;
}

function addTypingIndicator() {
    const container = document.getElementById('chatContainer');
    const msg = document.createElement('div');
    msg.className = 'message ai';
    msg.id = 'typingIndicator';
    msg.innerHTML = `<div class="role">üé¨ AIGCÁï™ÂäáÂä©Êâã</div><div class="typing"><span></span><span></span><span></span></div>`;
    container.appendChild(msg);
    scrollToBottom();
}

function removeTypingIndicator() {
    const el = document.getElementById('typingIndicator');
    if (el) el.remove();
}

function addProgressCard(title, progress = 0) {
    const container = document.getElementById('chatContainer');
    const card = document.createElement('div');
    card.className = 'message ai';
    card.id = 'progressCard';
    card.innerHTML = `
        <div class="role">üé¨ AIGCÁï™ÂäáÂä©Êâã</div>
        <div class="progress-card">
            <div class="progress-header">
                <span>${title}</span>
                <span id="progressPercent">${progress}%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: ${progress}%"></div>
            </div>
        </div>
    `;
    container.appendChild(card);
    scrollToBottom();
}

function updateProgress(progress) {
    const fill = document.getElementById('progressFill');
    const percent = document.getElementById('progressPercent');
    if (fill) fill.style.width = progress + '%';
    if (percent) percent.textContent = progress + '%';
}

function removeProgressCard() {
    const el = document.getElementById('progressCard');
    if (el) el.remove();
}

function formatMessage(text) {
    // ÁÆÄÂçïÁöÑmarkdownÊîØÊåÅ
    return text
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ==================== ÂèØÁºñËæëÁ°ÆËÆ§Ê°Ü ====================
let pendingEditData = null;  // ÊöÇÂ≠òÂæÖÁ°ÆËÆ§ÁöÑÊï∞ÊçÆ

function showEditableResult(type, data, onConfirm, onRegenerate) {
    pendingEditData = { type, data, onConfirm, onRegenerate };
    
    const container = document.getElementById('chatContainer');
    const card = document.createElement('div');
    card.className = 'message ai';
    card.id = 'editableResultCard';
    
    // Ê†πÊçÆÁ±ªÂûãÈÖçÁΩÆ
    const typeConfig = {
        concept: { num: '01', title: 'È´òÊ¶ÇÂøµÂàÜÊûê', tag: 'ÂèØÁ∑®ËºØ', icon: 'üí°' },
        characters: { num: '02', title: 'ËßíËâ≤Ë®≠Ë®à', tag: 'ÂèØÁ∑®ËºØ', icon: 'üë§' },
        chapters: { num: '03', title: 'Á´†ÁØÄË¶èÂäÉ', tag: 'ÂèØÁ∑®ËºØ', icon: 'üìù' },
        production: { num: '04', title: 'ÊúçÂåñÈÅìË®≠Ë®à', tag: 'ÂèØÁ∑®ËºØ', icon: 'üëó' }
    };
    const config = typeConfig[type] || { num: '00', title: 'ÁîüÊàêÁµêÊûú', tag: 'ÂèØÁ∑®ËºØ', icon: 'üìã' };
    
    // Ê†πÊçÆÁ±ªÂûãÊ†ºÂºèÂåñÊòæÁ§∫
    let displayText = '';
    
    if (type === 'concept') {
        const hooks = Array.isArray(data.hooks) ? data.hooks.join('Ôºõ') : (data.hooks || '');
        displayText = `È°ûÂûã: ${data.genre || '(ÂæÖÂ°´ÂØ´)'}\n‰∏ªÈ°å: ${data.theme || '(ÂæÖÂ°´ÂØ´)'}\nÂü∫Ë™ø: ${data.tone || '(ÂæÖÂ°´ÂØ´)'}\nLogline: ${data.logline || '(ÂæÖÂ°´ÂØ´)'}\nÊôÇ‰ª£ËÉåÊôØ: ${data.era || data.setting || '(ÂæÖÂ°´ÂØ´)'}\nÊïÖ‰∫ãË≥£Èªû: ${hooks || data.conflict || '(ÂæÖÂ°´ÂØ´)'}\nÁõÆÊ®ôËßÄÁúæ: ${data.audience || '(ÂæÖÂ°´ÂØ´)'}\nÂ∞çÊ®ô‰ΩúÂìÅ: ${data.comparable || '(ÂæÖÂ°´ÂØ´)'}\nÊÉÖÊÑüÊóÖÁ®ã: ${data.emotionalJourney || '(ÂæÖÂ°´ÂØ´)'}`;
    } else if (type === 'characters') {
        displayText = (data || []).map(c => 
            `„Äê${c.name}„Äë(${c.role || 'ËßíËâ≤'})\n\nüìñ ‰∫∫Áâ©Â∞èÂÇ≥:\n${c.bio || '(ÂæÖÂ°´ÂØ´ - ÊèèËø∞ËßíËâ≤ËÉåÊôØ„ÄÅÊÄßÊ†º„ÄÅÂãïÊ©ü)'}\n\nüë§ Â§ñË≤åÁâπÂæµ:\n${c.appearance || '(ÂæÖÂ°´ÂØ´ - ÊèèËø∞Âπ¥ÈΩ°„ÄÅË∫´È´ò„ÄÅÈ´ÆÂûã„ÄÅÊúçË£ùÁ≠â)'}\n\nüé® AIÂΩ¢Ë±°Prompt:\n${c.prompt || c.ai_prompt || '(ÂæÖÂ°´ÂØ´ - Ëã±ÊñáÊèèËø∞ÔºåÁî®ÊñºAIÁîüÂúñ)'}`
        ).join('\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n');
    } else if (type === 'chapters') {
        displayText = (data || []).map((ch, i) => {
            let text = `„Äê${ch.phase || ''}„ÄëÁ¨¨${ch.number || i+1}ÈõÜ„Äå${ch.title || ch.name || ''}„Äç`;
            if (ch.summary || ch.description) text += `\nüìñ ${ch.summary || ch.description}`;
            if (ch.highlight) text += `\nüåü ‰∫ÆÈªû: ${ch.highlight}`;
            if (ch.conflict) text += `\n‚öîÔ∏è Ë°ùÁ™Å: ${ch.conflict}`;
            if (ch.hook) text += `\nüé£ Êá∏Âøµ: ${ch.hook}`;
            return text;
        }).join('\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n');
    } else if (type === 'production') {
        // ÊúçÂåñÈÅìÊ†ºÂºè
        let text = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê üëî ÊúçË£ùË®≠Ë®à ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
        text += (data.costumes || []).map(c => 
            `„Äê${c.character || c.name || 'ËßíËâ≤'}„Äë(${c.occasion || 'Â†¥Âêà'})\nÊúçË£ù: ${c.outfit || c.description || '(ÂæÖÂ°´ÂØ´)'}\nÈ¢®Ê†º: ${c.style || '(ÂæÖÂ°´ÂØ´)'}\nüé® Prompt: ${c.ai_prompt || c.prompt || '(ÂæÖÂ°´ÂØ´)'}`
        ).join('\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n');
        
        text += '\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê üè† Â†¥ÊôØË®≠Ë®à ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
        text += (data.sets || []).map(s => 
            `„Äê${s.name || s.location || 'Â†¥ÊôØ'}„Äë(${s.time || 'ÊôÇÈñì'})\nÊ∞õÂúç: ${s.atmosphere || s.description || '(ÂæÖÂ°´ÂØ´)'}\nüé® Prompt: ${s.ai_prompt || s.prompt || '(ÂæÖÂ°´ÂØ´)'}`
        ).join('\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n');
        
        text += '\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê üé≠ ÈÅìÂÖ∑Ë®≠Ë®à ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
        text += (data.props || []).map(p => 
            `„Äê${p.name || 'ÈÅìÂÖ∑'}„Äë\nÁî®ÈÄî: ${p.usage || p.description || '(ÂæÖÂ°´ÂØ´)'}\nüé® Prompt: ${p.ai_prompt || p.prompt || '(ÂæÖÂ°´ÂØ´)'}`
        ).join('\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n');
        
        displayText = text;
    } else {
        displayText = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    }
    
    card.innerHTML = `
        <div class="role">${config.icon} ${config.title}</div>
        <div class="content" style="padding:0;">
            <div class="editable-result">
                <div class="result-header">
                    <span class="result-number">${config.num}</span>
                    <span class="result-title">${config.title}</span>
                    <span class="result-tag">${config.tag}</span>
                </div>
                <textarea id="editableTextarea">${escapeHtml(displayText)}</textarea>
                <div class="actions">
                    <button class="btn-regenerate" onclick="regenerateResult()">‚úèÔ∏è ‰∏çÊªøÊÑèÔºåÊàëË¶ÅÊîπ</button>
                    <button class="btn-confirm" onclick="confirmResult()">‚úÖ Á¢∫Ë™çÂ≠òÂÖ•Ë≥áÁî¢Â∫´</button>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(card);
    
    // üîß Ëá™Âä®Ë∞ÉÊï¥textareaÈ´òÂ∫¶ÈÄÇÂ∫îÂÜÖÂÆπ
    const textarea = document.getElementById('editableTextarea');
    if (textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 500) + 'px';
    }
    
    scrollToBottom();
}

function confirmResult() {
    if (!pendingEditData) return;
    
    const textarea = document.getElementById('editableTextarea');
    const editedText = textarea?.value || '';
    
    // Ëß£ÊûêÁºñËæëÂêéÁöÑÂÜÖÂÆπ
    let finalData = pendingEditData.data;
    
    if (pendingEditData.type === 'concept') {
        // Â∞ùËØïËß£ÊûêÁºñËæëÂêéÁöÑÊ¶ÇÂøµ
        const lines = editedText.split('\n');
        finalData = { ...pendingEditData.data };
        lines.forEach(line => {
            if (line.startsWith('È°ûÂûã:')) finalData.genre = line.replace('È°ûÂûã:', '').trim();
            if (line.startsWith('‰∏ªÈ°å:')) finalData.theme = line.replace('‰∏ªÈ°å:', '').trim();
            if (line.startsWith('Âü∫Ë™ø:')) finalData.tone = line.replace('Âü∫Ë™ø:', '').trim();
            if (line.startsWith('Logline:')) finalData.logline = line.replace('Logline:', '').trim();
            if (line.startsWith('ÊôÇ‰ª£ËÉåÊôØ:')) finalData.era = line.replace('ÊôÇ‰ª£ËÉåÊôØ:', '').trim();
            if (line.startsWith('ÊïÖ‰∫ãË≥£Èªû:')) finalData.hooks = line.replace('ÊïÖ‰∫ãË≥£Èªû:', '').trim().split('Ôºõ');
            if (line.startsWith('ÁõÆÊ®ôËßÄÁúæ:')) finalData.audience = line.replace('ÁõÆÊ®ôËßÄÁúæ:', '').trim();
            if (line.startsWith('Â∞çÊ®ô‰ΩúÂìÅ:')) finalData.comparable = line.replace('Â∞çÊ®ô‰ΩúÂìÅ:', '').trim();
            if (line.startsWith('ÊÉÖÊÑüÊóÖÁ®ã:')) finalData.emotionalJourney = line.replace('ÊÉÖÊÑüÊóÖÁ®ã:', '').trim();
        });
    } else if (pendingEditData.type === 'characters') {
        // Ëß£ÊûêÁºñËæëÂêéÁöÑËßíËâ≤
        const charBlocks = editedText.split('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê').filter(b => b.trim());
        finalData = charBlocks.map(block => {
            const char = {};
            // Ëß£ÊûêËßíËâ≤ÂêçÂíåÁ±ªÂûã
            const nameMatch = block.match(/„Äê(.+?)„Äë\((.+?)\)/);
            if (nameMatch) {
                char.name = nameMatch[1].trim();
                char.role = nameMatch[2].trim();
            }
            // Ëß£Êûê‰∫∫Áâ©Â∞è‰º†
            const bioMatch = block.match(/üìñ ‰∫∫Áâ©Â∞èÂÇ≥:\n([\s\S]*?)(?=\n\nüë§|$)/);
            if (bioMatch) char.bio = bioMatch[1].trim();
            // Ëß£ÊûêÂ§ñË≤å
            const appearMatch = block.match(/üë§ Â§ñË≤åÁâπÂæµ:\n([\s\S]*?)(?=\n\nüé®|$)/);
            if (appearMatch) char.appearance = appearMatch[1].trim();
            // Ëß£ÊûêPrompt
            const promptMatch = block.match(/üé® AIÂΩ¢Ë±°Prompt:\n([\s\S]*?)$/);
            if (promptMatch) char.prompt = promptMatch[1].trim();
            return char;
        }).filter(c => c.name);
    } else if (pendingEditData.type === 'chapters') {
        // Ëß£ÊûêÁºñËæëÂêéÁöÑÁ´†ËäÇ
        const chapterBlocks = editedText.split('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê').filter(b => b.trim());
        finalData = chapterBlocks.map((block, i) => {
            const chapter = { ...pendingEditData.data[i] };
            // Ëß£ÊûêÁ´†ËäÇ‰ø°ÊÅØ
            const titleMatch = block.match(/„Äê(.+?)„ÄëÁ¨¨(\d+)ÈõÜ„Äå(.+?)„Äç/);
            if (titleMatch) {
                chapter.phase = titleMatch[1].trim();
                chapter.number = parseInt(titleMatch[2]);
                chapter.title = titleMatch[3].trim();
            }
            // Ëß£ÊûêÂêÑÂ≠óÊÆµ
            const summaryMatch = block.match(/üìñ\s*(.+?)(?=\nüåü|\n‚öîÔ∏è|\nüé£|$)/s);
            if (summaryMatch) chapter.summary = summaryMatch[1].trim();
            const highlightMatch = block.match(/üåü ‰∫ÆÈªû:\s*(.+?)(?=\n‚öîÔ∏è|\nüé£|$)/s);
            if (highlightMatch) chapter.highlight = highlightMatch[1].trim();
            const conflictMatch = block.match(/‚öîÔ∏è Ë°ùÁ™Å:\s*(.+?)(?=\nüé£|$)/s);
            if (conflictMatch) chapter.conflict = conflictMatch[1].trim();
            const hookMatch = block.match(/üé£ Êá∏Âøµ:\s*(.+?)$/s);
            if (hookMatch) chapter.hook = hookMatch[1].trim();
            return chapter;
        }).filter(c => c.title || c.number);
    } else if (pendingEditData.type === 'production') {
        // Ëß£ÊûêÁºñËæëÂêéÁöÑÊúçÂåñÈÅìÔºàÁÆÄÂåñÂ§ÑÁêÜÔºåÁõ¥Êé•ËøîÂõûÂéüÊï∞ÊçÆÔºåËÆ©Áî®Êà∑ÁºñËæëÂêéÁöÑÊñáÊú¨‰Ωú‰∏∫ÂèÇËÄÉÔºâ
        // Â§çÊùÇËß£ÊûêÂèØ‰ª•ÂêéÁª≠ÂÆåÂñÑ
        finalData = pendingEditData.data;
    }
    
    // ÁßªÈô§ÁºñËæëÂç°Áâá
    const card = document.getElementById('editableResultCard');
    if (card) card.remove();
    
    // Ë∞ÉÁî®Á°ÆËÆ§ÂõûË∞É
    if (pendingEditData.onConfirm) {
        pendingEditData.onConfirm(finalData);
    }
    
    pendingEditData = null;
}

function regenerateResult() {
    // ‰∏çÁõ¥Êé•ÈáçÊñ∞ÁîüÊàêÔºåÂÖàÂïèÁî®Êà∂ÊÉ≥Êîπ‰ªÄÈ∫º
    askForRevisionFeedback();
}

// üÜï Ë©¢Âïè‰øÆÊîπÊÑèË¶ã
function askForRevisionFeedback() {
    const card = document.getElementById('editableResultCard');
    if (card) card.remove();
    
    const type = pendingEditData?.type || 'content';
    const typeNames = {
        concept: 'È´òÊ¶ÇÂøµ',
        characters: 'ËßíËâ≤Ë®≠Ë®à', 
        chapters: 'Á´†ÁØÄË¶èÂäÉ',
        production: 'ÊúçÂåñÈÅì'
    };
    const typeName = typeNames[type] || 'ÂÖßÂÆπ';
    
    addAIMessage(`‚úèÔ∏è **ÊÉ≥ÊÄéÈ∫º‰øÆÊîπ${typeName}Ôºü**

Ë´ãÂëäË®¥Êàë‰Ω†ÁöÑ‰øÆÊîπÊÑèË¶ãÔºå‰æãÂ¶ÇÔºö
- „Äå‰∏ªÈ°åÂ§™ÊÇ≤ËßÄ‰∫ÜÔºåÊîπÊàêÊõ¥Ê≠£Èù¢ÁöÑ„Äç
- „ÄåËßíËâ≤Âπ¥ÈΩ°ÊîπÂ§ß‰∏ÄÈªû„Äç
- „ÄåÈ¢®Ê†ºÊîπÊàêÊõ¥Áèæ‰ª£ÁöÑ„Äç
- „ÄåÂ¢ûÂä†‰∏ÄÂÄãÂèçÊ¥æËßíËâ≤„Äç

ÊàñËº∏ÂÖ•„ÄåÈáçÂØ´„ÄçÂÆåÂÖ®ÈáçÊñ∞ÁîüÊàê„ÄÇ`);
    
    // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÔºåÁ≠âÂæÖÁî®Êà∑ËæìÂÖ•
    window.pendingRevision = {
        type: type,
        originalData: pendingEditData?.data,
        onConfirm: pendingEditData?.onConfirm,
        onRegenerate: pendingEditData?.onRegenerate
    };
    
    showQuickReplies([
        { text: 'üîÑ ÂÆåÂÖ®ÈáçÂØ´', action: () => forceRegenerate() },
        { text: '‚ùå ÂèñÊ∂à', action: () => cancelRevision() }
    ]);
}

// Â§ÑÁêÜÁî®Êà∑ÁöÑ‰øÆÊîπÊÑèËßÅ
async function handleRevisionFeedback(feedback) {
    if (!window.pendingRevision) return false;
    
    const { type, originalData, onConfirm } = window.pendingRevision;
    
    // Â¶ÇÊûúÁî®Êà∑ËØ¥"ÈáçÂÜô"ÔºåÁõ¥Êé•ÈáçÊñ∞ÁîüÊàê
    if (feedback.includes('ÈáçÂØ´') || feedback.includes('ÈáçÂÜô') || feedback.toLowerCase().includes('rewrite')) {
        forceRegenerate();
        return true;
    }
    
    const typeNames = {
        concept: 'È´òÊ¶ÇÂøµ',
        characters: 'ËßíËâ≤Ë®≠Ë®à',
        chapters: 'Á´†ÁØÄË¶èÂäÉ', 
        production: 'ÊúçÂåñÈÅì'
    };
    const typeName = typeNames[type] || 'ÂÖßÂÆπ';
    const agentIcons = {
        concept: 'üí°',
        characters: 'üë§',
        chapters: 'üìù',
        production: 'üëó'
    };
    
    // üîß ËØ¶ÁªÜÊ≠•È™§ÊòæÁ§∫
    const steps = [
        { text: `üì° ÈÄ£Êé•${typeName}Êô∫ËÉΩÈ´î...`, done: false, current: true },
        { text: 'üìö ËºâÂÖ•Áõ∏ÈóúSkills...', done: false },
        { text: 'ü§ñ Ë™øÁî®DeepSeekÊ®°Âûã...', done: false },
        { text: 'üìù Ëß£Êûê‰∏¶È©óË≠âÁµêÊûú...', done: false }
    ];
    
    showAgentStatus(`${agentIcons[type] || 'üîÑ'} ${typeName}‰øÆÊîπÂô®`, `Ê≠£Âú®ËôïÁêÜ‰øÆÊîπÊÑèË¶ã...`, type, steps);
    
    addAIMessage(`üîÑ Ê≠£Âú®Ê†πÊìö‰Ω†ÁöÑÊÑèË¶ã‰øÆÊîπ**${typeName}**...

> "${feedback}"`);
    
    try {
        // Ê≠•È™§1ÂÆåÊàêÔºåÊ≠•È™§2ÂºÄÂßã
        steps[0].done = true; steps[0].current = false;
        steps[1].current = true;
        showAgentStatus(`${agentIcons[type] || 'üîÑ'} ${typeName}‰øÆÊîπÂô®`, `ËºâÂÖ•narrative_completeÁ≠âSkills...`, type, steps);
        
        // ÊûÑÂª∫‰øÆÊîπÊèêÁ§∫
        const revisionPrompt = `
ÈÄôÊòØ‰πãÂâçÁîüÊàêÁöÑ${typeName}Ôºö
${JSON.stringify(originalData, null, 2)}

Áî®Êà∂ÁöÑ‰øÆÊîπÊÑèË¶ãÔºö
${feedback}

Ë´ãÊ†πÊìöÁî®Êà∂ÊÑèË¶ãÔºå‰øÆÊîπ‰∏¶Ëº∏Âá∫ÂÆåÊï¥ÁöÑÊñ∞ÁâàÊú¨„ÄÇ‰øùÊåÅJSONÊ†ºÂºè„ÄÇ
`;
        
        // Ê≠•È™§2ÂÆåÊàêÔºåÊ≠•È™§3ÂºÄÂßã
        steps[1].done = true; steps[1].current = false;
        steps[2].current = true;
        showAgentStatus(`${agentIcons[type] || 'üîÑ'} ${typeName}‰øÆÊîπÂô®`, `DeepSeekÊ≠£Âú®ÊÄùËÄÉ...`, type, steps);
        
        const result = await callAgent(type, revisionPrompt, { revision: true });
        
        // Ê≠•È™§3ÂÆåÊàêÔºåÊ≠•È™§4ÂºÄÂßã
        steps[2].done = true; steps[2].current = false;
        steps[3].current = true;
        showAgentStatus(`${agentIcons[type] || 'üîÑ'} ${typeName}‰øÆÊîπÂô®`, `Ëß£ÊûêJSONÁµêÊûú...`, type, steps);
        
        const revisedData = safeJSONParse(result, type);
        
        // ÂÖ®ÈÉ®ÂÆåÊàê
        steps[3].done = true; steps[3].current = false;
        
        hideAgentStatus();
        
        // ÊòæÁ§∫‰øÆÊîπÂêéÁöÑÁªìÊûú
        showEditableResult(type, revisedData, onConfirm, () => {
            askForRevisionFeedback();
        });
        
        addAIMessage(`‚úÖ Â∑≤Ê†πÊìö‰Ω†ÁöÑÊÑèË¶ã‰øÆÊîπÔºÅ

Ë´ãÊ™¢Êü•‰∏äÊñπÁµêÊûúÔºåÂèØ‰ª•ÁπºÁ∫åÁ∑®ËºØÊàñÁ¢∫Ë™ç„ÄÇ`);
        
    } catch (err) {
        hideAgentStatus();
        addAIMessage(`‚ùå ‰øÆÊîπÂ§±ÊïóÔºö${err.message}

Ë´ãÈáçË©¶ÊàñÈÅ∏Êìá„ÄåÂÆåÂÖ®ÈáçÂØ´„Äç„ÄÇ`);
        
        showQuickReplies([
            { text: 'üîÑ ÂÆåÂÖ®ÈáçÂØ´', action: () => forceRegenerate() },
            { text: '‚ùå ÂèñÊ∂à', action: () => cancelRevision() }
        ]);
    }
    
    window.pendingRevision = null;
    return true;
}

// Âº∫Âà∂ÂÆåÂÖ®ÈáçÊñ∞ÁîüÊàêÔºà‰∏çÈóÆÊÑèËßÅÔºâ
function forceRegenerate() {
    const pending = window.pendingRevision || pendingEditData;
    window.pendingRevision = null;
    pendingEditData = null;
    
    if (pending?.onRegenerate) {
        addAIMessage('üîÑ Â•ΩÁöÑÔºåÂÆåÂÖ®ÈáçÊñ∞ÁîüÊàê...');
        pending.onRegenerate();
    }
}

// ÂèñÊ∂à‰øÆÊîπ
function cancelRevision() {
    const pending = window.pendingRevision;
    window.pendingRevision = null;
    
    if (pending?.originalData && pending?.onConfirm) {
        // ÈáçÊñ∞ÊòæÁ§∫ÂéüÊù•ÁöÑÁºñËæëÊ°Ü
        showEditableResult(pending.type, pending.originalData, pending.onConfirm, () => {
            askForRevisionFeedback();
        });
    }
}

// ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫ÔºàÂëäËØâÁî®Êà∑ÂéüÂõ†ÂíåËß£ÂÜ≥ÊñπÊ≥ïÔºâ
function friendlyError(err, step) {
    const msg = err.message || String(err);
    
    // ÂàÜÊûêÈîôËØØÁ±ªÂûã
    if (msg.includes('timeout') || msg.includes('Timeout') || msg.includes('Ë∂ÖÊôÇ')) {
        return {
            title: '‚è±Ô∏è ËôïÁêÜÊôÇÈñìËºÉÈï∑',
            reason: 'AIÊ≠£Âú®Ê∑±Â∫¶ÊÄùËÄÉÔºå‰ΩÜËä±‰∫ÜÊØîÈ†êÊúüÊõ¥Èï∑ÁöÑÊôÇÈñì',
            solutions: [
                'Á®çÁ≠âÁâáÂàªÂæåÈáçË©¶',
                'Â¶ÇÊûúÂÖßÂÆπËºÉÈï∑ÔºåÂèØ‰ª•ÂòóË©¶Á∏ÆÁü≠Ëº∏ÂÖ•',
                'Á∂≤Áµ°ÂèØËÉΩËºÉÊÖ¢ÔºåÊèõÂÄãÊôÇÈñìË©¶Ë©¶'
            ]
        };
    }
    
    if (msg.includes('JSON') || msg.includes('parse') || msg.includes('Unexpected')) {
        return {
            title: 'üìã Ê†ºÂºèËß£ÊûêÂïèÈ°å',
            reason: 'AIÂõûË¶ÜÁöÑÊ†ºÂºè‰∏çÂ§™Ê®ôÊ∫ñÔºåÁ≥ªÁµ±Ê≠£Âú®Â≠∏ÁøíËôïÁêÜ',
            solutions: [
                'Áõ¥Êé•ÈáçË©¶ÈÄöÂ∏∏Â∞±ËÉΩËß£Ê±∫',
                'ÈÄôÊòØAIÂÅ∂ÁàæÁöÑÂ∞èËÑæÊ∞£Ôºå‰∏çÂΩ±ÈüøÂæåÁ∫å'
            ]
        };
    }
    
    if (msg.includes('network') || msg.includes('fetch') || msg.includes('ÈÄ£Êé•')) {
        return {
            title: 'üåê Á∂≤Áµ°ÈÄ£Êé•ÂïèÈ°å',
            reason: 'ËàáAIÊúçÂãôÁöÑÈÄ£Êé•Êö´ÊôÇ‰∏≠Êñ∑',
            solutions: [
                'Ê™¢Êü•Á∂≤Áµ°ÈÄ£Êé•',
                'Á®çÂæåÈáçË©¶',
                'Â¶ÇÊåÅÁ∫åÂ§±ÊïóÔºåÂèØËÉΩÊòØÊúçÂãôÁ∂≠Ë≠∑‰∏≠'
            ]
        };
    }
    
    if (msg.includes('API') || msg.includes('401') || msg.includes('403')) {
        return {
            title: 'üîë ÊúçÂãôÈ©óË≠âÂïèÈ°å',
            reason: 'APIÂØÜÈë∞ÂèØËÉΩÈúÄË¶ÅÊõ¥Êñ∞',
            solutions: [
                'ËÅØÁπ´ÁÆ°ÁêÜÂì°Ê™¢Êü•ÈÖçÁΩÆ',
                'Á®çÂæåÈáçË©¶'
            ]
        };
    }
    
    if (msg.includes('500') || msg.includes('502') || msg.includes('503')) {
        return {
            title: 'üîß ÊúçÂãôÊö´ÊôÇÁπÅÂøô',
            reason: 'AIÊúçÂãôÊ≠£Âú®ËôïÁêÜÂ§ßÈáèË´ãÊ±Ç',
            solutions: [
                'Á≠âÂæÖ1-2ÂàÜÈêòÂæåÈáçË©¶',
                'È´òÂ≥∞ÊúüÂèØËÉΩÈúÄË¶ÅÂ§öË©¶ÂπæÊ¨°'
            ]
        };
    }
    
    // ÈªòËÆ§ÈîôËØØ
    return {
        title: '‚ö†Ô∏è ÈÅáÂà∞‰∫ÜÂ∞èÂïèÈ°å',
        reason: msg.length > 100 ? msg.substring(0, 100) + '...' : msg,
        solutions: [
            'ÈáçË©¶‰∏ÄÊ¨°ÈÄöÂ∏∏ËÉΩËß£Ê±∫',
            'Â¶ÇÊûúÊåÅÁ∫åÂ§±ÊïóÔºåÂòóË©¶Á∞°ÂåñËº∏ÂÖ•ÂÖßÂÆπ',
            'ÊàñËÄÖÂÖà‰øùÂ≠òÈÄ≤Â∫¶ÔºåÁ®çÂæåÁπºÁ∫å'
        ]
    };
}

function showFriendlyError(err, step, retryAction) {
    const info = friendlyError(err, step);
    
    addAIMessage(`${info.title}

**ÂèØËÉΩÂéüÂõ†**: ${info.reason}

**Âª∫Ë≠∞**:
${info.solutions.map(s => `‚Ä¢ ${s}`).join('\n')}`, [
        { text: 'üîÑ ÈáçË©¶', action: retryAction },
        { text: 'üíæ ‰øùÂ≠òÈÄ≤Â∫¶', action: () => saveProject() },
        { text: 'üÜò Ê±ÇÂä©Â∞èÂä©Êâã', action: () => callHelpAgent() }
    ]);
}

// ==================== Áî®Êà∑Âä©ÊâãÊô∫ËÉΩ‰Ωì ====================
let lastError = null;  // ËÆ∞ÂΩïÊúÄÂêéÁöÑÈîôËØØ

// ËÆ∞ÂΩïÈîôËØØÔºàÂú®ÂêÑ‰∏™catchÂùó‰∏≠Ë∞ÉÁî®Ôºâ
function recordError(err, context) {
    lastError = {
        message: err.message || String(err),
        context: context,
        timestamp: new Date().toISOString(),
        state: {
            mode: state.mode,
            step: state.step,
            hasNovel: !!state.novel,
            hasConcept: !!state.concept,
            hasChapters: !!state.chapters,
            hasCharacters: !!state.characters,
            writeChapters: writeState.chapters?.length || 0
        }
    };
}

// Áî®Êà∑Âä©ÊâãÊô∫ËÉΩ‰Ωì
async function callHelpAgent() {
    const helpBtn = document.querySelector('.help-fab');
    helpBtn.classList.add('loading');
    helpBtn.textContent = 'üîç';
    
    addAIMessage(`üÜò **Áî®Êà∂Âä©Êâã‰æÜÂπ´Âøô‰∫ÜÔºÅ**

Ê≠£Âú®Ë®∫Êñ∑Á≥ªÁµ±ÁãÄÊÖã...`);
    
    // Êî∂ÈõÜËØäÊñ≠‰ø°ÊÅØ
    const diagnosis = {
        // ÂΩìÂâçÁä∂ÊÄÅ
        mode: state.mode || 'Êú™ÈñãÂßã',
        step: state.step || 0,
        
        // Êï∞ÊçÆÁä∂ÊÄÅ
        hasNovel: !!state.novel,
        novelLength: state.novel?.length || 0,
        hasConcept: !!state.concept,
        hasChapters: !!state.chapters || !!writeState.outline,
        chapterCount: (state.chapters?.chapters || state.chapters?.episodes || writeState.outline?.chapters || []).length,
        hasCharacters: !!state.characters,
        characterCount: (state.characters?.characters || []).length,
        writtenChapters: writeState.chapters?.length || 0,
        hasStoryboard: !!state.storyboard,
        
        // APIÁä∂ÊÄÅ
        apiConnected: API_BASE !== null,
        apiEndpoint: API_BASE,
        
        // ÊúÄËøëÈîôËØØ
        lastError: lastError
    };
    
    // ÂàÜÊûêÈóÆÈ¢òÂπ∂Êèê‰æõËß£ÂÜ≥ÊñπÊ°à
    const issues = [];
    const fixes = [];
    
    // Ê£ÄÊü•APIËøûÊé•
    if (!diagnosis.apiConnected) {
        issues.push('‚ùå APIÊú™ÈÄ£Êé•');
        fixes.push({ text: 'üîÑ ÈáçÊñ∞ÈÄ£Êé•API', action: async () => {
            await detectAPI();
            addAIMessage(API_BASE ? '‚úÖ APIÂ∑≤ÈáçÊñ∞ÈÄ£Êé•ÔºÅÂèØ‰ª•ÁπºÁ∫å‰∫Ü„ÄÇ' : '‚ùå ÈÄ£Êé•Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Áµ°');
        }});
    }
    
    // Ê£ÄÊü•Êï∞ÊçÆÂÆåÊï¥ÊÄß
    if (diagnosis.mode === 'write' && diagnosis.hasNovel === false && !writeState.idea) {
        issues.push('‚ö†Ô∏è ÈÇÑÊ≤íÊúâÈñãÂßãÂâµ‰Ωú');
        fixes.push({ text: '‚úçÔ∏è ÈñãÂßãÂâµ‰Ωú', action: () => doStartWriteMode() });
    }
    
    if (diagnosis.mode === 'import' && diagnosis.hasNovel && !diagnosis.hasConcept) {
        issues.push('‚ö†Ô∏è Â∞èË™™Â∑≤Â∞éÂÖ•‰ΩÜÊú™ÂàÜÊûê');
        fixes.push({ text: 'üìñ ÈáçÊñ∞ÂàÜÊûêÂ∞èË™™', action: () => runConceptStep() });
    }
    
    if (diagnosis.hasConcept && !diagnosis.hasChapters && diagnosis.step >= 2) {
        issues.push('‚ö†Ô∏è Á´†ÁØÄË¶èÂäÉÊú™ÂÆåÊàê');
        fixes.push({ text: 'üìù ÁîüÊàêÁ´†ÁØÄË¶èÂäÉ', action: () => state.mode === 'write' ? generateOutline() : runChaptersStep() });
    }
    
    if (diagnosis.hasChapters && !diagnosis.hasCharacters && diagnosis.step >= 4) {
        issues.push('‚ö†Ô∏è ËßíËâ≤Ë®≠Ë®àÊú™ÂÆåÊàê');
        fixes.push({ text: 'üë§ ÁîüÊàêËßíËâ≤Ë®≠Ë®à', action: () => runCharacterStep() });
    }
    
    // Ê£ÄÊü•ÊúÄËøëÈîôËØØ
    if (lastError) {
        issues.push(`‚ö†Ô∏è ÊúÄËøëÈåØË™§: ${lastError.context}`);
        
        if (lastError.message.includes('timeout') || lastError.message.includes('Timeout')) {
            fixes.push({ text: '‚è±Ô∏è Âª∂Èï∑Ë∂ÖÊôÇÈáçË©¶', action: () => {
                addAIMessage('Â∑≤Ë™øÊï¥Ë∂ÖÊôÇË®≠ÁΩÆÔºåË´ãÈáçË©¶‰∏ä‰∏ÄÊ≠•Êìç‰Ωú„ÄÇ');
            }});
        }
        
        if (lastError.message.includes('JSON') || lastError.message.includes('parse')) {
            fixes.push({ text: 'üîÑ Ê∏ÖÈô§Á∑©Â≠òÈáçË©¶', action: () => {
                lastError = null;
                addAIMessage('Â∑≤Ê∏ÖÈô§ÈåØË™§Ë®òÈåÑÔºåË´ãÈáçË©¶‰∏ä‰∏ÄÊ≠•Êìç‰Ωú„ÄÇ');
            }});
        }
    }
    
    // ÁîüÊàêËØäÊñ≠Êä•Âëä
    helpBtn.classList.remove('loading');
    helpBtn.textContent = 'üÜò';
    
    if (issues.length === 0) {
        // Ê≤°ÊúâÂèëÁé∞ÈóÆÈ¢ò
        addAIMessage(`‚úÖ **Ë®∫Êñ∑ÂÆåÊàê - Á≥ªÁµ±Ê≠£Â∏∏ÔºÅ**

**Áï∂ÂâçÁãÄÊÖã**:
‚Ä¢ Ê®°Âºè: ${diagnosis.mode === 'write' ? 'Ââµ‰ΩúÊ®°Âºè' : diagnosis.mode === 'import' ? 'Â∞éÂÖ•Ê®°Âºè' : 'Êú™ÈñãÂßã'}
‚Ä¢ Ê≠•È©ü: ${diagnosis.step}/5
${diagnosis.hasNovel ? `‚Ä¢ Â∞èË™™: ${diagnosis.novelLength.toLocaleString()} Â≠ó` : ''}
${diagnosis.chapterCount > 0 ? `‚Ä¢ Á´†ÁØÄ: ${diagnosis.chapterCount} Á´†` : ''}
${diagnosis.characterCount > 0 ? `‚Ä¢ ËßíËâ≤: ${diagnosis.characterCount} ÂÄã` : ''}
${diagnosis.writtenChapters > 0 ? `‚Ä¢ Â∑≤ÂØ´: ${diagnosis.writtenChapters} Á´†` : ''}
‚Ä¢ API: ${diagnosis.apiConnected ? 'Â∑≤ÈÄ£Êé• ‚úÖ' : 'Êú™ÈÄ£Êé• ‚ùå'}

**Ê≤íÊúâÁôºÁèæÂïèÈ°åÔºÅ** Â¶ÇÊûúÈÅáÂà∞Âõ∞Èõ£ÔºåË´ãÊèèËø∞ÂÖ∑È´îÊÉÖÊ≥Å„ÄÇ`, [
            { text: '‚ñ∂Ô∏è ÁπºÁ∫åÂâµ‰Ωú', action: () => state.mode === 'write' ? continueWriteProject() : continueImportProject() },
            { text: 'üè† ËøîÂõû‰∏ªÈ†Å', action: () => showStartOptions() }
        ]);
    } else {
        // ÂèëÁé∞ÈóÆÈ¢òÔºåÊèê‰æõ‰øÆÂ§çÈÄâÈ°π
        addAIMessage(`üîç **Ë®∫Êñ∑ÂÆåÊàê - ÁôºÁèæ ${issues.length} ÂÄãÂïèÈ°å**

**ÂïèÈ°åÂàóË°®**:
${issues.map(i => `${i}`).join('\n')}

**Áï∂ÂâçÁãÄÊÖã**:
‚Ä¢ Ê®°Âºè: ${diagnosis.mode === 'write' ? 'Ââµ‰ΩúÊ®°Âºè' : diagnosis.mode === 'import' ? 'Â∞éÂÖ•Ê®°Âºè' : 'Êú™ÈñãÂßã'}
‚Ä¢ ÈÄ≤Â∫¶: ${diagnosis.step}/5
‚Ä¢ API: ${diagnosis.apiConnected ? 'Â∑≤ÈÄ£Êé• ‚úÖ' : 'Êú™ÈÄ£Êé• ‚ùå'}

ÈªûÊìä‰∏ãÊñπÊåâÈàïËá™Âãï‰øÆÂæ©Ôºö`, fixes.concat([
            { text: 'üè† ËøîÂõû‰∏ªÈ†ÅÈáçÊñ∞ÈñãÂßã', action: () => {
                resetWorkflowFromStep(0);
                document.getElementById('chatContainer').innerHTML = '';
                showStartOptions();
            }}
        ]));
    }
}

function scrollToBottom() {
    const container = document.getElementById('chatContainer');
    setTimeout(() => container.scrollTop = container.scrollHeight, 100);
}

// ==================== Âø´Êç∑ÂõûÂ§ç ====================
function handleQuickReply(index) {
    if (window._quickReplies && window._quickReplies[index]) {
        const reply = window._quickReplies[index];
        if (reply.action) {
            reply.action();
        } else if (reply.text) {
            document.getElementById('userInput').value = reply.text;
            sendMessage();
        }
    }
}

// ==================== Â∑•‰ΩúÊµÅÈáçÁΩÆ (DeepSeekÈ£éÊ†º) ====================
// Ê£ÄÊü•ÊòØÂê¶ÊúâËøõË°å‰∏≠ÁöÑÂ∑•‰Ωú
function hasActiveWork() {
    // Ê£ÄÊü•ÂØπË±°ÊòØÂê¶ÊúâÂÆûÈôÖÂÜÖÂÆπ
    const hasContent = (obj) => obj && Object.keys(obj).length > 0;
    
    const result = !!(
        state.novel || 
        state.concept || 
        hasContent(state.interview) ||  // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÆûÈôÖÂõûÁ≠î
        state.chapters || 
        state.characters || 
        state.storyboard ||
        writeState.idea ||
        writeState.outline ||
        hasContent(writeState.interview) ||  // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÆûÈôÖÂõûÁ≠î
        (writeState.chapters && writeState.chapters.length > 0)
    );
    
    console.log('hasActiveWork:', result, { 
        novel: !!state.novel, 
        concept: !!state.concept, 
        interview: hasContent(state.interview),
        chapters: !!state.chapters,
        idea: !!writeState.idea,
        outline: !!writeState.outline
    });
    
    return result;
}

// ÈáçÁΩÆÂ∑•‰ΩúÊµÅÂà∞ÊåáÂÆöÊ≠•È™§ÔºàÊ∏ÖÈô§ËØ•Ê≠•È™§Âèä‰πãÂêéÁöÑÊâÄÊúâÊï∞ÊçÆÔºâ
function resetWorkflowFromStep(stepNumber) {
    console.log('resetWorkflowFromStep:', stepNumber);
    // Ê≠•È™§ÂÆö‰πâ:
    // 0: ÂàùÂßãÁä∂ÊÄÅÔºàÊ∏ÖÁ©∫‰∏ÄÂàáÔºâ
    // 1: ÂØºÂÖ•/ÂàõÊÑè ÂÆåÊàêÔºåÊ∏ÖÈô§ concept Âèä‰πãÂêé
    // 2: concept ÂÆåÊàêÔºåÊ∏ÖÈô§ interview Âèä‰πãÂêé  
    // 3: interview ÂÆåÊàêÔºåÊ∏ÖÈô§ chapters Âèä‰πãÂêé
    // 4: chapters ÂÆåÊàêÔºåÊ∏ÖÈô§ characters Âèä‰πãÂêé
    // 5: characters ÂÆåÊàêÔºåÊ∏ÖÈô§ storyboard Âèä‰πãÂêé
    
    if (stepNumber <= 0) {
        // ÂÆåÂÖ®ÈáçÁΩÆ
        state.novel = null;
        state.novelTitle = '';
        state.mode = null;
        state.step = 0;
        writeState.idea = null;
        writeState.currentQuestion = null;
        
        // üîß ÈáçÁΩÆÈ°πÁõÆËµÑ‰∫ß
        state.assets = {
            concept: null,
            characters: [],
            chapters: [],
            costumes: null,
            scripts: {},
            storyboards: {}
        };
        currentProjectId = null;
        
        // üîß Êõ¥Êñ∞Âè≥‰æßËµÑ‰∫ßÈù¢Êùø
        updateAssetsPanel();
    }
    if (stepNumber <= 1) {
        state.concept = null;
        writeState.interview = {};
    }
    if (stepNumber <= 2) {
        state.interview = {};
        state.interviewQuestions = [];
        state.currentQuestion = 0;
    }
    if (stepNumber <= 3) {
        state.chapters = null;
        writeState.outline = null;
    }
    if (stepNumber <= 4) {
        state.characters = null;
        writeState.chapters = [];
        writeState.currentChapter = 0;
    }
    if (stepNumber <= 5) {
        state.storyboard = null;
        writeState.storyboard = null;
    }
    
    state.step = stepNumber;
    console.log(`Â∑•‰ΩúÊµÅÈáçÁΩÆÂà∞Ê≠•È™§ ${stepNumber}`);
}

// Á°ÆËÆ§ÈáçÁΩÆÂØπËØùÊ°Ü
function confirmResetAndImport(callback) {
    if (!hasActiveWork()) {
        callback();
        return;
    }
    
    // üîß Ëá™Âä®‰øùÂ≠òÂΩìÂâçÈ°πÁõÆÔºå‰∏çÂÜçÊèêÁ§∫
    saveProject(true);  // ÈùôÈªò‰øùÂ≠ò
    
    // Ê∏ÖÁ©∫Âπ∂ÁªßÁª≠
    resetWorkflowFromStep(0);
    document.getElementById('chatContainer').innerHTML = '';
    callback();
}

// ÊòæÁ§∫Ë∞ÉÊï¥Ë≠¶ÂëäÔºà‰øÆÊîπÂâçÈù¢ÁöÑÊ≠•È™§‰ºöÊ∏ÖÁ©∫ÂêéÁª≠Ôºâ
function showAdjustWarning(stepName, stepNumber) {
    const stepNames = {
        'outline': 'Â§ßÁ∂±',
        'chapters': 'Á´†ÁØÄË¶èÂäÉ', 
        'characters': 'ËßíËâ≤Ë®≠Ë®à',
        'interview': 'Ë®™Ë´á'
    };
    
    const affectedSteps = [];
    if (stepNumber <= 3) affectedSteps.push('Á´†ÁØÄË¶èÂäÉ');
    if (stepNumber <= 4) {
        affectedSteps.push('ËßíËâ≤Ë®≠Ë®à');
        if (writeState.chapters?.length > 0) {
            affectedSteps.push(`Â∑≤ÂØ´ÁöÑ ${writeState.chapters.length} Á´†ÂÖßÂÆπ`);
        }
    }
    if (stepNumber <= 5) affectedSteps.push('ÂàÜÈè°Ë°®');
    
    addAIMessage(`‚ö†Ô∏è **Ë™øÊï¥${stepNames[stepName] || stepName}**

‰øÆÊîπÊ≠§Ê≠•È©üÊúÉ**Ê∏ÖÁ©∫ÂæåÁ∫åÊâÄÊúâÂÖßÂÆπ**Ôºö
${affectedSteps.map(s => `‚Ä¢ ${s}`).join('\n')}

Á¢∫ÂÆöË¶ÅË™øÊï¥ÂóéÔºü`, [
        { text: `‚úèÔ∏è Á¢∫ÂÆöË™øÊï¥${stepNames[stepName] || stepName}`, action: () => {
            resetWorkflowFromStep(stepNumber);
            // Ê†πÊçÆÊ≠•È™§Á±ªÂûãÔºåÊòæÁ§∫Áõ∏Â∫îÁöÑË∞ÉÊï¥ÁïåÈù¢
            if (stepName === 'outline') {
                addAIMessage(`üìù Ë´ãÊèèËø∞‰Ω†ÊÉ≥Â¶Ç‰ΩïË™øÊï¥Â§ßÁ∂±Ôºö
- Êï¥È´îÁµêÊßã
- Á´†ÁØÄÊï∏Èáè
- ÊïÖ‰∫ãËµ∞Âêë
- ÂÖ∂‰ªñË¶ÅÊ±Ç`);
            } else if (stepName === 'chapters') {
                runChaptersStep();
            } else if (stepName === 'characters') {
                runCharacterStep();
            }
        }},
        { text: '‚ùå ÂèñÊ∂à', action: () => showCurrentProgress() }
    ]);
}

// ÊòæÁ§∫ÂΩìÂâçËøõÂ∫¶
function showCurrentProgress() {
    const title = state.novelTitle || writeState.outline?.title || 'Êú™ÂëΩÂêç';
    const mode = state.mode === 'write' ? 'Ââµ‰ΩúÊ®°Âºè' : 'Â∞éÂÖ•Ê®°Âºè';
    const chaptersCount = writeState.chapters?.length || 0;
    
    let progress = [];
    if (state.novel || writeState.idea) progress.push('‚úÖ ÊïÖ‰∫ãÈùàÊÑü');
    if (state.concept) progress.push('‚úÖ Ê¶ÇÂøµÂàÜÊûê');
    if (Object.keys(state.interview || {}).length > 0 || Object.keys(writeState.interview || {}).length > 0) progress.push('‚úÖ Ë®™Ë´á');
    if (state.chapters || writeState.outline) progress.push('‚úÖ Á´†ÁØÄË¶èÂäÉ');
    if (state.characters) progress.push('‚úÖ ËßíËâ≤Ë®≠Ë®à');
    if (chaptersCount > 0) progress.push(`‚úÖ Â∑≤ÂØ´ ${chaptersCount} Á´†`);
    if (state.storyboard) progress.push('‚úÖ ÂàÜÈè°Ë°®');
    
    addAIMessage(`üìä **Áï∂ÂâçÈÄ≤Â∫¶**

**„Ää${title}„Äã** - ${mode}

${progress.join('\n') || 'ÂâõÈñãÂßã'}

ÁπºÁ∫åÁï∂ÂâçÂ∑•‰ΩúÔºö`, [
        { text: '‚ñ∂Ô∏è ÁπºÁ∫å', action: () => state.mode === 'write' ? continueWriteProject() : continueImportProject() },
        { text: 'üíæ ‰øùÂ≠òÈ†ÖÁõÆ', action: () => saveProject() }
    ]);
}

// ==================== Êñá‰ª∂ÂØºÂÖ• ====================
document.getElementById('fileInput').addEventListener('change', async (e) => {
    console.log('üìÅ Êñá‰ª∂ÈÄâÊã©Ëß¶Âèë');
    const file = e.target.files[0];
    if (!file) {
        console.log('üìÅ Ê≤°ÊúâÈÄâÊã©Êñá‰ª∂');
        return;
    }
    console.log('üìÅ Êñá‰ª∂:', file.name, file.size, 'bytes');
    
    // üîß ‰øùÂ≠òÊñá‰ª∂ÂºïÁî®ÔºàÂõ†‰∏∫ÂêéÈù¢Ë¶ÅÊ∏ÖÁ©∫inputÔºâ
    const selectedFile = file;
    e.target.value = ''; // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•ÔºåÂÖÅËÆ∏ÈÄâÊã©Âêå‰∏ÄÊñá‰ª∂
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâËøõË°å‰∏≠ÁöÑÂ∑•‰Ωú - Ëá™Âä®‰øùÂ≠òÂêéÁªßÁª≠
    if (hasActiveWork()) {
        saveProject(null, true); // ÈùôÈªò‰øùÂ≠òÂΩìÂâçÈ°πÁõÆ
        // Ê∏ÖÁ©∫Áä∂ÊÄÅ
        currentProjectId = null;
        state.assets = { concept: null, characters: [], chapters: [], costumes: null, scripts: {}, storyboards: {} };
        state.production = { episodes: 10, durationMin: 3, shotsPerMin: 10 };
        updateAssetsPanel();
    }
    
    // üîß ‰ΩøÁî®‰øùÂ≠òÁöÑÊñá‰ª∂ÂºïÁî®ÁªßÁª≠Â§ÑÁêÜ
    const fileToProcess = selectedFile;
    
    addUserMessage(`üìÑ Â∞éÂÖ•Êñá‰ª∂: ${fileToProcess.name}`);
    addTypingIndicator();
    
    try {
        let text = '';
        const ext = fileToProcess.name.split('.').pop().toLowerCase();
        
        if (ext === 'txt') {
            text = await fileToProcess.text();
        } else if (ext === 'docx') {
            const arrayBuffer = await fileToProcess.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            text = result.value;
        } else if (ext === 'pdf') {
            const arrayBuffer = await fileToProcess.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }
        }
        
        state.novel = text;
        
        // üîß Bug #5 fix: ‰ªéÊñáÊú¨ÂÜÖÂÆπÊèêÂèñÊ†áÈ¢òÔºåËÄå‰∏çÊòØÁî®Êñá‰ª∂Âêç
        const extractedTitle = extractTitleFromText(text);
        state.novelTitle = extractedTitle || fileToProcess.name.replace(/\.[^/.]+$/, '');
        
        state.step = 1;
        state.mode = 'import';
        
        // üîß Ëá™Âä®ÂàõÂª∫È°πÁõÆ
        currentProjectId = null;  // ÈáçÁΩÆÔºåËÆ©saveProjectÂàõÂª∫Êñ∞ID
        saveProject(state.novelTitle, true);  // ÈùôÈªò‰øùÂ≠ò
        
        console.log('üìÅ Áä∂ÊÄÅÂ∑≤ËÆæÁΩÆ:', { mode: state.mode, step: state.step, title: state.novelTitle, novelLen: text.length, projectId: currentProjectId });
        
        removeTypingIndicator();
        
        const preview = text.substring(0, 200) + (text.length > 200 ? '...' : '');
        addAIMessage(`‚úÖ ÊàêÂäüÂ∞éÂÖ•„Ää${state.novelTitle}„Äã

**Â≠óÊï∏**: ${text.length.toLocaleString()} Â≠ó
**È†êË¶Ω**: ${preview}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Ë´ãÈÅ∏ÊìáÂàÜÊûêÊñπÂºèÔºö`, [
            { text: 'üé§ Ê∑±Â∫¶Ë®™Ë´áÔºàÊõ¥Á≤æÊ∫ñÔºâ', action: () => startImportInterview() },
            { text: '‚ö° Áõ¥Êé•ÂàÜÊûêÔºàÊõ¥Âø´ÈÄüÔºâ', action: () => runConceptStep() }
        ]);
        
    } catch (err) {
        removeTypingIndicator();
        addAIMessage(`üìÑ **Êñá‰ª∂ËÆÄÂèñÈÅáÂà∞ÂïèÈ°å**

**ÂèØËÉΩÂéüÂõ†**: 
‚Ä¢ Êñá‰ª∂Ê†ºÂºè‰∏çÊîØÊåÅÔºàÁõÆÂâçÊîØÊåÅ .txt, .docx, .pdfÔºâ
‚Ä¢ Êñá‰ª∂ÂèØËÉΩÂ∑≤ÊêçÂ£ûÊàñÂä†ÂØÜ
‚Ä¢ Êñá‰ª∂Â§™Â§ßÔºàÂª∫Ë≠∞ < 5MBÔºâ

**Âª∫Ë≠∞**:
‚Ä¢ ÂòóË©¶Âè¶Â≠òÁÇ∫ .txt Ê†ºÂºèÂæåÈáçÊñ∞Â∞éÂÖ•
‚Ä¢ Á¢∫Ë™çÊñá‰ª∂ÂèØ‰ª•Ê≠£Â∏∏ÊâìÈñã`, [
            { text: 'üìÑ ÈáçÊñ∞ÈÅ∏ÊìáÊñá‰ª∂', action: () => document.getElementById('fileInput').click() },
            { text: '‚úçÔ∏è ÊîπÁî®Ââµ‰ΩúÊ®°Âºè', action: () => startWriteMode() }
        ]);
    }
});

// ==================== Âø´ÈÄüÁîüÊàêÔºàË∑≥ËøáËÆøË∞àÔºâ====================
async function quickGenerate() {
    addAIMessage(`‚ö° **Âø´ÈÄüÁîüÊàêÊ®°Âºè**

Ê≠£Âú®Ëá™ÂãïÂÆåÊàêÊâÄÊúâÊ≠•È©ü...`);
    
    addProgressCard('Âø´ÈÄüÁîüÊàêÂàÜÈè°', 0);
    
    try {
        // Ê≠•È™§1: Á´†ËäÇËßÑÂàí
        updateProgress(20);
        showAgentStatus('üìù Á´†ÁØÄË¶èÂäÉÂ∏´', 'Ë¶èÂäÉÊïÖ‰∫ãÁµêÊßã...', 'narrative');
        const chaptersResult = await callAgent('narrative', state.novel.substring(0, 5000), { concept: state.concept });
        state.chapters = safeJSONParse(chaptersResult, 'chapters');
        state.step = 4;
        
        // Ê≠•È™§2: ËßíËâ≤ËÆæËÆ°
        updateProgress(50);
        showAgentStatus('üë§ ËßíËâ≤Ë®≠Ë®àÂ∏´', 'Ë®≠Ë®àËßíËâ≤...');
        const charactersResult = await callAgent('character', state.novel.substring(0, 4000), { concept: state.concept, chapters: state.chapters });
        state.characters = safeJSONParse(charactersResult, 'characters');
        state.step = 5;
        
        // Ê≠•È™§3: ÂàÜÈïúÁîüÊàê
        updateProgress(80);
        showAgentStatus('üé¨ ÂàÜÈè°Â∞éÊºî', 'ÁîüÊàêÂàÜÈè°Ë°®...', 'storyboard');
        const storyboardResult = await callAgent('storyboard', state.novel.substring(0, 3000), { concept: state.concept, chapters: state.chapters, characters: state.characters });
        state.storyboard = storyboardResult;
        
        updateProgress(100);
        removeProgressCard();
        hideAgentStatus();
        
        const eps = state.chapters?.chapters || state.chapters?.episodes || [];
        const chars = state.characters?.characters || [];
        
        addAIMessage(`‚úÖ **Âø´ÈÄüÁîüÊàêÂÆåÊàêÔºÅ**

üìä **ÁîüÊàêÁµêÊûú**Ôºö
‚Ä¢ Á´†ÁØÄÔºö${eps.length} ÈõÜ
‚Ä¢ ËßíËâ≤Ôºö${chars.length} ÂÄã
‚Ä¢ ÂàÜÈè°ÔºöÂ∑≤ÁîüÊàê

Êé•‰∏ã‰æÜÔºö`, [
            { text: 'üì• Â∞éÂá∫Excel', action: () => exportExcel() },
            { text: 'üì• Â∞éÂá∫JSON', action: () => exportAll() },
            { text: 'üëÄ Êü•ÁúãË©≥ÊÉÖ', action: () => showGeneratedDetails() }
        ]);
        
    } catch (err) {
        removeProgressCard();
        hideAgentStatus();
        recordError(err, 'Âø´ÈÄüÁîüÊàê');
        showFriendlyError(err, 'Âø´ÈÄüÁîüÊàê', () => quickGenerate());
    }
}

function showGeneratedDetails() {
    const eps = state.chapters?.chapters || state.chapters?.episodes || [];
    const chars = state.characters?.characters || [];
    
    let details = `üìã **ÁîüÊàêË©≥ÊÉÖ**\n\n**Á´†ÁØÄÂàóË°®**Ôºö\n`;
    eps.slice(0, 5).forEach((ep, i) => {
        details += `‚Ä¢ Á¨¨${i+1}ÈõÜÔºö${ep.title || ep.name || 'Êú™ÂëΩÂêç'}\n`;
    });
    if (eps.length > 5) details += `‚Ä¢ ...ÈÇÑÊúâ ${eps.length - 5} ÈõÜ\n`;
    
    details += `\n**ËßíËâ≤ÂàóË°®**Ôºö\n`;
    chars.slice(0, 5).forEach(c => {
        details += `‚Ä¢ ${c.name}Ôºà${c.role || 'ËßíËâ≤'}Ôºâ\n`;
    });
    if (chars.length > 5) details += `‚Ä¢ ...ÈÇÑÊúâ ${chars.length - 5} ÂÄãËßíËâ≤\n`;
    
    addAIMessage(details, [
        { text: 'üì• Â∞éÂá∫', action: () => exportAll() },
        { text: 'üîÑ ÈáçÊñ∞ÁîüÊàê', action: () => quickGenerate() }
    ]);
}

// ==================== Ê£ÄÊü•Â∞èËØ¥ÂÜÖÂÆπ ====================
function checkNovelExists() {
    if (!state.novel || state.novel.length < 10) {
        addAIMessage(`‚ö†Ô∏è **ÈÇÑÊ≤íÊúâÂ∞éÂÖ•Â∞èË™™ÂÖßÂÆπ**

Ë´ãÂÖàÈÅ∏Êìá‰∏ÄÁ®ÆÊñπÂºèÈñãÂßãÔºö`, [
            { text: 'üìÑ Â∞éÂÖ•Â∞èË™™', action: () => document.getElementById('fileInput').click() },
            { text: '‚úçÔ∏è AIÂπ´ÊàëÂØ´', action: () => startWriteMode() }
        ]);
        return false;
    }
    return true;
}

// ==================== Ê≠•È™§ÊâßË°å ====================
async function runConceptStep() {
    if (!checkNovelExists()) return;
    
    addTypingIndicator();
    
    // ËØ¶ÁªÜÊ≠•È™§ÊòæÁ§∫
    const steps = [
        { text: 'üìñ ËÆÄÂèñÂ∞èË™™ÂÖ®Êñá...', done: false, current: true },
        { text: 'üìö ËºâÂÖ• Robert McKee„ÄäÊïÖ‰∫ã„ÄãÊñπÊ≥ïË´ñ', done: false },
        { text: 'üéØ ÊèêÂèñÊ†∏ÂøÉÊà≤ÂäáË°ùÁ™Å', done: false },
        { text: 'üé≠ ÂàÜÊûêÈ°ûÂûã/‰∏ªÈ°å/Âü∫Ë™ø', done: false },
        { text: 'üí° ÁîüÊàêÈ´òÊ¶ÇÂøµLogline', done: false }
    ];
    showAgentStatus('üí° È´òÊ¶ÇÂøµÂàÜÊûêÂ∏´', '„ÄåËÆìÊàë‰æÜÁêÜËß£ÈÄôÂÄãÊïÖ‰∫ã...„Äç', 'concept', steps);
    
    try {
        // Ê≠•È™§1: ËØªÂèñ
        await new Promise(r => setTimeout(r, 500));
        steps[0].done = true; steps[0].current = false;
        steps[1].current = true;
        showAgentStatus('üí° È´òÊ¶ÇÂøµÂàÜÊûêÂ∏´', '„ÄåËºâÂÖ•McKeeÂÉπÂÄºËΩâÊèõÁêÜË´ñ...„Äç', 'concept', steps);
        
        // Ê≠•È™§2: ËΩΩÂÖ•ÊñπÊ≥ïËÆ∫
        await new Promise(r => setTimeout(r, 800));
        steps[1].done = true; steps[1].current = false;
        steps[2].current = true;
        showAgentStatus('üí° È´òÊ¶ÇÂøµÂàÜÊûêÂ∏´', '„ÄåÊ≠£Âú®ÊèêÂèñÊ†∏ÂøÉÊà≤ÂäáË°ùÁ™Å...„Äç', 'concept', steps);
        
        // Ê≠•È™§3: Ë∞ÉÁî®AI
        await new Promise(r => setTimeout(r, 500));
        steps[2].done = true; steps[2].current = false;
        steps[3].current = true;
        showAgentStatus('üí° È´òÊ¶ÇÂøµÂàÜÊûêÂ∏´', '„ÄåDeepSeekÂàÜÊûê‰∏≠...È°ûÂûã/‰∏ªÈ°å/Âü∫Ë™ø„Äç', 'concept', steps);
        
        const result = await callAgent('concept', state.novel.substring(0, 4000));
        
        // Ê≠•È™§4ÂÆåÊàê
        steps[3].done = true; steps[3].current = false;
        steps[4].current = true;
        showAgentStatus('üí° È´òÊ¶ÇÂøµÂàÜÊûêÂ∏´', '„ÄåÊï¥ÁêÜÂàÜÊûêÁµêÊûú...„Äç', 'concept', steps);
        await new Promise(r => setTimeout(r, 300));
        
        steps.forEach(s => { s.done = true; s.current = false; });
        const conceptData = safeJSONParse(result, 'concept');
        
        removeTypingIndicator();
        hideAgentStatus();
        
        // ÊòæÁ§∫ÂèØÁºñËæëÁ°ÆËÆ§Ê°Ü
        showEditableResult('concept', conceptData, 
            // Á°ÆËÆ§ÂõûË∞É
            (finalData) => {
                state.concept = finalData;
                state.assets.concept = finalData;
                state.step = 1;
                
                addAIMessage(`‚úÖ **È´òÊ¶ÇÂøµÂ∑≤Á¢∫Ë™çÔºÅ**

**È°ûÂûã**: ${finalData.genre || '-'}
**‰∏ªÈ°å**: ${finalData.theme || '-'}
**Âü∫Ë™ø**: ${finalData.tone || '-'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Â∑≤Â≠òÂÖ•È†ÖÁõÆË≥áÁî¢ÔºåÊé•‰∏ã‰æÜÈÄ≤Ë°å**ËßíËâ≤ÂàÜÊûê**...`);
                
                saveProject();
                updateAssetsPanel();
                setTimeout(() => runCharacterAnalysis(), 1000);
            },
            // ÈáçÊñ∞ÁîüÊàêÂõûË∞É
            () => {
                addAIMessage('üîÑ Â•ΩÁöÑÔºåÊ≠£Âú®ÈáçÊñ∞ÁîüÊàêÈ´òÊ¶ÇÂøµ...');
                runConceptStep();
            }
        );
        
    } catch (err) {
        removeTypingIndicator();
        recordError(err, 'Ê¶ÇÂøµÂàÜÊûê');
        showFriendlyError(err, 'Ê¶ÇÂøµÂàÜÊûê', () => runConceptStep());
    }
}

// ==================== ËßíËâ≤ÂàÜÊûêÔºàÊ≠•È™§2Ôºâ====================
async function runCharacterAnalysis() {
    if (!checkNovelExists()) return;
    
    state.step = 2;
    addTypingIndicator();
    
    // ËØ¶ÁªÜÊ≠•È™§ÊòæÁ§∫
    const steps = [
        { text: 'üìñ ËÆÄÂèñÂ∞èË™™ÊñáÊú¨...', done: false, current: true },
        { text: 'üìö ËºâÂÖ• Bancroft„ÄäËßíËâ≤Â°ëÈÄ†„ÄãÊñπÊ≥ïË´ñ', done: false },
        { text: 'üîç NLPË≠òÂà•‰∏ªË¶ÅËßíËâ≤', done: false },
        { text: 'üß† ÂàÜÊûêËßíËâ≤ÂøÉÁêÜÂãïÊ©ü', done: false },
        { text: 'üé® ÁîüÊàêËßíËâ≤Ë¶ñË¶∫Ë®≠Ë®à', done: false },
        { text: '‚ú® Ëº∏Âá∫AIÁπ™ÂúñPrompt', done: false }
    ];
    showAgentStatus('üë§ ËßíËâ≤Ë®≠Ë®àÂ∏´', '„ÄåËÆìÊàë‰æÜË™çË≠òÊØè‰∏ÄÂÄãËßíËâ≤...„Äç', 'character', steps);
    
    try {
        // Ê≠•È™§1: ËØªÂèñ
        await new Promise(r => setTimeout(r, 400));
        steps[0].done = true; steps[0].current = false;
        steps[1].current = true;
        showAgentStatus('üë§ ËßíËâ≤Ë®≠Ë®àÂ∏´', '„ÄåËºâÂÖ•Tom BancroftËßíËâ≤Ë®≠Ë®àÁêÜË´ñ...„Äç', 'character', steps);
        
        // Ê≠•È™§2: ËΩΩÂÖ•ÊñπÊ≥ïËÆ∫
        await new Promise(r => setTimeout(r, 600));
        steps[1].done = true; steps[1].current = false;
        steps[2].current = true;
        showAgentStatus('üë§ ËßíËâ≤Ë®≠Ë®àÂ∏´', '„ÄåÊ≠£Âú®Ë≠òÂà•‰∏ªËßí/ÈÖçËßí/ÂèçÊ¥æ...„Äç', 'character', steps);
        
        // Ê≠•È™§3: NLPËØÜÂà´
        await new Promise(r => setTimeout(r, 500));
        steps[2].done = true; steps[2].current = false;
        steps[3].current = true;
        showAgentStatus('üë§ ËßíËâ≤Ë®≠Ë®àÂ∏´', '„ÄåÂàÜÊûêËßíËâ≤ÊÖæÊúõ„ÄÅÊÅêÊáº„ÄÅÂÖßÂøÉË°ùÁ™Å...„Äç', 'character', steps);
        
        const result = await callAgent('character', state.novel.substring(0, 4000), {
            concept: state.assets.concept
        });
        
        // Ê≠•È™§4ÂÆåÊàê
        steps[3].done = true; steps[3].current = false;
        steps[4].current = true;
        showAgentStatus('üë§ ËßíËâ≤Ë®≠Ë®àÂ∏´', '„ÄåÁîüÊàêËßíËâ≤Â§ñË≤åÊèèËø∞...„Äç', 'character', steps);
        await new Promise(r => setTimeout(r, 400));
        
        // Ê≠•È™§5ÂÆåÊàê
        steps[4].done = true; steps[4].current = false;
        steps[5].current = true;
        showAgentStatus('üë§ ËßíËâ≤Ë®≠Ë®àÂ∏´', '„ÄåËΩâÊèõÁÇ∫AIÁπ™ÂúñPrompt...„Äç', 'character', steps);
        await new Promise(r => setTimeout(r, 300));
        
        steps.forEach(s => { s.done = true; s.current = false; });
        
        console.log('üîç ËßíËâ≤APIËøîÂõû:', result);
        console.log('üîç ËßíËâ≤APIËøîÂõûÁ±ªÂûã:', typeof result);
        
        // Â¶ÇÊûúresultÂ∑≤ÁªèÊòØÂØπË±°ÔºåÁõ¥Êé•‰ΩøÁî®ÔºõÂê¶ÂàôËß£Êûê
        let charData;
        if (typeof result === 'object' && result !== null) {
            charData = result;
        } else {
            charData = safeJSONParse(result, 'characters');
        }
        console.log('üîç ËßíËâ≤Ëß£ÊûêÂêé:', charData);
        console.log('üîç charData keys:', Object.keys(charData || {}));
        
        // Â§öÁßçÊ†ºÂºèÂÖºÂÆπÔºàÂ¢ûÂº∫ÁâàÔºâ
        let chars = charData.characters 
            || charData.protagonists?.concat(charData.antagonists || [], charData.supporting || []) 
            || charData.character_list
            || charData.roles
            || charData.cast
            || [];
        
        // Â¶ÇÊûúËøòÊòØÁ©∫ÁöÑÔºåÂ∞ùËØïÁõ¥Êé•Áî®charData‰Ωú‰∏∫Êï∞ÁªÑ
        if ((!chars || chars.length === 0) && Array.isArray(charData)) {
            chars = charData;
        }
        
        // Â¶ÇÊûúcharDataÊúânameÂ±ûÊÄßÔºåÂèØËÉΩÊï¥‰∏™ÂØπË±°Â∞±ÊòØÂçï‰∏™ËßíËâ≤
        if ((!chars || chars.length === 0) && charData.name) {
            chars = [charData];
            console.log('üîç Âçï‰∏™ËßíËâ≤ÂØπË±°ÔºåÂåÖË£Ö‰∏∫Êï∞ÁªÑ');
        }
        
        // Â∞ùËØïÈÅçÂéÜcharDataÊâæÂà∞‰ªª‰ΩïÊï∞ÁªÑÁ±ªÂûãÁöÑÂ±ûÊÄß
        if (!chars || chars.length === 0) {
            for (const key in charData) {
                if (Array.isArray(charData[key]) && charData[key].length > 0 && charData[key][0]?.name) {
                    chars = charData[key];
                    console.log('üîç ÊâæÂà∞ËßíËâ≤Êï∞ÁªÑÂú®Â±ûÊÄß:', key);
                    break;
                }
            }
        }
        
        // Â¶ÇÊûúËß£ÊûêÂá∫Êù•ÊòØÁ©∫ÁöÑÔºåÁªô‰∏Ä‰∏™ÊèêÁ§∫
        if (!chars || chars.length === 0) {
            removeTypingIndicator();
            hideAgentStatus();
            console.error('‚ùå ËßíËâ≤Ëß£ÊûêÂ§±Ë¥•ÔºåÂéüÂßãÊï∞ÊçÆ:', result);
            console.error('‚ùå Ëß£ÊûêÂêéÊï∞ÊçÆ:', charData);
            addAIMessage(`‚ö†Ô∏è **ËßíËâ≤ÂàÜÊûêÊú™ËøîÂõûÁµêÊûú**

AIËøîÂõûÁöÑÂÖßÂÆπÊ†ºÂºèÂèØËÉΩÊúâÂïèÈ°å„ÄÇË´ãÈáçË©¶„ÄÇ

<details><summary>Ë™øË©¶‰ø°ÊÅØ</summary>
È°ûÂûã: ${typeof result}
Keys: ${Object.keys(charData || {}).join(', ') || 'ÁÑ°'}
</details>`, [
                { text: 'üîÑ ÈáçÊñ∞ÁîüÊàêËßíËâ≤', action: () => runCharacterAnalysis() },
                { text: '‚è≠Ô∏è Ë∑≥ÈÅéËßíËâ≤ÂàÜÊûê', action: () => runProductionEvaluation() }
            ]);
            return;
        }
        
        // Ê†ºÂºèÂåñËßíËâ≤Êï∞ÊçÆÔºàÂÖºÂÆπÂµåÂ•óÁªìÊûÑÔºâ
        const formattedChars = chars.map(c => {
            // ÊèêÂèñÂøÉÁêÜÂ±ÇÈù¢
            const psychology = c.psychology || {};
            const psychBio = [psychology.want, psychology.need, psychology.wound].filter(Boolean).join('Ôºõ');
            
            // ÊèêÂèñËßÜËßâÂ±ÇÈù¢
            const visual = c.visual || {};
            const visualDesc = [visual.age, visual.gender, visual.height, visual.build, visual.hair, visual.face].filter(Boolean).join('Ôºå');
            
            return {
                name: c.name || 'Êú™ÂëΩÂêç',
                role: c.role || c.type || 'ËßíËâ≤',
                bio: c.bio || c.description || c.backstory || psychBio || '',
                appearance: c.appearance || c.physical || visualDesc || '',
                prompt: c.prompt || c.ai_prompt || c.image_prompt || ''
            };
        });
        
        console.log('‚úÖ Ê†ºÂºèÂåñËßíËâ≤:', formattedChars);
        
        removeTypingIndicator();
        hideAgentStatus();
        
        // ÊòæÁ§∫ÂèØÁºñËæëÁ°ÆËÆ§Ê°Ü
        showEditableResult('characters', formattedChars,
            // Á°ÆËÆ§ÂõûË∞É
            (finalData) => {
                // üîß ‰ΩøÁî®ÁºñËæëÂêéÁöÑÊï∞ÊçÆÔºàÂåÖÂê´ÂÆåÊï¥ÁöÑbio/appearance/promptÔºâ
                state.assets.characters = finalData;
                
                // ËØ¶ÁªÜËßíËâ≤ÂàóË°®
                const charDetails = finalData.map(c => {
                    const bio = c.bio ? `\n   üìñ ${c.bio.substring(0, 80)}${c.bio.length > 80 ? '...' : ''}` : '';
                    const prompt = c.prompt ? `\n   üé® ${c.prompt.substring(0, 60)}...` : '';
                    return `‚Ä¢ **${c.name}** (${c.role})${bio}${prompt}`;
                }).join('\n\n');
                
                addAIMessage(`‚úÖ **ËßíËâ≤Â∑≤Á¢∫Ë™çÔºÅ**

${charDetails}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ÂÖ± **${finalData.length}** ÂÄãËßíËâ≤Â∑≤Â≠òÂÖ•Ë≥áÁî¢
Êé•‰∏ã‰æÜË®≠ÁΩÆ**Ë£Ω‰ΩúÂèÉÊï∏**...`);
                
                saveProject();
                updateAssetsPanel();
                setTimeout(() => runProductionEvaluation(), 1000);
            },
            // ÈáçÊñ∞ÁîüÊàêÂõûË∞É
            () => {
                addAIMessage('üîÑ Â•ΩÁöÑÔºåÊ≠£Âú®ÈáçÊñ∞ÂàÜÊûêËßíËâ≤...');
                runCharacterAnalysis();
            }
        );
        
    } catch (err) {
        removeTypingIndicator();
        hideAgentStatus();
        showFriendlyError(err, 'ËßíËâ≤ÂàÜÊûê', () => runCharacterAnalysis());
    }
}

// ==================== Êô∫ËÉΩËØÑ‰º∞Âª∫ËÆÆ ====================
async function runProductionEvaluation() {
    if (!state.novel) {
        askProductionSettings();
        return;
    }
    
    addTypingIndicator();
    showAgentStatus('üéØ Ë£Ω‰ΩúË©ï‰º∞Â∏´', '„ÄåÊ≠£Âú®ÂàÜÊûê‰ΩúÂìÅË¶èÊ®°...„Äç', 'concept');
    
    try {
        // Âü∫Á°ÄÊï∞ÊçÆÂàÜÊûê
        const novelLength = state.novel.length;
        const charCount = state.assets?.characters?.length || 0;
        const conceptGenre = state.assets?.concept?.genre || 'ÂäáÊÉÖ';
        const conceptTone = state.assets?.concept?.tone || '‰∏≠ÊÄß';
        
        // Êô∫ËÉΩËØÑ‰º∞ÁÆóÊ≥ï
        let suggestedEpisodes, suggestedDuration, suggestedDensity, reasoning;
        
        // Ê†πÊçÆÂ≠óÊï∞‰º∞ÁÆóÔºà‰∏≠ÊñáÁ∫¶500Â≠ó/ÂàÜÈíüÂèô‰∫ãÔºâ
        const estimatedMinutes = Math.round(novelLength / 400);
        
        if (novelLength < 10000) {
            // Áü≠ÁØá < 1‰∏áÂ≠ó
            suggestedEpisodes = Math.max(3, Math.min(8, Math.ceil(estimatedMinutes / 3)));
            suggestedDuration = 3;
            suggestedDensity = 12;
            reasoning = `üìö **Áü≠ÁØá‰ΩúÂìÅ**Ôºà${novelLength.toLocaleString()}Â≠óÔºâ\nÈÅ©ÂêàË£Ω‰ΩúÁ≤æÂìÅÁü≠ÂäáÔºåÁØÄÂ•èÁ∑äÊπä`;
        } else if (novelLength < 50000) {
            // ‰∏≠ÁØá 1-5‰∏áÂ≠ó
            suggestedEpisodes = Math.max(10, Math.min(24, Math.ceil(estimatedMinutes / 4)));
            suggestedDuration = 5;
            suggestedDensity = 10;
            reasoning = `üìñ **‰∏≠ÁØá‰ΩúÂìÅ**Ôºà${novelLength.toLocaleString()}Â≠óÔºâ\nÈÅ©ÂêàË£Ω‰ΩúÊ®ôÊ∫ñÁï™ÂäáÔºåÊÉÖÁØÄÂÆåÊï¥`;
        } else if (novelLength < 150000) {
            // ÈïøÁØá 5-15‰∏áÂ≠ó
            suggestedEpisodes = Math.max(20, Math.min(40, Math.ceil(estimatedMinutes / 5)));
            suggestedDuration = 5;
            suggestedDensity = 10;
            reasoning = `üìï **Èï∑ÁØá‰ΩúÂìÅ**Ôºà${novelLength.toLocaleString()}Â≠óÔºâ\nÂª∫Ë≠∞ÂàÜÂ≠£Ë£Ω‰ΩúÔºåÊØèÂ≠£12-24ÈõÜ`;
        } else {
            // Ë∂ÖÈïøÁØá > 15‰∏áÂ≠ó
            suggestedEpisodes = 30;
            suggestedDuration = 8;
            suggestedDensity = 10;
            reasoning = `üìö **Ë∂ÖÈï∑ÁØá‰ΩúÂìÅ**Ôºà${novelLength.toLocaleString()}Â≠óÔºâ\nÂª∫Ë≠∞ÂÖàË£Ω‰ΩúÁ¨¨‰∏ÄÂ≠£Ôºà30ÈõÜÔºâÔºåÂæåÁ∫åÂàÜÂ≠£`;
        }
        
        // Ê†πÊçÆÁ±ªÂûãÂæÆË∞É
        if (conceptGenre.includes('Âãï‰Ωú') || conceptGenre.includes('Êá∏Áñë')) {
            suggestedDensity = Math.min(15, suggestedDensity + 3);
        } else if (conceptGenre.includes('ÊñáËóù') || conceptGenre.includes('ÊÑõÊÉÖ')) {
            suggestedDensity = Math.max(8, suggestedDensity - 2);
        }
        
        // ËÆ°ÁÆóÊÄªÈïúÂ§¥
        const totalShots = suggestedEpisodes * suggestedDuration * suggestedDensity;
        const totalMinutes = suggestedEpisodes * suggestedDuration;
        
        // ËäÇÂ•èÊèèËø∞
        let paceIcon = '‚öñÔ∏è';
        let paceDesc = '‰∏≠Á≠âÁØÄÂ•è';
        if (suggestedDensity >= 13) { paceIcon = 'üöÄ'; paceDesc = 'Âø´ÁØÄÂ•èÂãï‰ΩúÊà≤'; }
        else if (suggestedDensity <= 9) { paceIcon = 'üé≠'; paceDesc = 'ÊÖ¢ÁØÄÂ•èÊñáËóùÁâá'; }
        
        removeTypingIndicator();
        hideAgentStatus();
        
        // ‰øùÂ≠òÂª∫ËÆÆÂÄº
        const suggestion = { 
            episodes: suggestedEpisodes, 
            duration: suggestedDuration, 
            density: suggestedDensity,
            totalShots,
            totalMinutes
        };
        
        addAIMessage(`üéØ **Êô∫ËÉΩË£Ω‰ΩúË©ï‰º∞**

${reasoning}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìä **AI Âª∫Ë≠∞Ë¶èÊ†º**Ôºö
‚Ä¢ ÈõÜÊï∏Ôºö**${suggestedEpisodes}** ÈõÜ
‚Ä¢ ÊôÇÈï∑Ôºö**${suggestedDuration}** ÂàÜÈêò/ÈõÜ
‚Ä¢ Èè°È†≠ÂØÜÂ∫¶Ôºö**${suggestedDensity}** ÂÄã/ÂàÜÈêò
‚Ä¢ ${paceIcon} ${paceDesc}

üìà **Áî¢Âá∫È†ê‰º∞**Ôºö
‚Ä¢ Á∏ΩÊôÇÈï∑Ôºö${totalMinutes} ÂàÜÈêò
‚Ä¢ Á∏ΩÂàÜÈè°Ôºö**${totalShots.toLocaleString()}** ÂÄã

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üí° ÈÄôÊòØÂü∫Êñº‰ΩúÂìÅË¶èÊ®°ÁöÑÊô∫ËÉΩÂª∫Ë≠∞Ôºå‰Ω†ÂèØ‰ª•Ôºö`, [
            { text: `‚úÖ Êé°Áî®Âª∫Ë≠∞ (${suggestedEpisodes}ÈõÜ√ó${suggestedDuration}ÂàÜ)`, action: () => applyProductionSuggestion(suggestion) },
            { text: '‚úèÔ∏è Ëá™Â∑±Ë®≠ÂÆö', action: () => askProductionSettings() }
        ]);
        
    } catch (err) {
        removeTypingIndicator();
        hideAgentStatus();
        console.error('Ë©ï‰º∞Â§±Êïó:', err);
        // Âá∫ÈîôÊó∂Áõ¥Êé•ËøõÂÖ•ÊâãÂä®ËÆæÁΩÆ
        askProductionSettings();
    }
}

// Â∫îÁî®AIÂª∫ËÆÆÁöÑËßÑÊ†º
function applyProductionSuggestion(suggestion) {
    state.production.episodes = suggestion.episodes;
    state.production.durationMin = suggestion.duration;
    state.production.shotsPerMin = suggestion.density;
    state.production.totalShots = suggestion.totalShots;
    
    addAIMessage(`‚úÖ **Â∑≤Êé°Áî®AIÂª∫Ë≠∞Ë¶èÊ†º**

üìä **Ë£Ω‰ΩúË¶èÊ†º**:
‚Ä¢ ${suggestion.episodes} ÈõÜ √ó ${suggestion.duration} ÂàÜÈêò
‚Ä¢ Èè°È†≠ÂØÜÂ∫¶: ${suggestion.density} ÂÄã/ÂàÜÈêò
‚Ä¢ È†êË®àÂàÜÈè°: **${suggestion.totalShots.toLocaleString()}** ÂÄã

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Ê≠£Âú®ÁîüÊàê**Á´†ÁØÄË¶èÂäÉ**...`);
    
    saveProject();
    setTimeout(() => runChapterPlanning(), 1000);
}

// ==================== Âà∂‰ΩúËÆæÁΩÆÈóÆÁ≠îÔºàÁ∫ØÂØπËØùÂºèÔºâ====================
let productionStep = 0;  // 0=ÈõÜÊï∞, 1=Êó∂Èïø, 2=ÂØÜÂ∫¶, 3=ÂÆåÊàê

function askProductionSettings() {
    productionStep = 0;
    state.step = 1.5;  // Âà∂‰ΩúËÆæÁΩÆÈò∂ÊÆµ
    
    addAIMessage(`üé¨ **Ë£Ω‰ΩúË¶èÊ†ºË®≠ÂÆö (1/3)**

‰Ω†Â∏åÊúõÈÄôÈÉ®‰ΩúÂìÅÂàÜÊàêÂ§öÂ∞ëÈõÜÔºü

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üí° Áõ¥Êé•Ëº∏ÂÖ•Êï∏Â≠óÔºå‰æãÂ¶ÇÔºö10„ÄÅ20„ÄÅ30
Âª∫Ë≠∞ÔºöÁü≠ÁØá5-10ÈõÜÔºå‰∏≠ÁØá15-25ÈõÜÔºåÈï∑ÁØá30+ÈõÜ`);
}

function handleProductionInput(text) {
    const num = parseInt(text.trim());
    
    if (productionStep === 0) {
        // ÈõÜÊï∞
        if (isNaN(num) || num < 1 || num > 100) {
            addAIMessage(`‚ùå Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈõÜÊï∏Ôºà1-100‰πãÈñìÁöÑÊï∏Â≠óÔºâ`);
            return;
        }
        state.production.episodes = num;
        productionStep = 1;
        
        addAIMessage(`‚úÖ Â∑≤Ë®≠ÂÆö **${num}** ÈõÜ

üé¨ **Ë£Ω‰ΩúË¶èÊ†ºË®≠ÂÆö (2/3)**

ÊØèÈõÜÂ§ßÁ¥ÑÂ§öÂ∞ëÂàÜÈêòÔºü

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üí° Áõ¥Êé•Ëº∏ÂÖ•Êï∏Â≠óÔºå‰æãÂ¶ÇÔºö3„ÄÅ5„ÄÅ10
AIÁï™ÂäáÂª∫Ë≠∞Ôºö2-10ÂàÜÈêò/ÈõÜ`);
        
    } else if (productionStep === 1) {
        // Êó∂Èïø
        if (isNaN(num) || num < 1 || num > 30) {
            addAIMessage(`‚ùå Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÊôÇÈï∑Ôºà1-30ÂàÜÈêò‰πãÈñìÁöÑÊï∏Â≠óÔºâ`);
            return;
        }
        state.production.durationMin = num;
        productionStep = 2;
        
        addAIMessage(`‚úÖ Â∑≤Ë®≠ÂÆöÊØèÈõÜ **${num}** ÂàÜÈêò

üé¨ **Ë£Ω‰ΩúË¶èÊ†ºË®≠ÂÆö (3/3)**

ÈÅ∏ÊìáÈè°È†≠ÁØÄÂ•èÔºö

**üê¢ ‰ΩéÂØÜÂ∫¶ (6-10Èè°/ÂàÜÈêò)**
ÈÅ©ÂêàÔºöÊñáËóùÁâá„ÄÅÊÉÖÊÑüÂäá„ÄÅÂ∞çË©±Êà≤
ÁâπÈªûÔºöÈï∑Èè°È†≠„ÄÅÊÖ¢ÁØÄÂ•è„ÄÅÊ≥®ÈáçÊ∞õÂúçÁáüÈÄ†
ÂèÉËÄÉÔºö„ÄäËä±Ê®£Âπ¥ËèØ„Äã„ÄäÊù±‰∫¨Áâ©Ë™û„Äã

**‚öñÔ∏è ‰∏≠ÂØÜÂ∫¶ (10-14Èè°/ÂàÜÈêò)**
ÈÅ©ÂêàÔºöÂäáÊÉÖÁâá„ÄÅÂÆ∂Â∫≠Âäá„ÄÅÊó•Â∏∏Áï™
ÁâπÈªûÔºöÁØÄÂ•èÈÅ©‰∏≠„ÄÅÊïò‰∫ãÊµÅÊö¢„ÄÅÊÉÖÁØÄÁ∑äÊπä
ÂèÉËÄÉÔºö„ÄäÈú∏ÁéãÂà•Âß¨„Äã„ÄäÂçÉËàáÂçÉÂ∞ã„Äã

**üöÄ È´òÂØÜÂ∫¶ (15-20Èè°/ÂàÜÈêò)**
ÈÅ©ÂêàÔºöÂãï‰ΩúÁâá„ÄÅÊá∏ÁñëÂäá„ÄÅÂø´ÁØÄÂ•èÊïò‰∫ã
ÁâπÈªûÔºöÂø´ÈÄüÂâ™ËºØ„ÄÅË¶ñË¶∫Ë°ùÊìä„ÄÅÁ∑äÂºµÂà∫ÊøÄ
ÂèÉËÄÉÔºö„ÄäË´úÂΩ±ÈáçÈáç„Äã„ÄäÁòãÁãÇÁöÑÈ∫•ÂÖãÊñØ„Äã`, [
            { text: 'üê¢ ‰Ωé (6-10/ÂàÜ)', action: () => setShotDensity(8, '‰Ωé') },
            { text: '‚öñÔ∏è ‰∏≠ (10-14/ÂàÜ)', action: () => setShotDensity(12, '‰∏≠') },
            { text: 'üöÄ È´ò (15-20/ÂàÜ)', action: () => setShotDensity(17, 'È´ò') }
        ]);
        
    } else if (productionStep === 2) {
        // ÈïúÂ§¥ÂØÜÂ∫¶ - ‰πüÊîØÊåÅÁõ¥Êé•ËæìÂÖ•Êï∞Â≠ó
        if (isNaN(num) || num < 5 || num > 30) {
            addAIMessage(`‚ùå Ë´ãÈÅ∏Êìá‰∏äÊñπÊåâÈàïÔºåÊàñËº∏ÂÖ•ÊúâÊïàÊï∏Â≠óÔºà5-30Ôºâ`);
            return;
        }
        finalizeShotDensity(num);
    }
}

function setShotDensity(density, level) {
    addUserMessage(`Èè°È†≠ÁØÄÂ•è: ${level}`);
    finalizeShotDensity(density);
}

function finalizeShotDensity(num) {
    state.production.shotsPerMin = num;
    state.production.totalShots = state.production.episodes * state.production.durationMin * num;
    productionStep = 3;
    state.step = 3;  // Á´†ËäÇËßÑÂàíÈò∂ÊÆµ
    
    // Ê†πÊçÆÂØÜÂ∫¶ÁªôÂá∫ËäÇÂ•èÊèèËø∞
    let paceDesc = '';
    if (num <= 10) paceDesc = 'üê¢ ÊÖ¢ÁØÄÂ•è - ÈÅ©ÂêàÊñáËóùÁâá„ÄÅÂ∞çË©±Êà≤';
    else if (num <= 14) paceDesc = '‚öñÔ∏è ‰∏≠Á≠âÁØÄÂ•è - ÈÅ©ÂêàÂäáÊÉÖÁâá„ÄÅÊó•Â∏∏Áï™';
    else paceDesc = 'üöÄ Âø´ÁØÄÂ•è - ÈÅ©ÂêàÂãï‰ΩúÊà≤„ÄÅÊá∏ÁñëÂäá';
    
    addAIMessage(`‚úÖ **Ë£Ω‰ΩúË¶èÊ†ºÁ¢∫Ë™ç**

üìä **‰Ω†ÁöÑÁï™ÂäáË¶èÊ†º**:
‚Ä¢ ÈõÜÊï∏: ${state.production.episodes} ÈõÜ
‚Ä¢ ÊØèÈõÜÊôÇÈï∑: ${state.production.durationMin} ÂàÜÈêò
‚Ä¢ Èè°È†≠ÂØÜÂ∫¶: ${state.production.shotsPerMin} ÂÄã/ÂàÜÈêò
‚Ä¢ Á∏ΩÊôÇÈï∑: ${state.production.episodes * state.production.durationMin} ÂàÜÈêò
‚Ä¢ È†êË®àÂàÜÈè°: **${state.production.totalShots}** ÂÄã

${paceDesc}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Ê≠£Âú®ÁîüÊàê**Á´†ÁØÄË¶èÂäÉ**...`);
    
    // ÁîüÊàêÁ´†ËäÇËßÑÂàí
    saveProject();
    setTimeout(() => runChapterPlanning(), 1000);
}

// ==================== Á´†ËäÇËßÑÂàíÔºàÊ≠•È™§3Ôºâ====================
async function runChapterPlanning() {
    if (!checkNovelExists()) return;
    
    addTypingIndicator();
    
    // ËØ¶ÁªÜÊ≠•È™§
    const steps = [
        { text: 'üìä ÂàÜÊûêÊïÖ‰∫ãÊû∂Êßã...', done: false, current: true },
        { text: 'üìö ËºâÂÖ• Blake Snyder„ÄäSave the Cat„Äã15ÁØÄÊãç', done: false },
        { text: 'üé≠ Â•óÁî®‰∏âÂπïÂäáÁµêÊßãÊ®°Âûã', done: false },
        { text: 'üìù Ë®≠Ë®àÂêÑÈõÜÊÉÖÁØÄË¶ÅÈªû', done: false },
        { text: '‚è±Ô∏è Ë®àÁÆóÊôÇÈï∑ËàáÁØÄÂ•èÂàÜÈÖç', done: false }
    ];
    showAgentStatus('üìù Á´†ÁØÄË¶èÂäÉÂ∏´', '„ÄåÊ≠£Âú®Ë¶èÂäÉÊïÖ‰∫ãÁØÄÂ•è...„Äç', 'narrative', steps);
    
    try {
        // Ê≠•È™§1: ÂàÜÊûê
        await new Promise(r => setTimeout(r, 400));
        steps[0].done = true; steps[0].current = false;
        steps[1].current = true;
        showAgentStatus('üìù Á´†ÁØÄË¶èÂäÉÂ∏´', '„ÄåËºâÂÖ•Blake Snyder 15ÁØÄÊãçË°®...„Äç', 'narrative', steps);
        
        // Ê≠•È™§2: ÊñπÊ≥ïËÆ∫
        await new Promise(r => setTimeout(r, 600));
        steps[1].done = true; steps[1].current = false;
        steps[2].current = true;
        showAgentStatus('üìù Á´†ÁØÄË¶èÂäÉÂ∏´', '„ÄåÂäÉÂàÜËµ∑/Êâø/ËΩâ/ÂêàÈóúÈçµÁØÄÈªû...„Äç', 'narrative', steps);
        
        // Ê≠•È™§3: ‰∏âÂπïÂâß
        await new Promise(r => setTimeout(r, 500));
        steps[2].done = true; steps[2].current = false;
        steps[3].current = true;
        showAgentStatus('üìù Á´†ÁØÄË¶èÂäÉÂ∏´', '„ÄåDeepSeekË¶èÂäÉÂêÑÈõÜÊÉÖÁØÄ...„Äç', 'narrative', steps);
        
        // üîß ÊòéÁ°ÆÂëäËØâAIÈúÄË¶ÅÁîüÊàêÂ§öÂ∞ëÈõÜ
        const episodeCount = state.production.episodes || 10;
        const novelWithInstructions = `„ÄêÈáçË¶ÅÊåá‰ª§„ÄëË´ãË¶èÂäÉ ${episodeCount} ÈõÜÁöÑÁ´†ÁØÄÂ§ßÁ∂±ÔºåÂøÖÈ†àËº∏Âá∫ ${episodeCount} ÂÄãÁ´†ÁØÄÔºå‰∏çËÉΩÂ§ö‰πü‰∏çËÉΩÂ∞ëÔºÅ

---‰ª•‰∏ãÊòØÂ∞èË™™ÂÖßÂÆπ---
${state.novel.substring(0, 5000)}`;
        
        const result = await callAgent('narrative', novelWithInstructions, {
            concept: state.assets.concept,
            characters: state.assets.characters,
            targetEpisodes: episodeCount,
            durationPerEp: state.production.durationMin,
            instruction: `ÂøÖÈ†àÁîüÊàêÊÅ∞Â•Ω ${episodeCount} ÂÄãÁ´†ÁØÄÔºÅ`
        });
        
        steps[1].done = true; steps[1].current = false;
        steps[2].done = true; steps[3].done = true;
        
        const chapData = safeJSONParse(result, 'chapters');
        const chapters = chapData.chapters || chapData.episodes || [];
        
        // üîß Ê£ÄÊü•Á´†ËäÇÊï∞ÈáèÊòØÂê¶Á¨¶ÂêàË¶ÅÊ±Ç
        const targetCount = state.production.episodes || 10;
        if (chapters.length < targetCount) {
            console.warn(`‚ö†Ô∏è Á´†ÁØÄÊï∏Èáè‰∏çË∂≥: ÈúÄË¶Å${targetCount}ÈõÜÔºåÂè™ÁîüÊàê‰∫Ü${chapters.length}ÈõÜ`);
        }
        
        // Â≠òÂÖ•È°πÁõÆËµÑ‰∫ßÔºàÂåÖÂê´ÂÆåÊï¥‰ø°ÊÅØÔºâ
        state.assets.chapters = chapters.map((c, i) => ({
            number: c.number || i + 1,
            title: c.title || `Á¨¨${i+1}ÈõÜ`,
            phase: c.phase || '',           // Ëµ∑/Êâø/ËΩ¨/Âêà
            duration: c.duration || state.production.durationMin,
            summary: c.summary || c.description || '',
            highlight: c.highlight || '',    // ‰∫ÆÁÇπ
            conflict: c.conflict || '',      // ÂÜ≤Á™Å
            emotion: c.emotion || '',        // ÊÉÖÊÑüËµ∞Âêë
            hook: c.hook || ''               // ÊÇ¨ÂøµÈí©Â≠ê
        }));
        
        removeTypingIndicator();
        hideAgentStatus();
        
        // ËÆ°ÁÆóËµ∑ÊâøËΩ¨ÂêàÁªìÊûÑ
        const total = state.assets.chapters.length;
        const structure = {
            Ëµ∑: Math.ceil(total * 0.1),  // 10% ÂºÄÁØá
            Êâø: Math.ceil(total * 0.3),  // 30% ÂèëÂ±ï
            ËΩ¨: Math.ceil(total * 0.4),  // 40% È´òÊΩÆ
            Âêà: total - Math.ceil(total * 0.1) - Math.ceil(total * 0.3) - Math.ceil(total * 0.4)  // Ââ©‰Ωô ÁªìÂ±Ä
        };
        
        // ÊòæÁ§∫ÂÖ®ÈÉ®Á´†ËäÇÂàóË°®ÔºàËØ¶ÁªÜ‰ø°ÊÅØÔºâ
        const chapterList = state.assets.chapters.map((c, i) => {
            // ‰ºòÂÖà‰ΩøÁî®APIËøîÂõûÁöÑphaseÔºåÂê¶ÂàôÊ†πÊçÆ‰ΩçÁΩÆËÆ°ÁÆó
            let phase = c.phase || '';
            if (!phase) {
                if (i < structure.Ëµ∑) phase = 'Ëµ∑';
                else if (i < structure.Ëµ∑ + structure.Êâø) phase = 'Êâø';
                else if (i < structure.Ëµ∑ + structure.Êâø + structure.ËΩ¨) phase = 'ËΩ¨';
                else phase = 'Âêà';
            }
            
            let details = `**„Äê${phase}„ÄëÁ¨¨${c.number}ÈõÜ ${c.title}**`;
            if (c.summary) details += `\n   üìñ ${c.summary.substring(0, 60)}${c.summary.length > 60 ? '...' : ''}`;
            if (c.highlight) details += `\n   üåü ‰∫ÆÈªû: ${c.highlight}`;
            if (c.conflict) details += `\n   ‚öîÔ∏è Ë°ùÁ™Å: ${c.conflict}`;
            if (c.hook) details += `\n   üé£ Êá∏Âøµ: ${c.hook}`;
            return details;
        }).join('\n\n');
        
        // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞ÁõÆÊ†áÈõÜÊï∞ (Â§çÁî®‰∏äÈù¢ÁöÑtargetCount)
        const actualCount = state.assets.chapters.length;
        const isShort = actualCount < targetCount;
        
        const warningMsg = isShort 
            ? `\n\n‚ö†Ô∏è **Ê≥®ÊÑèÔºöÊÇ®Ë¶ÅÊ±Ç${targetCount}ÈõÜÔºåÂØ¶ÈöõÁîüÊàê‰∫Ü${actualCount}ÈõÜ**\nÂ¶ÇÊûú‰∏çÊªøÊÑèÔºåÂèØ‰ª•ÈªûÊìäÈáçÊñ∞ÁîüÊàê„ÄÇ`
            : '';
        
        // üîß ‰ΩøÁî®ÂèØÁºñËæëÁ°ÆËÆ§Ê°ÜÔºåËÆ©Áî®Êà∑ÂèØ‰ª•‰øÆÊîπ
        showEditableResult('chapters', state.assets.chapters,
            // Á°ÆËÆ§ÂõûË∞É
            (finalData) => {
                state.assets.chapters = finalData;
                state.step = 4;
                
                // üîß Ë∞ÉËØïÔºöÁ°ÆËÆ§‰øùÂ≠òÂâçÁöÑËµÑ‰∫ßÁä∂ÊÄÅ
                console.log('‚úÖ ÂàÜÁ´†Á°ÆËÆ§Ôºå‰øùÂ≠òÂâçËµÑ‰∫ß:', {
                    concept: !!state.assets.concept,
                    characters: state.assets.characters?.length || 0,
                    chapters: finalData.length
                });
                
                addAIMessage(`‚úÖ **Á´†ÁØÄË¶èÂäÉÂ∑≤Á¢∫Ë™çÔºÅ** (${finalData.length}ÈõÜ)

üìä **ÊïÖ‰∫ãÁµêÊßã**
${finalData.slice(0, 3).map(c => `‚Ä¢ Á¨¨${c.number}ÈõÜ„Äå${c.title}„Äç`).join('\n')}
${finalData.length > 3 ? `...ÈÇÑÊúâ ${finalData.length - 3} ÈõÜ` : ''}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Â∑≤Â≠òÂÖ•È†ÖÁõÆË≥áÁî¢ÔºåÊé•‰∏ã‰æÜÈÄ≤Ë°å**ÊúçÂåñÈÅìË®≠Ë®à**...`);
                
                saveProject();
                updateAssetsPanel();
                setTimeout(() => runProductionDesign(), 1000);
            },
            // ÈáçÊñ∞ÁîüÊàêÂõûË∞É
            () => {
                addAIMessage('üîÑ Â•ΩÁöÑÔºåÊ≠£Âú®ÈáçÊñ∞Ë¶èÂäÉÁ´†ÁØÄ...');
                runChapterPlanning();
            }
        );
        
    } catch (err) {
        removeTypingIndicator();
        hideAgentStatus();
        showFriendlyError(err, 'Á´†ÁØÄË¶èÂäÉ', () => runChapterPlanning());
    }
}

// ==================== ÊúçÂåñÈÅìËÆæËÆ°ÔºàÊ≠•È™§4Ôºâ====================
async function runProductionDesign() {
    if (!checkNovelExists()) return;
    
    addTypingIndicator();
    
    // ËØ¶ÁªÜÊ≠•È™§
    const steps = [
        { text: 'üèõÔ∏è Ë™øÁî®ÊôÇ‰ª£ËÉåÊôØË≥áÊñôÂ∫´...', done: false, current: true },
        { text: 'üëî ÂïüÂãïÊúçË£ùË®≠Ë®àÊ®°ÁµÑ', done: false },
        { text: 'üè† ÁîüÊàêÂ†¥ÊôØ‰ΩàÊôØÊñπÊ°à', done: false },
        { text: 'üîß ÂàóÂá∫ÈóúÈçµÈÅìÂÖ∑Ê∏ÖÂñÆ', done: false }
    ];
    showAgentStatus('üëó ÊúçÂåñÈÅìË®≠Ë®àÂ∏´', '„ÄåÊ≠£Âú®Á†îÁ©∂ÊôÇ‰ª£È¢®Ê†º...„Äç', 'production_design', steps);
    
    try {
        steps[0].done = true; steps[0].current = false;
        steps[1].current = true;
        showAgentStatus('üëó ÊúçÂåñÈÅìË®≠Ë®àÂ∏´', '„ÄåÁÇ∫ÊØèÂÄãËßíËâ≤Ë®≠Ë®àÂ∞àÂ±¨ÈÄ†Âûã...„Äç', 'production_design', steps);
        
        const result = await callAgent('production_design', state.novel.substring(0, 3000), {
            concept: state.assets.concept,
            characters: state.assets.characters,
            chapters: state.assets.chapters
        });
        
        console.log('üîç production_design ÂéüÂßãËøîÂõû:', result);
        console.log('üîç production_design ËøîÂõûÁ±ªÂûã:', typeof result);
        
        steps.forEach(s => { s.done = true; s.current = false; });
        
        // Â¶ÇÊûúresultÂ∑≤ÁªèÊòØÂØπË±°ÔºåÁõ¥Êé•‰ΩøÁî®
        let designData;
        if (typeof result === 'object' && result !== null) {
            designData = result;
        } else {
            designData = safeJSONParse(result, 'production_design');
        }
        
        console.log('üîç production_design Ëß£ÊûêÂêé:', designData);
        
        // ÂáÜÂ§áÊúçÂåñÈÅìÊï∞ÊçÆ
        const costumes = designData.costumes || [];
        const sets = designData.sets || designData.scenes || designData.locations || [];
        const props = designData.props || [];
        
        removeTypingIndicator();
        hideAgentStatus();
        
        // Ê†ºÂºèÂåñ‰∏∫ÂèØÁºñËæëÊñáÊú¨
        const productionData = { costumes, sets, props };
        
        // ÊòæÁ§∫ÂèØÁºñËæëÁ°ÆËÆ§Ê°Ü
        showEditableResult('production', productionData,
            // Á°ÆËÆ§ÂõûË∞É
            (finalData) => {
                state.assets.costumes = finalData.costumes || [];
                state.assets.sets = finalData.sets || [];
                state.assets.props = finalData.props || [];
                
                const costumeCount = state.assets.costumes.length;
                const setCount = state.assets.sets.length;
                const propCount = state.assets.props.length;
                
                addAIMessage(`‚úÖ **ÊúçÂåñÈÅìÂ∑≤Á¢∫Ë™çÔºÅ**

‚Ä¢ üëî ÊúçË£ù: ${costumeCount} Â•ó
‚Ä¢ üè† Â†¥ÊôØ: ${setCount} ÂÄã
‚Ä¢ üé≠ ÈÅìÂÖ∑: ${propCount} ‰ª∂

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Â∑≤Â≠òÂÖ•È†ÖÁõÆË≥áÁî¢ÔºåÊé•‰∏ã‰æÜÈñãÂßã**ÂØ´ÂäáÊú¨**ÔºàÁ¨¨1ÈõÜÔºâ...`);
                
                state.step = 5;
                state.currentChapter = 1;
                saveProject();
                updateAssetsPanel();
                setTimeout(() => runScriptWriting(1), 1000);
            },
            // ÈáçÊñ∞ÁîüÊàêÂõûË∞É
            () => {
                addAIMessage('üîÑ Â•ΩÁöÑÔºåÊ≠£Âú®ÈáçÊñ∞Ë®≠Ë®àÊúçÂåñÈÅì...');
                runProductionDesign();
            }
        );
        
    } catch (err) {
        removeTypingIndicator();
        hideAgentStatus();
        showFriendlyError(err, 'ÊúçÂåñÈÅìË®≠Ë®à', () => runProductionDesign());
    }
}

// ==================== ÂâßÊú¨ÂÜô‰ΩúÔºàÊ≠•È™§5ÔºåÂàÜÁ´†Ôºâ====================
async function runScriptWriting(chapterNum) {
    if (!checkNovelExists()) return;
    
    const chapter = state.assets.chapters?.[chapterNum - 1];
    if (!chapter) {
        addAIMessage(`‚ö†Ô∏è **Á¨¨${chapterNum}ÈõÜ‰∏çÂ≠òÂú®**

${state.assets.chapters?.length > 0 
    ? `ÁõÆÂâçÊúâ ${state.assets.chapters.length} ÈõÜÔºåË´ãËº∏ÂÖ•„ÄåÁîüÊàêÁ¨¨1ÈõÜÂäáÊú¨„ÄçÂà∞„ÄåÁîüÊàêÁ¨¨${state.assets.chapters.length}ÈõÜÂäáÊú¨„Äç`
    : 'Ë´ãÂÖàÁîüÊàêÁ´†ÁØÄË¶èÂäÉÔºåËº∏ÂÖ•„ÄåÁîüÊàêÁ´†ÁØÄ„Äç'}`, [
            { text: 'üìù ÁîüÊàêÁ´†ÁØÄË¶èÂäÉ', action: () => runChapterPlanning() }
        ]);
        return;
    }
    
    addTypingIndicator();
    
    // ËØ¶ÁªÜÊ≠•È™§
    const steps = [
        { text: 'üìã Ê≠£Âú®ËÆÄÂèñÁ´†ÁØÄÂ§ßÁ∂±...', done: false, current: true },
        { text: 'üîó ËºâÂÖ•ÂâçÈõÜÂäáÊÉÖ‰∏ä‰∏ãÊñá', done: false },
        { text: 'üé¨ Ë™øÁî®Â†¥ÊôØÁµêÊßãÊ®°Êùø', done: false },
        { text: 'üí¨ ÁîüÊàêËßíËâ≤Â∞çË©±Âè∞Ë©û', done: false },
        { text: 'üé≠ Ê∑ªÂä†Ë°®ÊºîÂãï‰ΩúÊèèËø∞', done: false }
    ];
    showAgentStatus('‚úçÔ∏è Á∑®Âäá', `„ÄåÁ¨¨${chapterNum}ÈõÜÔºåËÆìÊàëÊßãÊÄù‰∏Ä‰∏ã...„Äç`, 'screenwriter', steps);
    
    try {
        // Ëé∑ÂèñÂâçÈù¢Á´†ËäÇ‰Ωú‰∏∫‰∏ä‰∏ãÊñá
        steps[0].done = true; steps[0].current = false;
        steps[1].current = true;
        showAgentStatus('‚úçÔ∏è Á∑®Âäá', '„ÄåÂõûÈ°ß‰∏Ä‰∏ãÂâçÈù¢ÁöÑÂäáÊÉÖ...„Äç', 'screenwriter', steps);
        
        const prevScripts = [];
        for (let i = Math.max(1, chapterNum - 2); i < chapterNum; i++) {
            if (state.assets.scripts[i]) {
                prevScripts.push(`„ÄêÁ¨¨${i}ÈõÜÊëòË¶Å„Äë${state.assets.scripts[i].substring(0, 500)}...`);
            }
        }
        
        steps[1].done = true; steps[1].current = false;
        steps[2].current = true;
        showAgentStatus('‚úçÔ∏è Á∑®Âäá', '„ÄåÈùàÊÑü‰æÜ‰∫ÜÔºåÊ≠£Âú®Êí∞ÂØ´...„Äç', 'screenwriter', steps);
        
        // ËÆ°ÁÆóÁõÆÊ†áÂ≠óÊï∞Ôºà1ÂàÜÈíüÁ∫¶300-400Â≠óÂØπÁôΩ+Âä®‰ΩúÊèèÂÜôÔºâ
        const durationMin = state.production?.durationMin || 3;
        const targetWords = durationMin * 400;  // ÊØèÂàÜÈíü400Â≠ó
        
        const context = {
            concept: state.assets.concept,
            characters: state.assets.characters,
            chapter: chapter,
            previousScripts: prevScripts.join('\n'),
            costumes: state.assets.costumes,
            production: state.production,
            duration: durationMin,
            targetWords: targetWords,
            instruction: `„ÄêÈáçË¶Å„ÄëÊú¨ÈõÜÊôÇÈï∑ ${durationMin} ÂàÜÈêòÔºåÂäáÊú¨ÂøÖÈ†àÈÅîÂà∞ ${targetWords} Â≠ó‰ª•‰∏äÔºÅ‰∏çË¶ÅÂØ´Â§™Áü≠ÔºÅ`
        };
        
        // Âú®Â∞èËØ¥ÂÜÖÂÆπÂâçÂä†ÊòéÁ°ÆÁöÑÂ≠óÊï∞Ë¶ÅÊ±Ç
        const novelWithInstructions = `„ÄêÁ∑®ÂäáÊåá‰ª§„ÄëË´ãÁÇ∫Á¨¨${chapterNum}ÈõÜÂØ´ÂÆåÊï¥ÂäáÊú¨
- ÊôÇÈï∑Ë¶ÅÊ±ÇÔºö${durationMin} ÂàÜÈêò
- Â≠óÊï∏Ë¶ÅÊ±ÇÔºöËá≥Â∞ë ${targetWords} Â≠óÔºàÁ¥Ñ ${Math.ceil(targetWords/100)} ÊÆµÂ†¥ÊôØÔºâ
- ÂøÖÈ†àÂåÖÂê´ÔºöÂ†¥ÊôØÊèèÂØ´„ÄÅÂãï‰ΩúÊåáÁ§∫„ÄÅÂÆåÊï¥Â∞çÁôΩ
- Ê†ºÂºèÔºö„ÄêÂ†¥ÊôØNÔºöÂú∞Èªû - ÊôÇÈñì„Äë

---‰ª•‰∏ãÊòØÂéüËëóÂèÉËÄÉ---
${state.novel.substring(0, 2000)}`;
        
        // üîß ‰ΩøÁî®ÊµÅÂºèAPIÈÅøÂÖçCloudflareË∂ÖÊó∂
        let result = await callAgentStream('screenwriter', novelWithInstructions, context, 
            (chunk, fullText) => {
                // ÂÆûÊó∂Êõ¥Êñ∞ÊòæÁ§∫
                updateAgentStatus('‚úçÔ∏è Á∑®Âäá', `ÁîüÊàê‰∏≠... ${fullText.length}Â≠ó`);
            }
        );
        
        // üîß Ê∏ÖÁêÜMarkdownÊ†áËÆ∞ÔºàÂâßÊú¨‰∏çÈúÄË¶Å**Á≤ó‰Ωì**Ôºâ
        result = cleanScriptMarkdown(result);
        
        // Ê†áËÆ∞ÂÖ®ÈÉ®ÂÆåÊàê
        steps.forEach(s => { s.done = true; s.current = false; });
        
        // Â≠òÂÖ•È°πÁõÆËµÑ‰∫ß
        state.assets.scripts[chapterNum] = result;
        state.currentChapter = chapterNum;
        
        removeTypingIndicator();
        hideAgentStatus();
        
        addAIMessage(`‚úçÔ∏è **Á¨¨${chapterNum}ÈõÜÂäáÊú¨ÂÆåÊàêÔºÅ**

üìÑ **${chapter.title}**
${result.substring(0, 300)}...

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úÖ Â∑≤Â≠òÂÖ•È†ÖÁõÆË≥áÁî¢

${chapterNum < state.assets.chapters.length ? `ÁπºÁ∫åÂØ´Á¨¨${chapterNum + 1}ÈõÜ...` : 'ÂÖ®ÈÉ®ÂäáÊú¨ÂÆåÊàêÔºÅ'}`);
        
        saveProject();
        
        if (chapterNum < state.assets.chapters.length) {
            // ÁªßÁª≠‰∏ã‰∏ÄÈõÜ
            setTimeout(() => runScriptWriting(chapterNum + 1), 1500);
        } else {
            // ÂÖ®ÈÉ®ÂÆåÊàêÔºåËá™Âä®ÂºÄÂßãÁîüÊàêÂàÜÈïú
            state.step = 6;
            addAIMessage(`üé¨ **ÂäáÊú¨ÂÖ®ÈÉ®ÂÆåÊàêÔºÅÂÖ± ${state.assets.chapters.length} ÈõÜ**

ÁèæÂú®Ëá™ÂãïÈñãÂßãÁîüÊàêÂàÜÈè°...`, [
                { text: 'üì• Â∞éÂá∫ÂäáÊú¨(Word)', action: () => exportScripts() }
            ]);
            
            // Ëá™Âä®ÂºÄÂßãÁ¨¨1ÈõÜÂàÜÈïú
            setTimeout(() => runStoryboardGeneration(1), 1500);
        }
        
    } catch (err) {
        removeTypingIndicator();
        hideAgentStatus();
        showFriendlyError(err, `Á¨¨${chapterNum}ÈõÜÂäáÊú¨`, () => runScriptWriting(chapterNum));
    }
}

// ==================== ÂØºÂÖ•Ê®°ÂºèËÆøË∞à ====================
async function startImportInterview() {
    addAIMessage(`üé§ **Ê∑±Â∫¶Ë®™Ë´áÊ®°Âºè**

È¶ñÂÖàËÆìÊàëÂàÜÊûê‰∏Ä‰∏ãÊïÖ‰∫ãÊ¶ÇÂøµÔºåÁÑ∂ÂæåË®≠Ë®àÈáùÂ∞çÊÄßÂïèÈ°å...`);
    
    // ÂÖàÂÅöÊ¶ÇÂøµÂàÜÊûê
    addTypingIndicator();
    try {
        const result = await callAgent('concept', state.novel.substring(0, 4000));
        state.concept = safeJSONParse(result, 'concept');
        state.assets.concept = state.concept;
        removeTypingIndicator();
        
        addAIMessage(`üìñ **Ê¶ÇÂøµÂàÜÊûêÂÆåÊàê**

**È°ûÂûã**: ${state.concept.genre || '-'}
**‰∏ªÈ°å**: ${state.concept.theme || '-'}

ÁèæÂú®Ê†πÊìöÊïÖ‰∫ãÂÖßÂÆπË®≠Ë®àË®™Ë´áÂïèÈ°å...`);
        
        // ÁÑ∂ÂêéÂºÄÂßãËÆøË∞à
        state.step = 2;  // ËÆøË∞àÈò∂ÊÆµ
        await startInterview();
        
    } catch (err) {
        removeTypingIndicator();
        addAIMessage(`‚ö†Ô∏è Ê¶ÇÂøµÂàÜÊûêÂ§±ÊïóÔºåÁõ¥Êé•ÈÄ≤ÂÖ•ÈÄöÁî®Ë®™Ë´á...`);
        state.step = 2;
        await startInterview();
    }
}

async function startInterview() {
    // ÁîüÊàêËÆøË∞àÈóÆÈ¢ò - Ë∞ÉÁî®ËÆøË∞àÊô∫ËÉΩ‰Ωì
    addTypingIndicator();
    showAgentStatus('üé§ Ë®™Ë´áÂ∏´', 'ÂàÜÊûêÊïÖ‰∫ãÔºåË®≠Ë®àÂïèÈ°å...', 'interview');
    
    try {
        // ‰º†ÂÖ•Êõ¥Â§öÂ∞èËØ¥ÂÜÖÂÆπÔºà6000Â≠óÁ¨¶ÔºâËÆ©AIËÉΩÊèêÂèñÂÖ∑‰Ωì‰∫∫Áâ©ÂíåÊÉÖËäÇ
        const result = await callAgent('interview', state.novel.substring(0, 6000), {
            concept: state.concept,
            novel: state.novel.substring(0, 6000)  // È¢ùÂ§ñ‰º† novel Â≠óÊÆµÁ°Æ‰øùÂêéÁ´ØËÉΩËØÜÂà´
        });
        
        console.log('Ë®™Ë´áAgentËøîÂõû:', result?.substring(0, 200));
        
        // Ëß£ÊûêÈóÆÈ¢ò
        const questions = extractQuestions(result);
        console.log('ÊèêÂèñÂà∞ÂïèÈ°å:', questions);
        
        if (questions.length > 0) {
            state.interviewQuestions = questions;
            state.currentQuestion = 0;
            
            removeTypingIndicator();
            hideAgentStatus();
            
            addAIMessage(`üé§ **Ë®™Ë´áÂ∏´** Ê†πÊìö‰Ω†ÁöÑÊïÖ‰∫ãË®≠Ë®à‰∫Ü ${questions.length} ÂÄãÈáùÂ∞çÊÄßÂïèÈ°åÔºö`);
            
            // ÈóÆÁ¨¨‰∏Ä‰∏™ÈóÆÈ¢ò
            setTimeout(() => askNextQuestion(), 500);
        } else {
            throw new Error('Êú™ËÉΩÊèêÂèñÂà∞ÂïèÈ°å');
        }
        
    } catch (err) {
        console.error('Ë®™Ë´áÁîüÊàêÂ§±Êïó:', err);
        removeTypingIndicator();
        hideAgentStatus();
        
        // ‰ΩøÁî®ÈªòËÆ§ÈóÆÈ¢ò
        state.interviewQuestions = [
            '‰Ω†Ââµ‰ΩúÈÄôÂÄãÊïÖ‰∫ãÁöÑÂàùË°∑ÊòØ‰ªÄÈ∫ºÔºüÊÉ≥ÂÇ≥ÈÅî‰ªÄÈ∫ºÊ†∏ÂøÉ‰ø°ÊÅØÔºü',
            'ÊïÖ‰∫ã‰∏≠Âì™ÂÄãËßíËâ≤ÊúÄÊâìÂãï‰Ω†ÔºüÁÇ∫‰ªÄÈ∫ºÔºü',
            '‰Ω†Â∏åÊúõËßÄÁúæÁúãÂÆåÂæåÊúâ‰ªÄÈ∫ºÊÑüÂèóÔºü',
            'ÊúâÂèÉËÄÉÈÅéÂÖ∂‰ªñ‰ΩúÂìÅÁöÑÈ¢®Ê†ºÂóéÔºü',
            'Â∞çË¶ñË¶∫ÂëàÁèæÊúâ‰ªÄÈ∫ºÊÉ≥Ê≥ïÔºü'
        ];
        state.currentQuestion = 0;
        
        addAIMessage(`‚ö†Ô∏è Ë®™Ë´áÂ∏´Êö´ÊôÇÈõ¢Á∑öÔºå‰ΩøÁî®ÈÄöÁî®ÂïèÈ°åÔºö

ÊàëÊúÉÂïè‰Ω† 5 ÂÄãÂïèÈ°åÔºåÂπ´Âä©ÊàëÊõ¥Â•ΩÂú∞ÁêÜËß£‰Ω†ÁöÑÂâµ‰ΩúÊÑèÂúñ„ÄÇ`);
        
        setTimeout(() => askNextQuestion(), 500);
    }
}

function extractQuestions(text) {
    // ÊèêÂèñÈóÆÈ¢òÂàóË°® - ÊîØÊåÅÂ§öÁßçÊ†ºÂºè
    const questions = [];
    
    // ÊñπÊ≥ï1: ‰ºòÂÖàÊèêÂèñ„Äå„ÄçÂºïÂè∑ÂÜÖÁöÑÈóÆÈ¢ò
    const quoted = text.match(/„Äå([^„Äç]+[Ôºü?])„Äç/g);
    if (quoted) {
        quoted.forEach(q => {
            const clean = q.replace(/[„Äå„Äç]/g, '').trim();
            if (clean.length > 5 && !questions.includes(clean)) {
                questions.push(clean);
            }
        });
    }
    
    // Â¶ÇÊûúÂ∑≤ÁªèÊèêÂèñÂà∞Ë∂≥Â§üÁöÑÈóÆÈ¢òÔºåÁõ¥Êé•ËøîÂõû
    if (questions.length >= 5) {
        return questions.slice(0, 5);
    }
    
    // ÊñπÊ≥ï2: ÊèêÂèñÂÖ∂‰ªñÂåÖÂê´ÈóÆÂè∑ÁöÑÂè•Â≠êÔºàÂéªÈáçÔºâ
    const lines = text.split('\n');
    for (const line of lines) {
        if ((line.includes('?') || line.includes('Ôºü')) && line.length > 10) {
            // Ê∏ÖÁêÜÊ†ºÂºè
            let clean = line.replace(/^[\d\.\)„ÄÅ\-\*\s]+/, '').trim();
            clean = clean.replace(/^\*\*[^*]+\*\*\s*/, ''); // ÁßªÈô§**Ê†áÈ¢ò**
            clean = clean.replace(/^„Äå|„Äç$/g, '').trim();
            
            if (clean.length > 10 && clean.length < 150) {
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Á±ª‰ººÈóÆÈ¢ò
                const isDuplicate = questions.some(q => 
                    q.includes(clean.substring(0, 15)) || clean.includes(q.substring(0, 15))
                );
                if (!isDuplicate) {
                    questions.push(clean);
                }
            }
        }
    }
    
    // ËøîÂõûÂâç5‰∏™ÈóÆÈ¢òÔºåÂ¶ÇÊûúÊ≤°ÊúâÊèêÂèñÂà∞ÂàôÁî®ÈªòËÆ§ÈóÆÈ¢ò
    return questions.length > 0 ? questions.slice(0, 5) : [
        '‰Ω†Ââµ‰ΩúÈÄôÂÄãÊïÖ‰∫ãÁöÑÂàùË°∑ÊòØ‰ªÄÈ∫ºÔºüÊÉ≥ÂÇ≥ÈÅî‰ªÄÈ∫ºÊ†∏ÂøÉ‰ø°ÊÅØÔºü',
        'ÊïÖ‰∫ã‰∏≠Âì™ÂÄãËßíËâ≤ÊúÄÊâìÂãï‰Ω†ÔºüÁÇ∫‰ªÄÈ∫ºÔºü',
        '‰Ω†Â∏åÊúõËßÄÁúæÁúãÂÆåÂæåÊúâ‰ªÄÈ∫ºÊÑüÂèóÔºü',
        'ÊúâÊ≤íÊúâÂèÉËÄÉÈÅéÂÖ∂‰ªñ‰ΩúÂìÅÁöÑÈ¢®Ê†ºÔºü',
        'Â∞çË¶ñË¶∫È¢®Ê†ºÊúâ‰ªÄÈ∫ºÊÉ≥Ê≥ïÔºüÔºàÊØîÂ¶ÇËâ≤Ë™ø„ÄÅÊ∞õÂúçÔºâ'
    ];
}

function askNextQuestion() {
    if (state.currentQuestion >= state.interviewQuestions.length) {
        // ËÆøË∞àÁªìÊùü
        finishInterview();
        return;
    }
    
    const q = state.interviewQuestions[state.currentQuestion];
    const num = state.currentQuestion + 1;
    const total = state.interviewQuestions.length;
    
    // Á∫ØÂØπËØùÂºèÔºö‰∏çÊòæÁ§∫ÊåâÈíÆÔºåÁî®Êà∑Áõ¥Êé•Âú®ËæìÂÖ•Ê°ÜÂõûÁ≠î
    addAIMessage(`üé§ **ÂâµÊÑèË®™Ë´á (${num}/${total})**

${q}`, [
        { text: '‚è≠Ô∏è Ë∑≥ÈÅéÈÄôÈ°å', action: () => skipQuestion() }
    ]);
}

function skipQuestion() {
    state.interview[state.currentQuestion] = '(Ë∑≥ÈÅé)';
    state.currentQuestion++;
    askNextQuestion();
}

async function finishInterview() {
    addAIMessage(`‚úÖ Ë®™Ë´áÂÆåÊàêÔºÅÊÑüË¨ù‰Ω†ÁöÑÂàÜ‰∫´„ÄÇ

‰Ω†ÁöÑÊÉ≥Ê≥ïÊúÉËûçÂÖ•Âà∞ËßíËâ≤Ë®≠Ë®àÂíåÁ´†ÁØÄË¶èÂäÉ‰∏≠„ÄÇ

Êé•‰∏ã‰æÜÈÄ≤Ë°å**ËßíËâ≤ÂàÜÊûê**...`);
    
    // ÁªßÁª≠ËßíËâ≤ÂàÜÊûêÊµÅÁ®ã
    saveProject();
    setTimeout(() => runCharacterAnalysis(), 1000);
}

async function runChaptersStep() {
    addProgressCard('ÁîüÊàêÁ´†ÁØÄË¶èÂäÉ', 0);
    
    try {
        const context = {
            concept: state.concept,
            interview: state.interview
        };
        
        // üîß ‰øÆÂ§çBug#3: Èò≤Ê≠¢null.substring()ÈîôËØØ
        const novelText = state.novel || writeState.idea?.premise || writeState.outline?.synopsis || '';
        
        updateProgress(30);
        const result = await callAgent('narrative', novelText.substring(0, 5000), context);
        updateProgress(100);
        
        state.chapters = safeJSONParse(result, 'chapters');
        state.step = 3;  // Ê†áËÆ∞Á´†ËäÇËßÑÂàíÂÆåÊàê
        
        removeProgressCard();
        
        const eps = state.chapters.chapters || state.chapters.episodes || [];
        addAIMessage(`üìù **Á´†ÁØÄË¶èÂäÉÂÆåÊàêÔºÅ** ÂÖ± ${eps.length} ÈõÜ

${eps.slice(0, 3).map((ep, i) => `‚Ä¢ Á¨¨${i+1}ÈõÜ: ${ep.title || ep.name || 'Êú™ÂëΩÂêç'}`).join('\n')}
${eps.length > 3 ? `‚Ä¢ ...ÈÇÑÊúâ ${eps.length - 3} ÈõÜ` : ''}

‚è≥ Ê≠£Âú®Ë®≠Ë®àËßíËâ≤...`);
        
        // üîß Ëá™Âä®ÁªßÁª≠‰∏ã‰∏ÄÊ≠•
        saveProject();
        setTimeout(() => runCharacterStep(), 1000);
        
    } catch (err) {
        removeProgressCard();
        recordError(err, 'Á´†ÁØÄË¶èÂäÉ');
        showFriendlyError(err, 'Á´†ÁØÄË¶èÂäÉ', () => runChaptersStep());
    }
}

async function runCharacterStep() {
    addProgressCard('ÁîüÊàêËßíËâ≤Ë®≠Ë®à', 0);
    
    try {
        const context = {
            concept: state.concept,
            chapters: state.chapters
        };
        
        // üîß ‰øÆÂ§çBug#3: Èò≤Ê≠¢null.substring()ÈîôËØØ
        const novelText = state.novel || writeState.outline?.synopsis || JSON.stringify(state.chapters) || '';
        
        updateProgress(30);
        const result = await callAgent('character', novelText.substring(0, 4000), context);
        updateProgress(100);
        
        state.characters = safeJSONParse(result, 'characters');
        state.step = 4;  // Ê†áËÆ∞ËßíËâ≤ËÆæËÆ°ÂÆåÊàê
        
        removeProgressCard();
        
        const chars = state.characters.characters || [];
        addAIMessage(`üë§ **ËßíËâ≤Ë®≠Ë®àÂÆåÊàêÔºÅ** ÂÖ± ${chars.length} ÂÄãËßíËâ≤

${chars.slice(0, 3).map(c => `‚Ä¢ **${c.name}** (${c.role || 'ËßíËâ≤'})`).join('\n')}

‚è≥ Ê≠£Âú®ÁîüÊàêÂàÜÈè°Ë°®...`);
        
        // üîß Ëá™Âä®ÁªßÁª≠‰∏ã‰∏ÄÊ≠•
        saveProject();
        setTimeout(() => runStoryboardStep(), 1000);
        
    } catch (err) {
        removeProgressCard();
        recordError(err, 'ËßíËâ≤Ë®≠Ë®à');
        showFriendlyError(err, 'ËßíËâ≤Ë®≠Ë®à', () => runCharacterStep());
    }
}

async function runStoryboardStep() {
    const targetShots = state.production?.totalShots || 100;
    const episodes = state.production?.episodes || 10;
    const shotsPerEp = Math.ceil(targetShots / episodes);
    
    addProgressCard(`ÁîüÊàêÂàÜÈè°Ë°® (ÁõÆÊ®ô: ${targetShots} ÂÄãÈè°È†≠)`, 0);
    
    try {
        // ÂåÖÂê´Âà∂‰ΩúËÆæÁΩÆ
        const context = {
            concept: state.concept,
            chapters: state.chapters,
            characters: state.characters,
            production: state.production,  // ‰º†ÈÄíÂà∂‰ΩúËÆæÁΩÆ
            targetShots: targetShots,
            shotsPerEpisode: shotsPerEp
        };
        
        // üîß ‰øÆÂ§çBug#3: Èò≤Ê≠¢null.substring()ÈîôËØØ
        const novelText = state.novel || writeState.outline?.synopsis || JSON.stringify(state.chapters) || '';
        
        // Ê∑ªÂä†Âà∂‰ΩúË¶ÅÊ±ÇÂà∞ÂÜÖÂÆπ
        const contentWithSpecs = `${novelText.substring(0, 2500)}

„ÄêË£Ω‰ΩúË¶èÊ†ºË¶ÅÊ±Ç„Äë
- Á∏ΩÈõÜÊï∏: ${episodes} ÈõÜ
- ÊØèÈõÜÊôÇÈï∑: ${state.production?.durationMin || 3} ÂàÜÈêò
- ÊØèÈõÜÈè°È†≠: ${shotsPerEp} ÂÄã
- Á∏ΩÈè°È†≠Êï∏: ${targetShots} ÂÄã
Ë´ãÊåâÁÖß‰ª•‰∏äË¶èÊ†ºÁîüÊàêÂÆåÊï¥ÁöÑÂàÜÈè°Ë°®„ÄÇ`;
        
        updateProgress(30);
        const result = await callAgent('storyboard', contentWithSpecs, context);
        updateProgress(100);
        
        // Ëß£ÊûêÂàÜÈïúÁªìÊûú
        const storyboardData = safeJSONParse(result, 'storyboard');
        state.storyboard = storyboardData;
        state.step = 5;  // Ê†áËÆ∞ÂàÜÈïúÂÆåÊàê
        
        removeProgressCard();
        saveProject();
        
        // ÁªüËÆ°ÂàÜÈïúÊï∞Èáè
        const shots = storyboardData?.shots || storyboardData?.storyboard || [];
        const shotCount = Array.isArray(shots) ? shots.length : 0;
        const epCount = (state.chapters?.chapters || state.chapters?.episodes || []).length;
        const charCount = (state.characters?.characters || []).length;
        
        // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞ÁõÆÊ†á
        const completion = Math.round((shotCount / targetShots) * 100);
        const status = shotCount >= targetShots * 0.8 ? '‚úÖ ÈÅîÊ®ô' : `‚ö†Ô∏è ${completion}%`;
        
        addAIMessage(`üé¨ **ÂàÜÈè°Ë°®ÁîüÊàêÂÆåÊàêÔºÅ**

üìä **Ë£Ω‰ΩúË≥áÊñôÁµ±Ë®à**:
‚Ä¢ ÊïÖ‰∫ãÊ¶ÇÂøµ: ‚úÖ
‚Ä¢ Á´†ÁØÄË¶èÂäÉ: ${epCount} ÈõÜ
‚Ä¢ ËßíËâ≤Ë®≠Ë®à: ${charCount} ÂÄã
‚Ä¢ ÂàÜÈè°Èè°È†≠: ${shotCount} / ${targetShots} ÂÄã ${status}

üéâ ‰Ω†ÁöÑAIÁï™ÂäáË£Ω‰ΩúË≥áÊñôÂ∑≤ÂÆåÊàêÔºÅ

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Â∞éÂá∫‰Ω†ÁöÑ‰ΩúÂìÅÔºö`, [
            { text: 'üì• Â∞éÂá∫Excel', action: () => exportExcel() },
            { text: 'üì• Â∞éÂá∫JSON', action: () => exportAll() }
        ]);
        
    } catch (err) {
        removeProgressCard();
        recordError(err, 'ÂàÜÈè°ÁîüÊàê');
        showFriendlyError(err, 'ÂàÜÈè°ÁîüÊàê', () => runStoryboardStep());
    }
}

// ==================== Êô∫ËÉΩ‰ΩìÂêçÁß∞Êò†Â∞Ñ ====================
const AGENT_NAMES = {
    concept: 'üí° Ê¶ÇÂøµÁîüÊàêÂô®',
    interview: 'üé§ Ë®™Ë´áÂ∏´',
    narrative: 'üìù Á´†ÁØÄË¶èÂäÉÂ∏´',
    character: 'üë§ ËßíËâ≤Ë®≠Ë®àÂ∏´',
    storyboard: 'üé¨ ÂàÜÈè°Â∞éÊºî',
    artstyle: 'üé® ÁæéË°ìÊåáÂ∞é',
    screenwriter: '‚úçÔ∏è Á∑®Âäá'
};

// ==================== APIË∞ÉÁî®ÔºàÂ∏¶Áä∂ÊÄÅÊòæÁ§∫Ôºâ====================
async function callAgent(agentId, content, context = {}) {
    const agentName = AGENT_NAMES[agentId] || agentId;
    
    // ÊòæÁ§∫Ë∞ÉÁî®Áä∂ÊÄÅ
    showAgentStatus(agentName, 'Ê∫ñÂÇô‰∏≠...');
    
    // üß† ÂêØÂä®ÊÄùËÄÉÂä®Áîª
    startThinkingAnimation(agentId);
    
    // üîß Êüê‰∫õagent‰ΩøÁî®Âø´ÈÄüÊ®°ÂûãÔºàÁ´†ÁØÄË¶èÂäÉ„ÄÅË®™Ë´áÁ≠âÈúÄË¶ÅÂø´ÈÄüÈüøÊáâÁöÑÔºâ
    const fastAgents = ['narrative', 'interview', 'concept'];
    const useReasoner = fastAgents.includes(agentId) ? false : (context.useReasoner !== false);
    
    // üîß Ê∑ªÂä†Ë∂ÖÊó∂ÊéßÂà∂Ôºà3ÂàÜÈíüÔºâ
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 180000);
    
    try {
        const response = await fetch(`${API_BASE}/agent/${agentId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content, ...context, useReasoner }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            hideAgentStatus();
            throw new Error(`APIÈåØË™§: ${response.status}`);
        }
        
        const data = await response.json();
        
        // üß† ÂÅúÊ≠¢ÊÄùËÄÉÂä®Áîª
        stopThinkingAnimation();
        
        // ÊòæÁ§∫tokenÊ∂àËÄó
        if (data.tokens) {
            updateAgentStatus(agentName, `ÂÆåÊàê ‚úÖ (${data.tokens.input + data.tokens.output} tokens)`);
        }
        
        // Â¶ÇÊûúÊúâÊÄùËÄÉËøáÁ®ãÔºàreasonerÔºâÔºåÊòæÁ§∫Âá∫Êù•
        if (data.reasoning || data.thinking) {
            showThinkingProcess(data.reasoning || data.thinking);
        }
        
        setTimeout(hideAgentStatus, 2000);
        return data.result;
        
    } catch (err) {
        clearTimeout(timeoutId);
        stopThinkingAnimation();  // üß† Âá∫Èîô‰πüÂÅúÊ≠¢Âä®Áîª
        hideAgentStatus();
        
        // üîß Â§ÑÁêÜË∂ÖÊó∂ÈîôËØØ
        if (err.name === 'AbortError') {
            throw new Error('Ë´ãÊ±ÇË∂ÖÊôÇÔºåAIÊ≠£Âú®ÂøôÁ¢å‰∏≠ÔºåË´ãÁ®çÂæåÈáçË©¶');
        }
        throw err;
    }
}

// ==================== ÊµÅÂºèË∞ÉÁî®AgentÔºàËß£ÂÜ≥Ë∂ÖÊó∂Ôºâ====================
async function callAgentStream(agentId, content, context = {}, onChunk = null) {
    const agentName = AGENT_NAMES[agentId] || agentId;
    const persona = AGENT_PERSONAS[agentId];
    const avatar = persona?.avatar || 'ü§ñ';
    
    showAgentStatus(agentName, 'Ê∫ñÂÇô‰∏≠...');
    
    // ÂàõÂª∫ÂÆûÊó∂È¢ÑËßàÂå∫Âüü
    let streamPreview = document.getElementById('streamPreview');
    if (!streamPreview) {
        streamPreview = document.createElement('div');
        streamPreview.id = 'streamPreview';
        streamPreview.className = 'message ai stream-preview';
        streamPreview.innerHTML = `
            <div class="role">${avatar} ${agentName}</div>
            <div class="content stream-content" id="streamContent">
                <span class="typing-cursor">‚ñå</span>
            </div>
        `;
        document.getElementById('chatContainer').appendChild(streamPreview);
        scrollToBottom();
    }
    
    return new Promise((resolve, reject) => {
        let fullText = '';
        const streamContent = document.getElementById('streamContent');
        
        fetch(`${API_BASE}/agent-stream/${agentId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content, ...context })
        }).then(response => {
            if (!response.ok) {
                hideAgentStatus();
                if (streamPreview) streamPreview.remove();
                reject(new Error(`APIÈåØË™§: ${response.status}`));
                return;
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            function read() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        hideAgentStatus();
                        // ÁßªÈô§È¢ÑËßàÂå∫Âüü
                        if (streamPreview) streamPreview.remove();
                        resolve(fullText);
                        return;
                    }
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.startsWith('data: '));
                    
                    for (const line of lines) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            if (data.chunk) {
                                fullText += data.chunk;
                                if (onChunk) onChunk(data.chunk, fullText);
                                
                                // ÂÆûÊó∂Êõ¥Êñ∞È¢ÑËßàÂÜÖÂÆπÔºàÊòæÁ§∫ÊúÄÂêé500Â≠óÁ¨¶Ôºâ
                                if (streamContent) {
                                    const displayText = fullText.length > 500 
                                        ? '...' + fullText.slice(-500) 
                                        : fullText;
                                    streamContent.innerHTML = `<pre style="white-space:pre-wrap;font-family:inherit;margin:0;">${displayText}</pre><span class="typing-cursor">‚ñå</span>`;
                                    scrollToBottom();
                                }
                                
                                updateAgentStatus(agentName, `ÁîüÊàê‰∏≠... ${fullText.length}Â≠ó`);
                            }
                            if (data.done) {
                                fullText = data.fullText || fullText;
                            }
                            if (data.error) {
                                if (streamPreview) streamPreview.remove();
                                reject(new Error(data.error));
                                return;
                            }
                        } catch (e) {
                            // ÂøΩÁï•Ëß£ÊûêÈîôËØØ
                        }
                    }
                    
                    read();
                }).catch(err => {
                    hideAgentStatus();
                    if (streamPreview) streamPreview.remove();
                    reject(err);
                });
            }
            
            read();
        }).catch(err => {
            hideAgentStatus();
            if (streamPreview) streamPreview.remove();
            reject(err);
        });
    });
}

// ==================== ÂàÜÈïúÁîüÊàêÔºàÊ≠•È™§6ÔºåÂàÜÁ´†Ôºâ====================
async function runStoryboardGeneration(chapterNum) {
    if (!checkNovelExists()) return;
    
    const chapter = state.assets.chapters?.[chapterNum - 1];
    const script = state.assets.scripts?.[chapterNum];
    
    if (!chapter) {
        const totalChapters = state.assets.chapters?.length || 0;
        const buttons = totalChapters > 0 
            ? [
                { text: 'üé¨ ÁîüÊàêÁ¨¨1ÈõÜÂàÜÈè°', action: () => runStoryboardGeneration(1) },
                { text: `üé¨ ÁîüÊàêÁ¨¨${totalChapters}ÈõÜÂàÜÈè°`, action: () => runStoryboardGeneration(totalChapters) }
            ]
            : [{ text: 'üìù ÁîüÊàêÁ´†ÁØÄË¶èÂäÉ', action: () => runChapterPlanning() }];
        
        addAIMessage(`‚ö†Ô∏è **Á¨¨${chapterNum}ÈõÜ‰∏çÂ≠òÂú®**

${totalChapters > 0 
    ? `ÁõÆÂâçÊúâ ${totalChapters} ÈõÜÔºåË´ãÈÅ∏ÊìáË¶ÅÁîüÊàêÁöÑÂàÜÈè°Ôºö`
    : 'Ë´ãÂÖàÁîüÊàêÁ´†ÁØÄË¶èÂäÉ'}`, buttons);
        return;
    }
    
    if (!script) {
        addAIMessage(`‚ö†Ô∏è **Á¨¨${chapterNum}ÈõÜÂäáÊú¨Â∞öÊú™ÂÆåÊàê**

Ë´ãÂÖàÁîüÊàêÂäáÊú¨`, [
            { text: `‚úçÔ∏è ÁîüÊàêÁ¨¨${chapterNum}ÈõÜÂäáÊú¨`, action: () => runScriptWriting(chapterNum) }
        ]);
        return;
    }
    
    const targetShots = Math.ceil(chapter.duration * state.production.shotsPerMin);
    
    addTypingIndicator();
    
    // ËØ¶ÁªÜÊ≠•È™§
    const steps = [
        { text: 'üìú Ê≠£Âú®ËÆÄÂèñÂäáÊú¨ÂÖßÂÆπ...', done: false, current: true },
        { text: 'üé• Ë™øÁî®Â†¥ÊôØÂàÜÊûêÂºïÊìé', done: false },
        { text: 'üìê ÂïüÂãïÊßãÂúñË®≠Ë®àÊ®°ÁµÑ', done: false },
        { text: 'üéûÔ∏è Ë®àÁÆóÈÅãÈè°ÁØÄÂ•èÊõ≤Á∑ö', done: false },
        { text: '‚ú® ÁîüÊàêMidjourney/SDÊèêÁ§∫Ë©û', done: false },
        { text: `üìä Ëº∏Âá∫${targetShots}ÂÄãÂ∞àÊ•≠ÂàÜÈè°`, done: false }
    ];
    showAgentStatus('üé¨ ÂàÜÈè°Â∞éÊºî', `„ÄåÁ¨¨${chapterNum}ÈõÜÔºåËÆìÊàë‰æÜÂàÜÈè°...„Äç`, 'storyboard', steps);
    
    try {
        // Êõ¥Êñ∞Ê≠•È™§ËøõÂ∫¶
        steps[0].done = true; steps[0].current = false;
        steps[1].current = true;
        showAgentStatus('üé¨ ÂàÜÈè°Â∞éÊºî', '„ÄåÂàÜÊûêÂ†¥ÊôØÂàáÊèõÁØÄÈªû...„Äç', 'storyboard', steps);
        
        const context = {
            concept: state.assets.concept,
            characters: state.assets.characters,
            chapter: chapter,
            script: script.substring(0, 3000),
            costumes: state.assets.costumes,
            targetShots: targetShots,
            production: state.production,
            useReasoner: true,  // üîß ‰ΩøÁî®DeepSeek ReasonerËé∑ÂæóÊõ¥È´òË¥®ÈáèÂàÜÈïú
            outputFormat: `ÊØèÂÄãÈè°È†≠ÂøÖÈ†àÂåÖÂê´‰ª•‰∏ãÂ≠óÊÆµ:
- scene: Â†¥ÊôØÊèèËø∞
- time: ÊôÇÈñì(Êó•/Â§ú/ÈªÉÊòèÁ≠â)
- lighting: ÂÖâÁ∑ö(high-key/low-key/Ëá™ÁÑ∂ÂÖâÁ≠â)
- mood: Ê∞õÂúçÊÉÖÁ∑í
- characters: Âá∫Â†¥ËßíËâ≤
- action: Âãï‰ΩúÊèèËø∞
- expression: Ë°®ÊÉÖ
- costume: ÊúçË£ù
- dialogue: Âè∞Ë©û(Â¶ÇÊúâ)
- camera_position: Ê©ü‰Ωç(eye-level/high-angle/low-angle)
- camera_movement: ÈÅãÈè°(pan/tilt/dolly/crane/steadicam/static)
- shot_size: ÊôØÂà•(ECU/CU/MCU/MS/MLS/LS/ELS)
- narrative_function: Êïò‰∫ãÂäüËÉΩ
- image_prompt: AIÂúñÁâáPrompt (Ëã±Êñá, ÂåÖÂê´ 8K, --ar 16:9, cinematic)
- video_prompt: AIË¶ñÈ†ªPrompt (Ëã±Êñá, 4 seconds, cinematic motion)`
        };
        
        const result = await callAgent('storyboard', script.substring(0, 2500), context);
        
        // Êõ¥Êñ∞Ê≠•È™§‰∏∫ÂÖ®ÈÉ®ÂÆåÊàê
        steps.forEach(s => { s.done = true; s.current = false; });
        showAgentStatus('üé¨ ÂàÜÈè°Â∞éÊºî', '„ÄåÊï¥ÁêÜÂàÜÈè°Êï∏ÊìöÔºåÈ¶¨‰∏äÂÆåÊàê...„Äç', 'storyboard', steps);
        
        const sbData = safeJSONParse(result, 'storyboard');
        const shots = sbData.shots || sbData.storyboard || [];
        
        // Â≠òÂÖ•È°πÁõÆËµÑ‰∫ß
        state.assets.storyboards[chapterNum] = shots;
        
        removeTypingIndicator();
        hideAgentStatus();
        
        const totalChapters = state.assets.chapters.length;
        const isLastChapter = chapterNum >= totalChapters;
        
        addAIMessage(`üé¨ **Á¨¨${chapterNum}ÈõÜÂàÜÈè°ÂÆåÊàêÔºÅ**

üìä **ÂàÜÈè°Áµ±Ë®à**:
‚Ä¢ ÁõÆÊ®ôÈè°È†≠: ${targetShots} ÂÄã
‚Ä¢ ÂØ¶ÈöõÁîüÊàê: ${shots.length} ÂÄã
‚Ä¢ ÂÆåÊàêÁéá: ${Math.round(shots.length / targetShots * 100)}%

${shots.slice(0, 3).map((s, i) => `**Èè°È†≠${i+1}**: ${s.scene || s.description || ''}`).join('\n')}
${shots.length > 3 ? `\n... ÂÖ± ${shots.length} ÂÄãÈè°È†≠` : ''}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úÖ Â∑≤Â≠òÂÖ•È†ÖÁõÆË≥áÁî¢ (${chapterNum}/${totalChapters})

${isLastChapter ? 'üéâ ÂÖ®ÈÉ®ÂàÜÈè°ÂÆåÊàêÔºÅ' : `ÁπºÁ∫åÁîüÊàêÁ¨¨${chapterNum + 1}ÈõÜ...`}`);
        
        saveProject();
        updateAssetsPanel();
        
        if (!isLastChapter) {
            // Ëá™Âä®ÁªßÁª≠‰∏ã‰∏ÄÈõÜ
            setTimeout(() => runStoryboardGeneration(chapterNum + 1), 1500);
        } else {
            // ÂÖ®ÈÉ®ÂÆåÊàê
            addAIMessage(`üéâ **ÂÖ®ÈÉ®ÂàÜÈè°ÁîüÊàêÂÆåÊàêÔºÅ**

üìä **Á∏ΩË®à**:
‚Ä¢ ${totalChapters} ÈõÜ
‚Ä¢ ${Object.values(state.assets.storyboards).reduce((sum, s) => sum + (s?.length || 0), 0)} ÂÄãÈè°È†≠

ÁèæÂú®ÂèØ‰ª•Â∞éÂá∫‰∫ÜÔºö`, [
                { text: 'üìÑ Â∞éÂá∫ÂäáÊú¨(Word)', action: () => exportScripts() },
                { text: 'üìä Â∞éÂá∫ÂàÜÈè°(Excel)', action: () => exportStoryboards() },
                { text: 'üöÄ Ëº∏ÂÖ•FizzStudio', action: () => importToFizzDragon() }
            ]);
        }
        
    } catch (err) {
        removeTypingIndicator();
        hideAgentStatus();
        showFriendlyError(err, `Á¨¨${chapterNum}ÈõÜÂàÜÈè°`, () => runStoryboardGeneration(chapterNum));
    }
}

// ==================== ÁªßÁª≠ÂΩìÂâçÊ≠•È™§ ====================
function continueCurrentStep() {
    const step = state.step || 0;
    
    switch(step) {
        case 0:
            addAIMessage(`Ë´ãÂÖàÂ∞éÂÖ•Â∞èË™™ÈñãÂßãÈ†ÖÁõÆ`);
            break;
        case 1:
            runConceptStep();
            break;
        case 2:
            runCharacterAnalysis();
            break;
        case 3:
            runChapterPlanning();
            break;
        case 4:
            runProductionDesign();
            break;
        case 5:
            const nextChapter = (state.currentChapter || 0) + 1;
            if (nextChapter <= (state.assets.chapters?.length || 0)) {
                runScriptWriting(nextChapter);
            } else {
                addAIMessage(`‚úÖ ÂäáÊú¨Â∑≤ÂÖ®ÈÉ®ÂÆåÊàêÔºÅ`, [
                    { text: 'üé¨ ÁîüÊàêÁ¨¨1ÈõÜÂàÜÈè°', action: () => runStoryboardGeneration(1) },
                    { text: 'üì• Â∞éÂá∫ÂäáÊú¨', action: () => exportScripts() }
                ]);
            }
            break;
        case 6:
            addAIMessage(`üé¨ ÂàÜÈè°ÈöéÊÆµ„ÄÇËº∏ÂÖ•„ÄåÁîüÊàêÁ¨¨XÈõÜÂàÜÈè°„ÄçÁîüÊàêÊåáÂÆöÈõÜÁöÑÂàÜÈè°`);
            break;
        default:
            if (state.mode === 'import') {
                continueImportProject();
            } else {
                continueWriteProject();
            }
    }
}

// ==================== È°πÁõÆËµÑ‰∫ßÊü•Áúã ====================
function showProjectAssets() {
    const a = state.assets || {};
    const p = state.production || {};
    
    // ÊûÑÂª∫ÂÆåÊï¥ËµÑ‰∫ßÈ°µÈù¢
    let html = `üì¶ **È†ÖÁõÆË≥áÁî¢**„Ää${state.novelTitle || 'Êú™ÂëΩÂêç'}„Äã

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

`;

    // 1. È´òÊ¶ÇÂøµ
    html += `**1Ô∏è‚É£ È´òÊ¶ÇÂøµ**\n`;
    if (a.concept) {
        html += `‚Ä¢ È°ûÂûã: ${a.concept.genre || '-'}\n`;
        html += `‚Ä¢ ‰∏ªÈ°å: ${a.concept.theme || '-'}\n`;
        html += `‚Ä¢ Âü∫Ë™ø: ${a.concept.tone || '-'}\n`;
        html += `‚Ä¢ Logline: ${a.concept.logline || '-'}\n`;
    } else {
        html += `‚ùå Êú™ÁîüÊàê\n`;
    }
    
    // 2. ‰∫∫Áâ©Â∞è‰º†
    html += `\n**2Ô∏è‚É£ ‰∫∫Áâ©Â∞èÂÇ≥** (${a.characters?.length || 0}ÂÄã)\n`;
    if (a.characters?.length > 0) {
        a.characters.slice(0, 5).forEach(c => {
            html += `‚Ä¢ **${c.name}** (${c.role}): ${(c.bio || '').substring(0, 50)}...\n`;
        });
        if (a.characters.length > 5) html += `  ... ÂÖ±${a.characters.length}ÂÄãËßíËâ≤\n`;
    } else {
        html += `‚ùå Êú™ÁîüÊàê\n`;
    }
    
    // 3. Á´†ËäÇÈõÜÊï∞
    html += `\n**3Ô∏è‚É£ Á´†ÁØÄË¶èÂäÉ** (${a.chapters?.length || 0}ÈõÜ)\n`;
    if (a.chapters?.length > 0) {
        html += `‚Ä¢ Á∏ΩÈõÜÊï∏: ${a.chapters.length} ÈõÜ\n`;
        html += `‚Ä¢ ÊØèÈõÜÊôÇÈï∑: ${p.durationMin || 3} ÂàÜÈêò\n`;
        html += `‚Ä¢ Á∏ΩÊôÇÈï∑: ${(a.chapters.length * (p.durationMin || 3))} ÂàÜÈêò\n`;
        a.chapters.slice(0, 3).forEach(c => {
            html += `  - Á¨¨${c.number}ÈõÜ: ${c.title || 'Êú™ÂëΩÂêç'}\n`;
        });
        if (a.chapters.length > 3) html += `  ... ÂÖ±${a.chapters.length}ÈõÜ\n`;
    } else {
        html += `‚ùå Êú™ÁîüÊàê\n`;
    }
    
    // 4. ÊúçÂåñÈÅì
    html += `\n**4Ô∏è‚É£ ÊúçÂåñÈÅì**\n`;
    const costumeCount = a.costumes?.length || 0;
    const setCount = a.sets?.length || 0;
    const propCount = a.props?.length || 0;
    if (costumeCount + setCount + propCount > 0) {
        html += `‚Ä¢ ÊúçË£ù: ${costumeCount} Â•ó\n`;
        html += `‚Ä¢ Â†¥ÊôØ: ${setCount} ÂÄã\n`;
        html += `‚Ä¢ ÈÅìÂÖ∑: ${propCount} ‰ª∂\n`;
    } else {
        html += `‚ùå Êú™ÁîüÊàê\n`;
    }
    
    // 5. ‰∫∫Áâ©ÊèêÁ§∫ËØç
    html += `\n**5Ô∏è‚É£ ‰∫∫Áâ©ÊèêÁ§∫Ë©û**\n`;
    const charsWithPrompt = (a.characters || []).filter(c => c.prompt);
    if (charsWithPrompt.length > 0) {
        charsWithPrompt.slice(0, 3).forEach(c => {
            html += `‚Ä¢ ${c.name}: ${(c.prompt || '').substring(0, 40)}...\n`;
        });
    } else {
        html += `‚ùå Êú™ÁîüÊàê\n`;
    }
    
    // 6. ÂâßÊú¨
    const scripts = a.scripts || {};
    const scriptKeys = Object.keys(scripts);
    html += `\n**6Ô∏è‚É£ ÂäáÊú¨** (${scriptKeys.length}/${a.chapters?.length || 0}ÈõÜ)\n`;
    if (scriptKeys.length > 0) {
        scriptKeys.slice(0, 3).forEach(k => {
            const script = scripts[k];
            html += `‚Ä¢ Á¨¨${k}ÈõÜ: ${(script || '').length}Â≠ó\n`;
        });
        if (scriptKeys.length > 3) html += `  ... ÂÖ±${scriptKeys.length}ÈõÜÂäáÊú¨\n`;
    } else {
        html += `‚ùå Êú™ÁîüÊàê\n`;
    }
    
    // 7. ÂàÜÈïú
    const sbs = a.storyboards || {};
    const sbKeys = Object.keys(sbs);
    const totalShots = sbKeys.reduce((sum, k) => sum + (sbs[k]?.length || 0), 0);
    html += `\n**7Ô∏è‚É£ ÂàÜÈè°Ë°®** (${sbKeys.length}/${a.chapters?.length || 0}ÈõÜ, ${totalShots}Èè°È†≠)\n`;
    if (sbKeys.length > 0) {
        sbKeys.slice(0, 3).forEach(k => {
            const shots = sbs[k] || [];
            html += `‚Ä¢ Á¨¨${k}ÈõÜ: ${shots.length}ÂÄãÈè°È†≠\n`;
        });
        if (sbKeys.length > 3) html += `  ... ÂÖ±${sbKeys.length}ÈõÜÂàÜÈè°\n`;
    } else {
        html += `‚ùå Êú™ÁîüÊàê\n`;
    }
    
    // ÁªüËÆ°
    html += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä **Áµ±Ë®à**: ${totalShots}/${p.totalShots || 0} Èè°È†≠ (${p.totalShots ? Math.round(totalShots/p.totalShots*100) : 0}%)`;
    
    addAIMessage(html, [
        { text: 'üì• Â∞éÂá∫ÂÖ®ÈÉ®', action: () => exportAll() },
        { text: 'üì• Â∞éÂá∫ÂäáÊú¨', action: () => exportScripts() },
        { text: 'üì• Â∞éÂá∫ÂàÜÈè°', action: () => exportStoryboards() }
    ]);
}

// ==================== ÁßªÂä®Á´ØÂØºÂá∫ËèúÂçï ====================
function showMobileExportMenu() {
    const a = state.assets || {};
    const hasScripts = Object.keys(a.scripts || {}).length > 0;
    const hasStoryboards = Object.keys(a.storyboards || {}).length > 0;
    const hasAny = a.concept || a.characters?.length || a.chapters?.length;
    
    if (!hasAny) {
        addAIMessage(`üì§ **Â∞éÂá∫ÂäüËÉΩ**

‚ö†Ô∏è ÁõÆÂâçÈÇÑÊ≤íÊúâÈ†ÖÁõÆÂÖßÂÆπÂèØ‰ª•Â∞éÂá∫„ÄÇ

Ë´ãÂÖàÔºö
1. Â∞éÂÖ•Â∞èË™™ÊàñÂâµÂª∫Êñ∞È†ÖÁõÆ
2. ÂÆåÊàêËá≥Â∞ë‰∏ÄÂÄãÊ≠•È©ü`, [
            { text: 'üìÑ Â∞éÂÖ•Â∞èË™™', action: () => document.getElementById('fileInput').click() },
            { text: '‚ú® Êñ∞Âª∫È†ÖÁõÆ', action: () => startNewProject() }
        ]);
        return;
    }
    
    addAIMessage(`üì§ **Â∞éÂá∫ÈÅ∏È†Ö**

ÈÅ∏ÊìáË¶ÅÂ∞éÂá∫ÁöÑÂÖßÂÆπÔºö

${hasScripts ? '‚úÖ' : '‚¨ú'} **ÂäáÊú¨** - WordÊ†ºÂºè (.doc)
${hasStoryboards ? '‚úÖ' : '‚¨ú'} **ÂàÜÈè°Ë°®** - ExcelÊ†ºÂºè (.xls)
‚úÖ **ÂÖ®ÈÉ®Ë≥áÁî¢** - JSONÊ†ºÂºè`, [
        { text: 'üìù Â∞éÂá∫ÂäáÊú¨', action: () => exportScripts() },
        { text: 'üìä Â∞éÂá∫ÂàÜÈè°', action: () => exportStoryboards() },
        { text: 'üì¶ Â∞éÂá∫ÂÖ®ÈÉ®', action: () => exportAll() }
    ]);
}

// ==================== ÂØºÂá∫ÂáΩÊï∞ ====================
function exportScripts() {
    const scripts = state.assets.scripts;
    if (!scripts || Object.keys(scripts).length === 0) {
        addAIMessage(`‚ùå ÈÇÑÊ≤íÊúâÂäáÊú¨ÂèØ‰ª•Â∞éÂá∫`);
        return;
    }
    
    let content = `# ${state.novelTitle} - ÂäáÊú¨\n\n`;
    // ÁîüÊàêWordÊ†ºÂºèÔºàHTML-based .docÔºâ
    let wordContent = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body { font-family: "Microsoft YaHei", "SimSun", serif; line-height: 1.8; }
h1 { font-size: 24pt; text-align: center; margin-bottom: 30px; }
h2 { font-size: 16pt; color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 30px; }
.scene { font-weight: bold; margin-top: 20px; }
.action { color: #555; margin: 10px 0; }
.dialogue { margin-left: 40px; }
.character { font-weight: bold; }
hr { border: none; border-top: 1px dashed #999; margin: 30px 0; }
</style>
</head>
<body>
<h1>${state.novelTitle || 'ÂäáÊú¨'}</h1>
`;
    
    for (const [num, script] of Object.entries(scripts)) {
        const chapter = state.assets.chapters[num - 1];
        wordContent += `<h2>Á¨¨${num}ÈõÜ ${chapter?.title || ''}</h2>\n`;
        wordContent += `<div style="white-space: pre-wrap;">${escapeHtml(script)}</div>\n`;
        wordContent += `<hr>\n`;
    }
    
    wordContent += `</body></html>`;
    
    // ÂØºÂá∫‰∏∫ .doc Ê†ºÂºèÔºàWordÂèØ‰ª•Áõ¥Êé•ÊâìÂºÄHTMLÊ†ºÂºèÁöÑ.docÔºâ
    const blob = new Blob([wordContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${state.novelTitle}_ÂäáÊú¨.doc`;
    a.click();
    URL.revokeObjectURL(url);
    
    addAIMessage(`‚úÖ ÂäáÊú¨Â∑≤Â∞éÂá∫ÁÇ∫ WordÔºÅ

üìÑ **${state.novelTitle}_ÂäáÊú¨.doc**
‚Ä¢ ÂÖ± ${Object.keys(scripts).length} ÈõÜ
‚Ä¢ ÂèØÁî® Microsoft Word ÊâìÈñãÁ∑®ËºØ`);
}

function exportStoryboards() {
    const sbs = state.assets.storyboards;
    if (!sbs || Object.keys(sbs).length === 0) {
        addAIMessage(`‚ùå ÈÇÑÊ≤íÊúâÂàÜÈè°ÂèØ‰ª•Â∞éÂá∫`);
        return;
    }
    
    // ÂêàÂπ∂ÊâÄÊúâÂàÜÈïú
    let allShots = [];
    for (const [num, shots] of Object.entries(sbs)) {
        shots.forEach((shot, i) => {
            allShots.push({
                episode: num,
                shot_id: `E${String(num).padStart(3,'0')}_S${String(i+1).padStart(3,'0')}`,
                ...shot
            });
        });
    }
    
    // ÂØºÂá∫CSVÔºà‰∏ì‰∏öÊ†ºÂºèÔºâ
    const headers = ['shot_id', 'ÈõÜÊï∏', 'Áï´Èù¢ÊèèËø∞', 'Â†¥ÊôØ', 'ÊôÇÈñì', 'ÂÖâÁ∑ö', 'Ê∞õÂúç', 'ËßíËâ≤', 'Âãï‰Ωú', 'Ë°®ÊÉÖ', 'ÊúçË£ù', 'Âè∞Ë©û', 'Ê©ü‰Ωç', 'ÈÅãÈè°', 'ÊôØÂà•', 'Êïò‰∫ãÂäüËÉΩ', 'Image_Prompt', 'Video_Prompt'];
    
    let csv = headers.join(',') + '\n';
    allShots.forEach(shot => {
        const row = [
            shot.shot_id,
            shot.episode,
            `"${(shot.description || shot.scene || '').replace(/"/g, '""')}"`,
            `"${(shot.scene || shot.location || '').replace(/"/g, '""')}"`,
            shot.time || '',
            shot.lighting || '',
            shot.mood || shot.atmosphere || '',
            `"${(shot.characters || shot.character || '').replace(/"/g, '""')}"`,
            `"${(shot.action || '').replace(/"/g, '""')}"`,
            shot.expression || '',
            shot.costume || '',
            `"${(shot.dialogue || '').replace(/"/g, '""')}"`,
            shot.camera_position || shot.camera || '',
            shot.camera_movement || shot.movement || '',
            shot.shot_size || shot.framing || '',
            shot.narrative_function || '',
            `"${(shot.image_prompt || shot.ai_prompt || '').replace(/"/g, '""')}"`,
            `"${(shot.video_prompt || '').replace(/"/g, '""')}"`
        ];
        csv += row.join(',') + '\n';
    });
    
    // ÁîüÊàêExcelÊ†ºÂºèÔºàXML-based .xlsÔºâ
    let excelContent = `<?xml version="1.0" encoding="UTF-8"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
<Styles>
<Style ss:ID="header">
<Font ss:Bold="1" ss:Color="#FFFFFF"/>
<Interior ss:Color="#E31B23" ss:Pattern="Solid"/>
<Alignment ss:Horizontal="Center"/>
</Style>
<Style ss:ID="cell">
<Alignment ss:Vertical="Top" ss:WrapText="1"/>
</Style>
</Styles>
<Worksheet ss:Name="ÂàÜÈè°Ë°®">
<Table>
<Row>`;
    
    // Ë°®Â§¥
    headers.forEach(h => {
        excelContent += `<Cell ss:StyleID="header"><Data ss:Type="String">${h}</Data></Cell>`;
    });
    excelContent += `</Row>`;
    
    // Êï∞ÊçÆË°å
    allShots.forEach(shot => {
        excelContent += `<Row>`;
        const values = [
            shot.shot_id,
            shot.episode,
            shot.description || shot.scene || '',
            shot.scene || shot.location || '',
            shot.time || '',
            shot.lighting || '',
            shot.mood || shot.atmosphere || '',
            shot.characters || shot.character || '',
            shot.action || '',
            shot.expression || '',
            shot.costume || '',
            shot.dialogue || '',
            shot.camera_position || shot.camera || '',
            shot.camera_movement || shot.movement || '',
            shot.shot_size || shot.framing || '',
            shot.narrative_function || '',
            shot.image_prompt || shot.ai_prompt || '',
            shot.video_prompt || ''
        ];
        values.forEach(v => {
            excelContent += `<Cell ss:StyleID="cell"><Data ss:Type="String">${escapeHtml(String(v))}</Data></Cell>`;
        });
        excelContent += `</Row>`;
    });
    
    excelContent += `</Table></Worksheet></Workbook>`;
    
    // ÂØºÂá∫‰∏∫ .xls Ê†ºÂºè
    const blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${state.novelTitle}_ÂàÜÈè°Ë°®.xls`;
    a.click();
    URL.revokeObjectURL(url);
    
    addAIMessage(`‚úÖ ÂàÜÈè°Ë°®Â∑≤Â∞éÂá∫ÁÇ∫ ExcelÔºÅ

üìä **${state.novelTitle}_ÂàÜÈè°Ë°®.xls**
‚Ä¢ Á∏ΩÈè°È†≠: ${allShots.length} ÂÄã
‚Ä¢ 18ÂàóÂ∞àÊ•≠Â≠óÊÆµ
‚Ä¢ ÂèØÁî® Microsoft Excel ÊâìÈñãÁ∑®ËºØ

ÂåÖÂê´ÔºöÂ†¥ÊôØ„ÄÅÂÖâÁ∑ö„ÄÅÈÅãÈè°„ÄÅImage_Prompt„ÄÅVideo_Prompt Á≠â`);
}

function downloadFile(filename, content, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

// ÂØºÂá∫ÂÖ®ÈÉ®È°πÁõÆËµÑ‰∫ß
function exportAll() {
    const a = state.assets || {};
    const p = state.production || {};
    const title = state.novelTitle || 'Êú™ÂëΩÂêç';
    
    const projectData = {
        title: title,
        exportTime: new Date().toISOString(),
        production: p,
        
        // 1. È´òÊ¶ÇÂøµ
        concept: a.concept,
        
        // 2. ‰∫∫Áâ©Â∞è‰º†
        characters: a.characters,
        
        // 3. Á´†ËäÇËßÑÂàí
        chapters: a.chapters,
        
        // 4. ÊúçÂåñÈÅì
        costumes: a.costumes,
        sets: a.sets,
        props: a.props,
        
        // 5. ÂâßÊú¨
        scripts: a.scripts,
        
        // 6. ÂàÜÈïú
        storyboards: a.storyboards,
        
        // ÁªüËÆ°
        stats: {
            totalChapters: a.chapters?.length || 0,
            totalCharacters: a.characters?.length || 0,
            totalScripts: Object.keys(a.scripts || {}).length,
            totalStoryboards: Object.keys(a.storyboards || {}).length,
            totalShots: Object.values(a.storyboards || {}).reduce((sum, shots) => sum + (shots?.length || 0), 0)
        }
    };
    
    downloadFile(`${title}_È†ÖÁõÆË≥áÁî¢.json`, JSON.stringify(projectData, null, 2), 'application/json');
    
    addAIMessage(`‚úÖ **È†ÖÁõÆË≥áÁî¢Â∑≤Â∞éÂá∫ÔºÅ**

üìÑ Êñá‰ª∂: ${title}_È†ÖÁõÆË≥áÁî¢.json

ÂåÖÂê´ÂÖßÂÆπ:
‚Ä¢ È´òÊ¶ÇÂøµ
‚Ä¢ ${projectData.stats.totalCharacters} ÂÄãËßíËâ≤Â∞èÂÇ≥
‚Ä¢ ${projectData.stats.totalChapters} ÈõÜÁ´†ÁØÄË¶èÂäÉ
‚Ä¢ ÊúçÂåñÈÅìË®≠Ë®à
‚Ä¢ ${projectData.stats.totalScripts} ÈõÜÂäáÊú¨
‚Ä¢ ${projectData.stats.totalStoryboards} ÈõÜÂàÜÈè° (${projectData.stats.totalShots} Èè°È†≠)`);
}

// ==================== ÂØºÂÖ•FizzDragon ====================
function importToFizzDragon() {
    const a = state.assets || {};
    const storyboards = a.storyboards || {};
    const chapters = a.chapters || [];
    
    // Ëé∑ÂèñÊúâÂàÜÈïúÁöÑÈõÜÊï∞
    const availableEpisodes = Object.keys(storyboards)
        .map(k => parseInt(k))
        .filter(k => storyboards[k]?.length > 0)
        .sort((a, b) => a - b);
    
    if (availableEpisodes.length === 0) {
        addAIMessage(`‚ö†Ô∏è **ÈÇÑÊ≤íÊúâÂàÜÈè°ÂèØ‰ª•Â∞éÂÖ•**

Ë´ãÂÖàÁîüÊàêÂàÜÈè°Ôºö
1. ÂÆåÊàêÁ´†ÁØÄË¶èÂäÉ
2. ÁîüÊàêÂêÑÈõÜÂäáÊú¨
3. ÁîüÊàêÂàÜÈè°Ë°®

ÁÑ∂ÂæåÂÜçÂ∞éÂÖ• FizzStudio„ÄÇ`, [
            { text: 'üìù ÁîüÊàêÁ´†ÁØÄ', action: () => runChapterPlanning() }
        ]);
        return;
    }
    
    // ÊòæÁ§∫ÈÄâÊã©ÂØπËØùÊ°Ü
    showStoryboardSelector(availableEpisodes, chapters, storyboards);
}

function showStoryboardSelector(episodes, chapters, storyboards) {
    const title = state.novelTitle || 'Êú™ÂëΩÂêç';
    
    // ÂàõÂª∫ÈÄâÊã©Ê°ÜHTML
    let checkboxesHtml = episodes.map(ep => {
        const chapter = chapters[ep - 1];
        const shotCount = storyboards[ep]?.length || 0;
        const chapterTitle = chapter?.title || `Á¨¨${ep}ÈõÜ`;
        return `
            <label class="storyboard-checkbox">
                <input type="checkbox" value="${ep}" checked>
                <span class="checkbox-label">
                    <strong>Á¨¨${ep}ÈõÜ</strong> ${chapterTitle}
                    <span class="shot-count">${shotCount}Èè°</span>
                </span>
            </label>
        `;
    }).join('');
    
    const totalShots = episodes.reduce((sum, ep) => sum + (storyboards[ep]?.length || 0), 0);
    
    const container = document.getElementById('chatContainer');
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message ai';
    msgDiv.innerHTML = `
        <div class="role">üöÄ FizzStudio</div>
        <div class="content">
            <div class="storyboard-selector">
                <div class="selector-header">
                    <strong>ÈÅ∏ÊìáË¶ÅÂ∞éÂÖ•ÁöÑÂàÜÈè°</strong>
                    <span class="total-info">ÂÖ± ${episodes.length} ÈõÜ / ${totalShots} Èè°È†≠</span>
                </div>
                <div class="selector-actions-top">
                    <button onclick="toggleAllStoryboards(true)">ÂÖ®ÈÅ∏</button>
                    <button onclick="toggleAllStoryboards(false)">ÂèñÊ∂àÂÖ®ÈÅ∏</button>
                </div>
                <div class="selector-list">
                    ${checkboxesHtml}
                </div>
                <div class="selector-actions">
                    <button class="btn-cancel" onclick="this.closest('.message').remove()">ÂèñÊ∂à</button>
                    <button class="btn-confirm" onclick="confirmFizzStudioImport()">üöÄ Á¢∫Ë™çÂ∞éÂÖ•</button>
                </div>
            </div>
        </div>
    `;
    container.appendChild(msgDiv);
    scrollToBottom();
}

function toggleAllStoryboards(checked) {
    document.querySelectorAll('.storyboard-checkbox input').forEach(cb => {
        cb.checked = checked;
    });
}

function confirmFizzStudioImport() {
    const selected = Array.from(document.querySelectorAll('.storyboard-checkbox input:checked'))
        .map(cb => parseInt(cb.value));
    
    if (selected.length === 0) {
        alert('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÈõÜÂàÜÈè°');
        return;
    }
    
    const a = state.assets || {};
    const title = state.novelTitle || 'Êú™ÂëΩÂêç';
    
    // Êî∂ÈõÜÈÄâ‰∏≠ÁöÑÂàÜÈïúÊï∞ÊçÆ
    const exportData = {
        title: title,
        exportTime: new Date().toISOString(),
        source: 'aigc_workbench',
        version: '3.0',
        episodes: selected.map(ep => ({
            episode: ep,
            chapter: a.chapters?.[ep - 1],
            script: a.scripts?.[ep],
            storyboard: a.storyboards?.[ep]
        })),
        characters: a.characters,
        production: state.production
    };
    
    const totalShots = selected.reduce((sum, ep) => sum + (a.storyboards?.[ep]?.length || 0), 0);
    
    // ÁßªÈô§ÈÄâÊã©Ê°Ü
    document.querySelector('.storyboard-selector')?.closest('.message')?.remove();
    
    // ÊòæÁ§∫ÂØºÂÖ•ÈÄâÈ°π
    addAIMessage(`‚úÖ **Â∑≤ÈÅ∏Êìá ${selected.length} ÈõÜÂàÜÈè°**

üìä ÂÖ± ${totalShots} ÂÄãÈè°È†≠

ÈÅ∏ÊìáÂ∞éÂÖ•ÊñπÂºèÔºö`, [
        { text: 'üìã Ë§áË£ΩÊï∏Êìö', action: () => copyToClipboard(JSON.stringify(exportData, null, 2)) },
        { text: 'üì• ‰∏ãËºâJSON', action: () => downloadFile(`${title}_fizzstudio.json`, JSON.stringify(exportData, null, 2), 'application/json') },
        { text: 'üåê ÊâìÈñãFizzStudio', action: () => window.open('https://fizzdragon.com/studio', '_blank') }
    ]);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        addAIMessage('‚úÖ Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÊùøÔºÅ\n\nÂâçÂæÄ FizzDragon Âπ≥Âè∞Á≤òË≤ºÂ∞éÂÖ•Âç≥ÂèØ„ÄÇ');
    }).catch(err => {
        addAIMessage('‚ùå Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãï‰∏ãËºâJSONÊñá‰ª∂„ÄÇ');
    });
}

// ==================== Êô∫ËÉΩ‰ΩìÁä∂ÊÄÅÊòæÁ§∫ ====================
function showAgentStatus(agentName, status, agentId = null, steps = null) {
    // üîß ÂÖàÁßªÈô§typingÊ∂àÊÅØÔºåÈÅøÂÖçÈáçÂ§ç
    const typingMsg = document.getElementById('typingIndicator');
    if (typingMsg) typingMsg.remove();
    
    // Ëé∑ÂèñAgent‰∫∫Ê†ºÂåñÁü≠ËØ≠
    const persona = agentId ? AGENT_PERSONAS[agentId] : null;
    const personalizedName = persona?.name || agentName;
    const avatar = persona?.avatar || 'ü§ñ';
    
    // üîß Ê†πÊçÆÂΩìÂâçÊ≠•È™§Ëé∑ÂèñÂØπÂ∫îÁöÑpersonaÁü≠ËØ≠
    let phrase = status;
    if (persona?.phrases) {
        // ÊâæÂà∞ÂΩìÂâçËøõË°å‰∏≠ÁöÑÊ≠•È™§Á¥¢Âºï
        const currentStepIndex = steps?.findIndex(s => s.current);
        if (currentStepIndex !== undefined && currentStepIndex >= 0) {
            // Â∞ùËØïËé∑Âèñstep1, step2, step3...ÂØπÂ∫îÁöÑÁü≠ËØ≠
            const stepKey = `step${currentStepIndex + 1}`;
            phrase = persona.phrases[stepKey] || persona.phrases.working || status;
        } else {
            phrase = persona.phrases.working || status;
        }
    }
    
    // ÊûÑÂª∫ËØ¶ÁªÜÊ≠•È™§HTMLÔºàÊõ¥Á¥ßÂáëÔºâ
    let stepsHtml = '';
    if (steps && steps.length > 0) {
        stepsHtml = `<div class="agent-steps">` + 
            steps.map((step, i) => `
                <div class="step-item ${step.done ? 'done' : step.current ? 'current' : ''}">
                    <span class="step-icon">${step.done ? '‚úÖ' : step.current ? '‚è≥' : '‚óã'}</span>
                    <span class="step-text">${step.text}</span>
                </div>
            `).join('') + 
        `</div>`;
    }
    
    // Âú®ÂØπËØùÊ°Ü‰∏≠ÊòæÁ§∫ËøõÂ∫¶
    let progressMsg = document.getElementById('agentProgressMsg');
    if (!progressMsg) {
        progressMsg = document.createElement('div');
        progressMsg.id = 'agentProgressMsg';
        progressMsg.className = 'message ai agent-progress';
        document.getElementById('chatContainer').appendChild(progressMsg);
    }
    // üîß Êõ¥Á¥ßÂáëÁöÑÂ∏ÉÂ±ÄÔºåÊòæÁ§∫avatarÂ§ß‰∏ÄÁÇπ
    progressMsg.innerHTML = `
        <div class="role"><span style="font-size:18px;">${avatar}</span> ${personalizedName}</div>
        <div class="content" style="padding:4px 0;">
            <div style="display:flex;align-items:center;gap:8px;">
                <div class="agent-spinner-inline"></div>
                <span style="font-style:italic;color:#ccc;">${phrase}</span>
            </div>
            ${stepsHtml}
        </div>
    `;
    scrollToBottom();
    
    // Ê∑ªÂä†spinnerÊ†∑Âºè
    if (!document.getElementById('spinnerStyle')) {
        const style = document.createElement('style');
        style.id = 'spinnerStyle';
        style.textContent = `
            .agent-spinner, .agent-spinner-inline {
                width: 16px;
                height: 16px;
                border: 2px solid #E31B2333;
                border-top-color: #E31B23;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                flex-shrink: 0;
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            .agent-progress {
                border-left: 2px solid #E31B23 !important;
                background: rgba(227, 27, 35, 0.05) !important;
                padding: 8px 12px !important;
            }
            .agent-progress .content {
                padding: 0 !important;
            }
            .agent-steps {
                margin-top: 8px;
                padding: 6px 10px;
                background: rgba(0,0,0,0.2);
                border-radius: 6px;
            }
            .step-item {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 4px 0;
                font-size: 12px;
                color: #666;
            }
            .step-item.done {
                color: #4CAF50;
            }
            .step-item.current {
                color: #E31B23;
                font-weight: 500;
            }
            .step-icon {
                width: 16px;
                text-align: center;
            }
            /* ÊÄùËÄÉËøáÁ®ãÊ†∑Âºè - DeepSeekÈ£éÊ†º */
            .thinking-message {
                background: rgba(227, 27, 35, 0.03) !important;
                border-left: 2px solid #E31B23 !important;
            }
            .thinking-header {
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                padding: 4px 0;
                user-select: none;
            }
            .thinking-header:hover {
                opacity: 0.8;
            }
            .thinking-icon {
                font-size: 16px;
            }
            .thinking-icon.spinning {
                animation: pulse 1.5s ease-in-out infinite;
            }
            @keyframes pulse {
                0%, 100% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.6; transform: scale(0.95); }
            }
            .thinking-title {
                color: #E31B23;
                font-weight: 500;
                font-size: 13px;
            }
            .thinking-toggle {
                margin-left: auto;
                color: #666;
                transition: transform 0.2s;
            }
            .thinking-message.expanded .thinking-toggle {
                transform: rotate(180deg);
            }
            .thinking-content {
                margin-top: 8px;
                font-size: 12px;
                color: #888;
                line-height: 1.6;
            }
            .thinking-preview {
                white-space: pre-wrap;
            }
            .thinking-full {
                display: none;
                white-space: pre-wrap;
                max-height: 300px;
                overflow-y: auto;
            }
            .thinking-message.expanded .thinking-preview {
                display: none;
            }
            .thinking-message.expanded .thinking-full {
                display: block;
            }
            /* Âä®ÊÄÅÊÄùËÄÉÂä®Áîª */
            .thinking-animation {
                background: rgba(227, 27, 35, 0.05) !important;
                border-left: 2px solid #E31B23 !important;
            }
            .thinking-header.active .thinking-title::after {
                content: '...';
                animation: dots 1.5s steps(4) infinite;
            }
            @keyframes dots {
                0% { content: ''; }
                25% { content: '.'; }
                50% { content: '..'; }
                75% { content: '...'; }
            }
            .thinking-steps-anim {
                margin-top: 8px;
                padding: 8px 12px;
                background: rgba(0,0,0,0.2);
                border-radius: 6px;
            }
            .think-step {
                padding: 4px 0;
                font-size: 12px;
                color: #666;
                opacity: 0;
                animation: fadeIn 0.3s ease forwards;
            }
            .think-step.done {
                color: #4CAF50;
            }
            .think-step.current {
                color: #E31B23;
                font-weight: 500;
            }
            @keyframes fadeIn {
                to { opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }
}

function updateAgentStatus(agentName, status) {
    const statusBar = document.getElementById('agentStatusBar');
    if (statusBar) {
        statusBar.innerHTML = `<span>‚úÖ <strong>${agentName}</strong> ${status}</span>`;
    }
}

function hideAgentStatus() {
    // ÁßªÈô§ÊóßÁöÑÈ°∂ÈÉ®Áä∂ÊÄÅÊ†èÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
    const statusBar = document.getElementById('agentStatusBar');
    if (statusBar) statusBar.remove();
    
    // ÁßªÈô§ÂØπËØùÊ°Ü‰∏≠ÁöÑËøõÂ∫¶Ê∂àÊÅØ
    const progressMsg = document.getElementById('agentProgressMsg');
    if (progressMsg) progressMsg.remove();
}

// ÊÄùËÄÉËøáÁ®ãÂ±ïÁ§∫ - DeepSeekÈ£éÊ†ºÂèØÊäòÂè†Èù¢Êùø
function showThinkingProcess(thinking) {
    if (!thinking || thinking.length < 10) return;
    
    const container = document.getElementById('chatContainer');
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'message ai thinking-message';
    
    // ÈªòËÆ§ÊäòÂè†ÔºåÁÇπÂáªÂ±ïÂºÄ
    const isLong = thinking.length > 200;
    const previewText = isLong ? thinking.substring(0, 200) + '...' : thinking;
    
    thinkingDiv.innerHTML = `
        <div class="thinking-header" onclick="this.parentElement.classList.toggle('expanded')">
            <span class="thinking-icon">üí≠</span>
            <span class="thinking-title">ÊÄùËÄÉÈÅéÁ®ã</span>
            <span class="thinking-toggle">${isLong ? '‚ñº' : ''}</span>
        </div>
        <div class="thinking-content">
            <div class="thinking-preview">${escapeHtml(previewText)}</div>
            ${isLong ? `<div class="thinking-full">${escapeHtml(thinking)}</div>` : ''}
        </div>
    `;
    container.appendChild(thinkingDiv);
    scrollToBottom();
}

// Âä®ÊÄÅÊÄùËÄÉÂä®ÁîªÔºàË∞ÉÁî®APIÊó∂ÊòæÁ§∫Ôºâ
let thinkingAnimationInterval = null;
const THINKING_STEPS = {
    concept: [
        'üìö ËºâÂÖ•McKee„ÄäÊïÖ‰∫ã„ÄãÁêÜË´ñ...',
        'üé≠ ÂàÜÊûê‰∏âÂπïÁµêÊßã...',
        'üí° ÊèêÂèñÊ†∏ÂøÉÊà≤ÂäáË°ùÁ™Å...',
        'üé¨ Á¢∫ÂÆöÈ°ûÂûãËàáÂü∫Ë™ø...',
        '‚ú® ÁîüÊàêÈ´òÊ¶ÇÂøµ...'
    ],
    character: [
        'üìñ ËºâÂÖ•ËßíËâ≤Ë®≠Ë®àÊñπÊ≥ïË´ñ...',
        'üß† ÂàÜÊûêËßíËâ≤ÂøÉÁêÜÂãïÊ©ü...',
        'üíî ÊßãÂª∫ÂÖßÂøÉË°ùÁ™Å...',
        'üë§ Ë®≠Ë®àÂ§ñË≤åÁâπÂæµ...',
        '‚ú® ÂÆåÂñÑ‰∫∫Áâ©Â∞èÂÇ≥...'
    ],
    narrative: [
        'üìö ËºâÂÖ•Êïò‰∫ãÁµêÊßãÁêÜË´ñ...',
        'üéØ ÂàÜÊûêÊïÖ‰∫ãÁØÄÊãç...',
        'üìù Ë¶èÂäÉÁ´†ÁØÄÁµêÊßã...',
        'üîó Ë®≠Ë®àÊÉÖÁØÄÈâ§Â≠ê...',
        '‚ú® ÁîüÊàêÁ´†ÁØÄÂ§ßÁ∂±...'
    ],
    storyboard: [
        'üé• ËºâÂÖ•ÂàÜÈè°ÊäÄÊ≥ï...',
        'üìê Ë®àÁÆóÈè°È†≠ÂØÜÂ∫¶...',
        'üé¨ ÂàÜÊûêÂ†¥ÊôØËΩâÊèõ...',
        'üí° Ë®≠Ë®àË¶ñË¶∫Êïò‰∫ã...',
        '‚ú® ÁîüÊàêÂàÜÈè°Ë°®...'
    ],
    default: [
        'üìö ËºâÂÖ•Â∞àÊ•≠Áü•Ë≠òÂ∫´...',
        'üß† ÂàÜÊûêËº∏ÂÖ•ÂÖßÂÆπ...',
        'üí° ÊáâÁî®ÊñπÊ≥ïË´ñ...',
        '‚ú® ÁîüÊàêÁµêÊûú...'
    ]
};

function startThinkingAnimation(agentId) {
    const steps = THINKING_STEPS[agentId] || THINKING_STEPS.default;
    let stepIndex = 0;
    
    // ÂàõÂª∫ÊÄùËÄÉÂä®ÁîªÂÖÉÁ¥†
    const container = document.getElementById('chatContainer');
    let thinkingAnim = document.getElementById('thinkingAnimation');
    if (!thinkingAnim) {
        thinkingAnim = document.createElement('div');
        thinkingAnim.id = 'thinkingAnimation';
        thinkingAnim.className = 'message ai thinking-animation';
        container.appendChild(thinkingAnim);
    }
    
    // Êõ¥Êñ∞Âä®ÁîªÂÜÖÂÆπ
    function updateAnimation() {
        const currentStep = steps[stepIndex % steps.length];
        thinkingAnim.innerHTML = `
            <div class="thinking-header active">
                <span class="thinking-icon spinning">üß†</span>
                <span class="thinking-title">Ê≠£Âú®ÊÄùËÄÉ</span>
            </div>
            <div class="thinking-steps-anim">
                ${steps.slice(0, stepIndex + 1).map((s, i) => 
                    `<div class="think-step ${i === stepIndex ? 'current' : 'done'}">${s}</div>`
                ).join('')}
            </div>
        `;
        stepIndex++;
        scrollToBottom();
    }
    
    updateAnimation();
    thinkingAnimationInterval = setInterval(updateAnimation, 1500);
}

function stopThinkingAnimation() {
    if (thinkingAnimationInterval) {
        clearInterval(thinkingAnimationInterval);
        thinkingAnimationInterval = null;
    }
    const thinkingAnim = document.getElementById('thinkingAnimation');
    if (thinkingAnim) thinkingAnim.remove();
}

// ==================== Áî®Êà∑ËæìÂÖ• ====================
function sendMessage() {
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    if (!text) return;
    
    addUserMessage(text);
    input.value = '';
    
    // Â§ÑÁêÜÁî®Êà∑ÂõûÂ§ç
    handleUserInput(text);
}

function handleUserInput(text) {
    console.log('üîî handleUserInput:', { 
        mode: state.mode, 
        step: state.step, 
        writeQ: writeState.currentQuestion,
        novelTitle: state.novelTitle,
        textLen: text.length,
        appMode: appMode,
        adStep: adState.step,
        pendingRevision: !!window.pendingRevision
    });
    
    // ==================== ‰øÆÊîπÊÑèË¶ãËôïÁêÜ ====================
    if (window.pendingRevision) {
        handleRevisionFeedback(text);
        return;
    }
    
    // ==================== ÂπøÂëäÊ®°ÂºèÂ§ÑÁêÜ ====================
    if (appMode === 'ad' && adState.step > 0) {
        handleAdInput(text);
        return;
    }
    
    // ==================== ÂëΩ‰ª§Â§ÑÁêÜ ====================
    const lowerText = text.toLowerCase().trim();
    
    // ==================== Êô∫ËÉΩAgentË∞ÉÁî® ====================
    // ÈáçÊñ∞ÁîüÊàêËßíËâ≤
    if (lowerText.includes('ÈáçÊñ∞ÁîüÊàêËßíËâ≤') || lowerText.includes('ÈáçÊñ∞Ë®≠Ë®àËßíËâ≤') || lowerText.includes('ÂÜçÁîüÊàêËßíËâ≤')) {
        addAIMessage('üîÑ Â•ΩÁöÑÔºåÊ≠£Âú®ÈáçÊñ∞ÁîüÊàêËßíËâ≤ÂàÜÊûê...');
        runCharacterAnalysis();
        return;
    }
    
    // ÈáçÊñ∞ÁîüÊàêÈ´òÊ¶ÇÂøµ
    if (lowerText.includes('ÈáçÊñ∞ÁîüÊàêÊ¶ÇÂøµ') || lowerText.includes('ÈáçÊñ∞ÂàÜÊûê') || lowerText.includes('ÈáçÂÅöÈ´òÊ¶ÇÂøµ')) {
        addAIMessage('üîÑ Â•ΩÁöÑÔºåÊ≠£Âú®ÈáçÊñ∞ÁîüÊàêÈ´òÊ¶ÇÂøµ...');
        runConceptAnalysis();
        return;
    }
    
    // ÈáçÊñ∞ËßÑÂàíÁ´†ËäÇ
    if (lowerText.includes('ÈáçÊñ∞Ë¶èÂäÉÁ´†ÁØÄ') || lowerText.includes('ÈáçÊñ∞ËßÑÂàíÁ´†ËäÇ') || lowerText.includes('ÈáçÂÅöÁ´†ÁØÄ')) {
        addAIMessage('üîÑ Â•ΩÁöÑÔºåÊ≠£Âú®ÈáçÊñ∞Ë¶èÂäÉÁ´†ÁØÄ...');
        runChapterPlanning();
        return;
    }
    
    // ÈáçÊñ∞ÁîüÊàêÊúçÂåñÈÅì
    if (lowerText.includes('ÈáçÊñ∞ÁîüÊàêÊúçÂåñÈÅì') || lowerText.includes('ÈáçÂÅöÊúçÂåñÈÅì') || lowerText.includes('ÈáçÊñ∞Ë®≠Ë®àÊúçË£ù')) {
        addAIMessage('üîÑ Â•ΩÁöÑÔºåÊ≠£Âú®ÈáçÊñ∞ÁîüÊàêÊúçÂåñÈÅìË®≠Ë®à...');
        runProductionDesign();
        return;
    }
    
    // ÁîüÊàêÂâßÊú¨ÔºàÊåáÂÆöÈõÜÊï∞Ôºâ
    const scriptMatch = text.match(/(?:ÁîüÊàê|ÂØ´|ÂÜô)[Á¨¨]?(\d+)[ÈõÜÁ´†]?(?:ÁöÑ)?[ÂâßÂäá]Êú¨/);
    if (scriptMatch) {
        const epNum = parseInt(scriptMatch[1]);
        runScriptWriting(epNum);
        return;
    }
    
    // ÈÄöÁî®"ÁîüÊàêXX"ÂëΩ‰ª§
    if (lowerText.includes('ÁîüÊàêËßíËâ≤') || lowerText.includes('Ë®≠Ë®àËßíËâ≤')) {
        runCharacterAnalysis();
        return;
    }
    if (lowerText.includes('ÁîüÊàêÊ¶ÇÂøµ') || lowerText.includes('ÂàÜÊûêÊ¶ÇÂøµ')) {
        runConceptAnalysis();
        return;
    }
    if (lowerText.includes('ÁîüÊàêÁ´†ÁØÄ') || lowerText.includes('Ë¶èÂäÉÁ´†ÁØÄ') || lowerText.includes('ÁîüÊàêÁ´†ËäÇ')) {
        runChapterPlanning();
        return;
    }
    if (lowerText.includes('ÁîüÊàêÊúçÂåñÈÅì') || lowerText.includes('Ë®≠Ë®àÊúçÂåñÈÅì')) {
        runProductionDesign();
        return;
    }
    if (lowerText.includes('ÁîüÊàêÂäáÊú¨') || lowerText.includes('ÁîüÊàêÂâßÊú¨') || lowerText.includes('ÂØ´ÂäáÊú¨')) {
        // Â¶ÇÊûúÊ≤°ÊúâÊåáÂÆöÈõÜÊï∞ÔºåÁîüÊàêÁ¨¨‰∏ÄÈõÜ
        runScriptWriting(1);
        return;
    }
    
    // ÁîüÊàêÂàÜÈïúÂëΩ‰ª§
    const storyboardMatch = text.match(/ÁîüÊàê[Á¨¨]?(\d+)[ÈõÜÁ´†]?ÂàÜ[ÈïúÈè°]/);
    if (storyboardMatch) {
        const epNum = parseInt(storyboardMatch[1]);
        runStoryboardGeneration(epNum);
        return;
    }
    
    // ÂØºÂá∫ÂëΩ‰ª§
    if (lowerText.includes('ÂØºÂá∫') || lowerText.includes('Â∞éÂá∫')) {
        if (lowerText.includes('ÂâßÊú¨') || lowerText.includes('ÂäáÊú¨')) {
            exportScripts();
        } else if (lowerText.includes('ÂàÜÈïú') || lowerText.includes('ÂàÜÈè°')) {
            exportStoryboards();
        } else {
            exportAll();
        }
        return;
    }
    
    // Êü•ÁúãÈ°πÁõÆËµÑ‰∫ß
    if (lowerText.includes('È°πÁõÆËµÑ‰∫ß') || lowerText.includes('È†ÖÁõÆË≥áÁî¢') || lowerText === 'ËµÑ‰∫ß' || lowerText === 'Ë≥áÁî¢') {
        showProjectAssets();
        return;
    }
    
    // ÁªßÁª≠ÊµÅÁ®ã
    if (lowerText === 'ÁªßÁª≠' || lowerText === 'ÁπºÁ∫å') {
        continueCurrentStep();
        return;
    }
    
    // Â∏ÆÂä©ÂëΩ‰ª§
    if (lowerText === 'Â∏ÆÂä©' || lowerText === 'Âπ´Âä©' || lowerText === 'help' || lowerText === '?') {
        addAIMessage(`üìñ **ÂèØÁî®ÂëΩ‰ª§**

**ÁîüÊàêÂÖßÂÆπÔºö**
‚Ä¢ ÁîüÊàêÊ¶ÇÂøµ / ÈáçÊñ∞ÁîüÊàêÊ¶ÇÂøµ
‚Ä¢ ÁîüÊàêËßíËâ≤ / ÈáçÊñ∞ÁîüÊàêËßíËâ≤
‚Ä¢ ÁîüÊàêÁ´†ÁØÄ / ÈáçÊñ∞Ë¶èÂäÉÁ´†ÁØÄ
‚Ä¢ ÁîüÊàêÊúçÂåñÈÅì / ÈáçÊñ∞ÁîüÊàêÊúçÂåñÈÅì
‚Ä¢ ÁîüÊàêÁ¨¨XÈõÜÂäáÊú¨
‚Ä¢ ÁîüÊàêÁ¨¨XÈõÜÂàÜÈè°

**Â∞éÂá∫Ôºö**
‚Ä¢ Â∞éÂá∫ÂäáÊú¨
‚Ä¢ Â∞éÂá∫ÂàÜÈè°
‚Ä¢ Â∞éÂá∫ÂÖ®ÈÉ®

**ÂÖ∂‰ªñÔºö**
‚Ä¢ È†ÖÁõÆË≥áÁî¢ - Êü•ÁúãÁï∂ÂâçË≥áÁî¢
‚Ä¢ ÁπºÁ∫å - ÁπºÁ∫å‰∏ã‰∏ÄÊ≠•
‚Ä¢ Âπ´Âä© - È°ØÁ§∫Ê≠§Ë®äÊÅØ`);
        return;
    }
    
    // ÂÜô‰ΩúÊ®°Âºè - Â§ÑÁêÜÂàùÂßãÊÉ≥Ê≥ïËæìÂÖ•ÔºàÁ≠âÂæÖÊïÖ‰∫ãÁÅµÊÑüÔºâ
    // üîß ‰øÆÂ§çÔºöÊîæÂÆΩÊù°‰ª∂Ôºå-1 Êàñ null Êàñ undefined ÈÉΩÁÆóÂàùÂßãÁä∂ÊÄÅ
    if (state.mode === 'write' && (writeState.currentQuestion === -1 || writeState.currentQuestion === null || writeState.currentQuestion === undefined) && !writeState.idea) {
        console.log('ÂÜô‰ΩúÊ®°Âºè: Êé•Êî∂ÊïÖ‰∫ãÁÅµÊÑü, currentQuestion:', writeState.currentQuestion);
        writeState.idea = { premise: text };
        writeState.currentQuestion = -1;  // Á°Æ‰øùËÆæÁΩÆ‰∏∫ -1
        startWriteInterview();
        return;
    }
    
    // ÂÜô‰ΩúÊ®°Âºè - ËÆøË∞àÈóÆÈ¢ò
    if (state.mode === 'write' && typeof writeState.currentQuestion === 'number' && writeState.currentQuestion >= 0 && writeState.currentQuestion < WRITE_QUESTIONS.length) {
        console.log('ÂÜô‰ΩúÊ®°Âºè: ÂõûÁ≠îËÆøË∞àÈóÆÈ¢ò', writeState.currentQuestion);
        if (text.toLowerCase() === 'Ë∑≥ÈÅé' || text.toLowerCase() === 'Ë∑≥Ëøá') {
            writeState.interview[writeState.currentQuestion] = '(Ë∑≥ÈÅé)';
        } else {
            writeState.interview[writeState.currentQuestion] = text;
        }
        writeState.currentQuestion++;
        setTimeout(() => askWriteQuestion(), 500);
        return;
    }
    
    // ÂØºÂÖ•Ê®°Âºè - Âà∂‰ΩúËÆæÁΩÆÈóÆÁ≠î
    if (state.step === 1.5 && productionStep < 3) {
        handleProductionInput(text);
        return;
    }
    
    // ÂØºÂÖ•Ê®°Âºè - ËÆøË∞àÈóÆÈ¢òÔºàÁ∫ØÂØπËØùÂºèÔºâ
    if (state.step === 2 && state.currentQuestion < (state.interviewQuestions?.length || 0)) {
        // ÊîØÊåÅË∑≥ËøáÂëΩ‰ª§
        if (text.toLowerCase() === 'Ë∑≥ÈÅé' || text.toLowerCase() === 'Ë∑≥Ëøá') {
            state.interview[state.currentQuestion] = '(Ë∑≥ÈÅé)';
        } else {
            state.interview[state.currentQuestion] = text;
        }
        state.currentQuestion++;
        setTimeout(() => askNextQuestion(), 500);
        return;
    }
    
    // ÂØºÂÖ•Ê®°Âºè - Á∫ØÂØπËØùÂºèÁä∂ÊÄÅÊèêÁ§∫ÔºàÂ∏¶ÂèØÊìç‰ΩúÊåâÈíÆÔºâ
    if (state.mode === 'import' && state.step >= 1) {
        const stepNames = ['Á≠âÂæÖÂ∞éÂÖ•', 'Ê¶ÇÂøµÂàÜÊûê', 'Ë®™Ë´á‰∏≠', 'Á´†ÁØÄË¶èÂäÉ', 'ÊúçÂåñÈÅì', 'ÂäáÊú¨', 'ÂàÜÈè°'];
        const a = state.assets || {};
        const scriptCount = Object.keys(a.scripts || {}).length;
        const sbCount = Object.keys(a.storyboards || {}).length;
        const chapterCount = a.chapters?.length || 0;
        
        addAIMessage(`üìä **È†ÖÁõÆÁãÄÊÖã**: „Ää${state.novelTitle || 'Êú™ÂëΩÂêç'}„Äã

‚Ä¢ È´òÊ¶ÇÂøµ: ${a.concept ? '‚úÖ' : '‚è≥'}
‚Ä¢ ËßíËâ≤: ${a.characters?.length || 0} ÂÄã
‚Ä¢ Á´†ÁØÄ: ${chapterCount} ÈõÜ
‚Ä¢ ÂäáÊú¨: ${scriptCount}/${chapterCount} ÈõÜ
‚Ä¢ ÂàÜÈè°: ${sbCount}/${chapterCount} ÈõÜ

Ëº∏ÂÖ•„ÄåÂπ´Âä©„ÄçÊü•ÁúãÂèØÁî®ÂëΩ‰ª§`, [
            { text: 'üìù ÁπºÁ∫åÊµÅÁ®ã', action: () => continueCurrentStep() },
            { text: 'üì• Â∞éÂá∫ÈÄ≤Â∫¶', action: () => exportAll() }
        ]);
        return;
    }
    
    // ÂàùÂßãÁä∂ÊÄÅ - Áî®Êà∑Áõ¥Êé•ÂèëÈÄÅÊñáÂ≠ó
    if (state.step === 0 && !state.mode) {
        // Ê£ÄÊµãÊòØÂê¶ÂÉèÊòØÊïÖ‰∫ãÂÜÖÂÆπÔºàË∂ÖËøá100Â≠óÔºâ
        if (text.length > 100) {
            addAIMessage(`üìñ Êî∂Âà∞‰Ω†ÁöÑÂÖßÂÆπÔºà${text.length}Â≠óÔºâÔºÅ

ÈÄôÁúãËµ∑‰æÜÂÉèÊòØÊïÖ‰∫ãÂÖßÂÆπÔºåË´ãÈÅ∏ÊìáËôïÁêÜÊñπÂºèÔºö`, [
                { text: 'üìù ‰ΩúÁÇ∫Ââµ‰ΩúÈùàÊÑü', action: () => {
                    state.mode = 'write';
                    writeState.currentQuestion = -1;
                    writeState.idea = { premise: text };
                    startWriteInterview();
                }},
                { text: 'üìÑ Áõ¥Êé•ÂàÜÊûêÁîüÊàêÂàÜÈè°', action: async () => {
                    state.novel = text;
                    state.novelTitle = 'Áõ¥Êé•Ëº∏ÂÖ•';
                    state.step = 1;
                    state.mode = 'import';
                    await runConceptStep();
                }}
            ]);
        } else {
            addAIMessage(`üëã Ë´ãÈÅ∏ÊìáÈñãÂßãÊñπÂºèÔºö`, [
                { text: 'üìÑ Â∞éÂÖ•Â∞èË™™Êñá‰ª∂', action: () => document.getElementById('fileInput').click() },
                { text: '‚úçÔ∏è AIÂπ´ÊàëÂØ´Â∞èË™™', action: () => startWriteMode() },
                { text: 'üìù Áõ¥Êé•Ëº∏ÂÖ•ÊïÖ‰∫ã', action: () => addAIMessage('Ë´ãÁõ¥Êé•Ëº∏ÂÖ•ÊàñÁ≤òË≤º‰Ω†ÁöÑÊïÖ‰∫ãÂÖßÂÆπÔºà100Â≠ó‰ª•‰∏äÔºâÔºåÊàëÊúÉËá™ÂãïË≠òÂà•‰∏¶ËôïÁêÜ„ÄÇ') }
            ]);
        }
        return;
    }
    
    // ÂÖ∂‰ªñÊÉÖÂÜµ - ÊòæÁ§∫Â∏ÆÂä©ÈÄâÈ°π
    addAIMessage(`üìä **Áï∂ÂâçÁãÄÊÖã**
‚Ä¢ Ê®°Âºè: ${state.mode === 'write' ? 'Ââµ‰Ωú' : state.mode === 'import' ? 'Â∞éÂÖ•' : 'Êú™ÈñãÂßã'}
‚Ä¢ Ê≠•È©ü: ${state.step}/5

ÈúÄË¶Å‰ªÄÈ∫ºÂπ´Âä©Ôºü`, [
        { text: '‚ñ∂Ô∏è ÁπºÁ∫å', action: () => state.mode === 'write' ? continueWriteProject() : continueImportProject() },
        { text: 'üÜò Ë®∫Êñ∑ÂïèÈ°å', action: () => callHelpAgent() },
        { text: 'üè† ÈáçÊñ∞ÈñãÂßã', action: () => { resetWorkflowFromStep(0); document.getElementById('chatContainer').innerHTML = ''; showStartOptions(); }}
    ]);
}

// ÂõûËΩ¶ÂèëÈÄÅ
document.getElementById('userInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Ëá™Âä®Ë∞ÉÊï¥È´òÂ∫¶
document.getElementById('userInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 150) + 'px';
});

// ==================== üñºÔ∏è ÂõæÂÉèÁîüÊàê (Replicate) ====================
async function generateImage(prompt, type = 'character') {
    addTypingIndicator();
    showAgentStatus('üñºÔ∏è ÂúñÂÉèÁîüÊàê', 'Ê≠£Âú®ÁîüÊàê...');
    
    try {
        const response = await fetch(`${API_BASE.replace('/api', '')}/api/generate-image`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt,
                model: 'flux_schnell',  // Âø´ÈÄüÊ®°Âºè
                aspectRatio: type === 'character' ? '3:4' : '16:9'
            })
        });
        
        const result = await response.json();
        
        removeTypingIndicator();
        hideAgentStatus();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        // ÊòæÁ§∫ÁîüÊàêÁöÑÂõæÁâá
        addAIMessage(`üñºÔ∏è **${type === 'character' ? 'ËßíËâ≤Âúñ' : 'Â†¥ÊôØÂúñ'}ÁîüÊàêÂÆåÊàêÔºÅ**

<img src="${result.url}" style="max-width:100%;border-radius:12px;margin:10px 0;">

**Prompt**: ${prompt.substring(0, 100)}...`, [
            { text: 'üì• ‰∏ãËºâÂúñÁâá', action: () => window.open(result.url, '_blank') },
            { text: 'üîÑ ÈáçÊñ∞ÁîüÊàê', action: () => generateImage(prompt, type) }
        ]);
        
        return result.url;
        
    } catch (err) {
        removeTypingIndicator();
        hideAgentStatus();
        addAIMessage(`‚ùå ÂúñÁâáÁîüÊàêÂ§±Êïó: ${err.message}

ÂèØËÉΩÂéüÂõ†Ôºö
‚Ä¢ Êú™ÈÖçÁΩÆ REPLICATE_API_KEY
‚Ä¢ API È°çÂ∫¶Áî®ÂÆå
‚Ä¢ Á∂≤Áµ°ÂïèÈ°å`, [
            { text: 'üîÑ ÈáçË©¶', action: () => generateImage(prompt, type) }
        ]);
        return null;
    }
}

// ÊâπÈáèÁîüÊàêËßíËâ≤Âõæ
async function generateCharacterImages() {
    const chars = state.characters?.characters || [];
    if (chars.length === 0) {
        addAIMessage('‚ùå Ê≤íÊúâËßíËâ≤Êï∏ÊìöÔºåË´ãÂÖàÁîüÊàêËßíËâ≤Ë®≠Ë®à');
        return;
    }
    
    addAIMessage(`üñºÔ∏è **ÈñãÂßãÁîüÊàêËßíËâ≤Âúñ** (ÂÖ± ${chars.length} ÂÄã)

ÈÄôÂèØËÉΩÈúÄË¶ÅÂπæÂàÜÈêò...`);
    
    for (const char of chars.slice(0, 5)) {  // ÊúÄÂ§öÁîüÊàê5‰∏™
        const prompt = char.ai_prompt || `${char.name}, ${char.appearance || ''}, portrait, cinematic lighting, detailed face`;
        await generateImage(prompt, 'character');
        await new Promise(r => setTimeout(r, 2000));  // Èó¥Èöî2Áßí
    }
    
    addAIMessage(`‚úÖ **ËßíËâ≤ÂúñÁîüÊàêÂÆåÊàêÔºÅ**`);
}

// Ê£ÄÊü•ÁîüÂõæÊúçÂä°Áä∂ÊÄÅ
async function checkImageGenStatus() {
    try {
        const response = await fetch(`${API_BASE.replace('/api', '')}/api/generate-image/status`);
        const status = await response.json();
        return status.enabled;
    } catch {
        return false;
    }
}

// ==================== ÂØºÂá∫ ====================
function exportAll() {
    const data = {
        title: state.novelTitle,
        concept: state.concept,
        interview: state.interview,
        chapters: state.chapters,
        characters: state.characters,
        storyboard: state.storyboard,
        exportTime: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${state.novelTitle}_AIÁï™Âäá.json`;
    a.click();
    
    addAIMessage(`‚úÖ Â∑≤Â∞éÂá∫ **${state.novelTitle}_AIÁï™Âäá.json**`);
}

// ==================== ÂêØÂä® ====================
// Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
const authToken = localStorage.getItem('fizzdragon_token');
const savedUser = JSON.parse(localStorage.getItem('fizzdragon_user') || 'null');
if (savedUser) {
    currentUser = { ...currentUser, ...savedUser };
}

if (!authToken) {
    // Êú™ÁôªÂΩïÔºåÂÜÖÊµãÊ®°ÂºèÁõ¥Êé•ÂàùÂßãÂåñ
    init();
} else {
    // È™åËØÅtoken
    fetch('/api/auth/verify', {
        headers: { 'Authorization': `Bearer ${authToken}` }
    }).then(res => {
        if (!res.ok) {
            localStorage.removeItem('fizzdragon_token');
            localStorage.removeItem('fizzdragon_user');
            init(); // ÂÜÖÊµãÊ®°ÂºèÔºöÈ™åËØÅÂ§±Ë¥•‰πüÂàùÂßãÂåñ
        } else {
            // ÁôªÂΩïÊúâÊïàÔºåÂàùÂßãÂåñ
            init();
        }
    }).catch(() => {
        // ÁΩëÁªúÈîôËØØÔºå‰ªçÁÑ∂Â∞ùËØïÂàùÂßãÂåñÔºàÁ¶ªÁ∫øÊ®°ÂºèÔºâ
        init();
    });
}
    </script>
</body>
</html>
